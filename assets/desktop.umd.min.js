!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):((t=t||self).desktop=t.desktop||{},t.desktop.min=e())}(this,(function(){"use strict";var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(e,n)};function e(e,n){function i(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(i.prototype=n.prototype,new i)}var n=function(){return(n=Object.assign||function(t){for(var e,n=1,i=arguments.length;n<i;n++)for(var o in e=arguments[n])Object.prototype.hasOwnProperty.call(e,o)&&(t[o]=e[o]);return t}).apply(this,arguments)};function i(t,e,n,i){return new(n||(n=Promise))((function(o,r){function s(t){try{c(i.next(t))}catch(t){r(t)}}function a(t){try{c(i.throw(t))}catch(t){r(t)}}function c(t){t.done?o(t.value):new n((function(e){e(t.value)})).then(s,a)}c((i=i.apply(t,e||[])).next())}))}function o(t,e){var n,i,o,r,s={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return r={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(r[Symbol.iterator]=function(){return this}),r;function a(r){return function(a){return function(r){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,i&&(o=2&r[0]?i.return:r[0]?i.throw||((o=i.return)&&o.call(i),0):i.next)&&!(o=o.call(i,r[1])).done)return o;switch(i=0,o&&(r=[2&r[0],o.value]),r[0]){case 0:case 1:o=r;break;case 4:return s.label++,{value:r[1],done:!1};case 5:s.label++,i=r[1],r=[0];continue;case 7:r=s.ops.pop(),s.trys.pop();continue;default:if(!(o=(o=s.trys).length>0&&o[o.length-1])&&(6===r[0]||2===r[0])){s=0;continue}if(3===r[0]&&(!o||r[1]>o[0]&&r[1]<o[3])){s.label=r[1];break}if(6===r[0]&&s.label<o[1]){s.label=o[1],o=r;break}if(o&&s.label<o[2]){s.label=o[2],s.ops.push(r);break}o[2]&&s.ops.pop(),s.trys.pop();continue}r=e.call(t,s)}catch(t){r=[6,t],i=0}finally{n=o=0}if(5&r[0])throw r[1];return{value:r[0]?r[1]:void 0,done:!0}}([r,a])}}}function r(){for(var t=0,e=0,n=arguments.length;e<n;e++)t+=arguments[e].length;var i=Array(t),o=0;for(e=0;e<n;e++)for(var r=arguments[e],s=0,a=r.length;s<a;s++,o++)i[o]=r[s];return i}var s=1,a=2,c=3,u=4;function d(t){return t.type===c?"timestamp":t.type===a?"number":t.type===s?"string":t.type===u?"object":"unknown"}function p(t){return t.constructor===Date?"timestamp":"number"==typeof t?"number":"string"==typeof t?"string":"object"==typeof t?"object":"string"}function h(t){var e={},n=d(t);if("object"===n){var i=Object.keys(t.value).reduce((function(e,n){var i=p(t.value[n]);if("object"===i){var o=function t(e){return Object.keys(e).reduce((function(n,i){var o=p(e[i]);return n[i]="object"===o?{type:"object",description:"",context:{},composite:t(e[i])}:{type:o,description:"",context:{}},n}),{})}(t.value[n]);e[n]={type:"object",description:"",context:{},composite:o}}else e[n]={type:i,description:"",context:{}};return e}),{});e.composite=i}return e.name=f(t.path.join("/")+"/"+t.name),e.type=n,e.description=t.description,e.context={},e}function f(t){return void 0!==t&&t.length>0&&"/"!==t[0]?"/"+t:t}function l(t){return"timestamp"===d(t)?Date.now():function t(e){if("object"!=typeof e)return e;return Object.keys(e).reduce((function(n,i){var o=e[i];return"object"==typeof o&&o.constructor!==Date?n[i]=t(o):o.constructor===Date?n[i]=new Date(o).getTime():o.constructor===Boolean?n[i]=o.toString():n[i]=o,n}),{})}(t.value)}function y(t){var e=function t(e){return e.reduce((function(e,n){return e.concat(Array.isArray(n)?t(n):n)}),[])}(t.root.getAggregateState()),n=e.sort((function(t,e){return t.state?e.state?e.state-t.state:-1:1}))[0];return{description:function(t){var e="";return t.forEach((function(t,n,i){var o=t.path.join(".");n===i.length-1?e+=o+"."+t.name+": "+t.description:e+=o+"."+t.name+": "+t.description+","})),e.length>100?e.slice(0,100)+"...":e}(e),value:n.state}}var g=function(t,e,n){if(null===t||"object"!=typeof t)throw new Error("Missing definition");if(null===e||"object"!=typeof e)throw new Error("Missing parent");if(null===n||"object"!=typeof n)throw new Error("Missing transport")},v=function(){function t(t,e,n,i,o){this.definition=t,this.system=e,this.transport=n,this.value=i,this.type=o,this.path=[],g(t,e,n),this.path=e.path.slice(0),this.path.push(e.name),this.name=t.name,this.description=t.description,n.createMetric(this)}return Object.defineProperty(t.prototype,"repo",{get:function(){var t;return null===(t=this.system)||void 0===t?void 0:t.repo},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"id",{get:function(){return this.system.path+"/"+name},enumerable:!0,configurable:!0}),t.prototype.update=function(t){this.value=t,this.transport.updateMetric(this)},t}(),m=function(t){function n(e,n,i,o){return t.call(this,e,n,i,o,a)||this}return e(n,t),n.prototype.incrementBy=function(t){this.update(this.value+t)},n.prototype.increment=function(){this.incrementBy(1)},n.prototype.decrement=function(){this.incrementBy(-1)},n.prototype.decrementBy=function(t){this.incrementBy(-1*t)},n}(v),w=function(t){function n(e,n,i,o){return t.call(this,e,n,i,o,u)||this}return e(n,t),n.prototype.update=function(t){this.mergeValues(t),this.transport.updateMetric(this)},n.prototype.mergeValues=function(t){var e=this;return Object.keys(this.value).forEach((function(n){void 0!==t[n]&&(e.value[n]=t[n])}))},n}(v),b=function(t){function n(e,n,i,o){return t.call(this,e,n,i,o,s)||this}return e(n,t),n}(v),_=function(t){function n(e,n,i,o){return t.call(this,e,n,i,o,c)||this}return e(n,t),n.prototype.now=function(){this.update(new Date)},n}(v);var I=function(){function t(t,e){e.init(this),this.root=function t(e,n,i,o,r){if(!n)throw new Error("Repository is required");if(!i)throw new Error("Transport is required");var d,p,h=i,f=e,l=r||"",y=n,g=o,v=function t(e){if(!e||!e.parent)return[];var n=t(e.parent);return n.push(e.name),n}(o),I={},A=(p="/",((d=v)&&d.length>0?d.join(p):"")+e),C=n.root,T=[],S=[];function k(t,e,n,i){var o={name:""};o="string"==typeof t?{name:t}:t;var r=S.filter((function(t){return t.name===o.name}));if(r.length>0){var s=r[0];if(s.type!==e)throw new Error("A metric named "+o.name+" is already defined with different type.");return void 0!==n&&s.update(n),s}var a=i(o);return S.push(a),a}var x={get name(){return f},get description(){return l},get repo(){return y},get parent(){return g},path:v,id:A,root:C,get subSystems(){return T},get metrics(){return S},subSystem:function(e,n){if(!e||0===e.length)throw new Error("name is required");var i=T.filter((function(t){return t.name===e}));if(i.length>0)return i[0];var o=t(e,y,h,x,n);return T.push(o),o},getState:function(){return I},setState:function(t,e){I={state:t,description:e},h.updateSystem(x,I)},stringMetric:function(t,e){return k(t,s,e,(function(t){return new b(t,x,h,e)}))},timestampMetric:function(t,e){return k(t,c,e,(function(t){return new _(t,x,h,e)}))},objectMetric:function(t,e){return k(t,u,e,(function(t){return new w(t,x,h,e)}))},numberMetric:function(t,e){return k(t,a,e,(function(t){return new m(t,x,h,e)}))},getAggregateState:function(){var t=[];return Object.keys(I).length>0&&t.push({name:f,path:v,state:I.state,description:I.description}),T.forEach((function(e){var n=e.getAggregateState();n.length>0&&t.push.apply(t,n)})),t}};return h.createSystem(x),x}("",this,e),this.addSystemMetrics(this.root,t.clickStream||void 0===t.clickStream)}return t.prototype.addSystemMetrics=function(t,e){if("undefined"!=typeof navigator&&t.stringMetric("UserAgent",navigator.userAgent),e&&"undefined"!=typeof document){var n=t.subSystem("ClickStream"),i=function(t){if(t.target){var e=t.target;n.objectMetric("LastBrowserEvent",{type:"click",timestamp:new Date,target:{className:t.target?e.className:"",id:e.id,type:"<"+e.tagName.toLowerCase()+">",href:e.href||""}})}};n.objectMetric("Page",{title:document.title,page:window.location.href}),document.addEventListener?document.addEventListener("click",i):document.attachEvent("onclick",i)}t.stringMetric("StartTime",(new Date).toString());var o=t.stringMetric("StartURL",""),r=t.stringMetric("AppName","");if("undefined"!=typeof window){if(void 0!==window.location){var s=window.location.href;o.update(s)}void 0!==window.glue42gd&&r.update(window.glue42gd.appName)}},t}(),A=function(){function t(){}return t.prototype.init=function(t){},t.prototype.createSystem=function(t){},t.prototype.updateSystem=function(t,e){},t.prototype.createMetric=function(t){},t.prototype.updateMetric=function(t){},t}(),C=function(t){var e;return e=t.connection&&"object"==typeof t.connection?function(t,e){if(!t||"object"!=typeof t)throw new Error("Connection is required parameter");var i,o,r=function(t){s(t.root)},s=function(t){a(t),t.metrics.forEach((function(t){c(t)})),t.subSystems.forEach((function(t){s(t)}))},a=function(t){void 0!==t.parent&&i.then((function(){var e={type:"define",metrics:[{name:f(t.path.join("/")+"/"+t.name+"/State"),type:"object",composite:{Description:{type:"string",description:""},Value:{type:"number",description:""}},description:"System state",context:{}}]};o.send(e)}))},c=function(t){var e=d(t);i.then((function(){var t={type:"define",metrics:[h(e)]};o.send(t),void 0!==e.value&&u(e)}))},u=function(t){if(p()){var e=l(t),n={type:"publish",values:[{name:f(t.path.join("/")+"/"+t.name),value:e,timestamp:Date.now()}]};o.send(n)}},d=function(t){var e=n({},t);return"object"==typeof t.value&&null!==t.value&&(e.value=n({},t.value)),e},p=function(){var t;try{return(null!==(t=e.canUpdateMetric)&&void 0!==t?t:function(){return!0})()}catch(t){return!0}};return{init:function(n){var s;i=new Promise((function(t){s=t})),(o=t.domain("metrics")).onJoined((function(t){!t&&s&&(s(),s=void 0);var e={type:"define",metrics:[{name:"/State",type:"object",composite:{Description:{type:"string",description:""},Value:{type:"number",description:""}},description:"System state",context:{}}]};o.send(e),t&&r(n)})),o.join({system:e.system,service:e.service,instance:e.instance})},createSystem:a,updateSystem:function(e,n){i.then((function(){var i={type:"publish",values:[{name:f(e.path.join("/")+"/"+e.name+"/State"),value:{Description:n.description,Value:n.state},timestamp:Date.now()}]};o.send(i);var r=y(e),s={type:"publish",peer_id:t.peerId,values:[{name:"/State",value:{Description:r.description,Value:r.value},timestamp:Date.now()}]};o.send(s)}))},createMetric:c,updateMetric:function(t){var e=d(t);i.then((function(){return u(e)}))}}}(t.connection,t):new A,new I(t,e).root};function T(t){if(t&&t.errorHandling&&"function"!=typeof t.errorHandling&&"log"!==t.errorHandling&&"silent"!==t.errorHandling&&"throw"!==t.errorHandling)throw new Error('Invalid options passed to createRegistry. Prop errorHandling should be ["log" | "silent" | "throw" | (err) => void], but '+typeof t.errorHandling+" was passed");var e=t&&"function"==typeof t.errorHandling&&t.errorHandling,n={};function i(n,i){var o=n instanceof Error?n:new Error(n);if(e)e(o);else{var r='[ERROR] callback-registry: User callback for key "'+i+'" failed: '+o.stack;if(t)switch(t.errorHandling){case"log":return console.error(r);case"silent":return;case"throw":throw new Error(r)}console.error(r)}}return{add:function(t,e){var i=n[t];return i||(i=[],n[t]=i),i.push(e),function(){var i=n[t];i&&(i=i.reduce((function(t,n,i){return n===e&&t.length===i||t.push(n),t}),[]),n[t]=i)}},execute:function(t){for(var e=[],o=1;o<arguments.length;o++)e[o-1]=arguments[o];var r=n[t];if(!r||0===r.length)return[];var s=[];return r.forEach((function(n){try{var o=n.apply(void 0,e);s.push(o)}catch(e){s.push(void 0),i(e,t)}})),s},clear:function(){n={}},clearKey:function(t){n[t]&&delete n[t]}}}T.default=T;var S=T,k=function(){function t(t,e){var n=this;this.registry=S(),this.gw=t.facade,this.gw.connect((function(t,e){n.messageHandler(e)})).then((function(t){n.client=t}))}return Object.defineProperty(t.prototype,"isObjectBasedTransport",{get:function(){return!0},enumerable:!0,configurable:!0}),t.prototype.sendObject=function(t){return this.client?(this.client.send(t),Promise.resolve(void 0)):Promise.reject("not connected")},t.prototype.send=function(t){return Promise.reject("not supported")},t.prototype.onMessage=function(t){return this.registry.add("onMessage",t)},t.prototype.onConnectedChanged=function(t){t(!0)},t.prototype.close=function(){return Promise.resolve()},t.prototype.open=function(){return Promise.resolve()},t.prototype.name=function(){return"in-memory"},t.prototype.reconnect=function(){return Promise.resolve()},t.prototype.messageHandler=function(t){this.registry.execute("onMessage",t)},t}(),x=function(){function t(t,e){var n=this;this.logger=e,this.registry=S(),this.worker=new SharedWorker(t),this.worker.port.onmessage=function(t){n.messageHandler(t.data)}}return Object.defineProperty(t.prototype,"isObjectBasedTransport",{get:function(){return!0},enumerable:!0,configurable:!0}),t.prototype.sendObject=function(t){return this.worker.port.postMessage(t),Promise.resolve()},t.prototype.send=function(t){return Promise.reject("not supported")},t.prototype.onMessage=function(t){return this.registry.add("onMessage",t)},t.prototype.onConnectedChanged=function(t){t(!0)},t.prototype.close=function(){return Promise.resolve()},t.prototype.open=function(){return Promise.resolve()},t.prototype.name=function(){return"shared-worker"},t.prototype.reconnect=function(){return Promise.resolve()},t.prototype.messageHandler=function(t){this.registry.execute("onMessage",t)},t}(),P=function(){function t(){}return t.getGDMajorVersion=function(){if("undefined"!=typeof window&&window.glueDesktop&&window.glueDesktop.version){var t=Number(window.glueDesktop.version.substr(0,1));return isNaN(t)?void 0:t}},t.isNode=function(){if(void 0!==t._isNode)return t._isNode;if("undefined"!=typeof window)return t._isNode=!1,!1;try{t._isNode="[object process]"===Object.prototype.toString.call(global.process)}catch(e){t._isNode=!1}return t._isNode},t}(),M=function(){function t(){var t=this;this.rejected=!1,this.resolved=!1,this.promise=new Promise((function(e,n){t.resolve=function(n){t.resolved=!0,e(n)},t.reject=function(e){t.rejected=!0,n(e)}}))}return t.delay=function(t){return new Promise((function(e){return setTimeout(e,t)}))},Object.defineProperty(t.prototype,"ended",{get:function(){return this.rejected||this.resolved},enumerable:!0,configurable:!0}),t}(),j=P.isNode()?require("ws"):window.WebSocket,E=function(){function t(t,e){if(this._running=!0,this._registry=S(),this.wsRequests=[],this.settings=t,this.logger=e,!this.settings.ws)throw new Error("ws is missing")}return t.prototype.onMessage=function(t){return this._registry.add("onMessage",t)},t.prototype.send=function(t,e){var n=this;return new Promise((function(e,i){n.waitForSocketConnection((function(){var o;try{null===(o=n.ws)||void 0===o||o.send(t),e()}catch(t){i(t)}}),i)}))},t.prototype.open=function(){var t=this;return this.logger.info("opening ws..."),this._running=!0,new Promise((function(e,n){t.waitForSocketConnection(e,n)}))},t.prototype.close=function(){return this._running=!1,this.ws&&this.ws.close(),Promise.resolve()},t.prototype.onConnectedChanged=function(t){return this._registry.add("onConnectedChanged",t)},t.prototype.name=function(){return"ws "+this.settings.ws},t.prototype.reconnect=function(){var t;null===(t=this.ws)||void 0===t||t.close();var e=new M;return this.waitForSocketConnection((function(){e.resolve()})),e.promise},t.prototype.waitForSocketConnection=function(t,e){var n;e=null!=e?e:function(){},this._running?1!==(null===(n=this.ws)||void 0===n?void 0:n.readyState)?(this.wsRequests.push({callback:t,failed:e}),this.wsRequests.length>1||this.openSocket()):t():e("wait for socket on "+this.settings.ws+" failed - socket closed by user")},t.prototype.openSocket=function(t,e){return i(this,void 0,void 0,(function(){var n=this;return o(this,(function(i){switch(i.label){case 0:if(void 0===t&&(t=this.settings.reconnectInterval),void 0!==e){if(0===e)return this.notifyForSocketState("wait for socket on "+this.settings.ws+" failed - no more retries left"),[2];this.logger.debug("will retry "+e+" more times (every "+t+" ms)")}i.label=1;case 1:return i.trys.push([1,3,,4]),[4,this.initiateSocket()];case 2:return i.sent(),this.notifyForSocketState(),[3,4];case 3:return i.sent(),setTimeout((function(){var i=void 0===e?void 0:e-1;n.openSocket(t,i)}),t),[3,4];case 4:return[2]}}))}))},t.prototype.initiateSocket=function(){var t=this,e=new M;return this.logger.debug("initiating ws to "+this.settings.ws+"..."),this.ws=new j(this.settings.ws||""),this.ws.onerror=function(n){var i="";try{i=JSON.stringify(n)}catch(t){var o=new WeakSet;i=JSON.stringify(n,(function(t,e){if("object"==typeof e&&null!==e){if(o.has(e))return;o.add(e)}return e}))}e.reject("error"),t.notifyStatusChanged(!1,i)},this.ws.onclose=function(n){t.logger.info("ws closed "+n),e.reject("closed"),t.notifyStatusChanged(!1)},this.ws.onopen=function(){var n;t.logger.info("ws opened "+(null===(n=t.settings.identity)||void 0===n?void 0:n.application)),e.resolve(),t.notifyStatusChanged(!0)},this.ws.onmessage=function(e){t._registry.execute("onMessage",e.data)},e.promise},t.prototype.notifyForSocketState=function(t){this.wsRequests.forEach((function(e){t?e.failed&&e.failed(t):e.callback()})),this.wsRequests=[]},t.prototype.notifyStatusChanged=function(t,e){this._registry.execute("onConnectedChanged",t,e)},t}();var O=1;var W,R,F,L={nextValue:function(){return(O=(9301*O+49297)%233280)/233280},seed:function(t){O=t}},N="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ_-";function D(){F=!1}function G(t){if(t){if(t!==W){if(t.length!==N.length)throw new Error("Custom alphabet for shortid must be "+N.length+" unique characters. You submitted "+t.length+" characters: "+t);var e=t.split("").filter((function(t,e,n){return e!==n.lastIndexOf(t)}));if(e.length)throw new Error("Custom alphabet for shortid must be "+N.length+" unique characters. These characters were not unique: "+e.join(", "));W=t,D()}}else W!==N&&(W=N,D())}function B(){return F||(F=function(){W||G(N);for(var t,e=W.split(""),n=[],i=L.nextValue();e.length>0;)i=L.nextValue(),t=Math.floor(i*e.length),n.push(e.splice(t,1)[0]);return n.join("")}())}var H={characters:function(t){return G(t),W},seed:function(t){L.seed(t),R!==t&&(D(),R=t)},lookup:function(t){return B()[t]},shuffled:B},q="object"==typeof window&&(window.crypto||window.msCrypto);var U=function(){if(!q||!q.getRandomValues)return 48&Math.floor(256*Math.random());var t=new Uint8Array(1);return q.getRandomValues(t),48&t[0]};var V=function(t,e){for(var n,i=0,o="";!n;)o+=t(e>>4*i&15|U()),n=e<Math.pow(16,i+1),i++;return o};var z=function(t){var e=H.shuffled();return{version:15&e.indexOf(t.substr(0,1)),worker:15&e.indexOf(t.substr(1,1))}};var J=function(t){if(!t||"string"!=typeof t||t.length<6)return!1;for(var e=H.characters(),n=t.length,i=0;i<n;i++)if(-1===e.indexOf(t[i]))return!1;return!0},K=function(t,e){return t(e={exports:{}},e.exports),e.exports}((function(t){var e,n,i=0;function o(){var t="",o=Math.floor(.001*(Date.now()-1459707606518));return o===n?e++:(e=0,n=o),t+=V(H.lookup,6),t+=V(H.lookup,i),e>0&&(t+=V(H.lookup,e)),t+=V(H.lookup,o)}t.exports=o,t.exports.generate=o,t.exports.seed=function(e){return H.seed(e),t.exports},t.exports.worker=function(e){return i=e,t.exports},t.exports.characters=function(t){return void 0!==t&&H.characters(t),H.shuffled()},t.exports.decode=z,t.exports.isValid=J})),Z=(K.generate,K.seed,K.worker,K.characters,K.decode,K.isValid,K);function Y(t,e,n,i,o){null==t&&(t="global"),i=i||["success"],o=o||["error"];var r,s=!1,a=!1,c=!1,u=S();e.disconnected((function(){c=!1,n.debug("connection is down"),s=!1,a=!0,u.execute("onLeft",{disconnected:!0})})),e.loggedIn((function(){c=!0,a&&(n.debug("connection is now up - trying to reconnect..."),p(r))})),e.on("success",(function(t){return f(t)})),e.on("error",(function(t){return h(t)})),e.on("result",(function(t){return f(t)})),i&&i.forEach((function(t){e.on(t,(function(t){return f(t)}))})),o&&o.forEach((function(t){e.on(t,(function(t){return h(t)}))}));var d={};function p(e){return r=e,new Promise((function(i,o){if(s)i();else{var r;if("global"===t)r=c?Promise.resolve({}):Promise.reject("not connected to gateway");else n.debug("joining domain "+t),r=y({type:"join",destination:t,domain:"global",options:e});r.then((function(){!function(){n.debug("did join "+t),s=!0;var e=a;a=!1,u.execute("onJoined",e)}(),i()})).catch((function(e){n.debug("error joining "+t+" domain: "+JSON.stringify(e)),o(e)}))}}))}function h(e){if(t===e.domain){var n=e.request_id;if(n){var i=d[n];i&&i.error(e)}}}function f(e){if(e.domain===t){var n=e.request_id;if(n){var i=d[n];i&&i.success(e)}}}function l(){return Z()}function y(i,o,r){r=r||{},i.request_id=i.request_id||l(),i.domain=i.domain||t,r.skipPeerId||(i.peer_id=e.peerId);var s=i.request_id;return new Promise((function(t,a){d[s]={success:function(e){delete d[s],e._tag=o,t(e)},error:function(t){n.warn("GW error - "+JSON.stringify(t)+" for request "+JSON.stringify(i)),delete d[s],t._tag=o,a(t)}},e.send(i,r).catch((function(t){d[s].error({err:t})}))}))}return{join:p,leave:function(){return"global"===t?Promise.resolve():(n.debug("stopping session "+t+"..."),a=!1,y({type:"leave",destination:t,domain:"global"}).then((function(){s=!1,u.execute("onLeft")})))},onJoined:function(t){return s&&t(!1),u.add("onJoined",t)},onLeft:function(t){return s||t(),u.add("onLeft",t)},send:y,sendFireAndForget:function(n){n.request_id=n.request_id?n.request_id:l(),n.domain=n.domain||t,n.peer_id=e.peerId,e.send(n)},on:function(i,o){e.on(i,(function(e){if(e.domain===t)try{o(e)}catch(t){n.error("Callback  failed: "+t+" \n "+t.stack+" \n msg was: "+JSON.stringify(e),t)}}))},loggedIn:function(t){return e.loggedIn(t)},connected:function(t){return e.connected(t)},disconnected:function(t){return e.disconnected(t)},get peerId(){return e.peerId},get domain(){return t}}}var X=function(){function t(t,e,n){var i=this;this.connection=t,this.settings=e,this.logger=n,this.protocolVersion=3,this.datePrefix="#T42_DATE#",this.datePrefixLen=this.datePrefix.length,this.dateMinLen=this.datePrefixLen+1,this.datePrefixFirstChar=this.datePrefix[0],this.registry=S(),this._isLoggedIn=!1,this.shouldTryLogin=!0,this.initialLogin=!0,this.initialLoginAttempts=3,this.sessions=[],t.disconnected((function(){i.handleDisconnected()})),this.ping()}return Object.defineProperty(t.prototype,"isLoggedIn",{get:function(){return this._isLoggedIn},enumerable:!0,configurable:!0}),t.prototype.processStringMessage=function(t){var e=this,n=JSON.parse(t,(function(t,n){if("string"!=typeof n)return n;if(n.length<e.dateMinLen)return n;if(n[0]!==e.datePrefixFirstChar)return n;if(n.substring(0,e.datePrefixLen)!==e.datePrefix)return n;try{var i=parseInt(n.substring(e.datePrefixLen,n.length),10);return isNaN(i)?n:new Date(i)}catch(t){return n}}));return{msg:n,msgType:n.type}},t.prototype.createStringMessage=function(t){var e=Date.prototype.toJSON;try{var n=this.datePrefix;return Date.prototype.toJSON=function(){return n+this.getTime()},JSON.stringify(t)}finally{Date.prototype.toJSON=e}},t.prototype.processObjectMessage=function(t){if(!t.type)throw new Error("Object should have type property");return{msg:t,msgType:t.type}},t.prototype.createObjectMessage=function(t){return t},t.prototype.login=function(t,e){return i(this,void 0,void 0,(function(){var n,i,r,s,a,c,u,d,p,h;return o(this,(function(o){switch(o.label){case 0:if(this.logger.debug("logging in..."),this.loginConfig=t,this.loginConfig||(this.loginConfig={username:"",password:""}),this.shouldTryLogin=!0,n={},this.connection.gatewayToken=t.gatewayToken,!t.gatewayToken)return[3,5];if(!e)return[3,4];o.label=1;case 1:return o.trys.push([1,3,,4]),[4,this.getNewGWToken()];case 2:return d=o.sent(),t.gatewayToken=d,[3,4];case 3:return i=o.sent(),this.logger.warn("failed to get GW token when reconnecting "+((null==i?void 0:i.message)||i)),[3,4];case 4:return n.method="gateway-token",n.token=t.gatewayToken,this.connection.gatewayToken=t.gatewayToken,[3,10];case 5:return"sspi"!==t.flowName?[3,9]:(n.provider="win",n.method="access-token",t.flowCallback&&t.sessionId?(r=n,[4,t.flowCallback(t.sessionId,null)]):[3,7]);case 6:return r.token=o.sent().data.toString("base64"),[3,8];case 7:throw new Error("Invalid SSPI config");case 8:return[3,10];case 9:if(t.token)n.method="access-token",n.token=t.token;else{if(!t.username)throw new Error("invalid auth message"+JSON.stringify(t));n.method="secret",n.login=t.username,n.secret=t.password}o.label=10;case 10:s={type:"hello",identity:this.settings.identity,authentication:n},t.sessionId&&(s.request_id=t.sessionId),this.globalDomain=Y("global",this.connection,this.logger.subLogger("global-domain"),["welcome","token","authentication-request"]),a={skipPeerId:!0},this.initialLogin&&(a.retryInterval=this.settings.reconnectInterval,a.maxRetries=this.settings.reconnectAttempts),o.label=11;case 11:o.trys.push([11,19,20,21]),c=void 0,o.label=12;case 12:return[4,this.globalDomain.send(s,void 0,a)];case 13:return"authentication-request"!==(u=o.sent()).type?[3,16]:(d=Buffer.from(u.authentication.token,"base64"),t.flowCallback&&t.sessionId?(p=s.authentication,[4,t.flowCallback(t.sessionId,d)]):[3,15]);case 14:p.token=o.sent().data.toString("base64"),o.label=15;case 15:return s.request_id=t.sessionId,[3,12];case 16:if("welcome"===u.type)return c=u,[3,18];throw"error"===u.type?new Error("Authentication failed: "+u.reason):new Error("Unexpected message type during authentication: "+u.type);case 17:return[3,12];case 18:return this.initialLogin=!1,this.logger.info("login successful with peerId "+c.peer_id),this.connection.peerId=c.peer_id,this.connection.resolvedIdentity=c.resolved_identity,this.connection.availableDomains=c.available_domains,c.options&&(this.connection.token=c.options.access_token,this.connection.info=c.options.info),this.setLoggedIn(!0),[2,c.resolved_identity];case 19:throw h=o.sent(),this.logger.error("error sending hello message - "+(h.message||h.msg||h.reason||h),h),h;case 20:return t&&t.flowCallback&&t.sessionId&&t.flowCallback(t.sessionId,null),[7];case 21:return[2]}}))}))},t.prototype.logout=function(){return i(this,void 0,void 0,(function(){var t;return o(this,(function(e){switch(e.label){case 0:return this.logger.debug("logging out..."),this.shouldTryLogin=!1,this.pingTimer&&clearTimeout(this.pingTimer),t=this.sessions.map((function(t){t.leave()})),[4,Promise.all(t)];case 1:return e.sent(),[2]}}))}))},t.prototype.loggedIn=function(t){return this._isLoggedIn&&t(),this.registry.add("onLoggedIn",t)},t.prototype.domain=function(t,e,n,i){var o=this.sessions.filter((function(e){return e.domain===t}))[0];return o||(o=Y(t,this.connection,e,n,i),this.sessions.push(o)),o},t.prototype.handleDisconnected=function(){var t=this;if(this.setLoggedIn(!1),this.shouldTryLogin&&this.initialLogin){if(this.initialLoginAttempts<=0)return;this.initialLoginAttempts--}if(this.logger.debug("disconnected - will try new login?"+this.shouldTryLogin),this.shouldTryLogin){if(!this.loginConfig)throw new Error("no login info");this.connection.login(this.loginConfig,!0).catch((function(){setTimeout(t.handleDisconnected,1e3)}))}},t.prototype.setLoggedIn=function(t){this._isLoggedIn=t,this._isLoggedIn&&this.registry.execute("onLoggedIn")},t.prototype.ping=function(){var t=this;this.shouldTryLogin&&(this._isLoggedIn&&this.connection.send({type:"ping"}),this.pingTimer=setTimeout((function(){t.ping()}),3e4))},t.prototype.authToken=function(){return this.globalDomain?this.globalDomain.send({type:"create-token"}).then((function(t){return t.token})):Promise.reject(new Error("no global domain session"))},t.prototype.getNewGWToken=function(){if(void 0!==typeof window){var t=window.glue42gd;if(t)return t.getGWToken()}return Promise.reject(new Error("not running in GD"))},t}(),Q=function(){function t(t){this.specsNames=[],this.messages={},this.subs={},this.subsRefCount={},this.specs={};for(var e=0,n=t;e<n.length;e++){var i=n[e];this.specs[i.name]=i,this.specsNames.push(i.name)}}return t.prototype.init=function(t){var e=this;this.connection=t;for(var n=0,i=this.specsNames;n<i.length;n++)for(var o=i[n],r=function(n){var i=s.subsRefCount[n];if(i||(i=0),i+=1,s.subsRefCount[n]=i,i>1)return"continue";var o=t.on(n,(function(t){return e.processMessage(n,t)}));s.subs[n]=o},s=this,a=0,c=this.specs[o].types;a<c.length;a++){r(c[a])}},t.prototype.processMessage=function(t,e){if(!this.isDone&&e)for(var n=0,i=this.specsNames;n<i.length;n++){var o=i[n];if(-1!==this.specs[o].types.indexOf(t)){var r=this.messages[o]||[];this.messages[o]=r,r.push(e)}}},t.prototype.drain=function(t,e){var n;e&&(this.messages[t]||[]).forEach(e),delete this.messages[t];for(var i=0,o=this.specs[t].types;i<o.length;i++){var r=o[i];this.subsRefCount[r]-=1,this.subsRefCount[r]<=0&&(null===(n=this.connection)||void 0===n||n.off(this.subs[r]),delete this.subs[r],delete this.subsRefCount[r])}delete this.specs[t],this.specs.length||(this.isDone=!0)},t}(),$=function(){function t(t,e){if(this.settings=t,this.logger=e,this.messageHandlers={},this.ids=1,this.registry=S(),this._connected=!1,this.isTrace=!1,(t=t||{}).reconnectAttempts=t.reconnectAttempts||10,t.reconnectInterval=t.reconnectInterval||1e3,t.inproc)this.transport=new k(t.inproc,e.subLogger("inMemory"));else if(t.sharedWorker)this.transport=new x(t.sharedWorker,e.subLogger("shared-worker"));else{if(void 0===t.ws)throw new Error("No connection information specified");this.transport=new E(t,e.subLogger("ws"))}this.isTrace=e.canPublish("trace"),e.info("starting with "+this.transport.name()+" transport"),this.protocol=new X(this,t,e.subLogger("protocol")),this.transport.onConnectedChanged(this.handleConnectionChanged.bind(this)),this.transport.onMessage(this.handleTransportMessage.bind(this)),t.replaySpecs&&t.replaySpecs.length&&(this.replayer=new Q(t.replaySpecs),this.replayer.init(this))}return Object.defineProperty(t.prototype,"protocolVersion",{get:function(){var t;return null===(t=this.protocol)||void 0===t?void 0:t.protocolVersion},enumerable:!0,configurable:!0}),t.prototype.send=function(t,e){if(this.transport.sendObject&&this.transport.isObjectBasedTransport){var n=this.protocol.createObjectMessage(t);return this.isTrace&&this.logger.trace(">> "+JSON.stringify(n)),this.transport.sendObject(n,e)}var i=this.protocol.createStringMessage(t);return this.isTrace&&this.logger.trace(">> "+i),this.transport.send(i,e)},t.prototype.on=function(t,e){t=t.toLowerCase(),void 0===this.messageHandlers[t]&&(this.messageHandlers[t]={});var n=this.ids++;return this.messageHandlers[t][n]=e,{type:t,id:n}},t.prototype.off=function(t){delete this.messageHandlers[t.type.toLowerCase()][t.id]},Object.defineProperty(t.prototype,"isConnected",{get:function(){return this.protocol.isLoggedIn},enumerable:!0,configurable:!0}),t.prototype.connected=function(t){var e=this;return this.protocol.loggedIn((function(){t(e.settings.ws||e.settings.sharedWorker||"")}))},t.prototype.disconnected=function(t){return this.registry.add("disconnected",t)},t.prototype.login=function(t,e){return i(this,void 0,void 0,(function(){return o(this,(function(n){switch(n.label){case 0:return[4,this.transport.open()];case 1:return n.sent(),[2,this.protocol.login(t,e)]}}))}))},t.prototype.logout=function(){return i(this,void 0,void 0,(function(){return o(this,(function(t){switch(t.label){case 0:return[4,this.protocol.logout()];case 1:return t.sent(),[4,this.transport.close()];case 2:return t.sent(),[2]}}))}))},t.prototype.loggedIn=function(t){return this.protocol.loggedIn(t)},t.prototype.domain=function(t,e,n){return this.protocol.domain(t,this.logger.subLogger("domain="+t),e,n)},t.prototype.authToken=function(){return this.protocol.authToken()},t.prototype.reconnect=function(){return this.transport.reconnect()},t.prototype.distributeMessage=function(t,e){var n=this,i=this.messageHandlers[e.toLowerCase()];void 0!==i&&Object.keys(i).forEach((function(e){var o=i[e];if(void 0!==o)try{o(t)}catch(t){n.logger.error("Message handler failed with "+t.stack,t)}}))},t.prototype.handleConnectionChanged=function(t){this._connected!==t&&(this._connected=t,t?this.registry.execute("connected"):this.registry.execute("disconnected"))},t.prototype.handleTransportMessage=function(t){var e;e="string"==typeof t?this.protocol.processStringMessage(t):this.protocol.processObjectMessage(t),this.isTrace&&this.logger.trace("<< "+JSON.stringify(e)),this.distributeMessage(e.msg,e.msgType)},t}(),tt=["trace","debug","info","warn","error","off"],et=function(){function t(t,e,n){this.name=t,this.parent=e,this.subLoggers=[],this.logFn=console,this.customLogFn=!1,this.name=t,this.path=e?e.path+"."+t:t,this.loggerFullName="["+this.path+"]",this.includeTimeAndLevel=!n,n&&(this.logFn=n,this.customLogFn=!0)}return t.prototype.subLogger=function(e){var n=this.subLoggers.filter((function(t){return t.name===e}))[0];if(void 0!==n)return n;Object.keys(this).forEach((function(t){if(t===e)throw new Error("This sub logger name is not allowed.")}));var i=new t(e,this,this.customLogFn?this.logFn:void 0);return this.subLoggers.push(i),i},t.prototype.publishLevel=function(t){var e;return t&&(this._publishLevel=t),this._publishLevel||(null===(e=this.parent)||void 0===e?void 0:e.publishLevel())},t.prototype.consoleLevel=function(t){var e;return t&&(this._consoleLevel=t),this._consoleLevel||(null===(e=this.parent)||void 0===e?void 0:e.consoleLevel())},t.prototype.log=function(t,e,n){this.publishMessage(e||"info",t,n)},t.prototype.trace=function(t){this.log(t,"trace")},t.prototype.debug=function(t){this.log(t,"debug")},t.prototype.info=function(t){this.log(t,"info")},t.prototype.warn=function(t){this.log(t,"warn")},t.prototype.error=function(t,e){this.log(t,"error")},t.prototype.canPublish=function(t,e){return tt.indexOf(t)>=tt.indexOf(e||this.consoleLevel()||"trace")},t.prototype.publishMessage=function(e,n,i){var o,r,s=this.loggerFullName;if("error"===e&&!i){var a=new Error;a.stack&&(n=n+"\n"+a.stack.split("\n").slice(3).join("\n"))}if(this.canPublish(e,this.publishLevel())&&(null===(o=t.Interop)||void 0===o?void 0:o.methods({name:t.InteropMethodName}).length)>0&&(null===(r=t.Interop)||void 0===r||r.invoke(t.InteropMethodName,{msg:""+n,logger:s,level:e})),this.canPublish(e)){var c="";if(this.includeTimeAndLevel){var u=new Date;c="["+(u.getHours()+":"+u.getMinutes()+":"+u.getSeconds()+":"+u.getMilliseconds())+"] ["+e+"] "}var d=""+c+s+": "+n;switch(e){case"trace":this.logFn.debug(d);break;case"debug":this.logFn.debug?this.logFn.debug(d):this.logFn.log(d);break;case"info":this.logFn.info(d);break;case"warn":this.logFn.warn(d);break;case"error":this.logFn.error(d,i)}}},t.InteropMethodName="T42.AppLogger.Log",t}(),nt={get name(){return"context"},get types(){return["create-context","created","destroyed","context-created","context-added","subscribe-context","subscribed-context","unsubscribe-context","destroy-context","context-destroyed","update-context","context-updated","joined"]}};function it(t,e,n){var i,o,r,s,a;if(P.isNode()){var c=process.env._GD_STARTING_CONTEXT_;if(c)try{a=JSON.parse(c)}catch(t){}}var u=function(){var i,o,r,s,c,u,d,p,h,f=t.gateway,l=null!==(i=null==f?void 0:f.protocolVersion)&&void 0!==i?i:3,y=null==f?void 0:f.reconnectInterval,g=null==f?void 0:f.reconnectAttempts,v=null==f?void 0:f.ws,m=null==f?void 0:f.sharedWorker,w=null==f?void 0:f.inproc;n&&(v=n.gwURL),P.isNode()&&a&&a.gwURL&&(v=a.gwURL),v||m||w||(v="ws://localhost:8385");var b=function(){if(t.application)return t.application;if(n)return n.applicationName;var e=Z();if(P.isNode())return a?a.applicationConfig.name:"NodeJS"+e;if("undefined"!=typeof window&&"undefined"!=typeof document)return document.title+" ("+e+")";return e}(),_=b;void 0!==n?(u=n.windowId,d=n.pid,n.env&&(p=n.env.env,h=n.env.region),_=null!==(o=n.application)&&void 0!==o?o:"glue-app",c=n.appInstanceId):P.isNode()?(d=process.pid,a&&(p=a.env,h=a.region,c=a.instanceId)):u=window.name||Z();var I=null!==(s=null===(r=t.gateway)||void 0===r?void 0:r.replaySpecs)&&void 0!==s?s:[];return I.push(nt),{identity:{application:_,applicationName:b,windowId:u,instance:c,process:d,region:h,environment:p,api:e.version||"5.0.7"},reconnectInterval:y,ws:v,sharedWorker:m,inproc:w,protocolVersion:l,reconnectAttempts:g,replaySpecs:I}}();return{bus:null!==(i=t.bus)&&void 0!==i&&i,auth:function(){var e,n;return"string"==typeof t.auth?{token:t.auth}:t.auth?t.auth:P.isNode()&&a&&a.gwToken?{gatewayToken:a.gwToken}:(null===(e=t.gateway)||void 0===e?void 0:e.inproc)||(null===(n=t.gateway)||void 0===n?void 0:n.sharedWorker)?{username:"glue42",password:"glue42"}:void 0}(),logger:function(){var e,n,i=t.logger;return i||(i="error"),"string"==typeof i?{console:i,publish:"error"}:{console:null!==(e=i.console)&&void 0!==e?e:"error",publish:null!==(n=i.publish)&&void 0!==n?n:"error"}}(),connection:u,metrics:null===(o=t.metrics)||void 0===o||o,contexts:null===(r=t.contexts)||void 0===r||r,version:e.version||"5.0.7",libs:null!==(s=e.libs)&&void 0!==s?s:[],customLogger:t.customLogger}}function ot(){function t(){return(new Date).getTime()}var e,n,i=t();return{get startTime(){return i},get endTime(){return e},get period(){return n},stop:function(){return e=t(),n=t()-i}}}var rt=function(){function t(t,e,n,i){this.updateCallbacks={},this.contextId=t,this.name=e,this.isAnnounced=n,this.activityId=i,this.context={}}return t.prototype.hasCallbacks=function(){return Object.keys(this.updateCallbacks).length>0},t.prototype.getState=function(){return this.isAnnounced&&this.hasCallbacks()?3:this.isAnnounced?2:this.hasCallbacks()?1:0},t}();function st(t,e){if(e){if(e.reset)return t=n({},e.reset);t=at(t,void 0);var i=e.added,o=e.updated,r=e.removed;i&&Object.keys(i).forEach((function(e){t[e]=i[e]})),o&&Object.keys(o).forEach((function(e){ct(e,t,o)})),r&&r.forEach((function(e){delete t[e]}))}return t}function at(t,e){if(e=e||new WeakMap,Object(t)!==t)return t;if(t instanceof Set)return new Set(t);if(e.has(t))return e.get(t);var n=t instanceof Date?new Date(t):t instanceof RegExp?new RegExp(t.source,t.flags):t.constructor?new t.constructor:Object.create(null);return e.set(t,n),Object.assign.apply(Object,r([n],Object.keys(t).map((function(n){var i;return(i={})[n]=at(t[n],e),i}))))}var ct=function(t,e,n){var i=n[t];if(void 0===i)return e;var o=e[t];return o&&i?"string"==typeof o||"number"==typeof o||"boolean"==typeof o||"string"==typeof i||"number"==typeof i||"boolean"==typeof i||Array.isArray(o)||Array.isArray(i)?(e[t]=i,e):(e[t]=Object.assign({},o,i),e):(e[t]=i,e)};function ut(t,e){if(t===e)return!0;if(!(t instanceof Object&&e instanceof Object))return!1;if(t.constructor!==e.constructor)return!1;for(var n in t)if(t.hasOwnProperty(n)){if(!e.hasOwnProperty(n))return!1;if(t[n]!==e[n]){if("object"!=typeof t[n])return!1;if(!ut(t[n],e[n]))return!1}}for(var n in e)if(e.hasOwnProperty(n)&&!t.hasOwnProperty(n))return!1;return!0}var dt,pt=function(){function t(t){var e,n=this;this._contextNameToData={},this._gw3Subscriptions=[],this._nextCallbackSubscriptionNumber=0,this._contextNameToId={},this._contextIdToName={},this._connection=t.connection,this._logger=t.logger,this._gw3Session=this._connection.domain("global",["context-created","subscribed-context","context-destroyed","context-updated"]),this.subscribeToContextCreatedMessages(),this.subscribeToContextUpdatedMessages(),this.subscribeToContextDestroyedMessages(),null===(e=this._connection.replayer)||void 0===e||e.drain(nt.name,(function(t){var e=t.type;e&&("context-created"===e||"context-added"===e||"created"===e?n.handleContextCreatedMessage(t):"subscribed-context"===e||"context-updated"===e||"joined"===e?n.handleContextUpdatedMessage(t):"context-destroyed"!==e&&"destroyed"!==e||n.handleContextDestroyedMessage(t))}))}return t.prototype.dispose=function(){for(var t=0,e=this._gw3Subscriptions;t<e.length;t++){var n=e[t];this._connection.off(n)}for(var i in this._gw3Subscriptions.length=0,this._contextNameToData)this._contextNameToId.hasOwnProperty(i)&&delete this._contextNameToData[i]},t.prototype.createContext=function(t,e){var n=this;return this._gw3Session.send({type:"create-context",domain:"global",name:t,data:e,lifetime:"retained"}).then((function(i){if(n._contextNameToId[t]=i.context_id,!n._contextIdToName[i.context_id]){n._contextIdToName[i.context_id]=t;var o=n._contextNameToData[t]||new rt(i.context_id,t,!0,void 0);return o.isAnnounced=!0,o.name=t,o.contextId=i.context_id,n._contextNameToData[t]=o,o.context=i.data,o.sentExplicitSubscription=!0,o.context&&n.invokeUpdateCallbacks(o,o.context,void 0),n.update(t,e).then((function(){return i.context_id}))}return i.context_id}))},t.prototype.all=function(){var t=this;return Object.keys(this._contextNameToData).filter((function(e){return t._contextNameToData[e].isAnnounced}))},t.prototype.update=function(t,e){return i(this,void 0,void 0,(function(){var n,i,r,s=this;return o(this,(function(o){switch(o.label){case 0:return(n=this._contextNameToData[t])&&n.isAnnounced?(i=n.context,n.hasCallbacks()?[3,2]:[4,this.get(n.name,!1)]):[2,this.createContext(t,e)];case 1:i=o.sent(),o.label=2;case 2:return r=this.calculateContextDelta(i,e),Object.keys(r.added).length||Object.keys(r.updated).length||r.removed.length?[2,this._gw3Session.send({type:"update-context",domain:"global",context_id:n.contextId,delta:r},{},{skipPeerId:!1}).then((function(t){s.handleUpdated(n,r,{updaterId:t.peer_id})}))]:[2,Promise.resolve()]}}))}))},t.prototype.set=function(t,e){var n=this,i=this._contextNameToData[t];return i&&i.isAnnounced?this._gw3Session.send({type:"update-context",domain:"global",context_id:i.contextId,delta:{reset:e}},{},{skipPeerId:!1}).then((function(t){n.handleUpdated(i,{reset:e,added:{},removed:[],updated:{}},{updaterId:t.peer_id})})):this.createContext(t,e)},t.prototype.get=function(t,e){var n=this;void 0===e&&(e=!0);var r=this._contextNameToData[t];return r&&r.isAnnounced&&r.hasCallbacks()||e?Promise.resolve(r&&r.context):new Promise((function(e,r){return i(n,void 0,void 0,(function(){var n=this;return o(this,(function(i){return this.subscribe(t,(function(t,i,o,r){n.unsubscribe(r),e(t)})),[2]}))}))}))},t.prototype.subscribe=function(t,e){var n=this._nextCallbackSubscriptionNumber;this._nextCallbackSubscriptionNumber+=1;var i=this._contextNameToData[t];if(!i||!i.isAnnounced)return i=i||new rt(void 0,t,!1,void 0),this._contextNameToData[t]=i,i.updateCallbacks[n]=e,Promise.resolve(n);var o=i.hasCallbacks();return i.updateCallbacks[n]=e,o||i.joinedActivity||i.context&&i.sentExplicitSubscription?(e(i.context,i.context,[],n),Promise.resolve(n)):this.sendSubscribe(i).then((function(){return n}))},t.prototype.unsubscribe=function(t){for(var e=0,n=Object.keys(this._contextNameToData);e<n.length;e++){var i=n[e],o=(this._contextNameToId[i],this._contextNameToData[i]);if(!o)return;var r=o.hasCallbacks();delete o.updateCallbacks[t],o.isAnnounced&&r&&!o.hasCallbacks()&&o.sentExplicitSubscription&&this.sendUnsubscribe(o),o.isAnnounced||o.hasCallbacks()||delete this._contextNameToData[i]}},t.prototype.handleUpdated=function(t,e,n){var i=t.context;t.context=st(t.context,e),this._contextNameToData[t.name]!==t||ut(i,t.context)||this.invokeUpdateCallbacks(t,t.context,e,n)},t.prototype.subscribeToContextCreatedMessages=function(){for(var t=0,e=["context-added","context-created","created"];t<e.length;t++){var n=e[t],i=this._connection.on(n,this.handleContextCreatedMessage.bind(this));this._gw3Subscriptions.push(i)}},t.prototype.handleContextCreatedMessage=function(t){var e=t.type;"created"===e?(this._contextNameToId[t.activity_id]=t.context_id,this._contextIdToName[t.context_id]=t.activity_id):"context-added"===e&&(this._contextNameToId[t.name]=t.context_id,this._contextIdToName[t.context_id]=t.name);var n=this._contextIdToName[t.context_id];if(!n)throw new Error("Received created event for context with unknown name: "+t.context_id);if(!this._contextNameToId[n])throw new Error("Received created event for context with unknown id: "+t.context_id);var i=this._contextNameToData[n];if(i){if(i.isAnnounced)return;if(!i.hasCallbacks())throw new Error("Assertion failure: contextData.hasCallbacks()");i.isAnnounced=!0,i.contextId=t.context_id,i.activityId=t.activity_id,i.sentExplicitSubscription||this.sendSubscribe(i)}else this._contextNameToData[n]=i=new rt(t.context_id,n,!0,t.activity_id)},t.prototype.subscribeToContextUpdatedMessages=function(){for(var t=0,e=["context-updated","subscribed-context","joined"];t<e.length;t++){var n=e[t],i=this._connection.on(n,this.handleContextUpdatedMessage.bind(this));this._gw3Subscriptions.push(i)}},t.prototype.handleContextUpdatedMessage=function(t){var e=t.type,n=t.context_id,i=this._contextNameToData[this._contextIdToName[n]],o=!i||!i.isAnnounced;if("joined"===e)i?(i.contextId=n,i.isAnnounced=!0,i.activityId=t.activity_id):(i=new rt(n,t.activity_id,!0,t.activity_id),this._contextNameToData[t.activity_id]=i,this._contextIdToName[n]=t.activity_id,this._contextNameToId[t.activity_id]=n),i.joinedActivity=!0;else if(!i||!i.isAnnounced)return void("subscribed-context"===e?((i=i||new rt(n,t.name,!0,void 0)).sentExplicitSubscription=!0,this._contextNameToData[t.name]=i,this._contextIdToName[n]=t.name,this._contextNameToId[t.name]=n):this._logger.error("Received 'update' for unknown context: "+n));var r=i.context;if("subscribed-context"===e)i.context=t.data||{};else if("joined"===e)i.context=t.context_snapshot||{};else{if("context-updated"!==e)throw new Error("Unrecognized context update message "+e);i.context=st(i.context,t.delta)}!o&&ut(i.context,r)&&"subscribed-context"!==e||this.invokeUpdateCallbacks(i,i.context,t.delta,{updaterId:t.updater_id})},t.prototype.invokeUpdateCallbacks=function(t,e,n,i){for(var o in n=n||{added:{},updated:{},reset:{},removed:[]},t.updateCallbacks)if(t.updateCallbacks.hasOwnProperty(o))try{(0,t.updateCallbacks[o])(at(e),Object.assign({},n.added||{},n.updated||{},n.reset||{}),n.removed,parseInt(o,10),i)}catch(t){this._logger.debug("callback error: "+JSON.stringify(t))}},t.prototype.subscribeToContextDestroyedMessages=function(){for(var t=0,e=["context-destroyed","destroyed"];t<e.length;t++){var n=e[t],i=this._connection.on(n,this.handleContextDestroyedMessage.bind(this));this._gw3Subscriptions.push(i)}},t.prototype.handleContextDestroyedMessage=function(t){var e,n;if("destroyed"===t.type){if(n=t.activity_id,!(e=this._contextNameToId[n]))return void this._logger.error("Received 'destroyed' for unknown activity: "+t.activity_id)}else if(e=t.context_id,!(n=this._contextIdToName[e]))return void this._logger.error("Received 'destroyed' for unknown context: "+t.context_id);delete this._contextIdToName[e],delete this._contextNameToId[n];var i=this._contextNameToData[n];delete this._contextNameToData[n],i&&i.isAnnounced||this._logger.error("Received 'destroyed' for unknown context: "+e)},t.prototype.sendSubscribe=function(t){return t.sentExplicitSubscription=!0,this._gw3Session.send({type:"subscribe-context",domain:"global",context_id:t.contextId}).then((function(t){}))},t.prototype.sendUnsubscribe=function(t){return t.sentExplicitSubscription=!1,this._gw3Session.send({type:"unsubscribe-context",domain:"global",context_id:t.contextId}).then((function(t){}))},t.prototype.calculateContextDelta=function(t,e){var n={added:{},updated:{},removed:[],reset:void 0};if(t)for(var i=0,o=Object.keys(t);i<o.length;i++){var r=o[i];-1===Object.keys(e).indexOf(r)||null===e[r]||ut(t[r],e[r])||(n.updated[r]=e[r])}for(var s=0,a=Object.keys(e);s<a.length;s++){r=a[s];t&&-1!==Object.keys(t).indexOf(r)?null===e[r]&&n.removed.push(r):null!==e[r]&&(n.added[r]=e[r])}return n},t}(),ht=function(){function t(t){this._bridge=new pt(t)}return t.prototype.all=function(){return this._bridge.all()},t.prototype.update=function(t,e){return this.checkName(t),this._bridge.update(t,e)},t.prototype.set=function(t,e){return this.checkName(t),this._bridge.set(t,e)},t.prototype.subscribe=function(t,e){var n=this;return this.checkName(t),this._bridge.subscribe(t,(function(t,i,o,r,s){return e(t,i,o,(function(){return n._bridge.unsubscribe(r)}),s)})).then((function(t){return function(){n._bridge.unsubscribe(t)}}))},t.prototype.get=function(t,e){return void 0===e&&(e=!0),this._bridge.get(t,e)},t.prototype.ready=function(){return Promise.resolve(this)},t.prototype.checkName=function(t){if("string"!=typeof t||""===t)throw new Error("'name' must be non-empty string, got '"+t+"'")},t}();function ft(t,e,n){return"function"!=typeof e&&"function"!=typeof n?t:("function"!=typeof e?e=function(){}:"function"!=typeof n&&(n=function(){}),t.then(e,n))}function lt(t,e){return void 0===t&&(t=0),new Promise((function(n,i){return setTimeout((function(){return i(e)}),t)}))}!function(t){t[t.Success=0]="Success",t[t.Error=1]="Error"}(dt||(dt={}));var yt=function(){function t(t,e,n,i){this.protocol=t,this.repo=e,this.instance=n,this.configuration=i}return t.prototype.subscribe=function(t,e,n,i,o){var r=this,s=function(t,n,i,s){var a;e.methodResponseTimeout=null!==(a=e.methodResponseTimeout)&&void 0!==a?a:e.waitTimeoutMs,r.protocol.client.subscribe(n,e,t,i,s,o)};return ft(new Promise((function(n,i){var o,a=function(t){n(t)},c=function(t){i(t)};if(t)if((o="string"==typeof t?{name:t}:t).name){void 0===e&&(e={});var u=e.target;if(void 0===u&&(u="best"),"string"!=typeof u||"all"===u||"best"===u){void 0===e.methodResponseTimeout&&(e.methodResponseTimeout=e.method_response_timeout,void 0===e.methodResponseTimeout&&(e.methodResponseTimeout=r.configuration.methodResponseTimeout)),void 0===e.waitTimeoutMs&&(e.waitTimeoutMs=e.wait_for_method_timeout,void 0===e.waitTimeoutMs&&(e.waitTimeoutMs=r.configuration.waitTimeoutMs));var d=0,p=r.getServerMethodsByFilterAndTarget(o,u);if(p.length>0)s(p,p[0].methods[0],a,c);else{var h=function(){if(u&&e.waitTimeoutMs)if(d+=500,(p=r.getServerMethodsByFilterAndTarget(o,u)).length>0){var n=p[0].methods[0];s(p,n,a,c)}else if(d>=e.waitTimeoutMs){s(p,"string"==typeof t?{name:t}:t,a,c)}else setTimeout(h,500)};setTimeout(h,500)}}else i(new Error('"'+u+'" is not a valid target. Valid targets are "all", "best", or an instance.'))}else i("Method definition is required. Please, provide either a unique string for a method name or a “methodDefinition” object with a required “name” property.");else i("Method definition is required. Please, provide either a unique string for a method name or a “methodDefinition” object with a required “name” property.")})),n,i)},t.prototype.servers=function(t){var e=void 0===t?void 0:n({},t);return this.getServers(e).map((function(t){return t.server.instance}))},t.prototype.methods=function(t){return t="string"==typeof t?{name:t}:n({},t),this.getMethods(t)},t.prototype.methodsForInstance=function(t){return this.getMethodsForInstance(t)},t.prototype.methodAdded=function(t){return this.repo.onMethodAdded(t)},t.prototype.methodRemoved=function(t){return this.repo.onMethodRemoved(t)},t.prototype.serverAdded=function(t){return this.repo.onServerAdded(t)},t.prototype.serverRemoved=function(t){return this.repo.onServerRemoved((function(e,n){t(e,n)}))},t.prototype.serverMethodAdded=function(t){return this.repo.onServerMethodAdded((function(e,n){t({server:e,method:n})}))},t.prototype.serverMethodRemoved=function(t){return this.repo.onServerMethodRemoved((function(e,n){t({server:e,method:n})}))},t.prototype.invoke=function(t,e,r,s,a,c){return i(this,void 0,void 0,(function(){var u=this;return o(this,(function(d){return[2,ft(function(){return i(u,void 0,void 0,(function(){var i,a,c,u,d,p,h,f,l,y,g=this;return o(this,(function(o){switch(o.label){case 0:if(!(i="string"==typeof t?{name:t}:n({},t)).name)return[2,Promise.reject("Method definition is required. Please, provide either a unique string for a method name or a “methodDefinition” object with a required “name” property.")];if(e||(e={}),r||(r="best"),"string"==typeof r&&"all"!==r&&"best"!==r&&"skipMine"!==r)return[2,Promise.reject(new Error('"'+r+'" is not a valid target. Valid targets are "all" and "best".'))];if(s||(s={}),void 0===s.methodResponseTimeoutMs&&(s.methodResponseTimeoutMs=s.method_response_timeout,void 0===s.methodResponseTimeoutMs&&(s.methodResponseTimeoutMs=this.configuration.methodResponseTimeout)),void 0===s.waitTimeoutMs&&(s.waitTimeoutMs=s.wait_for_method_timeout,void 0===s.waitTimeoutMs&&(s.waitTimeoutMs=this.configuration.waitTimeoutMs)),void 0!==s.waitTimeoutMs&&"number"!=typeof s.waitTimeoutMs)return[2,Promise.reject(new Error('"'+s.waitTimeoutMs+'" is not a valid number for "waitTimeoutMs" '))];if("object"!=typeof e)return[2,Promise.reject(new Error("The method arguments must be an object. method: "+i.name))];if(0!==(a=this.getServerMethodsByFilterAndTarget(i,r)).length)return[3,4];o.label=1;case 1:return o.trys.push([1,3,,4]),[4,this.tryToAwaitForMethods(i,r,s)];case 2:return a=o.sent(),[3,4];case 3:return o.sent(),c=n(n({},i),{getServers:function(){return[]},supportsStreaming:!1,objectTypes:null!==(y=i.objectTypes)&&void 0!==y?y:[]}),u={method:c,called_with:e,message:"Can not find a method matching "+JSON.stringify(t)+" with server filter "+JSON.stringify(r),executed_by:void 0,returned:void 0,status:void 0},[2,Promise.reject(u)];case 4:return d=s.methodResponseTimeoutMs,p=s,h=a.map((function(t){var n=Z(),i=g.protocol.client.invoke(n,t.methods[0],e,t.server,p);return Promise.race([i,lt(d,{invocationId:n,message:"Invocation timeout ("+d+" ms) reached",status:dt.Error})])})),[4,Promise.all(h)];case 5:return f=o.sent(),l=this.getInvocationResultObj(f,i,e),f.every((function(t){return t.status===dt.Error}))?[2,Promise.reject(l)]:[2,l]}}))}))}(),a,c)]}))}))},t.prototype.getInvocationResultObj=function(t,e,n){var i=t.filter((function(t){return t.status===dt.Success})).reduce((function(t,i){return t=r(t,[{executed_by:i.instance,returned:i.result,called_with:n,method:e,message:i.message,status:i.status}])}),[]),o=t.filter((function(t){return t.status===dt.Error})).reduce((function(t,i){return t=r(t,[{executed_by:i.instance,called_with:n,name:e.name,message:i.message}])}),[]),s=t[0];return{method:e,called_with:n,returned:s.result,executed_by:s.instance,all_return_values:i,all_errors:o,message:s.message,status:s.status}},t.prototype.tryToAwaitForMethods=function(t,e,n){var i=this;return new Promise((function(o,r){if(0!==n.waitTimeoutMs)var s=0,a=setInterval((function(){s+=500;var c=i.getServerMethodsByFilterAndTarget(t,e);if(c.length>0)clearInterval(a),o(c);else if(s>=(n.waitTimeoutMs||1e4))return clearInterval(a),void r()}),500);else r()}))},t.prototype.filterByTarget=function(t,e){var n=this;if("string"!=typeof t){return(Array.isArray(t)?t:[t]).reduce((function(t,i){var o=e.filter((function(t){return n.instanceMatch(i,t.server.instance)}));return t.concat(o)}),[])}if("all"===t)return r(e);if("best"===t){var i=e.find((function(t){return t.server.instance.isLocal}));if(i)return[i];if(void 0!==e[0])return[e[0]]}else if("skipMine"===t)return e.filter((function(t){return t.server.instance.peerId!==n.instance.peerId}));return[]},t.prototype.instanceMatch=function(t,e){return this.containsProps(t,e)},t.prototype.methodMatch=function(t,e){return this.containsProps(t,e)},t.prototype.containsProps=function(t,e){return Object.keys(t).filter((function(e){return void 0!==t[e]&&"function"!=typeof t[e]&&"object_types"!==e&&"display_name"!==e&&"id"!==e&&"gatewayId"!==e&&"identifier"!==e&&"_"!==e[0]})).reduce((function(n,i){var o=t[i],r=e[i];if("objectTypes"===i){(o.length>r.length||!1===function(t,e){var n=t.reduce((function(t,e){return t[e]=!1,t}),{});e.forEach((function(t){void 0!==n[t]&&(n[t]=!0)}));return Object.keys(n).reduce((function(t,e){return n[e]||(t=!1),t}),!0)}(o,r))&&(n=!1)}else String(o).toLowerCase()!==String(r).toLowerCase()&&(n=!1);return n}),!0)},t.prototype.getMethods=function(t){var e=this;return void 0===t?this.repo.getMethods():this.repo.getMethods().filter((function(n){return e.methodMatch(t,n)}))},t.prototype.getMethodsForInstance=function(t){var e=this,n=this.repo.getServers().filter((function(n){return e.instanceMatch(t,n.instance)}));if(0===n.length)return[];var i={};return 1===n.length?i=n[0].methods:n.forEach((function(t){Object.keys(t.methods).forEach((function(e){var n=t.methods[e];i[n.identifier]=n}))})),Object.keys(i).map((function(t){return i[t]}))},t.prototype.getServers=function(t){var e=this,n=this.repo.getServers();return void 0===t?n.map((function(t){return{server:t,methods:[]}})):n.reduce((function(n,i){var o=e.repo.getServerMethodsById(i.id).filter((function(n){return e.methodMatch(t,n)}));return o.length>0&&n.push({server:i,methods:o}),n}),[])},t.prototype.getServerMethodsByFilterAndTarget=function(t,e){var n=this.getServers(t);return this.filterByTarget(e,n)},t}(),gt=function(){function t(t,e,n){this.protocol=t,this.repoMethod=e,this.subscription=n}return Object.defineProperty(t.prototype,"stream",{get:function(){if(!this.repoMethod.stream)throw new Error("no stream");return this.repoMethod.stream},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"arguments",{get:function(){return this.subscription.arguments||{}},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"branchKey",{get:function(){return this.subscription.branchKey},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"instance",{get:function(){if(!this.subscription.instance)throw new Error("no instance");return this.subscription.instance},enumerable:!0,configurable:!0}),t.prototype.close=function(){this.protocol.server.closeSingleSubscription(this.repoMethod,this.subscription)},t.prototype.push=function(t){this.protocol.server.pushDataToSingle(this.repoMethod,this.subscription,t)},t}(),vt=function(){function t(t,e,n){this.protocol=t,this.repoMethod=e,this.requestContext=n,this.arguments=n.arguments,this.instance=n.instance}return t.prototype.accept=function(){this.protocol.server.acceptRequestOnBranch(this.requestContext,this.repoMethod,"")},t.prototype.acceptOnBranch=function(t){this.protocol.server.acceptRequestOnBranch(this.requestContext,this.repoMethod,t)},t.prototype.reject=function(t){this.protocol.server.rejectRequest(this.requestContext,this.repoMethod,t)},t}(),mt=function(){function t(t,e){var n=this;this.protocol=t,this.server=e,t.server.onSubRequest((function(t,e){return n.handleSubRequest(t,e)})),t.server.onSubAdded((function(t,e){return n.handleSubAdded(t,e)})),t.server.onSubRemoved((function(t,e){return n.handleSubRemoved(t,e)}))}return t.prototype.handleSubRequest=function(t,e){if(e&&e.streamCallbacks&&"function"==typeof e.streamCallbacks.subscriptionRequestHandler){var n=new vt(this.protocol,e,t);e.streamCallbacks.subscriptionRequestHandler(n)}},t.prototype.handleSubAdded=function(t,e){if(e&&e.streamCallbacks&&"function"==typeof e.streamCallbacks.subscriptionAddedHandler){var n=new gt(this.protocol,e,t);e.streamCallbacks.subscriptionAddedHandler(n)}},t.prototype.handleSubRemoved=function(t,e){if(e&&e.streamCallbacks&&"function"==typeof e.streamCallbacks.subscriptionRemovedHandler){var n=new gt(this.protocol,e,t);e.streamCallbacks.subscriptionRemovedHandler(n)}},t}(),wt=function(){function t(t,e,n){this.key=t,this.protocol=e,this.repoMethod=n}return t.prototype.subscriptions=function(){var t=this;return this.protocol.server.getSubscriptionList(this.repoMethod,this.key).map((function(e){return new gt(t.protocol,t.repoMethod,e)}))},t.prototype.close=function(){this.protocol.server.closeAllSubscriptions(this.repoMethod,this.key)},t.prototype.push=function(t){this.protocol.server.pushData(this.repoMethod,t,[this.key])},t}(),bt=function(){function t(t,e,n){this._protocol=t,this._repoMethod=e,this._server=n,this.name=this._repoMethod.definition.name}return t.prototype.branches=function(t){var e=this,n=this._protocol.server.getBranchList(this._repoMethod);return t?n.indexOf(t)>-1?new wt(t,this._protocol,this._repoMethod):void 0:n.map((function(t){return new wt(t,e._protocol,e._repoMethod)}))},t.prototype.branch=function(t){return this.branches(t)},t.prototype.subscriptions=function(){var t=this;return this._protocol.server.getSubscriptionList(this._repoMethod).map((function(e){return new gt(t._protocol,t._repoMethod,e)}))},Object.defineProperty(t.prototype,"definition",{get:function(){var t=this._repoMethod.definition;return{accepts:t.accepts,description:t.description,displayName:t.displayName,name:t.name,objectTypes:t.objectTypes,returns:t.returns,supportsStreaming:t.supportsStreaming}},enumerable:!0,configurable:!0}),t.prototype.close=function(){this._protocol.server.closeAllSubscriptions(this._repoMethod),this._server.unregister(this._repoMethod.definition,!0)},t.prototype.push=function(t,e){if("string"!=typeof e&&!Array.isArray(e)&&void 0!==e)throw new Error("invalid branches should be string or string array");if("object"!=typeof t)throw new Error("Invalid arguments. Data must be an object.");this._protocol.server.pushData(this._repoMethod,t,e)},t.prototype.updateRepoMethod=function(t){this._repoMethod=t},t}(),_t=function(){function t(t,e){this.protocol=t,this.serverRepository=e,this.invocations=0,this.currentlyUnregistering={},this.streaming=new mt(t,this),this.protocol.server.onInvoked(this.onMethodInvoked.bind(this))}return t.prototype.createStream=function(t,e,i,o,r){var s=this;return ft(new Promise((function(i,o){if(t){var a;if(!(a="string"==typeof t?{name:""+t}:n({},t)).name)return o("The “name” property is required for the “streamDefinition” object and must be unique. Stream definition: "+JSON.stringify(a));if(s.serverRepository.getList().some((function(t){return t.definition.name===a.name})))return o('A stream with the name "'+a.name+'" already exists! Please, provide a unique name for the stream.');a.supportsStreaming=!0,e||(e={}),"function"!=typeof e.subscriptionRequestHandler&&(e.subscriptionRequestHandler=function(t){t.accept()});var c=s.serverRepository.add({definition:a,streamCallbacks:e,protocolState:{}});s.protocol.server.createStream(c).then((function(){var t;r?(t=r,r.updateRepoMethod(c)):t=new bt(s.protocol,c,s),c.stream=t,i(t)})).catch((function(t){c.repoId&&s.serverRepository.remove(c.repoId),o(t)}))}else o("The stream name must be unique! Please, provide either a unique string for a stream name to “glue.interop.createStream()” or a “methodDefinition” object with a unique “name” property for the stream.")})),i,o)},t.prototype.register=function(t,e){var n=this;if(!t)return Promise.reject("Method definition is required. Please, provide either a unique string for a method name or a “methodDefinition” object with a required “name” property.");if("function"!=typeof e)return Promise.reject("The second parameter must be a callback function. Method: "+("string"==typeof t?t:t.name));var r=function(t,r){return i(n,void 0,void 0,(function(){var n,i,s;return o(this,(function(o){switch(o.label){case 0:return o.trys.push([0,4,,5]),(n=e(t.args,t.instance))&&"function"==typeof n.then?[4,n]:[3,2];case 1:return i=o.sent(),r(void 0,i),[3,3];case 2:r(void 0,n),o.label=3;case 3:return[3,5];case 4:return(s=o.sent())||(s=""),r(s,s),[3,5];case 5:return[2]}}))}))};return r.userCallback=e,this.registerCore(t,r)},t.prototype.registerAsync=function(t,e){if(!t)return Promise.reject("Method definition is required. Please, provide either a unique string for a method name or a “methodDefinition” object with a required “name” property.");if("function"!=typeof e)return Promise.reject("The second parameter must be a callback function. Method: "+("string"==typeof t?t:t.name));var n=function(t,n){try{var i=!1,o=function(t){i||n(void 0,t),i=!0},r=function(t){i||(t||(t=""),n(t,t)),i=!0},s=e(t.args,t.instance,o,r);s&&"function"==typeof s.then&&s.then(o).catch(r)}catch(t){n(t,void 0)}};return n.userCallbackAsync=e,this.registerCore(t,n)},t.prototype.unregister=function(t,e){return void 0===e&&(e=!1),i(this,void 0,void 0,(function(){var n,i;return o(this,(function(o){switch(o.label){case 0:return void 0===t?[2,Promise.reject("Please, provide either a unique string for a name or an object containing a “name” property.")]:"function"!=typeof t?[3,2]:[4,this.unregisterWithPredicate(t,e)];case 1:return o.sent(),[2];case 2:return void 0===(n="string"==typeof t?{name:t}:t).name?[2,Promise.reject("Method name is required. Cannot find a method if the method name is undefined!")]:(i=this.serverRepository.getList().find((function(t){return t.definition.name===n.name&&(t.definition.supportsStreaming||!1)===e})))?[4,this.removeMethodsOrStreams([i])]:[2,Promise.reject('Method with a name "'+n.name+'" does not exist or is not registered by your application!')];case 3:return o.sent(),[2]}}))}))},t.prototype.unregisterWithPredicate=function(t,e){return i(this,void 0,void 0,(function(){var n;return o(this,(function(i){switch(i.label){case 0:return(n=this.serverRepository.getList().filter((function(e){return t(e.definition)})).filter((function(t){return(t.definition.supportsStreaming||!1)===e})))&&0!==n.length?[4,this.removeMethodsOrStreams(n)]:[2,Promise.reject("Could not find a "+(e?"stream":"method")+" matching the specified condition!")];case 1:return i.sent(),[2]}}))}))},t.prototype.removeMethodsOrStreams=function(t){var e=this,n=[];return t.forEach((function(t){var i=e.protocol.server.unregister(t).then((function(){t.repoId&&e.serverRepository.remove(t.repoId)}));n.push(i),e.addAsCurrentlyUnregistering(t.definition.name,i)})),Promise.all(n)},t.prototype.addAsCurrentlyUnregistering=function(t,e){return i(this,void 0,void 0,(function(){var n,i=this;return o(this,(function(o){return n=new Promise((function(t){return setTimeout(t,5e3)})),this.currentlyUnregistering[t]=Promise.race([e,n]).then((function(){delete i.currentlyUnregistering[t]})),[2]}))}))},t.prototype.registerCore=function(t,e){return i(this,void 0,void 0,(function(){var i,r,s,a=this;return o(this,(function(o){switch(o.label){case 0:return(i="string"==typeof t?{name:""+t}:n({},t)).name?(r=this.currentlyUnregistering[i.name])?[4,r]:[3,2]:[2,Promise.reject("Please, provide a (unique) string value for the “name” property in the “methodDefinition” object: "+JSON.stringify(t))];case 1:o.sent(),o.label=2;case 2:return this.serverRepository.getList().some((function(t){return t.definition.name===i.name}))?[2,Promise.reject('A method with the name "'+i.name+'" already exists! Please, provide a unique name for the method.')]:i.supportsStreaming?[2,Promise.reject("When you create methods with “glue.interop.register()” or “glue.interop.registerAsync()” the property “supportsStreaming” cannot be “true”. If you want “"+i.name+"” to be a stream, please use the “glue.interop.createStream()” method.")]:(s=this.serverRepository.add({definition:i,theFunction:e,protocolState:{}}),[2,this.protocol.server.register(s).catch((function(t){throw(null==s?void 0:s.repoId)&&a.serverRepository.remove(s.repoId),t}))])}}))}))},t.prototype.onMethodInvoked=function(t,e,n){var i=this;t&&t.theFunction&&t.theFunction(n,(function(n,o){if(null!=n)if(n.message&&"string"==typeof n.message)n=n.message;else if("string"!=typeof n)try{n=JSON.stringify(n)}catch(t){n="un-stringifyable error in onMethodInvoked! Top level prop names: "+Object.keys(n)}o?("object"!=typeof o||Array.isArray(o))&&(o={_value:o}):o={},i.protocol.server.methodInvocationResult(t,e,n,o)}))},t}(),It=function(){function t(t,e){var n=this;this.wrapped={getMethods:At,getStreams:Ct},t&&this.refreshWrappedObject(t),e&&(e.loggedIn((function(){n.refresh(e)})),this.refresh(e))}return t.prototype.unwrap=function(){return this.wrapped},t.prototype.refresh=function(t){if(t){var e=null==t?void 0:t.resolvedIdentity,n=Object.assign({},null!=e?e:{},{peerId:null==t?void 0:t.peerId});this.refreshWrappedObject(n)}},t.prototype.refreshWrappedObject=function(t){var e,n,i;this.wrapped.user=t.user,this.wrapped.instance=t.instance,this.wrapped.application=null!==(e=t.application)&&void 0!==e?e:Z(),this.wrapped.applicationName=t.applicationName,this.wrapped.pid=null!==(i=null!==(n=t.pid)&&void 0!==n?n:t.process)&&void 0!==i?i:Math.floor(1e10*Math.random()),this.wrapped.machine=t.machine,this.wrapped.environment=t.environment,this.wrapped.region=t.region,this.wrapped.windowId=t.windowId,this.wrapped.isLocal=!0,this.wrapped.api=t.api,this.wrapped.service=t.service,this.wrapped.peerId=t.peerId},t}();function At(){var t;return null===(t=It.API)||void 0===t?void 0:t.methodsForInstance(this)}function Ct(){var t;return null===(t=It.API)||void 0===t?void 0:t.methodsForInstance(this).filter((function(t){return t.supportsStreaming}))}var Tt=function(){function t(t){this.logger=t,this.servers={},this.methodsCount={},this.callbacks=S()}return t.prototype.addServer=function(t,e){this.logger.debug("adding server "+e);var n=this.servers[e];if(n)return n.id;var i=new It(t),o={id:e,methods:{},instance:i.unwrap(),wrapper:i};return this.servers[e]=o,this.callbacks.execute("onServerAdded",o.instance),e},t.prototype.removeServerById=function(t,e){var n=this,i=this.servers[t];i?(this.logger.debug("removing server "+t),Object.keys(i.methods).forEach((function(e){n.removeServerMethod(t,e)})),delete this.servers[t],this.callbacks.execute("onServerRemoved",i.instance,e)):this.logger.warn("not aware of server "+t+", my state "+JSON.stringify(Object.keys(this.servers)))},t.prototype.addServerMethod=function(t,e){var n=this.servers[t];if(!n)throw new Error("server does not exists");if(!n.methods[e.id]){var i=this.createMethodIdentifier(e),o=this,r={identifier:i,gatewayId:e.id,name:e.name,displayName:e.display_name,description:e.description,version:e.version,objectTypes:e.object_types||[],accepts:e.input_signature,returns:e.result_signature,supportsStreaming:void 0!==e.flags&&e.flags.streaming,getServers:function(){return o.getServersByMethod(i)}};return r.object_types=r.objectTypes,r.display_name=r.displayName,r.version=r.version,n.methods[e.id]=r,this.methodsCount[i]||(this.methodsCount[i]=0,this.callbacks.execute("onMethodAdded",r)),this.methodsCount[i]=this.methodsCount[i]+1,this.callbacks.execute("onServerMethodAdded",n.instance,r),r}},t.prototype.removeServerMethod=function(t,e){var n=this.servers[t];if(!n)throw new Error("server does not exists");var i=n.methods[e];delete n.methods[e],this.methodsCount[i.identifier]=this.methodsCount[i.identifier]-1,0===this.methodsCount[i.identifier]&&this.callbacks.execute("onMethodRemoved",i),this.callbacks.execute("onServerMethodRemoved",n.instance,i)},t.prototype.getMethods=function(){var t=this,e={};return Object.keys(this.servers).forEach((function(n){var i=t.servers[n];Object.keys(i.methods).forEach((function(t){var n=i.methods[t];e[n.identifier]=n}))})),Object.keys(e).map((function(t){return e[t]}))},t.prototype.getServers=function(){var t=this,e=[];return Object.keys(this.servers).forEach((function(n){var i=t.servers[n];e.push(i)})),e},t.prototype.getServerMethodsById=function(t){var e=this.servers[t];return Object.keys(e.methods).map((function(t){return e.methods[t]}))},t.prototype.onServerAdded=function(t){var e=this.callbacks.add("onServerAdded",t),n=this.getServers().map((function(t){return t.instance}));return this.returnUnsubWithDelayedReplay(e,n,t)},t.prototype.onMethodAdded=function(t){var e=this.callbacks.add("onMethodAdded",t),n=this.getMethods();return this.returnUnsubWithDelayedReplay(e,n,t)},t.prototype.onServerMethodAdded=function(t){var e=this.callbacks.add("onServerMethodAdded",t),n=!1,i=this.getServers();return setTimeout((function(){i.forEach((function(e){var i=e.methods;Object.keys(i).forEach((function(o){n||t(e.instance,i[o])}))}))}),0),function(){n=!0,e()}},t.prototype.onMethodRemoved=function(t){return this.callbacks.add("onMethodRemoved",t)},t.prototype.onServerRemoved=function(t){return this.callbacks.add("onServerRemoved",t)},t.prototype.onServerMethodRemoved=function(t){return this.callbacks.add("onServerMethodRemoved",t)},t.prototype.getServerById=function(t){return this.servers[t]},t.prototype.reset=function(){var t=this;Object.keys(this.servers).forEach((function(e){t.removeServerById(e,"reset")})),this.servers={},this.methodsCount={}},t.prototype.createMethodIdentifier=function(t){var e=void 0!==t.input_signature?t.input_signature:"",n=void 0!==t.result_signature?t.result_signature:"";return(t.name+e+n).toLowerCase()},t.prototype.getServersByMethod=function(t){var e=this,n=[];return Object.keys(this.servers).forEach((function(i){var o=e.servers[i];Object.keys(o.methods).forEach((function(e){o.methods[e].identifier===t&&n.push(o.instance)}))})),n},t.prototype.returnUnsubWithDelayedReplay=function(t,e,n){var i=!1;return setTimeout((function(){e.forEach((function(t){i||n(t)}))}),0),function(){i=!0,t()}},t}(),St=function(){function t(){this.nextId=0,this.methods=[]}return t.prototype.add=function(t){return t.repoId=String(this.nextId),this.nextId+=1,this.methods.push(t),t},t.prototype.remove=function(t){if("string"!=typeof t)return new TypeError("Expecting a string");this.methods=this.methods.filter((function(e){return e.repoId!==t}))},t.prototype.getById=function(t){if("string"==typeof t)return this.methods.find((function(e){return e.repoId===t}))},t.prototype.getList=function(){return this.methods.map((function(t){return t}))},t.prototype.length=function(){return this.methods.length},t.prototype.reset=function(){this.methods=[]},t}(),kt=function(){function t(t,e,n){var i=this;this.session=t,this.repository=e,this.serverRepository=n,this.ERR_URI_SUBSCRIPTION_FAILED="com.tick42.agm.errors.subscription.failure",this.callbacks=S(),this.nextStreamId=0,t.on("add-interest",(function(t){i.handleAddInterest(t)})),t.on("remove-interest",(function(t){i.handleRemoveInterest(t)}))}return t.prototype.acceptRequestOnBranch=function(t,e,n){if("string"!=typeof n&&(n=""),"object"!=typeof e.protocolState.subscriptionsMap)throw new TypeError("The streaming method is missing its subscriptions.");if(!Array.isArray(e.protocolState.branchKeyToStreamIdMap))throw new TypeError("The streaming method is missing its branches.");var i=this.getStreamId(e,n),o=t.msg.subscription_id,r={id:o,arguments:t.arguments,instance:t.instance,branchKey:n,streamId:i,subscribeMsg:t.msg};e.protocolState.subscriptionsMap[o]=r,this.session.sendFireAndForget({type:"accepted",subscription_id:o,stream_id:i}),this.callbacks.execute("onSubscriptionAdded",r,e)},t.prototype.rejectRequest=function(t,e,n){"string"!=typeof n&&(n=""),this.sendSubscriptionFailed("Subscription rejected by user. "+n,t.msg.subscription_id)},t.prototype.pushData=function(t,e,n){var i=this;if("object"==typeof t&&Array.isArray(t.protocolState.branchKeyToStreamIdMap)){if("object"!=typeof e)throw new Error("Invalid arguments. Data must be an object.");"string"==typeof n?n=[n]:(!Array.isArray(n)||n.length<=0)&&(n=[]),t.protocolState.branchKeyToStreamIdMap.filter((function(t){return!n||0===n.length||n.indexOf(t.key)>=0})).map((function(t){return t.streamId})).forEach((function(t){var n={type:"publish",stream_id:t,data:e};i.session.sendFireAndForget(n)}))}},t.prototype.pushDataToSingle=function(t,e,n){if("object"!=typeof n)throw new Error("Invalid arguments. Data must be an object.");var i={type:"post",subscription_id:e.id,data:n};this.session.sendFireAndForget(i)},t.prototype.closeSingleSubscription=function(t,e){t.protocolState.subscriptionsMap&&delete t.protocolState.subscriptionsMap[e.id];var n={type:"drop-subscription",subscription_id:e.id,reason:"Server dropping a single subscription"};this.session.sendFireAndForget(n);e.instance;this.callbacks.execute("onSubscriptionRemoved",e,t)},t.prototype.closeMultipleSubscriptions=function(t,e){var n=this;if("object"==typeof t&&"object"==typeof t.protocolState.subscriptionsMap&&t.protocolState.subscriptionsMap){var i=t.protocolState.subscriptionsMap,o=Object.keys(i).map((function(t){return i[t]}));"string"==typeof e&&(o=o.filter((function(t){return t.branchKey===e}))),o.forEach((function(t){delete i[t.id];var e={type:"drop-subscription",subscription_id:t.id,reason:"Server dropping all subscriptions on stream_id: "+t.streamId};n.session.sendFireAndForget(e)}))}},t.prototype.getSubscriptionList=function(t,e){if("object"!=typeof t)return[];if(!t.protocolState.subscriptionsMap)return[];var n=t.protocolState.subscriptionsMap,i=Object.keys(n).map((function(t){return n[t]}));return"string"!=typeof e?i:i.filter((function(t){return t.branchKey===e}))},t.prototype.getBranchList=function(t){if("object"!=typeof t)return[];if(!t.protocolState.subscriptionsMap)return[];var e=t.protocolState.subscriptionsMap,n=Object.keys(e).map((function(t){return e[t]})),i=[];return n.forEach((function(t){var e="";"object"==typeof t&&"string"==typeof t.branchKey&&(e=t.branchKey),-1===i.indexOf(e)&&i.push(e)})),i},t.prototype.onSubAdded=function(t){this.onSubscriptionLifetimeEvent("onSubscriptionAdded",t)},t.prototype.onSubRequest=function(t){this.onSubscriptionLifetimeEvent("onSubscriptionRequest",t)},t.prototype.onSubRemoved=function(t){this.onSubscriptionLifetimeEvent("onSubscriptionRemoved",t)},t.prototype.handleRemoveInterest=function(t){var e=this.serverRepository.getById(t.method_id);if("string"==typeof t.subscription_id&&"object"==typeof e&&e.protocolState.subscriptionsMap&&"object"==typeof e.protocolState.subscriptionsMap[t.subscription_id]){var n=e.protocolState.subscriptionsMap[t.subscription_id];delete e.protocolState.subscriptionsMap[t.subscription_id],this.callbacks.execute("onSubscriptionRemoved",n,e)}},t.prototype.onSubscriptionLifetimeEvent=function(t,e){this.callbacks.add(t,e)},t.prototype.getNextStreamId=function(){return this.nextStreamId+++""},t.prototype.handleAddInterest=function(t){var e=this.repository.getServerById(t.caller_id).instance,n={msg:t,arguments:t.arguments_kv||{},instance:e},i=this.serverRepository.getById(t.method_id);if(void 0!==i)i.protocolState.subscriptionsMap&&i.protocolState.subscriptionsMap[t.subscription_id]?this.sendSubscriptionFailed("A subscription with id "+t.subscription_id+" already exists.",t.subscription_id):this.callbacks.execute("onSubscriptionRequest",n,i);else{var o="No method with id "+t.method_id+" on this server.";this.sendSubscriptionFailed(o,t.subscription_id)}},t.prototype.sendSubscriptionFailed=function(t,e){var n={type:"error",reason_uri:this.ERR_URI_SUBSCRIPTION_FAILED,reason:t,request_id:e};this.session.sendFireAndForget(n)},t.prototype.getStreamId=function(t,e){if("string"!=typeof e&&(e=""),!t.protocolState.branchKeyToStreamIdMap)throw new Error("streaming "+t.definition.name+" method without protocol state");var n=t.protocolState.branchKeyToStreamIdMap.filter((function(t){return t.key===e}))[0],i=n?n.streamId:void 0;return"string"==typeof i&&""!==i||(i=this.getNextStreamId(),t.protocolState.branchKeyToStreamIdMap.push({key:e,streamId:i})),i},t}(),xt=function(){function t(t,e,n,i){var o=this;this.session=t,this.clientRepository=e,this.serverRepository=n,this.logger=i,this.callbacks=S(),this.streaming=new kt(t,e,n),this.session.on("invoke",(function(t){return o.handleInvokeMessage(t)}))}return t.prototype.createStream=function(t){return t.protocolState.subscriptionsMap={},t.protocolState.branchKeyToStreamIdMap=[],this.register(t,!0)},t.prototype.register=function(t,e){var n=this,i=t.definition,o={streaming:e||!1},r={type:"register",methods:[{id:t.repoId,name:i.name,display_name:i.displayName,description:i.description,version:i.version,flags:o,object_types:i.objectTypes||i.object_types,input_signature:i.accepts,result_signature:i.returns,restrictions:void 0}]};return this.session.send(r,{methodId:t.repoId}).then((function(){n.logger.debug("registered method "+t.definition.name+" with id "+t.repoId)})).catch((function(e){throw n.logger.warn("failed to register method "+t.definition.name+" with id "+t.repoId+" - "+JSON.stringify(e)),e}))},t.prototype.onInvoked=function(t){this.callbacks.add("onInvoked",t)},t.prototype.methodInvocationResult=function(t,e,n,i){var o;o=n||""===n?{type:"error",request_id:e,reason_uri:"agm.errors.client_error",reason:n,context:i,peer_id:void 0}:{type:"yield",invocation_id:e,peer_id:this.session.peerId,result:i,request_id:void 0},this.session.sendFireAndForget(o)},t.prototype.unregister=function(t){return i(this,void 0,void 0,(function(){var e;return o(this,(function(n){switch(n.label){case 0:return e={type:"unregister",methods:[t.repoId]},[4,this.session.send(e)];case 1:return n.sent(),[2]}}))}))},t.prototype.getBranchList=function(t){return this.streaming.getBranchList(t)},t.prototype.getSubscriptionList=function(t,e){return this.streaming.getSubscriptionList(t,e)},t.prototype.closeAllSubscriptions=function(t,e){this.streaming.closeMultipleSubscriptions(t,e)},t.prototype.pushData=function(t,e,n){this.streaming.pushData(t,e,n)},t.prototype.pushDataToSingle=function(t,e,n){this.streaming.pushDataToSingle(t,e,n)},t.prototype.closeSingleSubscription=function(t,e){this.streaming.closeSingleSubscription(t,e)},t.prototype.acceptRequestOnBranch=function(t,e,n){this.streaming.acceptRequestOnBranch(t,e,n)},t.prototype.rejectRequest=function(t,e,n){this.streaming.rejectRequest(t,e,n)},t.prototype.onSubRequest=function(t){this.streaming.onSubRequest(t)},t.prototype.onSubAdded=function(t){this.streaming.onSubAdded(t)},t.prototype.onSubRemoved=function(t){this.streaming.onSubRemoved(t)},t.prototype.handleInvokeMessage=function(t){var e=t.invocation_id,n=t.caller_id,i=t.method_id,o=t.arguments_kv,r=this.serverRepository.getList().filter((function(t){return t.repoId===i}))[0];if(void 0!==r){var s={args:o,instance:this.clientRepository.getServerById(n).instance};this.callbacks.execute("onInvoked",r,e,s)}},t}(),Pt=function(){function t(t,e){this.repository=t,this.subscriptionData=e}return Object.defineProperty(t.prototype,"requestArguments",{get:function(){return this.subscriptionData.params.arguments||{}},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"servers",{get:function(){var t=this;return this.subscriptionData.trackedServers.filter((function(t){return t.subscriptionId})).map((function(e){return t.repository.getServerById(e.serverId).instance}))},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"serverInstance",{get:function(){return this.servers[0]},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"stream",{get:function(){return this.subscriptionData.method},enumerable:!0,configurable:!0}),t.prototype.onData=function(t){if("function"!=typeof t)throw new TypeError("The data callback must be a function.");this.subscriptionData.handlers.onData.push(t),1===this.subscriptionData.handlers.onData.length&&this.subscriptionData.queued.data.length>0&&this.subscriptionData.queued.data.forEach((function(e){t(e)}))},t.prototype.onClosed=function(t){if("function"!=typeof t)throw new TypeError("The callback must be a function.");this.subscriptionData.handlers.onClosed.push(t)},t.prototype.onFailed=function(t){},t.prototype.onConnected=function(t){if("function"!=typeof t)throw new TypeError("The callback must be a function.");this.subscriptionData.handlers.onConnected.push(t)},t.prototype.close=function(){this.subscriptionData.close()},t.prototype.setNewSubscription=function(t){this.subscriptionData=t},t}(),Mt=function(){function t(t,e,n){var i=this;this.session=t,this.repository=e,this.logger=n,this.subscriptionsList={},this.subscriptionIdToLocalKeyMap={},this.nextSubLocalKey=0,this.handleErrorSubscribing=function(t){var e=t._tag,n=e.subLocalKey,o=i.subscriptionsList[n];if("object"==typeof o&&(o.trackedServers=o.trackedServers.filter((function(t){return t.serverId!==e.serverId})),o.trackedServers.length<=0)){if(clearTimeout(o.timeoutId),"awaitingAccept"===o.status){var r="string"==typeof t.reason&&""!==t.reason?' Publisher said "'+t.reason+'".':" No reason given.",s="object"==typeof o.params.arguments?JSON.stringify(o.params.arguments):"{}";o.error({message:"Subscription rejected."+r+" Called with:"+s,called_with:o.params.arguments,method:o.method})}else"subscribed"===o.status&&i.callOnClosedHandlers(o);delete i.subscriptionsList[n]}},this.handleSubscribed=function(t){var e=t._tag.subLocalKey,n=i.subscriptionsList[e];if("object"==typeof n){var o=t._tag.serverId,r=n.trackedServers.filter((function(t){return t.serverId===o}))[0];if("object"==typeof r){r.subscriptionId=t.subscription_id,i.subscriptionIdToLocalKeyMap[t.subscription_id]=e;var s="awaitingAccept"===n.status;if(n.status="subscribed",s){var a=!1,c=n.subscription;c?(c.setNewSubscription(n),n.success(c),a=!0):(c=new Pt(i.repository,n),n.subscription=c,n.success(c));for(var u=0,d=n.handlers.onConnected;u<d.length;u++){var p=d[u];try{p(c.serverInstance,a)}catch(t){}}}}}},this.handleEventData=function(t){var e=i.subscriptionIdToLocalKeyMap[t.subscription_id];if(void 0!==e){var n=i.subscriptionsList[e];if("object"==typeof n){var o=n.trackedServers.filter((function(e){return e.subscriptionId===t.subscription_id}));if(1===o.length){var r=t.oob,s=o[0].serverId,a=function(){return{data:t.data,server:i.repository.getServerById(s).instance,requestArguments:n.params.arguments,message:void 0,private:r}},c=n.handlers.onData,u=n.queued.data;c.length>0?c.forEach((function(t){"function"==typeof t&&t(a())})):u.push(a())}}}},this.handleSubscriptionCancelled=function(t){var e=i.subscriptionIdToLocalKeyMap[t.subscription_id];if(void 0!==e){var n=i.subscriptionsList[e];if("object"==typeof n){var o=n.trackedServers.length-1;n.trackedServers=n.trackedServers.filter((function(e){return e.subscriptionId!==t.subscription_id||(n.queued.closers.push(e.serverId),!1)})),n.trackedServers.length===o&&(n.trackedServers.length<=0&&(clearTimeout(n.timeoutId),i.callOnClosedHandlers(n),delete i.subscriptionsList[e]),delete i.subscriptionIdToLocalKeyMap[t.subscription_id])}}},t.on("subscribed",this.handleSubscribed),t.on("event",this.handleEventData),t.on("subscription-cancelled",this.handleSubscriptionCancelled)}return t.prototype.subscribe=function(t,e,n,i,o,r){var s=this;if(0!==n.length){var a=this.getNextSubscriptionLocalKey(),c=this.registerSubscription(a,t,e,i,o,e.methodResponseTimeout||1e4,r);"object"==typeof c?n.forEach((function(n){var i=n.server.id,o=n.methods.find((function(e){return e.name===t.name}));if(o){c.trackedServers.push({serverId:i,subscriptionId:void 0});var r={type:"subscribe",server_id:i,method_id:o.gatewayId,arguments_kv:e.arguments};s.session.send(r,{serverId:i,subLocalKey:a}).then((function(t){return s.handleSubscribed(t)})).catch((function(t){return s.handleErrorSubscribing(t)}))}else s.logger.error("can not find method "+t.name+" for target "+n.server.id)})):o({method:t,called_with:e.arguments,message:"Subscription failed. Unable to register the user callbacks."})}else o({method:t,called_with:e.arguments,message:"Subscription failed. No available servers matched the target params."})},t.prototype.drainSubscriptions=function(){var t=Object.values(this.subscriptionsList);return this.subscriptionsList={},this.subscriptionIdToLocalKeyMap={},t},t.prototype.getNextSubscriptionLocalKey=function(){var t=this.nextSubLocalKey;return this.nextSubLocalKey+=1,t},t.prototype.registerSubscription=function(t,e,n,i,o,r,s){var a=this,c={localKey:t,status:"awaitingAccept",method:e,params:n,success:i,error:o,trackedServers:[],handlers:{onData:(null==s?void 0:s.handlers.onData)||[],onClosed:(null==s?void 0:s.handlers.onClosed)||[],onConnected:(null==s?void 0:s.handlers.onConnected)||[]},queued:{data:[],closers:[]},timeoutId:void 0,close:function(){return a.closeSubscription(t)},subscription:null==s?void 0:s.subscription};return s||(n.onData&&c.handlers.onData.push(n.onData),n.onClosed&&c.handlers.onClosed.push(n.onClosed),n.onConnected&&c.handlers.onConnected.push(n.onConnected)),this.subscriptionsList[t]=c,c.timeoutId=setTimeout((function(){if(void 0!==a.subscriptionsList[t]){var i=a.subscriptionsList[t];"awaitingAccept"===i.status?(o({method:e,called_with:n.arguments,message:"Subscription failed. Subscription attempt timed out after "+r+" ms."}),delete a.subscriptionsList[t]):"subscribed"===i.status&&i.trackedServers.length>0&&(i.trackedServers=i.trackedServers.filter((function(t){return void 0!==t.subscriptionId})),delete i.timeoutId,i.trackedServers.length<=0&&(a.callOnClosedHandlers(i),delete a.subscriptionsList[t]))}}),r),c},t.prototype.callOnClosedHandlers=function(t,e){var n,i=t.queued.closers.length,o=i>0?t.queued.closers[i-1]:null;void 0!==o&&"string"==typeof o&&(n=this.repository.getServerById(o).instance),t.handlers.onClosed.forEach((function(i){"function"==typeof i&&i({message:e||"ServerInitiated",requestArguments:t.params.arguments||{},server:n,stream:t.method})}))},t.prototype.closeSubscription=function(t){var e=this,n=this.subscriptionsList[t];"object"==typeof n&&(n.trackedServers.forEach((function(t){void 0!==t.subscriptionId&&(n.queued.closers.push(t.serverId),e.session.sendFireAndForget({type:"unsubscribe",subscription_id:t.subscriptionId,reason_uri:"",reason:"ClientInitiated"}),delete e.subscriptionIdToLocalKeyMap[t.subscriptionId])})),n.trackedServers=[],this.callOnClosedHandlers(n,"ClientInitiated"),delete this.subscriptionsList[t])},t}(),jt=function(){function t(t,e,n){var i=this;this.session=t,this.repository=e,this.logger=n,t.on("peer-added",(function(t){return i.handlePeerAdded(t)})),t.on("peer-removed",(function(t){return i.handlePeerRemoved(t)})),t.on("methods-added",(function(t){return i.handleMethodsAddedMessage(t)})),t.on("methods-removed",(function(t){return i.handleMethodsRemovedMessage(t)})),this.streaming=new Mt(t,e,n)}return t.prototype.subscribe=function(t,e,n,i,o,r){this.streaming.subscribe(t,e,n,i,o,r)},t.prototype.invoke=function(t,e,n,i){var o=this,r=i.id,s={type:"call",server_id:r,method_id:e.gatewayId,arguments_kv:n};return this.session.send(s,{invocationId:t,serverId:r}).then((function(t){return o.handleResultMessage(t)})).catch((function(t){return o.handleInvocationError(t)}))},t.prototype.drainSubscriptions=function(){return this.streaming.drainSubscriptions()},t.prototype.handlePeerAdded=function(t){var e=t.new_peer_id,n=t.identity,i=!t.meta||t.meta.local,o=Number(n.process),r={machine:n.machine,pid:isNaN(o)?n.process:o,instance:n.instance,application:n.application,applicationName:n.applicationName,environment:n.environment,region:n.region,user:n.user,windowId:n.windowId,peerId:e,api:n.api,isLocal:i};this.repository.addServer(r,e)},t.prototype.handlePeerRemoved=function(t){var e=t.removed_id,n=t.reason;this.repository.removeServerById(e,n)},t.prototype.handleMethodsAddedMessage=function(t){var e=this,n=t.server_id;t.methods.forEach((function(t){e.repository.addServerMethod(n,t)}))},t.prototype.handleMethodsRemovedMessage=function(t){var e=this,n=t.server_id,i=t.methods,o=this.repository.getServerById(n);Object.keys(o.methods).forEach((function(t){var r=o.methods[t];i.indexOf(r.gatewayId)>-1&&e.repository.removeServerMethod(n,t)}))},t.prototype.handleResultMessage=function(t){var e=t._tag.invocationId,n=t.result,i=t._tag.serverId;return{invocationId:e,result:n,instance:this.repository.getServerById(i).instance,status:dt.Success,message:""}},t.prototype.handleInvocationError=function(t){if(this.logger.debug("handle invocation error "+JSON.stringify(t)),"_tag"in t){var e=t._tag.invocationId,n=t._tag.serverId,i=this.repository.getServerById(n),o=t.reason;return{invocationId:e,result:t.context,instance:i.instance,status:dt.Error,message:o}}return{invocationId:"",message:t.message,status:dt.Error,error:t}},t}();function Et(t,e,n,i,o,r){var s,a=o.logger.subLogger("gw3-protocol"),c=new Promise((function(t){s=t})),u=e.domain("agm",["subscribed"]),d=new xt(u,n,i,a.subLogger("server")),p=new jt(u,n,a.subLogger("client"));return u.onJoined((function(o){n.addServer(t,e.peerId),o?function(){a.info("reconnected - will replay registered methods and subscriptions");for(var t=0,e=p.drainSubscriptions();t<e.length;t++){var n=e[t],o=n.method,s=Object.assign({},n.params);a.info("trying to re-subscribe to method "+o.name),r.client.subscribe(o,s,void 0,void 0,n)}var c=i.getList();i.reset();for(var u=0,d=c;u<d.length;u++){var h=d[u],f=h.definition;a.info("re-publishing method "+f.name),h.stream?r.server.createStream(f,h.streamCallbacks,void 0,void 0,h.stream):h.theFunction&&h.theFunction.userCallback?r.register(f,h.theFunction.userCallback):h.theFunction&&h.theFunction.userCallbackAsync&&r.registerAsync(f,h.theFunction.userCallbackAsync)}}():s&&(s({client:p,server:d}),s=void 0)})),u.onLeft((function(){n.reset()})),u.join(),c}var Ot=function(){function t(t){var e=this;if(void 0===t)throw new Error("configuration is required");if(void 0===t.connection)throw new Error("configuration.connections is required");var n,i=t.connection;if("number"!=typeof t.methodResponseTimeout&&(t.methodResponseTimeout=3e4),"number"!=typeof t.waitTimeoutMs&&(t.waitTimeoutMs=3e4),It.API=this,this.instance=new It(void 0,i).unwrap(),this.clientRepository=new Tt(t.logger.subLogger("cRep")),this.serverRepository=new St,3!==i.protocolVersion)throw new Error("protocol "+i.protocolVersion+" not supported");n=Et(this.instance,i,this.clientRepository,this.serverRepository,t,this),this.readyPromise=n.then((function(n){return e.protocol=n,e.client=new yt(e.protocol,e.clientRepository,e.instance,t),e.server=new _t(e.protocol,e.serverRepository),e}))}return t.prototype.ready=function(){return this.readyPromise},t.prototype.serverRemoved=function(t){return this.client.serverRemoved(t)},t.prototype.serverAdded=function(t){return this.client.serverAdded(t)},t.prototype.serverMethodRemoved=function(t){return this.client.serverMethodRemoved(t)},t.prototype.serverMethodAdded=function(t){return this.client.serverMethodAdded(t)},t.prototype.methodRemoved=function(t){return this.client.methodRemoved(t)},t.prototype.methodAdded=function(t){return this.client.methodAdded(t)},t.prototype.methodsForInstance=function(t){return this.client.methodsForInstance(t)},t.prototype.methods=function(t){return this.client.methods(t)},t.prototype.servers=function(t){return this.client.servers(t)},t.prototype.subscribe=function(t,e,n,i){return this.client.subscribe(t,e,n,i)},t.prototype.createStream=function(t,e,n,i){return this.server.createStream(t,e,n,i)},t.prototype.unregister=function(t){return this.server.unregister(t)},t.prototype.registerAsync=function(t,e){return this.server.registerAsync(t,e)},t.prototype.register=function(t,e){return this.server.register(t,e)},t.prototype.invoke=function(t,e,n,i,o,r){return this.client.invoke(t,e,n,i,o,r)},t}(),Wt=["subscribed","success"],Rt=function(){function t(t,e){var n=this;this.publish=function(t,e,i){var o=i||{},r=o.routingKey,s=o.target,a=n.removeEmptyValues({type:"publish",topic:t,data:e,peer_id:n.peerId,routing_key:r,target_identity:s});n.session.send(a)},this.subscribe=function(t,e,i){return new Promise((function(o,r){var s=i||{},a=s.routingKey,c=s.target,u=n.removeEmptyValues({type:"subscribe",topic:t,peer_id:n.peerId,routing_key:a,source:c});n.session.send(u).then((function(i){var r=i.subscription_id;n.subscriptions.push({subscription_id:r,topic:t,callback:e,source:c}),o({unsubscribe:function(){return n.session.send({type:"unsubscribe",subscription_id:r,peer_id:n.peerId}),n.subscriptions=n.subscriptions.filter((function(t){return t.subscription_id!==r})),Promise.resolve()}})})).catch((function(t){return r(t)}))}))},this.watchOnEvent=function(){n.session.on("event",(function(t){var e=t.data,i=t.subscription_id,o=t["publisher-identity"],r=n.subscriptions.find((function(t){return t.subscription_id===i}));r&&(r.source?n.keysMatch(r.source,o)&&r.callback(e,r.topic,o):r.callback(e,r.topic,o))}))},this.connection=t,this.logger=e,this.peerId=t.peerId,this.subscriptions=[],this.session=t.domain("bus",Wt),this.readyPromise=this.session.join(),this.readyPromise.then((function(){n.watchOnEvent()}))}return t.prototype.ready=function(){return this.readyPromise},t.prototype.removeEmptyValues=function(t){var e={};return Object.keys(t).forEach((function(n){void 0!==t[n]&&null!==t[n]&&(e[n]=t[n])})),e},t.prototype.keysMatch=function(t,e){var n=Object.keys(t),i=!0;return n.forEach((function(n){t[n]!==e[n]&&(i=!1)})),i},t}(),Ft=function(t,e){var n,r=P.getGDMajorVersion(),s=Promise.resolve();if(r){if(r<3)throw new Error("GD v2 is not supported. Use v4 of the API to run in that context.");r>=3&&(n=window.glue42gd,s=window.gdPreloadPromise||s)}var a,c,u,d,p,h,f=ot(),l=it(t=t||{},e=e||{},n),y={};function g(t,e,n){u.canPublish("trace")&&u.trace("registering "+t+" module");var i=function(){e.initTime=n.stop(),e.initEndTime=n.endTime,u.trace(t+" is ready")};e.initStartTime=n.startTime,e.ready?e.ready().then((function(){i()})):i(),Array.isArray(t)||(t=[t]),t.forEach((function(t){y[t]=e,Ft[t]=e}))}function v(){var t,e,i,o=ot(),r=l.metrics,s=null==n?void 0:n.getMetricsPublishingEnabled,c=l.connection.identity,p=s||function(){return!0},h=C({connection:r?a:void 0,logger:u.subLogger("metrics"),canUpdateMetric:p,system:"Glue42",service:null!==(t=null==c?void 0:c.service)&&void 0!==t?t:"metrics-service",instance:null!==(i=null!==(e=null==c?void 0:c.instance)&&void 0!==e?e:null==c?void 0:c.windowId)&&void 0!==i?i:Z()}),f=h;return f="boolean"!=typeof r&&r.disableAutoAppSystem?h:h.subSystem("App"),g("metrics",d=function(t){var e,n=t.subSystem("reporting"),i={name:"features"};return t.featureMetric=function(t,o,r){if(void 0===t||""===t)throw new Error("name is mandatory");if(void 0===o||""===o)throw new Error("action is mandatory");if(void 0===r||""===r)throw new Error("payload is mandatory");e?e.update({name:t,action:o,payload:r}):e=n.objectMetric(i,{name:t,action:o,payload:r})},t}(f),o),Promise.resolve()}function m(){var t=l.activities&&3===a.protocolVersion;if(l.contexts||t){var e=ot();return g("contexts",p=new ht({connection:a,logger:u.subLogger("contexts")}),e),p}var n=a.replayer;n&&n.drain(nt.name)}function w(){return i(this,void 0,void 0,(function(){var t;return o(this,(function(e){return l.bus?(t=ot(),g("bus",h=new Rt(a,u.subLogger("bus")),t),[2,Promise.resolve()]):[2,Promise.resolve()]}))}))}function b(t){try{return t.forEach((function(t){!function(t,e){var n=ot(),i=e(y);i&&g(t,i,n)}(t.name,t.create)})),Promise.resolve()}catch(t){return Promise.reject(t)}}return s.then((function(){var t,e=ot();return(u=new et(""+(null===(t=l.connection.identity)||void 0===t?void 0:t.application),void 0,l.customLogger)).consoleLevel(l.logger.console),u.publishLevel(l.logger.publish),g("logger",u,e),Promise.resolve(void 0)})).then((function(){var t=ot();a=new $(l.connection,u.subLogger("connection"));var e=Promise.resolve(l.auth);return l.connection&&!l.auth&&(n?(u.trace("trying to get gw token..."),e=n.getGWToken().then((function(t){return u.trace("got GW token "+(null==t?void 0:t.substring(t.length-10))),{gatewayToken:t}}))):e=Promise.reject("You need to provide auth information")),e.then((function(t){var e;if("[object Object]"!==Object.prototype.toString.call(t))throw new Error("Invalid auth object - "+JSON.stringify(t));return e=t,a.login(e)})).then((function(){return g("connection",a,t),l})).catch((function(t){throw a&&a.logout(),t}))})).then((function(){return Promise.all([v(),(t=ot(),e={connection:a,logger:u.subLogger("interop")},c=new Ot(e),et.Interop=c,g(["interop","agm"],c,t),Promise.resolve()),m(),w()]);var t,e})).then((function(){return c.readyPromise})).then((function(){return b(l.libs||[])})).then((function(){var t=Object.keys(y).map((function(t){var e=y[t];return e.ready?e.ready():Promise.resolve()}));return Promise.all(t)})).then((function(){var i={coreVersion:"5.0.7",version:l.version};f.stop();var o={feedback:function(t){c&&c.invoke("T42.ACS.Feedback",t,"best")},info:i,logger:u,interop:c,agm:c,connection:a,metrics:d,contexts:p,bus:h,version:l.version,userConfig:t,done:function(){return null==u||u.info("done called by user..."),a.logout()}};return o.performance={get glueVer(){return l.version},get glueConfig(){return JSON.stringify(t)},get browser(){return window.performance.timing.toJSON()},get memory(){return window.performance.memory},get initTimes(){var t=Object.keys(o).filter((function(t){var e;return"initTimes"!==t&&"agm"!==t&&(null===(e=o[t])||void 0===e?void 0:e.initTime)})).map((function(t){return{name:t,time:o[t].initTime,startTime:o[t].initStartTime,endTime:o[t].initEndTime}}));return t.push({name:"glue",startTime:f.startTime,endTime:f.endTime,time:f.period}),t}},Object.keys(y).forEach((function(t){var e=y[t];o[t]=e})),o.config={},Object.keys(l).forEach((function(t){o.config[t]=l[t]})),e&&e.extOptions&&Object.keys(e.extOptions).forEach((function(t){o.config[t]=null==e?void 0:e.extOptions[t]})),(null==e?void 0:e.enrichGlue)&&e.enrichGlue(o),n&&n.updatePerfData&&n.updatePerfData(o.performance),o})).catch((function(t){return Promise.reject({err:t,libs:y})}))};"undefined"!=typeof window&&(window.GlueCore=Ft),Ft.version="5.0.7",Ft.default=Ft;var Lt=function(t,e){return(Lt=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(t,e)};function Nt(t,e){function n(){this.constructor=t}Lt(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)}var Dt=function(){return(Dt=Object.assign||function(t){for(var e,n=1,i=arguments.length;n<i;n++)for(var o in e=arguments[n])Object.prototype.hasOwnProperty.call(e,o)&&(t[o]=e[o]);return t}).apply(this,arguments)};function Gt(t,e,n,i){return new(n||(n=Promise))((function(o,r){function s(t){try{c(i.next(t))}catch(t){r(t)}}function a(t){try{c(i.throw(t))}catch(t){r(t)}}function c(t){t.done?o(t.value):new n((function(e){e(t.value)})).then(s,a)}c((i=i.apply(t,e||[])).next())}))}function Bt(t,e){var n,i,o,r,s={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return r={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(r[Symbol.iterator]=function(){return this}),r;function a(r){return function(a){return function(r){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,i&&(o=2&r[0]?i.return:r[0]?i.throw||((o=i.return)&&o.call(i),0):i.next)&&!(o=o.call(i,r[1])).done)return o;switch(i=0,o&&(r=[2&r[0],o.value]),r[0]){case 0:case 1:o=r;break;case 4:return s.label++,{value:r[1],done:!1};case 5:s.label++,i=r[1],r=[0];continue;case 7:r=s.ops.pop(),s.trys.pop();continue;default:if(!(o=(o=s.trys).length>0&&o[o.length-1])&&(6===r[0]||2===r[0])){s=0;continue}if(3===r[0]&&(!o||r[1]>o[0]&&r[1]<o[3])){s.label=r[1];break}if(6===r[0]&&s.label<o[1]){s.label=o[1],o=r;break}if(o&&s.label<o[2]){s.label=o[2],s.ops.push(r);break}o[2]&&s.ops.pop(),s.trys.pop();continue}r=e.call(t,s)}catch(t){r=[6,t],i=0}finally{n=o=0}if(5&r[0])throw r[1];return{value:r[0]?r[1]:void 0,done:!0}}([r,a])}}}var Ht=function(){function t(t){this._id=t}return Object.defineProperty(t.prototype,"id",{get:function(){return this._id},enumerable:!0,configurable:!0}),t.prototype._update=function(t){if(t._id!==this._id)throw Error("Can not update from entity with different id.");this._updateCore(t)},t.prototype._updateCore=function(t){},t.prototype._beforeDelete=function(t){},t}();function qt(t){return"string"==typeof t}function Ut(t){return Array.isArray?Array.isArray(t):"[object Array]"===toString.call(t)}function Vt(t){return void 0===t}function zt(t){return!t||void 0===t}function Jt(t){return!!(t&&t.constructor&&t.call&&t.apply)}function Kt(t,e){void 0!==t&&e(t)}var Zt=function(t){function e(e,n,i,o){var r=t.call(this,e)||this;return r._name=e,r._description=o,r._ownerWindow=n,r._helperWindows=i||[],r}return Nt(e,t),Object.defineProperty(e.prototype,"name",{get:function(){return this._name},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"description",{get:function(){return this._description},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"helperWindows",{get:function(){return this._helperWindows},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"ownerWindow",{get:function(){return this._ownerWindow},enumerable:!0,configurable:!0}),e.prototype.initiate=function(t,e,n){return this._manager.initiate(this._name,t,e,n)},e.prototype._updateCore=function(e){var n=this;t.prototype._updateCore.call(this,e),Kt(e._description,(function(t){return n._description=t})),Kt(e._ownerWindow,(function(t){return n._ownerWindow=t})),Kt(e._helperWindows,(function(t){return n._helperWindows=t}))},e}(Ht),Yt=function(t){function e(e,n){var i=t.call(this,e)||this;return i._name=e,i._appByWindowTypeGetter=n,i}return Nt(e,t),Object.defineProperty(e.prototype,"name",{get:function(){return this._name},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"config",{get:function(){return this._appByWindowTypeGetter(this._name)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"windows",{get:function(){return this._manager.getWindows({type:this._name})},enumerable:!0,configurable:!0}),e.prototype.create=function(t,e){var n=Object.assign({type:this.name,name:this.name,isIndependent:!1},e);return this._manager.createWindow(t,n)},e}(Ht),Xt=function(t,e){this.entity=t,this.context=e},Qt=function(t){this.type=t},$t=function(t){function e(e,n){var i=t.call(this,ee.StatusChange)||this;return i.newStatus=e,i.oldStatus=n,i}return Nt(e,t),e}(Qt),te=function(t){function e(e,n,i){var o=t.call(this,ee.ActivityContextChange)||this;return o.context="string"==typeof e?JSON.parse(e):e,o.updated=n,o.removed=i,o}return Nt(e,t),e}(Qt),ee=function(){function t(){}return t.Added="added",t.Removed="removed",t.Updated="updated",t.Closed="closed",t.StatusChange="statusChange",t.ActivityContextChange="activityContextUpdate",t.ActivityWindowEvent="activityWindowEvent",t.ActivityWindowJoinedActivity="joined",t.ActivityWindowLeftActivity="left",t}(),ne=function(){function t(){}return t.Created="created",t.Started="started",t.Destroyed="destroyed",t}(),ie=function(){function t(t){this._activity=t}return t.prototype.register=function(e,n){this._ensureHasAgm(),t.AGM.register(e,n)},t.prototype.servers=function(){return this._ensureHasAgm(),zt(this._activity)?[]:this._activity.windows.map((function(t){return t.instance}))},t.prototype.methods=function(){var t=this;if(this._ensureHasAgm(),zt(this._activity))return[];var e=this._activity.windows,n=[],i=[];return e.forEach((function(e){t.methodsForWindow(e).forEach((function(t){-1===n.indexOf(t.name)&&(n.push(t.name),i.push(t))}))})),i},t.prototype.methodsForWindow=function(e){return this._ensureHasAgm(),e.instance?t.AGM.methodsForInstance(e.instance):[]},t.prototype.invoke=function(e,n,i,o,r,s){this._ensureHasAgm();var a=this.servers();if(zt(i)&&(i="activity.all"),qt(i))if("activity.all"===i)a;else{if("activity.best"!==i){if("all"===i||"best"===i)return function(t,e,n){if("function"!=typeof e&&"function"!=typeof n)return t;"function"!=typeof e?e=function(){}:"function"!=typeof n&&(n=function(){}),t.then(e,n)}(t.AGM.invoke(e,n,i,o),r,s);throw new Error("Invalid invoke target "+i)}var c=a.filter((function(n){return t.AGM.methodsForInstance(n).filter((function(t){return t.name===e})).length>0}));c.length>0&&[c[0]]}else if(Ut(i)){if(i.length>=0){var u=i[0];if(this._isInstance(u))i.map((function(t){return t}));else{if(!this._isActivityWindow(u))throw new Error("Unknown target object");i.map((function(t){return t.instance}))}}}else if(this._isInstance(i))[i];else{if(!this._isActivityWindow(i))throw new Error("Unknown target object");[i.instance]}throw new Error("Not implemented")},t.prototype.unregister=function(e){return this._ensureHasAgm(),t.AGM.unregister(e)},t.prototype.createStream=function(e,n,i){this._ensureHasAgm(),t.AGM.createStream(e,{subscriptionAddedHandler:n,subscriptionRemovedHandler:i,subscriptionRequestHandler:void 0})},t.prototype.subscribe=function(e,n,i){return this._ensureHasAgm(),t.AGM.subscribe(e,n)},t.prototype._ensureHasAgm=function(){if(zt(t.AGM))throw new Error("Agm should be configured to be used in activity")},t.prototype._isInstance=function(t){return void 0!==t.application},t.prototype._isActivityWindow=function(t){return void 0!==t.instance},t}(),oe=function(){function t(t,e,n){this._manager=t,this._ownerActivityId=e,this._state=n}return Object.defineProperty(t.prototype,"ownerId",{get:function(){return this._state.ownerId},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"windowIds",{get:function(){return this._state.windowIds},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"frameColor",{get:function(){return this._state.frameColor},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"context",{get:function(){return this._state.context},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"tag",{get:function(){return this._state.tag},enumerable:!0,configurable:!0}),t.prototype.detach=function(t){var e=this;t=t||{};var n={};return Object.keys(this._state).forEach((function(t){n[t]=e._state[t]})),n.context=t.context||n.context,n.frameColor=t.frameColor||n.frameColor,this._manager.detachActivities(this._ownerActivityId,n)},t}(),re=function(t){setTimeout(t,0)};function se(t,e){if(!Jt(e))return t;t.then((function(t){re((function(){e(null,t)}))}),(function(t){re((function(){e(t,null)}))}))}var ae=function(t){function e(e,n,i,o,r){var s=t.call(this,e)||this;return s._id=e,s._actType=n,s._status=i,s._context=o,s._ownerId=r,s._agm=new ie(s),s}return Nt(e,t),Object.defineProperty(e.prototype,"type",{get:function(){if(this._manager)return this._manager.getActivityType(this._actType)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"context",{get:function(){return this._context},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"status",{get:function(){return this._status},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"owner",{get:function(){return this._ownerId?this._manager.getWindows({id:this._ownerId})[0]:null},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"windows",{get:function(){return this._manager.getWindows({activityId:this._id})},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"agm",{get:function(){return this._agm},enumerable:!0,configurable:!0}),e.prototype.addWindow=function(t,e){return this._manager.addWindowToActivity(this,t,e)},e.prototype.createWindow=function(t,e){return this._manager.createWindow(this,t,e)},e.prototype.createStackedWindows=function(t,e,n){return this._manager.createStackedWindows(this,t,e,n)},e.prototype.leave=function(t,e){return this._manager.leaveWindowFromActivity(this,t,e)},e.prototype.getWindowsByType=function(t){var e={activityId:this._id,type:t};return this._manager.getWindows(e)},e.prototype.setContext=function(t,e){return this._manager.setActivityContext(this,t,e)},e.prototype.updateContext=function(t,e){return this._manager.updateActivityContext(this,t,e)},e.prototype.onStatusChange=function(t){var e=this;return this._manager.subscribeActivityEvents((function(n,i,o){n.id===e.id&&t(n,i,o)}))},e.prototype.onWindowEvent=function(t){var e=this;return this._manager.subscribeWindowEvents((function(n,i,o){n.id===e.id&&t(n,i,o)}))},e.prototype.onContextChanged=function(t){var e=this;this._manager.subscribeActivityContextChanged((function(n,i,o,r){n.id===e.id&&t(i,o,r,n)}));try{t(this.context,this.context,[],this)}catch(t){return}},e.prototype.stop=function(){this._manager.stopActivity(this)},e.prototype.clone=function(t){return this._manager.clone(this,t)},e.prototype.attach=function(t,e){var n;return n="string"==typeof t?t:t.id,this._manager.attachActivities(n,this.id,e)},e.prototype.onActivityAttached=function(t){var e=this;this._manager.subscribeActivitiesAttached((function(n,i,o){n===e._id&&t(o)}))},e.prototype.onDetached=function(t){var e=this;this._manager.subscribeActivitiesDetached((function(n,i,o){i.id===e._id&&t(n,o)}))},e.prototype._updateCore=function(e){var n=this;t.prototype._updateCore.call(this,e),Kt(e._actType,(function(t){return n._actType=t})),Kt(e._context,(function(t){return n._context=t})),Kt(e._ownerId,(function(t){return n._ownerId=t})),!e._status||this._status&&this._status.state===e._status.state||(this._status=e._status)},e.prototype._updateDescriptors=function(t){var e=this;this._attached=t.map((function(t){return new oe(e._manager,e._id,t)}))},Object.defineProperty(e.prototype,"attached",{get:function(){return this._attached},enumerable:!0,configurable:!0}),e.prototype.setFrameColor=function(t,e){var n=this;return se(new Promise((function(e,i){var o=n.windows.length;0===o&&e(n),n.windows.forEach((function(i){i.underlyingWindow.setFrameColor(t,(function(){--o<=0&&e(n)}))})),setTimeout((function(){o>0&&i(n.id+" - timed out waiting for setFrameColor with"+t)}),5e3)})),e)},e.prototype.getFrameColor=function(){return this.windows&&0!==this.windows.length?this.windows[0].underlyingWindow.frameColor:""},e}(Ht),ce=function(){function t(){}return t.Trace="trace",t.Debug="debug",t.Info="info",t.Warn="warn",t.Error="error",t}(),ue=function(){function t(e){this._name=e,zt(t.GlueLogger)||(this._glueLogger=t.GlueLogger.subLogger(e))}return t.GetNamed=function(e){return new t(e)},t.Get=function(e){return new t(t.GetTypeName(e))},t.prototype.trace=function(e){zt(this._glueLogger)?t.Level===ce.Trace&&console.info(this._getMessage(e,ce.Trace)):this._glueLogger.trace(e)},t.prototype.debug=function(e){zt(this._glueLogger)?t.Level!==ce.Debug&&t.Level!==ce.Trace||console.info(this._getMessage(e,ce.Debug)):this._glueLogger.debug(e)},t.prototype.info=function(e){zt(this._glueLogger)?t.Level!==ce.Debug&&t.Level!==ce.Trace&&t.Level!==ce.Info||console.info(this._getMessage(e,ce.Info)):this._glueLogger.info(e)},t.prototype.warn=function(e){zt(this._glueLogger)?t.Level!==ce.Debug&&t.Level!==ce.Trace&&t.Level!==ce.Info&&t.Level!==ce.Warn||console.info(this._getMessage(e,ce.Info)):this._glueLogger.warn(e)},t.prototype.error=function(t){zt(this._glueLogger)?(console.error(this._getMessage(t,ce.Error)),console.trace()):this._glueLogger.error(t)},t.prototype._getMessage=function(t,e){return"["+e+"] "+this._name+" - "+t},t.GetTypeName=function(t){var e=/function (.{1,})\(/.exec(t.constructor.toString());return e&&e.length>1?e[1]:""},t.Level=ce.Info,t}(),de=function(t){function e(e,n,i,o,r,s,a,c){var u=t.call(this,e)||this;return u._logger=ue.Get("window"),u._type=i,u._activityId=o,u._name=n,u._instance=r,u._isIndependent=s,u._windowGetter=a,u._hcWindowId=c,u}return Nt(e,t),e.prototype.getBounds=function(){return this._manager.getWindowBounds(this.id)},Object.defineProperty(e.prototype,"name",{get:function(){return this._name},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"isIndependent",{get:function(){return this._isIndependent},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"type",{get:function(){if(this._manager)return this._manager.getWindowType(this._type)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"activity",{get:function(){if(!Vt(this._activityId))return this._manager.getActivityById(this._activityId)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"isOwner",{get:function(){var t=this.activity;return!Vt(t)&&t.owner.id===this.id},enumerable:!0,configurable:!0}),e.prototype.setVisible=function(t,e){return this._manager.setWindowVisibility(this.id,t)},e.prototype.activate=function(t){return this._manager.activateWindow(this.id,t)},e.prototype.setBounds=function(t,e){return this._manager.setWindowBounds(this.id,t,e)},e.prototype.close=function(){return this._manager.closeWindow(this.id)},Object.defineProperty(e.prototype,"instance",{get:function(){return this._instance},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"underlyingWindow",{get:function(){var t=this._windowGetter();return t||{id:this._hcWindowId}},enumerable:!0,configurable:!0}),e.prototype.onActivityJoined=function(t){this._subscribeForActivityWindowEvent(ee.ActivityWindowJoinedActivity,t)},e.prototype.onActivityRemoved=function(t){this._subscribeForActivityWindowEvent(ee.ActivityWindowLeftActivity,t)},e.prototype._updateCore=function(t){var e=this;Kt(t._activityId,(function(t){return e._activityId=t})),Kt(t._isIndependent,(function(t){return e._isIndependent=t})),Kt(t._hcWindowId,(function(t){return e._hcWindowId=t})),Kt(t._type,(function(t){return e._type=t})),Kt(t._name,(function(t){return e._name=t})),zt(t._instance)||(this._instance=t._instance)},e.prototype._subscribeForActivityWindowEvent=function(t,e){var n=this;this._manager.subscribeWindowEvents((function(i,o,r){o.id===n.id&&r===t&&e(i)}))},e.prototype._beforeDelete=function(t){this._hcWindowId=t._hcWindowId},e}(Ht),pe=function(){function t(t,e,n){this.state=t,this.message=e,this.time=n}return t.prototype.getState=function(){return this.state},t.prototype.getMessage=function(){return this.message},t.prototype.getTime=function(){return this.time},t}(),he=function(){function t(t,e,n,i){var o=this;if(this._activityChangeCallbacks=[],this._activityTypeStatusChangeCallbacks=[],this._activityWindowChangeCallbacks=[],this._windowTypeStatusChangeCallbacks=[],this._peerIdAndFactoryIdToPeerType={},this._peerFactoriesRegisteredByUs={},this._gw3Subscriptions=[],this._contextSubscriptions={},this._activityTypesInitiatedFromMe={},this._config=i,this._connection=t,this._logger=e,this._contexts=n,this._sessionJoinedPromise=new Promise((function(t){o._sessionJoinedPromiseResolve=t})),this._activityJoinedPromise=new Promise((function(t){o._activityJoinedPromiseResolve=t})),this._config.activityId||this._activityJoinedPromiseResolve({}),this._gw3Session=t.domain("activity",["joined","initiated","peer-created","token"]),"undefined"!=typeof window){var r=window.glue42gd;r&&"function"==typeof r.addRefreshHandler&&r.addRefreshHandler((function(t,e){o._gw3Session.send({type:"reload"}).then((function(n){if(n.token){try{r.setGWToken(n.token)}catch(t){return void e(t.message||t)}t()}else e("Expected gateway token for refreshing.")}),e)}))}}return t.activityTypeGwMessageEntityToActivityType=function(t,e){var n=function(t){return new Yt(t,void 0)};return new Zt(t.name,t.owner_type&&n(t.owner_type),t.helper_types&&t.helper_types.map(n),e)},t.peerFactoryGwMessageEntityToWindowType=function(t){return new Yt(t.peer_type,(function(t){}))},t.activityGwMessageToActivity=function(t,e){var n=void 0!==t.owner?t.owner.peer_id:t.owner_id;return new ae(t.activity_id,t.activity_type,e,t.context_snapshot,n)},t.activityToActivityStatusChangeEvent=function(t){return new Xt(t,new $t(t.status,void 0))},Object.defineProperty(t.prototype,"bridgeType",{get:function(){return"GW3"},enumerable:!0,configurable:!0}),t.prototype.init=function(){var t=this;this.forwardActivityTypeMessagesToStatusEventHandlers(),this.subscribe("created",this.handleActivityCreatedMessage),this.subscribe("destroyed",this.handleActivityDestroyedMessage),this.forwardActivityMessagesToStatusEventHandlers(),this.forwardActivityCreatedAndJoinedActivityToActivityWindowEventHandlers(),this.forwardPeerFactoryMessagesToStatusEventHandlers(),this.forwardPeerFactoryMessagesToPeerFactoryRequests(),this.subscribe("peer-factories-added",this.handlePeerFactoriesAdded),this.subscribe("peer-factories-removed",this.handlePeerFactoriesRemoved),this.forwardActivityWindowMessagesToEventHandlers(),this.subscribe("dispose-peer",(function(){if("dispose"!==t._config.disposeRequestHandling){if("exit"===t._config.disposeRequestHandling){if("undefined"!=typeof window&&"function"==typeof window.close)return void window.close();if("undefined"!=typeof process&&"function"==typeof process.exit)return void process.exit()}}else t.dispose()})),this._gw3Session.onJoined((function(){"trackMyOnly"===t._config.mode||"trackMyTypeAndInitiatedFromMe"===t._config.mode?t._sessionJoinedPromiseResolve(t):t._gw3Session.send({type:"subscribe",activity_types:"trackAll"===t._config.mode?[]:"trackTypes"===t._config.mode?t._config.typesToTrack:[]}).then((function(){t._sessionJoinedPromiseResolve(t)}))})),this._gw3Session.join()},t.prototype.dispose=function(){var t=this;this._gw3Subscriptions.forEach((function(e){return e&&t._connection.off(e)})),this._gw3Subscriptions.length=0},t.prototype.ready=function(){return Promise.all([this._sessionJoinedPromise,this._activityJoinedPromise])},t.prototype.initReady=function(){return this._sessionJoinedPromise},t.prototype.onActivityTypeStatusChange=function(t){this._activityTypeStatusChangeCallbacks.push(t)},t.prototype.registerActivityType=function(e,n,i,o,r){var s=this,a={};a.name=e;var c=function(t){return{type:t.type,name:t.name,configuration:t}};return a.owner_type=c(n),a.helper_types=i.map(c),this._gw3Session.send({type:"add-types",types:[a]}).then((function(){var e=t.activityTypeGwMessageEntityToActivityType(a,r);return s.invokeCallbacks(s._activityTypeStatusChangeCallbacks,new Xt(e,new Qt(ee.Added)),"add-types"),e}))},t.prototype.unregisterActivityType=function(t){var e=this;return this._gw3Session.send({type:"remove-types",types:[t]}).then((function(){var n=new Zt(t,void 0,void 0,void 0);e.invokeCallbacks(e._activityTypeStatusChangeCallbacks,new Xt(n,new Qt(ee.Removed)),"add-types")}))},t.prototype.onWindowTypeStatusChange=function(t){this._windowTypeStatusChangeCallbacks.push(t)},t.prototype.registerWindowFactory=function(e,n,i){var o=this;if(this._peerFactoriesRegisteredByUs[e])return Promise.reject(new Error("Factory for windowType "+e+" already registered."));this._peerFactoriesRegisteredByUs[e]=n;var r={id:e,peer_type:e,configuration:i};return this._gw3Session.send({type:"add-peer-factories",factories:[r]}).then((function(){o.invokeCallbacks(o._windowTypeStatusChangeCallbacks,new Xt(t.peerFactoryGwMessageEntityToWindowType(r),new Qt(ee.Added)),"add-peer-factories")})).catch((function(){delete o._peerFactoriesRegisteredByUs[e]}))},t.prototype.unregisterWindowFactory=function(t){var e=this;return this._peerFactoriesRegisteredByUs[t]?(delete this._peerFactoriesRegisteredByUs[t],this._gw3Session.send({type:"remove-peer-factories",factory_ids:[t]}).then((function(){e.invokeCallbacks(e._windowTypeStatusChangeCallbacks,new Xt(new Yt(t,void 0),new Qt(ee.Removed)),"add-peer-factories")}))):Promise.reject(new Error("Factory for windowType "+t+" not registered."))},t.prototype.onActivityStatusChange=function(t){this._activityChangeCallbacks.push(t)},t.prototype.initiateActivity=function(t,e,n){var i=this,o={type:"create",activity_type:t,initial_context:e};return this.isOverrideTypeDefinition(n)?o.types_override={owner_type:{type:n.owner.type,name:n.owner.name,configuration:n.owner},helper_types:n.helpers&&n.helpers.map((function(t){return{type:t.type,name:t.name,configuration:t}}))}:o.configuration=n&&n.map((function(t){return{type:t.type,name:t.name,configuration:t}})),this.sendCreateAndMapResultingMessagesToPromise(o,"initiated",(function(t,e){return t.request_id===e}),"created",(function(t,e,n){return t.activity_id===n.activity_id}),"destroyed",(function(t,e,n){return t.activity_id===n.activity_id}),(function(t){return t.activity_id})).then((function(e){return"trackMyTypeAndInitiatedFromMe"!==i._config.mode||i._activityTypesInitiatedFromMe[t]?e:(i._activityTypesInitiatedFromMe[t]=!0,i._gw3Session.send({type:"subscribe",activity_types:[t]}).then((function(){return e})))}))},t.prototype.stopActivity=function(t){return this._gw3Session.send({type:"destroy",activity_id:t.id,reason_uri:"com.tick42.glue.activity.constants.destroyReason.general",reason:"Destroying activity"}).then((function(t){return!0}))},t.prototype.updateActivityContext=function(t,e,n,i){if(n)return this._contexts.set(t.id,e);for(var o=0,r=i=i||[];o<r.length;o++){e[r[o]]=null}return this._contexts.update(t.id,e)},t.prototype.announceWindow=function(t,e){throw new Error("Invalid operation 'announceWindow' for GW3 protocol")},t.prototype.registerWindow=function(t,e,n){var i=void 0!==this._connection.gatewayToken,o=this._connection.peerId;if("undefined"!=typeof window){var r=window.glue42gd;r&&(i=void 0!==r.activityInfo)}return i&&this._gw3Session.send({type:"ready"}),this.invokeCallbacks(this._activityWindowChangeCallbacks,new Xt(new de(o,e,t,void 0,this.getAgmInstance(o),n,this.generateWindowGetter(o),void 0),new Qt(ee.Added)),"register window"),Promise.resolve(o)},t.prototype.onActivityWindowChange=function(t){this._activityWindowChangeCallbacks.push(t)},t.prototype.createWindow=function(t,e){var n=this;return e.layout||(e.left||e.width||e.height||e.top)&&(e.layout={mode:"pixels",cellSize:1}),this.sendCreateAndMapResultingMessagesToPromise({type:"create-peer",peer_type:e.type,peer_name:e.name||e.type,configuration:e,activity_id:t},void 0,void 0,"peer-created",(function(t,e){return t.request_id===e}),void 0,void 0,(function(t){return t.created_id})).then((function(i){if(t)return n.joinActivity(t,i,e.name).then((function(){return i}))}))},t.prototype.closeWindow=function(t){return this._gw3Session.send({destroy_peer_id:t}).then((function(t){}))},t.prototype.getAnnouncementInfo=function(){var t=this._config.activityId||this._config.announcementInfo&&this._config.announcementInfo.activityId,e=this._config.announcementInfo&&this._config.announcementInfo.activityWindowType,n=this._config.announcementInfo&&this._config.announcementInfo.activityWindowIndependent,i=this._config.announcementInfo&&this._config.announcementInfo.activityWindowName;if("undefined"!=typeof window&&void 0!==window.location&&window.location.search&&"function"==typeof URLSearchParams){var o=new URLSearchParams(location.search.slice(1));e=(e=e||o.get("t42PeerType"))||o.get("t42ActivityWindowType"),void 0===n&&(n=o.get("t42ActivityWindowIndependent")),i=i||o.get("t42ActivityWindowName"),t=t||o.get("t42ActivityId")}return{activityWindowId:void 0,activityId:t,activityWindowType:e=e||"unknown",activityWindowIndependent:n=n||!1,activityWindowName:i=i||this._connection.peerId}},t.prototype.joinActivity=function(t,e,n){var i=this,o=n&&{name:n}||{};return this._gw3Session.send(Dt({type:"join-activity",target_id:e,activity_id:t},o)).then((function(){i.invokeCallbacks(i._activityWindowChangeCallbacks,new Xt(new de(e,void 0,void 0,t,i.getAgmInstance(e),void 0,i.generateWindowGetter(e),void 0),new Qt(ee.ActivityWindowJoinedActivity)),"activity joined - ActivityWindow"),i.invokeCallbacks(i._activityChangeCallbacks,new Xt(new ae(t,void 0,new pe("created",void 0,void 0),void 0,void 0),new Qt(ee.Updated)),"activity joined - Activity")}))},t.prototype.leaveActivity=function(t,e){var n=this;return this._gw3Session.send({type:"leave-activity",target_id:e,activity_id:t}).then((function(){n.invokeCallbacks(n._activityWindowChangeCallbacks,new Xt(new de(e,void 0,void 0,null,n.getAgmInstance(e),void 0,n.generateWindowGetter(e),void 0),new Qt(ee.ActivityWindowLeftActivity)),"activity left - ActivityWindow"),n.invokeCallbacks(n._activityChangeCallbacks,new Xt(new ae(t,void 0,new pe("created",void 0,void 0),void 0,void 0),new Qt(ee.Updated)),"activity left - Activity")}))},t.prototype.getActivityTypes=function(){return Promise.resolve([])},t.prototype.getWindowTypes=function(){return Promise.resolve([])},t.prototype.getActivities=function(){return Promise.resolve([])},t.prototype.getActivityWindows=function(){return Promise.resolve([])},t.prototype.createStackedWindows=function(t,e,n){},t.prototype.getWindowBounds=function(t){},t.prototype.setWindowBounds=function(t,e){},t.prototype.activateWindow=function(t,e){},t.prototype.setWindowVisibility=function(t,e){},t.prototype.cloneActivity=function(t,e){},t.prototype.attachActivities=function(t,e,n){return this._gw3Session.send({type:"merge",into:e,merge:t})},t.prototype.detachActivities=function(t,e){return this._gw3Session.send({type:"split",from:t}).then((function(){return""}))},t.prototype.onActivitiesAttached=function(t){},t.prototype.onActivitiesDetached=function(t){},t.prototype.onActivityAttachedDescriptorsRefreshed=function(t){},t.prototype.getAttachedDescriptors=function(){return Promise.resolve([])},t.prototype.getRandomRequestId=function(){return this._connection.peerId+":"+Math.floor(1e9*Math.random())},t.prototype.forwardAddedAndRemovedMessagesToEventHandler=function(t,e,n,i){var o=function(t){return function(e){return new Xt(e,new Qt(t?ee.Added:ee.Removed))}};return[t&&this.forwardMessageToEventHandler(t,(function(t){return n(t,!0)}),o(!0),i),e&&this.forwardMessageToEventHandler(e,(function(t){return n(t,!1)}),o(!1),i)].filter((function(t){return t}))},t.prototype.forwardMessageToEventHandler=function(t,e,n,i){return this.subscribe(t,(function(t){e(t).forEach((function(e){return i.forEach((function(i){return i(n(e,t))}))}))}))},t.prototype.sendCreateAndMapResultingMessagesToPromise=function(t,e,n,i,o,r,s,a){var c,u,d,p,h,f,l=this,y=this.getRandomRequestId(),g=new Promise((function(t,e){c=t,u=e})),v=null,m=function(){l.dropSubscription(d),l.dropSubscription(p),l.dropSubscription(h),l.dropSubscription(f)};d=e&&this.subscribe(e,(function(t){n(t,y)&&(v=t,l.dropSubscription(d))})),p=this.subscribe(i,(function(t){o(t,y,v)&&c(a(t))})),h=r&&this.subscribe(r,(function(t){s(t,y,v)&&u(t)})),f=r&&this.subscribe("error",(function(t){t.request_id===y&&u(t)})),t.request_id=y;var w=this._gw3Session.send(t).then((function(){return g}));return w.then(m,m),w},t.prototype.peerFactoryIdAndOwnerIdToWindowType=function(t,e){var n=this._peerIdAndFactoryIdToPeerType[e+":"+t];return n?new Yt(n,void 0):null},t.prototype.subscribe=function(t,e){var n=this,i=this._connection.on(t,(function(t){return e.bind(n)(t)}));return this._gw3Subscriptions.push(i),i},t.prototype.dropSubscription=function(t){t&&(this._connection.off(t),delete this._gw3Subscriptions[this._gw3Subscriptions.indexOf(t)])},t.prototype.invokeCallbacks=function(t,e,n){var i=this;t.forEach((function(t){try{t(e)}catch(t){i._logger.error("Error in "+(n||e.context.type)+" callback: "+JSON.stringify(t))}}))},t.prototype.handleActivityCreatedMessage=function(t){t.context_id?this._contextSubscriptions[t.activity_id]||this.subscribeToContext(t):this._logger.error("Activity created with unknown context_id: "+t.activity_id)},t.prototype.subscribeToContext=function(t){return Gt(this,void 0,void 0,(function(){var e,n,i,o=this;return Bt(this,(function(r){switch(r.label){case 0:return e=t.activity_id,n=this._contextSubscriptions,i=e,[4,this._contexts.subscribe(e,(function(t,n,i){var r=new Xt(new ae(e,void 0,void 0,t,void 0),new te(t,n,i));o.invokeCallbacks(o._activityChangeCallbacks,r,"context updated")}))];case 1:return n[i]=r.sent(),[2]}}))}))},t.prototype.handleActivityDestroyedMessage=function(t){var e=this._contextSubscriptions[t.activity_id];"function"==typeof e&&e(),delete this._contextSubscriptions[t.activity_id]},t.prototype.handlePeerFactoriesAdded=function(t){var e=this;t.factories.forEach((function(n){e._peerIdAndFactoryIdToPeerType[t.owner_id+":"+n.id]=n.peer_type}))},t.prototype.handlePeerFactoriesRemoved=function(t){var e=this;t.factory_ids.forEach((function(n){delete e._peerIdAndFactoryIdToPeerType[t.owner_id+":"+n]}))},t.prototype.forwardActivityTypeMessagesToStatusEventHandlers=function(){this.forwardAddedAndRemovedMessagesToEventHandler("types-added","types-removed",(function(e,n){return n?e.types.map((function(e){return t.activityTypeGwMessageEntityToActivityType(e,void 0)})):e.types.map((function(t){return new Zt(t.name,void 0,void 0,void 0)}))}),this._activityTypeStatusChangeCallbacks)},t.prototype.forwardActivityCreatedAndJoinedActivityToActivityWindowEventHandlers=function(){for(var t=this,e=0,n=["created","joined","owner-changed"];e<n.length;e++){var i=n[e];this.forwardMessageToEventHandler(i,(function(e){return[e.owner||Dt(Dt({},e),{type:e.peer_type,name:e.peer_name,peer_id:e.owner_id})].concat(e.participants||[]).map((function(n){return new de(n.peer_id,n.name,n.type,e.activity_id,t.getAgmInstance(n.peer_id),void 0,t.generateWindowGetter(n.peer_id),void 0)}))}),(function(t,e){return new Xt(t,new Qt(ee.ActivityWindowJoinedActivity))}),this._activityWindowChangeCallbacks)}},t.prototype.forwardActivityMessagesToStatusEventHandlers=function(){for(var e=0,n=["created","joined"];e<n.length;e++){var i=n[e];this.forwardMessageToEventHandler(i,(function(e){return[t.activityGwMessageToActivity(e,new pe("started","",new Date))]}),(function(e,n){return t.activityToActivityStatusChangeEvent(e)}),this._activityChangeCallbacks)}this.forwardMessageToEventHandler("destroyed",(function(e){return[t.activityGwMessageToActivity(e,new pe("destroyed",e.reason,new Date))]}),(function(e,n){return t.activityToActivityStatusChangeEvent(e)}),this._activityChangeCallbacks),this.forwardMessageToEventHandler("initiated",(function(e){return[t.activityGwMessageToActivity(e,new pe("created","",new Date))]}),(function(e,n){return t.activityToActivityStatusChangeEvent(e)}),this._activityChangeCallbacks),this.forwardMessageToEventHandler("owner-changed",(function(e){return[t.activityGwMessageToActivity(e,new pe("created","",new Date))]}),(function(e,n){return t.activityToActivityStatusChangeEvent(e)}),this._activityChangeCallbacks)},t.prototype.forwardPeerFactoryMessagesToStatusEventHandlers=function(){var e=this;this.forwardAddedAndRemovedMessagesToEventHandler("peer-factories-added","peer-factories-removed",(function(n,i){return i?n.factories.map(t.peerFactoryGwMessageEntityToWindowType):n.factory_ids.map((function(t){return e.peerFactoryIdAndOwnerIdToWindowType(t,n.owner_id)})).filter((function(t){return null!=t}))}),this._windowTypeStatusChangeCallbacks)},t.prototype.forwardPeerFactoryMessagesToPeerFactoryRequests=function(){var t=this;this.subscribe("peer-requested",(function(e){var n=t._peerFactoriesRegisteredByUs[e.peer_factory];if(n)try{var i=e.configuration||{};i.gateway_token=i.gateway_token||e.gateway_token,i.peer_factory=i.peer_factory||e.peer_factory;var o=n({activityId:e.activity&&e.activity.id,activityType:e.activity&&e.activity.type,type:e.configuration&&e.configuration.type,gwToken:i.gateway_token,configuration:i});o&&o.then&&o.catch&&o.catch((function(n){return t._gw3Session.send({type:"error",request_id:e.request_id,reason:n&&(n.message||JSON.stringify(n))})}))}catch(n){t._gw3Session.send({type:"error",request_id:e.request_id,reason:n&&(n.message||JSON.stringify(n))})}else t._gw3Session.send({type:"error",request_id:e.request_id,reason:"Unknown peer factory "+e.peer_factory})}))},t.prototype.forwardActivityWindowMessagesToEventHandlers=function(){for(var t=this,e=function(e){n.subscribe(e,(function(n){var i="activity-joined"===e?n.joined_id:n.peer_id,o="activity-joined"===e?n.joined_type:n.peer_type,r="activity-joined"===e?n.joined_name:n.peer_name,s=new de(i,r,o,n.activity_id,t.getAgmInstance(i),void 0,t.generateWindowGetter(i),void 0);t._contextSubscriptions[n.activity_id]?"joined"===e&&t._activityJoinedPromiseResolve({}):t.subscribeToContext(n).then((function(){"joined"===e&&t._activityJoinedPromiseResolve({})})),t.invokeCallbacks(t._activityWindowChangeCallbacks,new Xt(s,new Qt(ee.ActivityWindowJoinedActivity)),e)}))},n=this,i=0,o=["activity-joined","joined"];i<o.length;i++){e(o[i])}this.subscribe("left",(function(e){var n=new de(e.left_id,void 0,void 0,null,t.getAgmInstance(e.left_id),void 0,t.generateWindowGetter(e.left_id),void 0);t.invokeCallbacks(t._activityWindowChangeCallbacks,new Xt(n,new Qt(ee.ActivityWindowLeftActivity)),"left")})),this.forwardAddedAndRemovedMessagesToEventHandler("peer-created",void 0,(function(e){return[new de(e.created_id,void 0,void 0,void 0,void 0,void 0,t.generateWindowGetter(e.created_id),void 0)]}),this._activityWindowChangeCallbacks)},t.prototype.getAgmInstance=function(t){return this._config.agm.servers().find((function(e){return e.peerId===t||e.windowId===t}))},t.prototype.generateWindowGetter=function(t){var e=this;return function(){var n=e.getAgmInstance(t);if(n){var i=n.windowId;return e._config.windows.list().filter((function(t){return t.id===i}))[0]}}},t.prototype.isOverrideTypeDefinition=function(t){return void 0!==t&&!!t.owner},t}(),fe=function(){function t(t,e){var n=this;this._myAttached=[],this._myDetached=[],this._myAttachedTo=[],this._myDetachedFrom=[],this._myActivityFrameColorChanged=[],this._myActivityJoinedCallbacks=[],this._myActivityRemovedCallbacks=[],this._myContextUpdateCallbacks=[],this._logger=ue.Get(this),this._m=t,t.ready().then((function(t){t.subscribeActivityContextChanged(n._subscribeMyContextChanged.bind(n)),t.subscribeWindowEvents(n._subscribeMyWindowEvent.bind(n)),t.subscribeActivitiesAttached(n._subscribeActivitiesAttached.bind(n)),t.subscribeActivitiesDetached(n._subscribeActivitiesDetached.bind(n)),e&&e.onWindowFrameColorChanged(n._subscribeWindowFrameColorChanged.bind(n))}))}return Object.defineProperty(t.prototype,"window",{get:function(){if(zt(this._w)){var t=this._m.announcedWindows;t.length>0&&(this._w=t[0])}return this._w},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"activity",{get:function(){var t=this.window;if(!zt(t))return t.activity},enumerable:!0,configurable:!0}),t.prototype.createWindow=function(t){return this._m.createWindow(this.activity,t)},t.prototype.createStackedWindows=function(t,e){return this._m.createStackedWindows(this.activity,t,e)},Object.defineProperty(t.prototype,"context",{get:function(){var t=this.activity;return Vt(t)?{}:t.context},enumerable:!0,configurable:!0}),t.prototype.updateContext=function(t,e){var n=this.activity;return Vt(n)?new Promise((function(t,e){e("Not in activity")})):n.updateContext(t,e)},t.prototype.setContext=function(t,e){var n=this.activity;return Vt(n)?new Promise((function(t,e){e("Not in activity")})):n.setContext(t,e)},t.prototype.onActivityJoined=function(t){this._myActivityJoinedCallbacks.push(t);var e=this.window;zt(e)||zt(e.activity)||t(e.activity)},t.prototype.onActivityLeft=function(t){this._myActivityRemovedCallbacks.push(t)},t.prototype.onContextChanged=function(t){this._myContextUpdateCallbacks.push(t);var e=this.window;if(!zt(e)){var n=e.activity;zt(n)||t(n.context,n.context,[],n)}},t.prototype.clone=function(t,e){var n=this.activity;return this._m.clone(n,t,e)},t.prototype.attach=function(t,e){var n;return n="string"==typeof t?t:t.id,this._m.attachActivities(n,this.activity.id,e)},t.prototype.onActivityAttached=function(t){this._myAttached.push(t)},t.prototype.onActivityDetached=function(t){this._myDetached.push(t)},t.prototype.onAttachedToActivity=function(t){this._myAttachedTo.push(t)},t.prototype.onDetachedFromActivity=function(t){this._myDetachedFrom.push(t)},Object.defineProperty(t.prototype,"attached",{get:function(){return this.activity?this.activity.attached:[]},enumerable:!0,configurable:!0}),t.prototype.setFrameColor=function(t,e){return this.activity?this.activity.setFrameColor(t,e):Promise.resolve(null)},t.prototype.getFrameColor=function(){return this.activity?this.activity.getFrameColor():""},t.prototype.onFrameColorChanged=function(t){this._myActivityFrameColorChanged.push(t)},t.prototype._subscribeMyContextChanged=function(t,e,n,i){var o=this.window;if(!zt(o)){var r=o.activity;zt(r)||t.id===r.id&&this._notifyMyContextChanged(t,e,n,i)}},t.prototype._subscribeMyWindowEvent=function(t,e,n){zt(this.window)||this.window.id===e.id&&(n===ee.ActivityWindowJoinedActivity?(this._notifyMyWindowEvent(t,this._myActivityJoinedCallbacks),this._notifyMyContextChanged(t,t.context,null,null)):n===ee.ActivityWindowLeftActivity&&this._notifyMyWindowEvent(t,this._myActivityRemovedCallbacks))},t.prototype._notifyMyWindowEvent=function(t,e){var n=this;e.forEach((function(e){try{e(t,event)}catch(t){n._logger.warn("error in user callback "+t)}}))},t.prototype._notifyMyContextChanged=function(t,e,n,i){var o=this;n=n||{},i=i||[],this._myContextUpdateCallbacks.forEach((function(r){try{r(e,n,i,t)}catch(t){o._logger.warn("error in user callback "+t)}}))},t.prototype._notifyAttached=function(t){var e=this;this._myAttached.forEach((function(n){try{n(t)}catch(t){e._logger.warn("error in user callback "+t)}}))},t.prototype._notifyDetached=function(t){var e=this;this._myDetached.forEach((function(n){try{n(t)}catch(t){e._logger.warn("error in user callback "+t)}}))},t.prototype._notifyAttachedTo=function(t){var e=this;this._myAttachedTo.forEach((function(n){try{n(e.activity,t)}catch(t){e._logger.warn("error in user callback "+t)}}))},t.prototype._notifyDetachedFrom=function(t,e,n){var i=this;this._myDetachedFrom.forEach((function(o){try{o(t,e,n)}catch(t){i._logger.warn("error in user callback "+t)}}))},t.prototype._subscribeActivitiesAttached=function(t,e){var n=this.window;if(!zt(n)){var i=n.activity;zt(i)||t.id===i.id&&(e.windowIds.indexOf(n.id)>=0?this._notifyAttachedTo(e):this._notifyAttached(e))}},t.prototype._subscribeActivitiesDetached=function(t,e,n){var i=this.window;if(!zt(i)){var o=i.activity;zt(o)||(e.id===o.id&&this._notifyDetached(n),t.id===o.id&&this._notifyDetachedFrom(t,e,n))}},t.prototype._subscribeWindowFrameColorChanged=function(t){var e=this.activity;e&&e.owner&&e.owner.underlyingWindow.id===t.id&&this._myActivityFrameColorChanged.forEach((function(e){e(t.frameColor)}))},t}(),le=function(){function t(t,e){if(this._logger=ue.Get("ReadyMarker ["+t+"]"),this._logger.debug("Initializing ready marker for '"+t+"' with "+e+" signals to wait"),e<=0)throw new Error("Invalid signal number. Should be > 0");this._signals=e,this._callbacks=[],this._name=t}return t.prototype.setCallback=function(t){this.isSet()?t(void 0):this.isError()?t(this._error):this._callbacks.push(t)},t.prototype.signal=function(t){if(this._logger.debug("Signaled - "+t+" - signals left "+(this._signals-1)),this._signals--,this._signals<0)throw new Error("Error in ready marker '"+this._name+" - signals are "+this._signals);this.isSet()&&this._callbacks.forEach((function(t){t(void 0)}))},t.prototype.error=function(t){this._error=t,this._callbacks.forEach((function(e){e(t)}))},t.prototype.isSet=function(){return!this.isError()&&0===this._signals},t.prototype.isError=function(){return!Vt(this._error)},t.prototype.getError=function(){return this._error},t}(),ye=function(){function t(t){this._items={},this._listeners=[],this._processNew=t}return t.prototype.addOne=function(t){this.add([t])},t.prototype.add=function(t){var e=this;t.forEach((function(t){e.process(new Xt(t,new Qt(ee.Added)))}))},t.prototype.process=function(t){var e=t.context,n=e.type,i=t.entity;if(n===ee.StatusChange&&!e.oldStatus){var o=this._items[i.id];o&&(e.oldStatus=o.status)}n===ee.StatusChange&&e.oldStatus&&e.newStatus&&e.oldStatus.state===e.newStatus.state&&(e.type=ee.Updated),"undefined"==typeof htmlContainer&&(n===ee.ActivityWindowJoinedActivity&&this._items[i.id]&&this._items[i.id].activity&&(e.type=ee.Updated),n===ee.ActivityWindowLeftActivity&&this._items[i.id]&&!this._items[i.id].activity&&(e.type=ee.Updated));var r=this._updateInternalCollections(i,n,e);return this._notifyListeners(r,e),r},t.prototype.get=function(){var t=[];for(var e in this._items)if(this._items.hasOwnProperty(e)){var n=this._items[e];t.push(n)}return t},t.prototype.getByName=function(t){for(var e in this._items)if(e===t)return this._items[e]},t.prototype.getOrWait=function(t){var e=this;return new Promise((function(n){var i=function(o){o.id===t&&(n(o),e.unsubscribe(i))};e.subscribe(i);var o=e.getByName(t);if(o)return e.unsubscribe(i),void n(o)}))},t.prototype.subscribe=function(t){var e=this;return this._listeners.push(t),Object.keys(this._items).forEach((function(n){var i=e._items[n];t(i,new Qt(ee.Added.toString()))})),function(){e.unsubscribe(t)}},t.prototype.unsubscribe=function(t){var e=this._listeners.indexOf(t);-1!==e&&this._listeners.splice(e,1)},t.prototype._notifyListeners=function(t,e){this._listeners.forEach((function(n){try{n(t,e)}catch(t){return}}))},t.prototype._updateInternalCollections=function(t,e,n){var i=t,o=e===ee.StatusChange&&i.status&&i.status.state===ne.Destroyed||e===ee.StatusChange&&n&&n.newStatus&&n.newStatus.state===ne.Destroyed,r=e===ee.Closed;if(e===ee.Removed&&void 0===i.isIndependent||r||o){var s=this._items[t.id];return delete this._items[t.id],this._processNew(t),s&&t._beforeDelete(s),t}var a=t.id;return this._items.hasOwnProperty(a)?this._items[t.id]._update(t):(this._processNew(t),this._items[t.id]=t),this._items[t.id]},t}(),ge=function(){function t(t,e,n){var i=this;this._logger=ue.Get("activityManager"),this._announcedWindows=[],this._attachedCallbacks=[],this._detachedCallbacks=[],this._frameColorChangesCallbacks=[],this._windowHandlers=[],this._bridge=t,this._activityTypes=new ye((function(t){return i._grabEntity(t)})),this._windowTypes=new ye((function(t){return i._grabEntity(t)})),this._activities=new ye((function(t){return i._grabEntity(t)})),this._windows=new ye((function(t){return i._grabEntity(t)})),this._dataReadyMarker=new le("Activity Manager Data",["GetActivityTypes","GetWindowTypes","GetActivities","GetWindows"].length),this._descriptorsMarker=new le("Attached Activities Descriptors",["GetDescriptors"].length),e?(this._readyMarker=new le("Activity Manager Announce",["Announcement"].length),this._dataReadyMarker.setCallback((function(t){t&&i._readyMarker.error(t),i._descriptorsMarker.setCallback((function(t){t&&i._readyMarker.error(t),i._logger.debug("Auto announcing window"),i.announceWindow().then((function(t){i._announcedWindows.push(t),i._readyMarker.signal("Successfully announced window with id '"+t.id+"'")})).catch((function(t){i._logger.debug("Will not announce window - "+t),i._readyMarker.signal()}))})),i.refreshDescriptors()}))):this._readyMarker=this._dataReadyMarker,this._bridge.onActivitiesAttached((function(t){i._handleActivitiesAttached(t)})),this._bridge.onActivitiesDetached((function(t){i._handleActivitiesDetached(t)})),this._bridge.onActivityAttachedDescriptorsRefreshed((function(t){i._handleActivityDescriptorsRefreshed(t)})),n&&n.onWindowFrameColorChanged(this._handleWindowFrameColorChanged.bind(this)),this._bridge.init(),this._subscribeForData(),this._bridge.initReady().then((function(t){i._getInitialData()})).catch((function(t){console.log(t)}))}return Object.defineProperty(t.prototype,"usingHc",{get:function(){return"HC"===this._bridge.bridgeType},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"announcedWindows",{get:function(){return this._announcedWindows},set:function(t){throw new Error("not allowed")},enumerable:!0,configurable:!0}),t.prototype.ready=function(t){var e=this,n=new Promise((function(t,n){e._readyMarker.setCallback((function(i){i?n(e._readyMarker.getError()):t(e)}))}));return se(Promise.all([this._bridge.ready(),n]).then((function(){return e})),t)},t.prototype.getActivityTypes=function(){return this._activityTypes.get()},t.prototype.getActivityType=function(t){return this._activityTypes.getByName(t)},t.prototype.registerActivityType=function(t,e,n,i,o,r){var s=this;return se(new Promise((function(r,a){var c;if(zt(t))a("activityTypeName argument can not be undefined");else if(qt(t))if(zt(s.getActivityType(t)))if(Vt(e))a("Owner window type can not be undefined");else{c=qt(e)?{type:e,name:"",isIndependent:!1,arguments:{}}:e;var u=[];if(!Vt(n)&&Ut(n))for(var d in n){var p=n[d];if(qt(p)){var h={type:p,name:"",isIndependent:!1,arguments:{},relativeTo:"",relativeDirection:"",windowStyleAttributes:{}};u.push(h)}else u.push(p)}s._bridge.registerActivityType(t,c,u,i,o).then((function(t){s._grabEntity(t),r(t)})).catch((function(t){a(t)}))}else a("Activity type '"+t+"' already exists");else a("activityTypeName should be string")})),r)},t.prototype.unregisterActivityType=function(t,e){var n=this;return se(new Promise((function(e,i){var o=n.getActivityType(t);Vt(o)?i("Activity type '"+t+"' does not exists"):n._bridge.unregisterActivityType(t).then((function(){return e(o)}),i)})),e)},t.prototype.initiate=function(t,e,n,i){var o=this;return se(new Promise((function(n,r){Vt(o.getActivityType(t))?r("Activity type '"+t+"' does not exists"):o._bridge.initiateActivity(t,e,i).then((function(t){o._activities.getOrWait(t).then((function(t){n(t)})).catch((function(t){return r(t)}))})).catch((function(t){r(t)}))})),n)},t.prototype.subscribeActivityTypeEvents=function(t){this._activityTypes.subscribe((function(e,n){t(e,n.type)}))},t.prototype.getWindowTypes=function(){return this._windowTypes.get()},t.prototype.getWindowType=function(t){return this._windowTypes.getByName(t)},t.prototype.registerWindowFactory=function(t,e,n){var i=this;return se(new Promise((function(n,o){if(zt(t))o("no windowType specified");else{if("object"==typeof(r=t)&&null!==r)t=t.getName();else if(!qt(t))return void o("windowType should be string or object that has getName method");var r;i._bridge.registerWindowFactory(t,e).then((function(t){n(t)})).catch((function(t){o(t)}))}})),n)},t.prototype.unregisterWindowFactory=function(t,e){var n=this;return se(new Promise((function(e,i){zt(t)?i("no windowType specified"):qt(t)?n._bridge.unregisterWindowFactory(t).then((function(t){e(t)})).catch((function(t){i(t)})):i("windowType should be a string")})),e)},t.prototype.getActivities=function(t){var e=this._activities.get();if(e=e.filter((function(t){return t._ownerId})),!t)return e;var n=t;if(qt(t))n=[t];else if(t instanceof Zt)n=[t.name];else if(!(t instanceof Array))throw new Error("Invalid input argument 'activityType' = "+t);return e.filter((function(t){var e=t.type;return function(t,e){for(var n=0;n<t.length;n++)if(e(t[n],n))return!0;return!1}(n,(function(t){return e.id===t.id}))}))},t.prototype.getActivityById=function(t){return this._activities.getByName(t)},t.prototype.announceWindow=function(t,e){var n=this;return new Promise((function(i,o){var r=n._bridge.getAnnouncementInfo();if(Vt(t)&&(t=r.activityWindowId),Vt(e)&&(e=r.activityWindowType),zt(e))throw new Error("Can not announce - unknown windowType");var s=r&&r.activityId;if(zt(t))n._logger.debug("Registering window with type:'"+e+"', name:'"+r.activityWindowName+"', ind.:'"+r.activityWindowIndependent+"'"),n._bridge.registerWindow(e,r.activityWindowName,r.activityWindowIndependent).then(n._windows.getOrWait.bind(n._windows)).then((function(t){return s?n._activities.getOrWait(s).then((function(e){return t})):t})).then((function(t){i(t)})).catch((function(t){n._logger.error(t)}));else{n._logger.debug("Announcing window with id '"+t+"' and type '"+e+"'");var a=n._windows.getByName(t);if(!zt(a))return n._logger.debug("Window with id '"+t+"' already announced - reusing the window"),void i(a);var c=function(e,r,s){t===r.id&&(s===ee.ActivityWindowJoinedActivity&&(Vt(r.activity)&&o("UNDEFINED ACTIVITY"),n._logger.trace("Got joined event for id '"+t+"'"),i(r),n.unsubscribeWindowEvents(c)))};n.subscribeWindowEvents(c),n._logger.trace("Waiting for joined event for id '"+t+"'"),n._bridge.announceWindow(e,t)}}))},t.prototype.subscribeWindowTypeEvents=function(t){this._windowTypes.subscribe((function(e,n){t(e,n.type)}))},t.prototype.subscribeActivityEvents=function(t){var e=this;return this._activities.subscribe((function(n,i){if(i.type===ee.StatusChange){var o=i;t(n,o.newStatus,o.oldStatus)}if(i.type===ee.Removed||i.type===ee.StatusChange&&i.newStatus.getState()===ne.Destroyed)for(var r=0,s=e._windows.get();r<s.length;r++){var a=s[r];a.activity&&a.activity.id===n.id&&e._windows.process(new Xt(a,new Qt(ee.ActivityWindowLeftActivity)))}}))},t.prototype.subscribeWindowEvents=function(t){var e=function(e,n){var i=n.type;i===ee.Added&&(i="opened"),t(e.activity,e,i)};return this._windowHandlers.push([t,e]),this._windows.subscribe(e)},t.prototype.unsubscribeWindowEvents=function(t){var e=this._windowHandlers.find((function(e){return e[0]===t}));e&&(this._windowHandlers.splice(this._windowHandlers.indexOf(e),1),this._windows.unsubscribe(e[1]))},t.prototype.createWindow=function(t,e,n){var i=this;return se(new Promise((function(n,o){var r,s;if(zt(e)&&o("windowType is undefined"),!zt((r=qt(e)?{type:e,name:"",isIndependent:!1,arguments:{}}:e instanceof Yt?{type:e.type||e.id,name:e.name||e.type||e.id,isIndependent:!1}:e).relativeTo))if("string"==typeof(s=r.relativeTo))!zt(a=i.getWindows({type:s}))&&a.length>0&&(r.relativeTo=a[0].id);else if(zt(s.type))zt(s.windowId)||(r.relativeTo=s.windowId);else{var a;!zt(a=i.getWindows({type:s.type}))&&a.length>0&&(r.relativeTo=a[0].id)}i._bridge.createWindow(t&&t.id,r).then((function(e){i._logger.debug("Window created, waiting for window entity with id "+e);var o=function(r,s){r.id!==e||t&&!r.activity||(i._logger.debug("Got entity window with id "+e),n(r),i._windows.unsubscribe(o))};i._windows.subscribe(o)})).catch((function(t){o(t)}))})),n)},t.prototype.createStackedWindows=function(t,e,n,i){var o=this;return se(new Promise((function(i,r){zt(t)&&r("activity is undefined"),zt(e)&&r("relativeWindowTypes is undefined"),Array.isArray(e)||r("relativeWindowTypes has to be array"),zt(n)&&(n=2e4);var s=[];e.forEach((function(t){var e,n;if(!zt((e=qt(t)?{type:t,name:"",isIndependent:!1,arguments:{}}:t).relativeTo))if(zt((n=e.relativeTo).type)){if(!zt(n.windowId)){var i=o.getWindows({id:n.windowId});!zt(i)&&i.length>0&&(e.relativeTo=i[0].type.name,e.useExisting=!0)}}else e.relativeTo=n.type;s.push(e)})),o._bridge.createStackedWindows(t.id,s,n).then((function(t){var e=[],n=[],r=function(o,s){t.indexOf(o.id)>=0&&n.indexOf(o.id)<0&&o.activity&&(this._logger.debug("Got entity window with id "+t),e.push(o),n.push(o.id),e.length===t.length&&(i(e),this._windows.unsubscribe(r)))}.bind(o);o._windows.subscribe(r)})).catch((function(t){r(t)}))})),i)},t.prototype.addWindowToActivity=function(t,e,n){var i=this._bridge.joinActivity(t.id,e.id).then((function(){return e}));return se(i,n),i},t.prototype.leaveWindowFromActivity=function(t,e,n){var i=this._bridge.leaveActivity(t.id,e.id).then((function(){return e}));return se(i,n),i},t.prototype.setActivityContext=function(t,e,n){var i=this;return se(new Promise((function(n,o){zt(t)&&o("activity can not be null"),i._bridge.updateActivityContext(t,e,!0).then((function(e){n(t)})).catch((function(t){o(t)}))})),n)},t.prototype.updateActivityContext=function(t,e,n){var i=this;return se(new Promise((function(n,o){zt(t)&&o("activity can not be null");var r=[];for(var s in e)e.hasOwnProperty(s)&&null===e[s]&&r.push(s);for(var a=0,c=r;a<c.length;a++){var u=c[a];delete e[u]}i._bridge.updateActivityContext(t,e,!1,r).then((function(e){n(t)})).catch((function(t){o(t)}))})),n)},t.prototype.subscribeActivityContextChanged=function(t){this._activities.subscribe((function(e,n){if(n.type===ee.ActivityContextChange){var i=n;t(e,i.context,i.updated,i.removed)}}))},t.prototype.stopActivity=function(t,e){return se(this._bridge.stopActivity(t),e)},t.prototype.getWindows=function(t){return Vt(t)?this._windows.get():Vt(t.id)?this._windows.get().filter((function(e){if(!Vt(t.type)&&e.type.id!==t.type)return!1;if(!Vt(t.name)&&e.name!==t.name)return!1;if(!Vt(t.activityId)){if(zt(e.activity))return!1;if(e.activity.id!==t.activityId)return!1}return!0})):[this._windows.getByName(t.id)]},t.prototype.getWindowBounds=function(t){return this._bridge.getWindowBounds(t)},t.prototype.setWindowBounds=function(t,e,n){var i=this;return se(new Promise((function(n,o){i._bridge.setWindowBounds(t,e).then((function(){return n()})).catch((function(t){return o(t)}))})),n)},t.prototype.closeWindow=function(t){return this._bridge.closeWindow(t)},t.prototype.activateWindow=function(t,e){return this._bridge.activateWindow(t,e)},t.prototype.setWindowVisibility=function(t,e){return this._bridge.setWindowVisibility(t,e)},t.prototype.clone=function(t,e,n){var i=this;return se(new Promise((function(n,o){t||o("activity can not be null"),i._bridge.cloneActivity(t.id,e).then((function(t){i._activities.getOrWait(t).then((function(t){n(t)})).catch((function(t){return o(t)}))})).catch((function(t){return o(t)}))})),n)},t.prototype.attachActivities=function(t,e,n,i){var o=this;return n=n||{},se(new Promise((function(i,r){if(o._activities.getByName(t)){if(o._activities.getByName(e))return o._bridge.attachActivities(t,e,n).then((function(t){var e=t.to,n=t.descriptor,r=t.descriptors;o._activities.getOrWait(e).then((function(t){t._updateDescriptors(r);var e=t.attached.filter((function(t){return t.ownerId===n.ownerId}))[0];i(e)}))})).catch((function(t){r(t)}));r("can not find activity with id "+e)}else r("can not find activity with id "+t)})),i)},t.prototype.detachActivities=function(t,e,n){var i=this;return se(new Promise((function(n,o){return i._bridge.detachActivities(t,e).then((function(){i._activities.getOrWait(void 0).then((function(t){t._updateDescriptors(void 0),i._activities.getOrWait(void 0).then((function(t){n(t)}))})).catch((function(t){return o(t)}))})).catch((function(t){o(t)}))})),n)},t.prototype.subscribeActivitiesAttached=function(t){this._attachedCallbacks.push(t)},t.prototype.subscribeActivitiesDetached=function(t){this._detachedCallbacks.push(t)},t.prototype.subscribeActivityFrameColorChanged=function(t){this._frameColorChangesCallbacks.push(t)},t.prototype._grabEntity=function(t){t._manager=this},t.prototype._getInitialData=function(){var t=this;this._logger.debug("Request initial data..."),this._bridge.getActivityTypes().then((function(e){t._activityTypes.add(e),t._dataReadyMarker.signal("Got act types")})).catch((function(e){t._logger.error(e),t._dataReadyMarker.error("Can not initialize ActivityManager - error getting activity types -"+e)})),this._bridge.getWindowTypes().then((function(e){t._windowTypes.add(e),t._dataReadyMarker.signal("Got window types")})).catch((function(e){t._logger.error(e),t._dataReadyMarker.error("Can not initialize ActivityManager - error getting window types  "+e)})),this._bridge.getActivities().then((function(e){t._activities.add(e),t._dataReadyMarker.signal("Got activities")})).catch((function(e){t._logger.error(e),t._dataReadyMarker.error("Can not initialize ActivityManager - error getting activity instances -"+e)})),this._bridge.getActivityWindows().then((function(e){t._windows.add(e),t._dataReadyMarker.signal("Got windows")})).catch((function(e){t._logger.error(e),t._dataReadyMarker.error("Can not initialize ActivityManager - error getting activity windows -"+e)}))},t.prototype._subscribeForData=function(){var t=this;this._logger.debug("Subscribe for data..."),this._bridge.onActivityTypeStatusChange((function(e){t._activityTypes.process(e)})),this._bridge.onWindowTypeStatusChange((function(e){t._windowTypes.process(e)})),this._bridge.onActivityWindowChange((function(e){t._windows.process(e)})),this._bridge.onActivityStatusChange((function(e){t._activities.process(e)}))},t.prototype._handleActivitiesAttached=function(t){var e=this,n=t.to,i=t.descriptor,o=t.descriptors;this._activities.getOrWait(n).then((function(t){t._updateDescriptors(o);var n=t.attached.filter((function(t){return t.ownerId===i.ownerId}))[0];e._attachedCallbacks.forEach((function(e){try{e(t,n)}catch(t){return}}))}))},t.prototype._handleActivitiesDetached=function(t){var e=this,n=t.oldActivityId,i=t.newActivityId,o=t.descriptors,r=t.descriptor;this._activities.getOrWait(n).then((function(t){t._updateDescriptors(o),e._activities.getOrWait(i).then((function(n){e._detachedCallbacks.forEach((function(e){try{e(n,t,r)}catch(t){return}}))}))}))},t.prototype._handleActivityDescriptorsRefreshed=function(t){var e=t.id,n=t.descriptors,i=this._activities.getByName(e);i&&i._updateDescriptors(n)},t.prototype.refreshDescriptors=function(){var t=this;this._bridge.getAttachedDescriptors().then((function(e){e&&Object.keys(e).forEach((function(n){var i=n,o=e[n],r=t._activities.getByName(i);r&&r._updateDescriptors(o)})),t._descriptorsMarker.signal("Successfully got descriptors")})).catch((function(e){t._descriptorsMarker.error("failed to get descriptors - "+e)}))},t.prototype._handleWindowFrameColorChanged=function(t){if(t.activityId){var e=this._activities.getByName(t.activityId);e&&e.owner&&e.owner.underlyingWindow.id===t.id&&this._frameColorChangesCallbacks.forEach((function(n){try{n(e,t.frameColor)}catch(t){return}}))}},t}(),ve=function(){function t(t,e){this._m=t,this._my=e,this.activityTypes={get:this._getActivityTypesWrapper.bind(this),register:this._m.registerActivityType.bind(this._m),unregister:this._m.unregisterActivityType.bind(this._m),subscribe:this._m.subscribeActivityTypeEvents.bind(this._m),unsubscribe:void 0,initiate:this._m.initiate.bind(this._m)},this.windowTypes={get:this._getWindowTypesWrapper.bind(this),registerFactory:this._m.registerWindowFactory.bind(this._m),unregisterFactory:this._m.unregisterWindowFactory.bind(this._m),subscribe:this._m.subscribeWindowTypeEvents.bind(this._m),unsubscribe:void 0},this.windows={get:this._m.getWindows.bind(this._m),subscribe:this._m.subscribeWindowEvents.bind(this._m),announce:this._m.announceWindow.bind(this._m),unsubscribe:void 0,create:this._m.createWindow.bind(this._m)},this.instances={get:this._m.getActivities.bind(this._m),subscribe:this._m.subscribeActivityEvents.bind(this._m),unsubscribe:void 0}}return t.prototype.onAttached=function(t){this._m.subscribeActivitiesAttached(t)},t.prototype.onDetached=function(t){this._m.subscribeActivitiesDetached(t)},t.prototype.onActivityFrameColorChanged=function(t){this._m.subscribeActivityFrameColorChanged(t)},t.prototype._getActivityTypesWrapper=function(t){return Vt(t)?this._m.getActivityTypes():this._m.getActivityType(t)},t.prototype._getWindowTypesWrapper=function(t){return Vt(t)?this._m.getWindowTypes():this._m.getWindowType(t)},t}(),me=function(){function t(t,e){this._mgr=t,this._my=e,this.all=new ve(t,e)}return t.prototype.ready=function(t){var e=this;return se(new Promise((function(t,n){e._mgr.ready().then((function(){t(e)})).catch((function(t){n(t)}))})),t)},Object.defineProperty(t.prototype,"my",{get:function(){return this._my},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"aware",{get:function(){return void 0!==this._my.window},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"inActivity",{get:function(){return this.aware&&void 0!==this._my.activity},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"agm",{get:function(){if(this.aware)return this.inActivity?this._my.activity.agm:new ie(null)},enumerable:!0,configurable:!0}),t.prototype.getAvailableFrameColors=function(){return[]},t}(),we=function(){function t(e){var n,i=this;if(!e)throw new Error("config can not be null");if(Vt(e.logLevel)||(ue.Level=e.logLevel),zt(e.logger)||(ue.GlueLogger=e.logger),this._isUsingHCImplementation=2===e.gdMajorVersion,this._isUsingGW3Implementation=t.checkIsUsingGW3Implementation(e.connection),this._isUsingHCImplementation)throw new Error("GD2 not supported");if(!this._isUsingGW3Implementation)throw new Error("Unable to instantiate activity bridge implementation");if(!(n=new he(e.connection,e.logger,e.contexts,e)))throw new Error("A bridge to native activity is needed to create activity lib.");ie.AGM=e.agm;var o=new ge(n,!e.disableAutoAnnounce,e.windows),r=new fe(o,e.windows);this._api=new me(o,r),this._readyPromise=o.ready().then((function(t){return i}))}return t.checkIsUsingGW3Implementation=function(t){return 3===t.protocolVersion},Object.defineProperty(t.prototype,"api",{get:function(){return this._api},set:function(t){this._api=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isUsingHCImplementation",{get:function(){return this._isUsingHCImplementation},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isUsingGW3Implementation",{get:function(){return this._isUsingGW3Implementation},enumerable:!0,configurable:!0}),t.prototype.ready=function(t){return se(this._readyPromise,t)},t}();function be(t){if(t&&t.errorHandling&&"function"!=typeof t.errorHandling&&"log"!==t.errorHandling&&"silent"!==t.errorHandling&&"throw"!==t.errorHandling)throw new Error('Invalid options passed to createRegistry. Prop errorHandling should be ["log" | "silent" | "throw" | (err) => void], but '+typeof t.errorHandling+" was passed");var e=t&&"function"==typeof t.errorHandling&&t.errorHandling,n={};function i(n,i){var o=n instanceof Error?n:new Error(n);if(e)e(o);else{var r='[ERROR] callback-registry: User callback for key "'+i+'" failed: '+o.stack;if(t)switch(t.errorHandling){case"log":return console.error(r);case"silent":return;case"throw":throw new Error(r)}console.error(r)}}return{add:function(t,e){var i=n[t];return i||(i=[],n[t]=i),i.push(e),function(){var i=n[t];i&&(i=i.reduce((function(t,n,i){return n===e&&t.length===i||t.push(n),t}),[]),n[t]=i)}},execute:function(t){for(var e=[],o=1;o<arguments.length;o++)e[o-1]=arguments[o];var r=n[t];if(!r||0===r.length)return[];var s=[];return r.forEach((function(n){try{var o=n.apply(void 0,e);s.push(o)}catch(e){s.push(void 0),i(e,t)}})),s},clear:function(){n={}},clearKey:function(t){n[t]&&delete n[t]}}}be.default=be;var _e=be;function Ie(t){return t?Object.keys(t).map((function(e){return t[e]})):[]}function Ae(t){var e;try{e=JSON.parse(JSON.stringify(t||{}))}catch(t){e={}}return e}var Ce=function(){function t(t,e,n){var i=this;this._appManager=t,this._name=e,this._agm=n,this._registry=_e(),t.onInstanceStarted((function(t){t.application&&t.application.name!==i._name||i._registry.execute("instanceStarted",t)})),t.onInstanceStopped((function(t){t.application&&t.application.name!==i._name||i._registry.execute("instanceStopped",t)})),t.onAppRemoved((function(t){t.name===i._name&&i._registry.execute("appRemoved",t)})),t.onAppChanged((function(t){t.name===i._name&&i._registry.execute("appChanged",t)})),t.onAppAvailable((function(t){t.name===i._name&&i._registry.execute("appAvailable",t)})),t.onAppUnavailable((function(t){t.name===i._name&&i._registry.execute("appUnavailable",t)}))}return Object.defineProperty(t.prototype,"name",{get:function(){return this._name},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"title",{get:function(){return this._props.Title},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"version",{get:function(){return this._props.Version},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"autoStart",{get:function(){return this._props.AutoStart},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isShell",{get:function(){return this._props.IsShell},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"caption",{get:function(){return this._props.Caption},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"hidden",{get:function(){return this._props.IsHidden},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"container",{get:function(){return this._props.ApplicationName},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"activityType",{get:function(){return this._props.ActivityType},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"activityWindowType",{get:function(){return this._props.ActivityWindowType},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"windowSettings",{get:function(){return this._props.Arguments?Ae(this._props.Arguments):{}},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"allowMultiple",{get:function(){return this._props.AllowMultiple},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"available",{get:function(){return this._props.IsReady||!1},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"icon",{get:function(){return this._props.Icon},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"iconURL",{get:function(){return this._props.IconUrl},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"sortOrder",{get:function(){return this._props.SortOrder},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"userProperties",{get:function(){return this._props.UserProperties?Ae(this._props.UserProperties):{}},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isActivity",{get:function(){return void 0!==this._props.ActivityType&&""!==this._props.ActivityType},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"configuration",{get:function(){return{autoStart:this._props.AutoStart,caption:this._props.Caption,hidden:this._props.IsHidden,container:this._props.ApplicationName,activityType:this._props.ActivityType,allowMultiple:this._props.AllowMultiple}},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"instances",{get:function(){var t=this;return this._appManager.instances().filter((function(e){return e.application.name===t._name}))},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"type",{get:function(){return this._props.Type},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"mode",{get:function(){if(!this._props)return"unknown";if(this._props.Mode&&"string"==typeof this._props.Mode)return this._props.Mode.toLowerCase();if(this.isActivity)return"unknown";if(this._props.Arguments&&this._props.Arguments.mode&&"string"==typeof this._props.Arguments.mode)return this._props.Arguments.mode.toLowerCase();var t=this._props.WindowStyleAttributes;if(t){var e=(t=t.split(" ").join("")).indexOf('mode:"');if(-1!==e){var n=e+'mode:"'.length,i=t.indexOf('"',n),o=t.substr(n,i-n);if(o&&"string"==typeof o)return o.toLowerCase()}}return"flat"},enumerable:!0,configurable:!0}),t.prototype.updateFromProps=function(t){var e=this;this._props||(this._props={Name:t.Name}),Object.keys(t).forEach((function(n){e._props[n]=t[n]}))},t.prototype.start=function(t,e){var n=this,i=this._name;return new Promise((function(o,r){e=e||{},t=t||{};n._agm.invoke("T42.ACS.StartApplication",{Name:i,Context:t,Options:e},"best",{methodResponseTimeoutMs:1e4},(function(t){var e=t.returned&&t.returned.Instance_0?t.returned.Instance_0:t.returned;if(e&&e.Id)if("startOnly"===n._appManager.mode){var i=n._appManager.handleInstanceStarted(e);o(i)}else!function(t){var e,i=function(){var e,i=n._appManager.instances().filter((function(e){return e.id===t}));return(e=2===i.length?i[0].isActivityInstance?i[0]:i[1]:i[0])?e.agm?e:void 0:e},s=setTimeout((function(){e&&e(),r("timeout")}),1e4);e=n._appManager.onInstanceAgmServerReady((function(n){n.id===t&&(e&&(e(),e=void 0),clearTimeout(s),setTimeout((function(){o(i())}),1))}));var a=i();a&&(e&&(e(),e=void 0),clearTimeout(s),o(a))}(e.Id);else o(void 0)}),(function(t){r(t)}))}))},t.prototype.onInstanceStarted=function(t){this._registry.add("instanceStarted",t)},t.prototype.onInstanceStopped=function(t){this._registry.add("instanceStopped",t)},t.prototype.onAvailable=function(t){this._registry.add("appAvailable",t)},t.prototype.onUnavailable=function(t){this._registry.add("appUnavailable",t)},t.prototype.onChanged=function(t){this._registry.add("appChanged",t)},t.prototype.onRemoved=function(t){this._registry.add("appRemoved",t)},t}(),Te=function(){function t(t,e,n,i,o,r,s){var a=this;this._id=t,this._appName=e,this._appManager=n,this._agm=i,this._activities=o,this._windows=r,this.onAgmReady=this._addToRegistry("agmReady"),this.onStopped=this._addToRegistry("stopped"),this._registry=_e(),s||(this._unsubscribeInstanceStopped=this._appManager.onInstanceStopped((function(t){t.id===a._id&&a._registry.execute("stopped",t)})),this._unsubscribeInstanceAgmServerReady=this._appManager.onInstanceAgmServerReady((function(t){t.id===a._id&&a._registry.execute("agmReady",t)})))}return Object.defineProperty(t.prototype,"id",{get:function(){return this._id},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"application",{get:function(){return this._appManager.application(this._appName)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"activity",{get:function(){var t=this;if(!this._activities)throw new Error("This method requires glue.activities library to be enabled.");return this._activities.all.instances.get().filter((function(e){return e.id===t._activityId}))[0]},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"activityInstances",{get:function(){var t=this;return this._appManager.instances().filter((function(e){return e.context&&e.context.activityId===t._activityId}))},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"activityOwnerInstance",{get:function(){return this._appManager.instances().filter((function(t){if(t.window&&t.window.context){var e=t.window.context;if(e._t42&&e._t42.activityIsOwner)return!0}return!1}))[0]},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"window",{get:function(){var t=this;if(!this._windows)throw new Error("This method requires glue.windows library to be enabled.");var e=this._windows.list().filter((function(e){return e.id===t._id}))[0];return!e&&this.activity&&this.activityOwnerInstance&&(e=this.activityOwnerInstance.window),e},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"context",{get:function(){var t,e,n;return null!=(n=null!=(t=this._startUpContext)?t:null===(e=this.window)||void 0===e?void 0:e.context)?n:{}},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"title",{get:function(){return this._title},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isActivityInstance",{get:function(){return this._isActivityInstance},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"activityId",{get:function(){return this._activityId},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"inActivity",{get:function(){return this._inActivity},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isSingleWindowApp",{get:function(){return!this._inActivity},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"agm",{get:function(){return this._agmInstance},enumerable:!0,configurable:!0}),t.prototype.updateFromProps=function(t){this._startUpContext=t.Context,this._title=t.Title,this._isActivityInstance=!1,t.ActivityId&&""!==t.ActivityId&&(this._activityId=t.ActivityId,this._isActivityInstance=!0),!this._activityId&&this._startUpContext&&this._startUpContext.activityId&&(this._activityId=this._startUpContext.activityId),this._inActivity=Boolean(this._activityId),this.updateAgmInstanceFromProps(t)},t.prototype.updateAgmInstanceFromProps=function(t){if(t.AgmServers)if(t.GD3){var e=t.AgmServers;e&&(this._agmInstance=e[0])}else{var n=t.AgmServers,i=Object.keys(n)[0];if(!i)return;var o=n[i];this._agmInstance={machine:o.machineName,user:o.userName,environment:o.environment,application:o.applicationName}}},t.prototype.stop=function(){var t=this;return new Promise((function(e,n){var i=t._appManager.onInstanceStopped((function(n){n.id===t._id&&(i(),e())}));t._agm.invoke("T42.ACS.StopApplication",{Name:t._appName,Id:t._id}).then((function(){"startOnly"===t._appManager.mode&&(t._appManager.handleInstanceStopped({Name:t._appName,Id:t.id,Context:void 0,Title:void 0,ActivityId:void 0,AgmServers:void 0}),e())})).catch((function(t){return n(t)}))}))},t.prototype.activate=function(){return this._agm.invoke("T42.ACS.ActivateApplication",{Name:this._appName,Id:this._id})},t.prototype.done=function(){this._registry.clear(),this._unsubscribeInstanceAgmServerReady(),this._unsubscribeInstanceStopped()},t.prototype._addToRegistry=function(t){var e=this;return function(n){e._registry.add(t,n)}},t}(),Se=function(){function t(t,e,n,i,o,r){var s=this;this.mode=t,this._agm=e,this._activities=n,this._windows=i,this._logger=o,this._gdMajorVersion=r,this._apps={},this._instances=[],this._registry=_e(),this.application=function(t){return s._apps[t]},this.applications=function(){return Object.keys(s._apps).map((function(t){return s._apps[t]}))},this.instances=function(){return s._instances},this.getMyInstance=function(){if(s._gdMajorVersion>=3){var t=window.glue42gd.appInstanceId;return s._instances.filter((function(e){return e.id===t}))[0]}},this.handleAppAdded=function(t){var e=s._getAppId(t);s._logger.trace("adding app "+e),s._apps[e]=new Ce(s,e,s._agm);var n=s._updateAppFromProps(t);s._registry.execute("appAdded",n)},this.handleAppUpdated=function(t){var e=s._updateAppFromProps(t);s._registry.execute("appChanged",e)},this.handleAppRemoved=function(t){var e=s._getAppId(t);s._logger.trace("removing app "+e);var n=s.application(e);s._instances=s._instances.filter((function(t){return t.application.name!==n.name})),delete s._apps[e],s._registry.execute("appRemoved",n)},this.handleAppReady=function(t){var e=s._getAppId(t),n=s._getAppOrThrow(e);n.updateFromProps(t),n.available?s._registry.execute("appAvailable",n):s._registry.execute("appUnavailable",n)},this.handleInstanceStarted=function(t){s._logger.trace("started app "+t.Name+" "+t.Id);var e=s._getInstanceId(t),n=s._getInstanceAppName(t),i=new Te(e,n,s,s._agm,s._activities,s._windows);return s._updateInstanceFromProps(i,t),s._instances.push(i),s._registry.execute("instanceStarted",i),i},this.handleInstanceStopped=function(t){s._logger.trace("failed to start app "+t.Name+" "+t.Id);var e=s._getInstanceId(t),n=s._getInstanceAppName(t),i=s._getInstanceOrThrow(e,n);s._instances=s._instances.filter((function(t){return!s._matchInstance(t,e,n)})),s._registry.execute("instanceStopped",i),i.done()},this.handleInstanceAgmServerReady=function(t){var e=s._getInstanceId(t),n=s._getInstanceAppName(t),i=s._getInstanceOrThrow(e,n);i.updateAgmInstanceFromProps(t),s._registry.execute("instanceAgmServerReady",i)},this.handleInstanceStartFailed=function(t){var e=s._getInstanceId(t),n=s._getInstanceAppName(t),i=new Te(e,n,void 0,void 0,void 0,void 0,!0);s._updateInstanceFromProps(i,t),s._registry.execute("instanceStartFailed",i)},this.handleInstanceUpdated=function(t){var e=s._getInstanceId(t),n=s._getInstanceAppName(t),i=s._getInstanceOrThrow(e,n);s._updateInstanceFromProps(i,t)},this.onInstanceStarted=function(t){return s._replay(s._instances,t),s._registry.add("instanceStarted",t)},this.onInstanceStartFailed=function(t){return s._registry.add("instanceStartFailed",t)},this.onInstanceStopped=function(t){return s._registry.add("instanceStopped",t)},this.onInstanceUpdated=function(t){return s._registry.add("instanceChanged",t)},this.onInstanceAgmServerReady=function(t){return s._registry.add("instanceAgmServerReady",t)},this.onAppAdded=function(t){return s._replay(s._apps,t),s._registry.add("appAdded",t)},this.onAppRemoved=function(t){return s._registry.add("appRemoved",t)},this.onAppAvailable=function(t){return s._registry.add("appAvailable",t)},this.onAppUnavailable=function(t){return s._registry.add("appUnavailable",t)},this.onAppChanged=function(t){return s._registry.add("appChanged",t)}}return t.prototype._getAppOrThrow=function(t){var e=this.application(t);if(!e)throw Error("app with id "+t+" not found");return e},t.prototype._getAppId=function(t){return t.Name},t.prototype._matchInstance=function(t,e,n){return t.id===e&&t.application.name===n},t.prototype._getInstanceByIdAndName=function(t,e){var n=this;return this._instances.filter((function(i){return n._matchInstance(i,t,e)}))[0]},t.prototype._getInstanceOrThrow=function(t,e){var n=this._getInstanceByIdAndName(t,e);if(!n)throw Error("instance with id "+t+" not found");return n},t.prototype._getInstanceId=function(t){return t.Id},t.prototype._getInstanceAppName=function(t){return t.Name},t.prototype._updateAppFromProps=function(t){var e=this._getAppId(t);this._logger.trace("updating app with  + "+e+", "+t);var n=this._getAppOrThrow(e);return n.updateFromProps(t),n},t.prototype._updateInstanceFromProps=function(t,e){this._logger.trace("updating instance with "+this._getInstanceId(e)+" for app "+this._getInstanceAppName(e)),t.updateFromProps(e)},t.prototype._replay=function(t,e){t&&(Array.isArray(t)?t.forEach((function(t){return e(t)})):Object.keys(t).map((function(e){return t[e]})).forEach((function(t){return e(t)})))},t}();function ke(t,e,n){var i=function(t){return!!(t&&t.constructor&&t.call&&t.apply)};if(!i(e)&&!i(n))return t;i(e)?i(n)||(n=function(){}):e=function(){},t.then(e,n)}var xe=function(t){var e=this;this._agm=t,this._registry=_e(),this.handleBranchModified=function(t){e._registry.execute("branchChanged",t)},this.handleBranchesModified=function(t){e._registry.execute("branchesChanged",t)},this.getRegion=function(t,n){return ke(e._agmInvoke("T42.ACS.GetConfigurationRegion",(function(t){return t.returned.Region})),t,n)},this.getBranches=function(t,n){return ke(e._agmInvoke("T42.ACS.GetBranches",(function(t){var e=t.returned.Branches;return Object.keys(e).map((function(t){return e[t]}))})),t,n)},this.getCurrentBranch=function(t,n){return ke(e._agmInvoke("T42.ACS.GetCurrentBranch",(function(t){return t.returned.Branch}),void 0),t,n)},this.setRegion=function(t,n,i){return ke(e._agmInvoke("T42.ACS.SetConfigurationRegion",(function(t){return t.returned.ResultMessage}),{Region:t}),n,i)},this.setCurrentBranch=function(t,n,i){return ke(e._agmInvoke("T42.ACS.SetCurrentBranch",(function(t){return t.returned.ResultMessage}),{Branch:t}),n,i)},this.currentUser=function(t,n){return ke(e._agmInvoke("T42.ACS.GetUser"),t,n)},this.getFunctionalEntitlement=function(t,n,i){return ke(e._agmInvoke("T42.ACS.GetFunctionalEntitlement",(function(t){return t.returned.Entitlement}),{Function:t}),n,i)},this.getFunctionalEntitlementBranch=function(t,n,i,o){return ke(e._agmInvoke("T42.ACS.GetFunctionalEntitlement",(function(t){return t.returned.Entitlement}),{Function:t,Branch:n}),i,o)},this.canI=function(t,n,i){return ke(e._agmInvoke("T42.ACS.CanI",(function(t){return t.returned.Result}),{Function:t}),n,i)},this.canIBranch=function(t,n,i,o){return ke(e._agmInvoke("T42.ACS.CanI",(function(t){return t.returned.Result}),{Function:t,Branch:n}),i,o)},this.onBranchesChanged=function(t){e._registry.add("branchesChanged",t)},this.onBranchChanged=function(t){e._registry.add("branchChanged",t)},this.exit=function(t){return e._agmInvoke("T42.ACS.Shutdown",null,t)},this.restart=function(t){return e._agmInvoke("T42.ACS.Restart",null,t)},this._agmInvoke=function(t,n,i){return i=i||{},new Promise((function(o,r){e._agm.invoke(t,i).then((function(t){n||(n=function(t){return t.returned}),o(n(t))})).catch((function(t){return r(t)}))}))}};var Pe=function(t){if(!t)throw Error("config not set");if(!t.agm)throw Error("config.agm is missing");var e=t.mode||"startOnly";if("startOnly"!==e&&"skipIcons"!==e&&"full"!==e)throw new Error("Invalid mode for appManager lib - "+e+" is not supported");var n,i=t.activities,o=t.agm,r=t.logger,s=t.windows,a=new Se(e,o,i,s,r.subLogger("applications"),t.gdMajorVersion),c=new xe(o);if("startOnly"===e)n=function(t,e){return new Promise((function(n,i){t.invoke("T42.ACS.GetApplications",{skipIcon:!0}).then((function(t){var i=t.returned;i||n();var o=i.applications;o||n(),Ie(o).map((function(t){return e.handleAppAdded(t)})),n()})).catch((function(t){return i("Error getting application snapshot: "+t.message)}))}))}(o,a);else{var u=function(t,e,n,i){var o;return{start:function(){var r,s,a=new Promise((function(t,e){r=t,s=e}));return t.subscribe("T42.ACS.OnEvent",{arguments:{skipIcon:i},waitTimeoutMs:1e4}).then((function(t){(o=t).onData((function(t){var i=t.data;Ie(i.OnApplicationAdded).map((function(t){return e.handleAppAdded(t)})),Ie(i.OnApplicationChanged).map((function(t){return e.handleAppUpdated(t)})),Ie(i.OnApplicationRemoved).map((function(t){return e.handleAppRemoved(t)})),Ie(i.OnApplicationReady).map((function(t){return e.handleAppReady(t)})),Ie(i.OnApplicationStarted).map((function(t){return e.handleInstanceStarted(t)})),Ie(i.OnApplicationStartFailed).map((function(t){return e.handleInstanceStartFailed(t)})),Ie(i.OnApplicationStopped).map((function(t){return e.handleInstanceStopped(t)})),Ie(i.OnApplicationUpdated).map((function(t){return e.handleInstanceUpdated(t)})),Ie(i.OnApplicationAgmServerReady).map((function(t){return e.handleInstanceAgmServerReady(t)})),Ie(i.OnBranchChanged).map((function(t){return n.handleBranchModified(t)})),Ie(i.OnBranchesModified).map((function(t){return n.handleBranchesModified(t)})),r()})),o.onFailed((function(t){return s(t)}))})).catch((function(t){return s("Error subscribing for T42.ACS.OnEvent stream. Err: "+t)})),a},stop:function(){o&&o.close()}}}(o,a,c,"skipIcons"===e);n=u.start()}return{ready:function(){return n},applications:a.applications,application:a.application,onAppAdded:a.onAppAdded,onAppRemoved:a.onAppRemoved,onAppChanged:a.onAppChanged,onAppAvailable:a.onAppAvailable,onAppUnavailable:a.onAppUnavailable,instances:a.instances,get myInstance(){return a.getMyInstance()},onInstanceStarted:a.onInstanceStarted,onInstanceStopped:a.onInstanceStopped,onInstanceUpdated:a.onInstanceUpdated,onInstanceStartFailed:a.onInstanceStartFailed,getRegion:c.getRegion,getBranches:c.getBranches,getCurrentBranch:c.getCurrentBranch,getFunctionalEntitlement:c.getFunctionalEntitlement,getFunctionalEntitlementBranch:c.getFunctionalEntitlementBranch,setCurrentBranch:c.setCurrentBranch,setRegion:c.setRegion,currentUser:c.currentUser,canI:c.canI,canIBranch:c.canIBranch,onBranchesChanged:c.onBranchesChanged,exit:c.exit,restart:c.restart}},Me=new(function(){function t(){this.waitForTimeoutInMilliseconds=6e4,this._windows={},this._pendingWindows={},this._pendingWindowsStates={},this._registry=_e()}return t.prototype.init=function(t){this._logger=t},t.prototype.get=function(t){return this._windows[t]||this._pendingWindows[t]},t.prototype.getIfReady=function(t){return this._windows[t]},Object.defineProperty(t.prototype,"list",{get:function(){return this._windows},enumerable:!0,configurable:!0}),t.prototype.add=function(t){if(!!this._pendingWindows[t.API.id])this._logger.error("trying to add window with id "+t.API.id+" from windowStore, which already exists");else{var e="remote"===t.API.windowType;this._pendingWindows[t.API.id]=t,this._pendingWindowsStates[t.API.id]={ready:!1,urlChanged:e},this._registry.execute("on-added",t)}},t.prototype.remove=function(t){delete this._windows[t.API.id],delete this._pendingWindows[t.API.id],delete this._pendingWindowsStates[t.API.id],this._registry.execute("on-removed",t)},t.prototype.setReadyState=function(t){var e=this._pendingWindowsStates[t];void 0!==e&&(e.ready=!0,e.urlChanged&&this.markReadyToShow(t))},t.prototype.setUrlChangedState=function(t){var e=this._pendingWindowsStates[t];void 0!==e&&(e.urlChanged=!0,e.ready&&this.markReadyToShow(t))},t.prototype.waitFor=function(t){var e=this;return new Promise((function(n,i){var o,r=setTimeout((function(){o(),i("waitFor timed out.")}),e.waitForTimeoutInMilliseconds),s=e._windows[t];s?(clearTimeout(r),n(s)):o=e.onReadyWindow((function(e){e.API.id===t&&(clearTimeout(r),o(),n(e))}))}))},t.prototype.onReadyWindow=function(t){return this._registry.add("on-ready",t)},t.prototype.onAdded=function(t){return this._registry.add("on-added",t)},t.prototype.onRemoved=function(t){return this._registry.add("on-removed",t)},t.prototype.markReadyToShow=function(t){this._pendingWindows[t]&&(this._windows[t]=this._pendingWindows[t],delete this._pendingWindows[t],delete this._pendingWindowsStates[t]),this._registry.execute("on-ready",this._windows[t])},t}()),je=function(){function t(){}return t.getGDMajorVersion=function(){if("undefined"==typeof window)return-1;if(!window.glueDesktop)return-1;if(!window.glueDesktop.version)return-1;var t=Number(window.glueDesktop.version.substr(0,1));return isNaN(t)?-1:t},t.callbackifyPromise=function(t,e,n){var i=function(t){var e=t;if(t instanceof Error&&(e=t.message),"function"!=typeof n)return Promise.reject(e);n(e)};try{return t().then((function(t){return"function"==typeof e&&e(t),t})).catch((function(t){return i(t)}))}catch(t){return i(t)}},t.getMonitor=function(t,e){var n=this;return e.map((function(e){var i=e.left,o=e.top,r=e.workingAreaWidth,s=e.workingAreaHeight;return{monitor:e,totalOverlap:n.calculateTotalOverlap({left:i,top:o,width:r,height:s},t)}})).sort((function(t,e){return e.totalOverlap-t.totalOverlap}))[0].monitor},t.getDisplayCenterOfScreen=function(t,e){var n=Math.floor(Math.max(e.left,e.left+(e.workingAreaWidth-t.width)/2));return{top:Math.floor(Math.max(e.top,e.top+(e.workingAreaHeight-t.height)/2)),left:n}},t.calculateTotalOverlap=function(t,e){var n=t.left,i=t.top,o=n+t.width,r=i+t.height,s=e.left,a=e.top,c=s+e.width,u=a+e.height;return Math.max(0,Math.min(o,c)-Math.max(n,s))*Math.max(0,Math.min(r,u)-Math.max(i,a))},t}(),Ee=function(t,e,n,i,o,r){var s,a,c=_e(),u=i.subLogger("window "+t),d=e.name,p=e.mode,h=e.url,f=e.title,l=e.context||{},y=e.bounds,g=e.frameColor,v=e.focus,m=e.neighbours||{},w=e.groupId,b=e.isGroupHeaderVisible,_=e.isTabHeaderVisible,I=e.isTabSelected,A=e.settings,C=e.isVisible,T=e.isCollapsed,S=e.state,k=e.tabGroupId,x=e.isLocked,P=[],M=e.zoomFactor;function j(t,e,i){return new Promise((function(o,r){var s,c,u=Z(t,y),d=!1,p=function(){d||(d=!0,"function"==typeof e&&e(a),o(a),c&&(c(),c=void 0),s&&(clearTimeout(s),s=void 0))};u||(c=U((function(e){e.id===a.id&&Z(t,e.bounds)&&p()}))),n.moveResize(a,t).then((function(){u?p():s=setTimeout((function(){p()}),1e3)})).catch((function(t){"function"==typeof i&&i(t),r(t)}))}))}function E(e,i,o){return new Promise((function(r,s){n.setVisible(a,e).then((function(){var n=void 0===e?!0===C:C===e;if(n)return"function"==typeof i&&i(a),r(a);var o=H((function(s){n=void 0===e?!0===s.isVisible:s.isVisible===e,s.id===t&&n&&("function"==typeof i&&i(a),o(),r(a))}))})).catch((function(t){"function"==typeof o&&o(t),s(t)}))}))}function O(t,e,i){return new Promise((function(o,r){n.updateContext(a,t).then((function(){"function"==typeof e&&e(a),o(a)})).catch((function(t){"function"==typeof i&&i(t),r(t)}))}))}function W(){return new Promise((function(t){var e=q((function(n){n.id===a.id&&(e(),t())}))}))}function R(t){return c.add("onUrlChanged",t)}function F(t){return T&&t(a),c.add("collapsed",t)}function L(t){return T||t(a),c.add("expanded",t)}function N(t){return"maximized"===S&&t(a),c.add("maximized",t)}function D(t){return"minimized"===S&&t(a),c.add("minimized",t)}function G(t){return"normal"===S&&t(a),c.add("normal",t)}function B(t){return c.add("detached",t)}function H(t){return c.add("visibility-changed",t)}function q(t){return c.add("lock-changed",t)}function U(t){return c.add("bounds-changed",t)}function V(t){return c.add("tab-header-visibility-changed",t)}function z(t){var e=m[t];if(void 0!==e)return e.reduce((function(t,e){var n=Me.get(e);return n&&t.push(n.API),t}),[])}function J(){if(l._APPLICATION_NAME)return l._APPLICATION_NAME;if(l&&l._t42&&l._t42.application)return l._t42.application;var t=K();return t?t.applicationName:void 0}function K(){if(void 0!==window.glue42gd&&window.glue42gd.getWindowInfo){var e=window.glue42gd.getWindowInfo(t);return e||void 0}}function Z(t,e){var n=t.height,i=t.width;t.height<A.minHeight&&(n=A.minHeight),t.height>A.maxHeight&&(n=A.maxHeight),t.width<A.minWidth&&(i=A.minWidth),t.width>A.maxWidth&&(i=A.maxWidth);var o=!n||e.height===n,r=!i||e.width===i,s=!t.left||e.left===t.left,a=!t.top||e.top===t.top;return o&&r&&s&&a}var Y={handleWindowClose:function(){void 0!==a.id&&(a.id=void 0,c.execute("onClose",a))},handleWindowChangeState:function(t){"collapsed"===t?T=!0:"expanded"===t?T=!1:S=t,c.execute(t,a)},handleTitleChanged:function(t){f=t,c.execute("onTitleChanged",t,a)},handleVisibilityChanged:function(t){t!==C&&(C=t,c.execute("visibility-changed",a))},handleUrlChanged:function(t){h=t,c.execute("onUrlChanged",t,a)},handleWindowSettingsChanged:function(t){A=t,c.execute("settings-changed",a)},handleContextUpdated:function(t){l=t,c.execute("context-updated",l,a)},handleFrameIsLockedChanged:function(t){x=t,c.execute("lock-changed",a)},handleBoundsChanged:function(t){y.top===t.top&&y.left===t.left&&y.width===t.width&&y.height===t.height||(y.top=t.top,y.left=t.left,y.width=t.width,y.height=t.height,c.execute("bounds-changed",a))},handleFocusChanged:function(t){v=t,c.execute("focus-changed",a)},handleFrameButtonAdded:function(t){var e=["buttonId","imageBase64","order","tooltip"].reduce((function(e,n){return e[n]=t[n],e}),{});-1===P.map((function(t){return t.buttonId})).indexOf(t.buttonId)&&P.push(e),c.execute("onFrameButtonAdded",e,a)},handleFrameButtonRemoved:function(t){var e;P=P.reduce((function(n,i){return i.buttonId===t?e=i:n.push(i),n}),[]),void 0!==e&&c.execute("onFrameButtonRemoved",e,a)},handleFrameButtonClicked:function(t){var e=P.filter((function(e){return e.buttonId===t.buttonId}));e.length>0&&c.execute("onFrameButtonClicked",e[0],a)},handleFrameColorChanged:function(t){g=t,c.execute("frame-color-changed",a)},handleFrameAttached:function(t,e){k=t,_=e,c.execute("frame-attached",a)},handleFrameSelectionChanged:function(e,n){var i;void 0!==e&&e===t?(I=!0,i=a):(I=!1,i=Me.get(e)?Me.get(e).API:void 0);var o=Me.get(n)?Me.get(n).API:void 0;if(I&&o)var r=o.onTabSelectionChanged((function(t,e){(e&&e.id)===o.id&&(r(),c.execute("tab-selection-changed",i,o,a))}));else c.execute("tab-selection-changed",i,o,a)},handleCompositionChanged:function(t,e){m=t||{},w=e},handleGroupHeaderVisibilityChanged:function(t){b=t},handleTabHeaderVisibilityChanged:function(t){_!==t&&(_=t,c.execute("tab-header-visibility-changed",a))},handleGroupChanged:function(e,n){i.trace("handle group changed to win: "+t+" with group id: "+e.id),s=e,w=e.id,c.execute("group-changed",a,e,n)},handleGroupAssociation:function(e){e&&u.trace("setting group to win: "+t+" with group id: "+e.id),s=e},handleAttached:function(t,e){k=t,_=e,c.execute("attached",a)},handleDetached:function(e){k=e;var n=c.add("frame-attached",(function(e){e.id===t&&(n(),c.execute("detached",a))}))},handleWindowAttached:function(t){c.execute("window-attached",t)},handleWindowDetached:function(t){c.execute("window-detached",t)},handleZoomFactorChanged:function(t){M=t,c.execute("zoom-factor-changed",a)}};return{API:a={get name(){return d},get application(){var t=o();return t?t.application(J()):void 0},get hostInstance(){return n.hostInstance},get agmInstance(){var t=this;if(window.glue42gd)return r.servers().find((function(e){return e.windowId===t.id}));var e=J();return e?{application:e}:void 0},get url(){return h},id:t,get title(){return f},get windowStyleAttributes(){return A},get settings(){return A},get tabGroupId(){return"tab"===p.toLowerCase()?k:void 0},get frameButtons(){return P},get mode(){return p},get state(){return S},get isCollapsed(){return T},get isVisible(){return C},get isLocked(){return x},get context(){return l},get bounds(){return y},get minHeight(){return A.minHeight},get maxHeight(){return A.maxHeight},get minWidth(){return A.minWidth},get maxWidth(){return A.maxWidth},get isFocused(){return v},get frameColor(){return g},get opened(){return void 0!==a.id},get group(){return s},get groupId(){return w},get topNeighbours(){return z("top")},get leftNeighbours(){return z("left")},get rightNeighbours(){return z("right")},get bottomNeighbours(){return z("bottom")},get isGroupHeaderVisible(){return b},get activityId(){if(l._t42)return l._t42.activityId;var t=K();return t?t.activityId:void 0},get activityWindowId(){if(l._t42)return l._t42.activityWindowId;var t=K();return t?t.activityWindowId:void 0},get windowType(){return e.windowType||"electron"},get zoomFactor(){return M},get screen(){return je.getMonitor(a.bounds,window.glue42gd.monitors)},maximize:function(e,i){return new Promise((function(o,r){n.maximize(a).then((function(){if("maximized"===S)return"function"==typeof e&&e(a),o(a);var n=N((function(i){i.id===t&&"maximized"===i.state&&("function"==typeof e&&e(a),n(),o(a))}))})).catch((function(t){"function"==typeof i&&i(t),r(t)}))}))},restore:function(e,i){return new Promise((function(o,r){n.restore(a).then((function(){if("normal"===S)return"function"==typeof e&&e(a),o(a);var n=G((function(i){t===i.id&&"normal"===i.state&&("function"==typeof e&&e(a),n(),o(a))}))})).catch((function(t){"function"==typeof i&&i(t),r(t)}))}))},minimize:function(e,i){return new Promise((function(o,r){n.minimize(a).then((function(){if("minimized"===S)return"function"==typeof e&&e(a),o(a);var n=D((function(i){if(t===i.id&&"minimized"===i.state)return"function"==typeof e&&e(a),n(),o(a)}))})).catch((function(t){"function"==typeof i&&i(t),r(t)}))}))},maximizeRestore:function(t,e){return new Promise((function(i,o){var r="normal"===S?N:G;n.maximizeRestore(a).then((function(){var e=r((function(){"function"==typeof t&&t(a),e&&e(),i(a)}))})).catch((function(t){"function"==typeof e&&e(t),o(t)}))}))},collapse:function(e,i){return new Promise((function(o,r){if(T)return"function"==typeof e&&e(a),o(a);n.collapse(a).then((function(){if(T)return"function"==typeof e&&e(a),o(a);var n=F((function(i){i.id===t&&("function"==typeof e&&e(a),n(),o(a))}))})).catch((function(t){"function"==typeof i&&i(t),r(t)}))}))},expand:function(e,i){return new Promise((function(o,r){if(!T)return"function"==typeof e&&e(a),o(a);n.expand(a).then((function(){if(!T)return"function"==typeof e&&e(a),o(a);var n=L((function(i){i.id===t&&("function"==typeof e&&e(a),n(),o(a))}))})).catch((function(t){"function"==typeof i&&i(t),r(t)}))}))},toggleCollapse:function(e,i){return new Promise((function(o,r){var s=T?L:F;n.toggleCollapse(a).then((function(){s((function(n){n.id===t&&("function"==typeof e&&e(a),o(a))}))})).catch((function(t){"function"==typeof i&&i(t),r(t)}))}))},focus:function(t,e){return new Promise((function(i,o){n.focus(a).then((function(){"function"==typeof t&&t(a),i(a)})).catch((function(t){"function"==typeof e&&e(t),o(t)}))}))},activate:function(t,e){return new Promise((function(i,o){n.activate(a).then((function(){"function"==typeof t&&t(a),i(a)})).catch((function(t){"function"==typeof e&&e(t),o(t)}))}))},moveResize:j,setTitle:function(t,e,i){return new Promise((function(o,r){n.setTitle(a,t).then((function(){"function"==typeof e&&e(a),o(a)})).catch((function(t){"function"==typeof i&&i(t),r(t)}))}))},setStyle:function(t,e,i){if(!t||0===Object.keys(t).length||Object.keys(t).every((function(t){return!t})))return i(o="Invalid style arguments: "+JSON.stringify(t)),Promise.reject(new Error(o));if(t&&void 0!==t.focus){var o;if("boolean"!=typeof t.focus)return i(o="Focus must be boolean. Currently only focus true is supported ! "+JSON.stringify(t)),Promise.reject(new Error(o));!1===t.focus&&console.warn("Focus false is not supported ! ")}return t&&void 0!==t.hidden&&"boolean"!=typeof t.hidden?(i(o="Hidden must be boolean ! provided: "+JSON.stringify(t)),Promise.reject(new Error(o))):je.callbackifyPromise((function(){return n.setStyle(a,t)}),e,i)},setOnTop:function(t,e,i){if(this.onTop===t){var o="OnTop setting is already set to '"+t+"'";return i(o),Promise.reject(new Error(o))}return je.callbackifyPromise((function(){return n.setOnTop(a,t)}),e,i)},resetButtons:function(t,e,i){return je.callbackifyPromise((function(){return n.resetButtons(a,t)}),e,i)},setSizeConstraints:function(t,e,i){if(!t||Object.keys(t).every((function(t){return void 0===t}))){var o="Invalid Constraints: "+JSON.stringify(t);return i(o),Promise.reject(new Error(o))}return je.callbackifyPromise((function(){return n.setSizeConstraints(a,t)}),e,i)},navigate:function(e,i,o){return new Promise((function(r,s){n.navigate(a,e).then((function(){if(e===h)return"function"==typeof i&&i(a),r(a);var n=R((function(e,o){o.id===t&&e===o.url&&("function"==typeof i&&i(a),n(),r(a))}))})).catch((function(t){"function"==typeof o&&o(t),s(t)}))}))},addFrameButton:function(t,e,i){return new Promise((function(o,r){return void 0===t?"function"==typeof i?void i("No button info"):void r("No button info"):void 0===t.buttonId?"function"==typeof i?void i("No buttonId"):void r("No buttonId"):void 0===t.imageBase64?"function"==typeof i?void i("No imageBase64"):void r("No imageBase64"):void n.addFrameButton(a,t).then((function(){"function"==typeof e&&e(a),o(a)})).catch((function(t){"function"==typeof i&&i(t),r(t)}))}))},removeFrameButton:function(t,e,i){return new Promise((function(o,r){if(void 0===t||""===t)return"function"==typeof i?void i("No buttonId"):void r("No buttonId");n.removeFrameButton(a,t).then((function(){"function"==typeof e&&e(a),o(a)})).catch((function(t){"function"==typeof i&&i(t),r(t)}))}))},setVisible:E,show:function(){return E(!0)},hide:function(){return E(!1)},center:function(t){return j(je.getDisplayCenterOfScreen(a.bounds,t||a.screen))},close:function(t,e){return new Promise((function(i,o){n.close(a).then((function(){"function"==typeof t&&t(a),i(a)})).catch((function(t){"function"==typeof e&&e(t),o(t)}))}))},snap:function(t,e,i,o){var r,s;if(!t)return Promise.reject("Please specify a target window! calledWith: "+t);if("string"==typeof t){var c=Me.get(t);if(!c)return Promise.reject(new Error("Invalid target parameter or no such window. Invoked with:  "+t));r=c.API.group}else r=t.group;return Promise.all([(s=r,new Promise((function(t,e){var n=s.onWindowAdded((function(e,i){a.id===i.id&&(n(),t())}))}))),n.snap(a,t,e)]).then((function(){return"function"==typeof i&&i(a),a})).catch((function(t){return"function"==typeof o&&o(t),t}))},showLoader:function(t){return new Promise((function(e,i){n.showLoader(a,t).then((function(){e(a)})).catch((function(t){i(t)}))}))},hideLoader:function(){return new Promise((function(t,e){n.hideLoader(a).then((function(){t(a)})).catch((function(t){e(t)}))}))},updateContext:O,lock:function(t,e){return a.isLocked?("function"==typeof t&&t(a),Promise.resolve(a)):new Promise((function(i,o){n.lock(a).then((function(){return W()})).then((function(){"function"==typeof t&&t(a),i(a)})).catch((function(t){"function"==typeof e&&e(t),o(t)}))}))},unlock:function(t,e){return a.isLocked?new Promise((function(i,o){n.unlock(a).then((function(){return W()})).then((function(){"function"==typeof t&&t(a),i(a)})).catch((function(t){"function"==typeof e&&e(t),o(t)}))})):("function"==typeof t&&t(a),Promise.resolve(a))},getIcon:function(t,e){return new Promise((function(i,o){n.getIcon(a).then((function(e){"function"==typeof t&&t(e),i(e)})).catch((function(t){"function"==typeof e&&e(t),o(t)}))}))},setIcon:function(t,e,i){return new Promise((function(o,r){n.setIcon(a,t).then((function(){"function"==typeof e&&e(a),o(a)})).catch((function(t){"function"==typeof i&&i(t),r(t)}))}))},setFrameColor:function(t,e,i){return new Promise((function(o,r){n.setFrameColor(a,t).then((function(){"function"==typeof e&&e(a),o(a)})).catch((function(t){"function"==typeof i&&i(t),r(t)}))}))},setTabTooltip:function(t){return Gt(this,void 0,void 0,(function(){return Bt(this,(function(e){if(!t)throw new Error(t+" is null or undefined");return[2,n.setTabTooltip(a,t)]}))}))},attachTab:function(t,e,i,o){return new Promise((function(r,s){var c,u=a.id,d="Invalid tab parameter - should be an object with property id or a string. Invoked for source window id:"+a.id;if(t){if("string"==typeof t)c=t;else{if(void 0===t.id)return void s(d);c=t.id}var p={sourceWindowId:c,targetWindowId:u};e&&(p.index=e);var h=Me.get(p.sourceWindowId).API,f=h.onAttached((function(t){t.id===h.id&&("function"==typeof i&&i(a),f(),r(a))}));n.attachTab(a,p).catch((function(t){"function"==typeof o&&o(t),f(),s(t)}))}else s(d)}))},detachTab:function(e,i,o){return new Promise((function(r,s){var u={windowId:a.id},d=e||{};void 0!==d.relativeTo&&("string"==typeof d.relativeTo?u.relativeTo=d.relativeTo:void 0!==d.relativeTo.id&&(u.relativeTo=d.relativeTo.id),void 0!==d.relativeDirection&&(u.relativeDirection=d.relativeDirection),void 0!==d.width&&(u.width=d.width),void 0!==d.height&&(u.height=d.height)),void 0!==d.bounds&&(u.bounds=d.bounds),void 0!==d.hideTabHeader&&(u.hideTabHeader=d.hideTabHeader);var p=!1,h=!1,f=c.add("frame-attached",(function(e){var n=void 0===d.hideTabHeader||d.hideTabHeader!==e.isTabHeaderVisible;t===e.id&&n&&(p=!0,f(),h&&("function"==typeof i&&i(a),r(a),"function"==typeof l&&l()))})),l=B((function(e){t===e.id&&(h=!0,l(),p&&("function"==typeof i&&i(a),r(a),"function"==typeof f&&f()))}));n.detachTab(a,u).catch((function(t){"function"==typeof o&&o(t),l(),f(),s(t)}))}))},setTabHeaderVisible:function(e,i,o){return new Promise((function(r,s){n.setTabHeaderVisible(a,e).then((function(){if(_===e)return"function"==typeof i&&i(a),r(a);var n=V((function(o){o.id===t&&o.isTabHeaderVisible===e&&("function"==typeof i&&i(a),n(),r(a))}))})).catch((function(t){"function"==typeof o&&o(t),s(t)}))}))},showPopup:function(t){return n.showPopup(a,t)},createFlydown:function(t){return n.createFlydown(a.id,t)},setModalState:function(t){return n.setModalState(a.id,t||!1)},setZoomFactor:function(t,e,i){return je.callbackifyPromise((function(){if(isNaN(t))throw new Error("zoomFactor is not a number");return n.setZoomFactor(a,t)}),e,i)},zoomIn:function(t,e){return je.callbackifyPromise((function(){return n.zoomIn(a)}),t,e)},zoomOut:function(t,e){return je.callbackifyPromise((function(){return n.zoomOut(a)}),t,e)},showDevTools:function(){return n.showDevTools(a)},capture:function(t){return n.capture(a,t)},flash:function(t){var e={shouldFlash:!0};return"boolean"==typeof t&&(e.shouldFlash=t),n.flash(a,e)},onClose:function(t){return c.add("onClose",t)},onUrlChanged:R,onTitleChanged:function(t){return t(a.title,a),c.add("onTitleChanged",t)},onFrameButtonAdded:function(t){return c.add("onFrameButtonAdded",t)},onFrameButtonRemoved:function(t){return c.add("onFrameButtonRemoved",t)},onFrameButtonClicked:function(t){return c.add("onFrameButtonClicked",t)},onCollapsed:F,onExpanded:L,onMinimized:D,onMaximized:N,onNormal:G,onAttached:function(t){return c.add("attached",t)},onDetached:B,onVisibilityChanged:H,onContextUpdated:function(t){return c.add("context-updated",t)},onLockingChanged:q,onBoundsChanged:U,onFrameColorChanged:function(t){return c.add("frame-color-changed",t)},onFocusChanged:function(t){return c.add("focus-changed",t)},onGroupChanged:function(t){return c.add("group-changed",t)},onWindowAttached:function(t){return c.add("window-attached",t)},onWindowDetached:function(t){return c.add("window-detached",t)},onTabSelectionChanged:function(t){return c.add("tab-selection-changed",t)},onTabHeaderVisibilityChanged:V,onClosing:function(e){if(!Jt(e))throw new Error("callback should be a function");return n.onClosing((function(t,n){var i=e();i&&i.then?i.then(t).catch(n):t()}),t)},onRefreshing:function(e){if(!Jt(e))throw new Error("callback should be a function");return n.onRefreshing((function(t,n,i){var o=e(i);o&&o.then?o.then(t).catch(n):t()}),t)},onZoomFactorChanged:function(t){if(!Jt(t))throw new Error("callback should be a function");return c.add("zoom-factor-changed",t)},get tabs(){return t=Me.list,"tab"!==p.toLowerCase()?[]:Object.keys(t).reduce((function(e,n){var i=t[n];return i&&i.API.tabGroupId&&void 0!==i.API.tabGroupId&&void 0!==a.tabGroupId&&i.API.tabGroupId===a.tabGroupId&&e.push(i.API),e}),[]);var t},get isTabHeaderVisible(){return _},get isTabSelected(){return I},getURL:function(){return Promise.resolve(h)},getTitle:function(){return Promise.resolve(f)},getBounds:function(){return Promise.resolve(y)},getContext:function(){return Promise.resolve(l)},setContext:function(t){return O(t)},resizeTo:function(t,e){return j({width:t,height:e})},moveTo:function(t,e){return j({top:t,left:e})},getParentWindow:function(){var t;return Gt(this,void 0,void 0,(function(){var e;return Bt(this,(function(n){return(e=A.parentInstanceId)?[2,null===(t=Me.list[e])||void 0===t?void 0:t.API]:[2,void 0]}))}))},getChildWindows:function(){return Gt(this,void 0,void 0,(function(){return Bt(this,(function(e){return[2,Object.keys(Me.list).map((function(t){return Me.list[t].API})).filter((function(e){return e.settings.parentInstanceId===t}))]}))}))}},Events:Y}},Oe=new(function(){function t(){this._registry=_e()}return Object.defineProperty(t.prototype,"hostInstance",{get:function(){return this.agmTarget},enumerable:!0,configurable:!0}),t.prototype.init=function(t,e){this.agm=t,this.agmTarget=e},t.prototype.close=function(t){var e=this;return new Promise((function(n,i){e.execute("close",{windowId:t.id}).then((function(){n(t)})).catch((function(t){i(t)}))}))},t.prototype.navigate=function(t,e){var n=this;return new Promise((function(i,o){n.execute("navigate",{windowId:t.id,options:{url:e}}).then((function(){i(t)})).catch((function(t){o(t)}))}))},t.prototype.setStyle=function(t,e){var n;return Gt(this,void 0,void 0,(function(){var i,o,r,s,a,c,u,d,p,h,f,l,y;return Bt(this,(function(g){switch(g.label){case 0:return i=[],o=function(t){return i.push(t)},void 0===e.focus||t.isFocused||o(t.focus()),void 0!==e.hidden&&(r=!e.hidden,o(t.setVisible(r))),void 0!==e.onTop&&o(t.setOnTop(e.onTop)),void 0===e.tabTooltip&&void 0===e.tabToolTip||(n=e.tabTooltip,s=null!=n?n:e.tabToolTip,o(t.setTabTooltip(s))),a=e.maxWidth,c=e.maxHeight,u=e.minWidth,d=e.minHeight,p=e.allowClose,h=e.allowCollapse,f=e.allowLockUnlock,l=e.allowMaximize,y=e.allowMinimize,o(t.setSizeConstraints({maxWidth:a,maxHeight:c,minWidth:u,minHeight:d})),o(t.resetButtons({allowClose:p,allowCollapse:h,allowLockUnlock:f,allowMaximize:l,allowMinimize:y})),[4,Promise.all(i)];case 1:return g.sent(),[2,t]}}))}))},t.prototype.setSizeConstraints=function(t,e){var n=this;return new Promise((function(i,o){n.execute("setSizeConstraints",{windowId:t.id,options:e}).then((function(){i(t)})).catch(o)}))},t.prototype.setTabTooltip=function(t,e){return Gt(this,void 0,void 0,(function(){return Bt(this,(function(n){switch(n.label){case 0:return[4,this.execute("setTabTooltip",{windowId:t.id,options:{tabToolTip:e}})];case 1:return n.sent(),[2,t]}}))}))},t.prototype.resetButtons=function(t,e){var n=this;return new Promise((function(i,o){n.execute("resetButtons",{windowId:t.id,options:e}).then((function(){i(t)})).catch(o)}))},t.prototype.setOnTop=function(t,e){var n=this;return new Promise((function(i,o){n.execute("setOnTop",{windowId:t.id,options:{onTop:e}}).then((function(){i(t)})).catch(o)}))},t.prototype.setTitle=function(t,e){var n=this;return new Promise((function(i,o){var r={windowId:t.id,options:{title:e}};n.execute("setTitle",r).then((function(){i(t)})).catch((function(t){o(t)}))}))},t.prototype.moveResize=function(t,e){var n=this;return new Promise((function(i,o){n.execute("moveResize",{windowId:t.id,options:{bounds:e}}).then((function(){i(t)})).catch((function(t){o(t)}))}))},t.prototype.addFrameButton=function(t,e){var n=this;return new Promise((function(i,o){n.execute("addButton",{windowId:t.id,options:e}).then((function(){i(t)})).catch((function(t){o(t)}))}))},t.prototype.removeFrameButton=function(t,e){var n=this;return new Promise((function(i,o){n.execute("removeButton",{windowId:t.id,options:e}).then((function(){i(t)})).catch((function(t){o(t)}))}))},t.prototype.activate=function(t){var e=this;return new Promise((function(n,i){e.execute("activate",{windowId:t.id}).then((function(){n(t)})).catch((function(t){i(t)}))}))},t.prototype.focus=function(t){var e=this;return new Promise((function(n,i){e.execute("focus",{windowId:t.id}).then((function(){n(t)})).catch((function(t){i(t)}))}))},t.prototype.maximizeRestore=function(t){var e=this;return new Promise((function(n,i){e.execute("maximizeRestore",{windowId:t.id}).then((function(){n(t)})).catch((function(t){i(t)}))}))},t.prototype.maximize=function(t){var e=this;return new Promise((function(n,i){e.execute("maximize",{windowId:t.id}).then((function(){n(t)})).catch((function(t){i(t)}))}))},t.prototype.restore=function(t){var e=this;return new Promise((function(n,i){e.execute("restore",{windowId:t.id}).then((function(){n(t)})).catch((function(t){i(t)}))}))},t.prototype.minimize=function(t){var e=this;return new Promise((function(n,i){e.execute("minimize",{windowId:t.id}).then((function(){n(t)})).catch((function(t){i(t)}))}))},t.prototype.collapse=function(t){var e=this;return new Promise((function(n,i){e.execute("collapse",{windowId:t.id}).then((function(){n(t)})).catch((function(t){i(t)}))}))},t.prototype.expand=function(t){var e=this;return new Promise((function(n,i){e.execute("expand",{windowId:t.id}).then((function(){n(t)})).catch((function(t){i(t)}))}))},t.prototype.toggleCollapse=function(t){var e=this;return new Promise((function(n,i){e.execute("toggleCollapse",{windowId:t.id}).then((function(){n(t)})).catch((function(t){i(t)}))}))},t.prototype.snap=function(t,e,n){var i=this;return new Promise((function(o,r){t.id;var s,a="Invalid target parameter - should be an object with property id or a string. Invoked for source window id:"+t.id;if(e){if("string"==typeof e)s=e;else{if(void 0===e.id)return void r(a);s=e.id}var c={targetWindowId:s};n&&(c.snappingEdge=n),i.execute("snap",{windowId:t.id,options:c}).then((function(){o(t)})).catch((function(t){r(t)}))}else r(a)}))},t.prototype.attachTab=function(t,e){var n=this;return new Promise((function(i,o){n.execute("attachTab",{windowId:t.id,options:e}).then((function(){i(t)})).catch((function(t){o(t)}))}))},t.prototype.detachTab=function(t,e){var n=this;return new Promise((function(i,o){n.execute("detachTab",{windowId:t.id,options:e}).then((function(){i(t)})).catch((function(t){o(t)}))}))},t.prototype.setVisible=function(t,e){var n=this;return void 0===e&&(e=!0),new Promise((function(i,o){var r;r=e?"show":"hide",n.execute(r,{windowId:t.id}).then((function(){i(t)})).catch((function(t){o(t)}))}))},t.prototype.showLoader=function(t,e){var n=this;return new Promise((function(i,o){n.execute("showLoadingAnimation",{windowId:t.id,options:e}).then((function(){i(t)})).catch((function(t){o(t)}))}))},t.prototype.hideLoader=function(t){var e=this;return new Promise((function(n,i){e.execute("hideLoadingAnimation",{windowId:t.id}).then((function(){n(t)})).catch((function(t){i(t)}))}))},t.prototype.updateContext=function(t,e){var n=this;return new Promise((function(i,o){n.execute("updateContext",{windowId:t.id,context:e,replace:!(Object.keys(t.context).length>0)}).then((function(){i(t)})).catch((function(t){o(t)}))}))},t.prototype.lock=function(t){var e=this;return new Promise((function(n,i){e.execute("lockUnlock",{windowId:t.id,options:{lock:!0}}).then((function(){n(t)})).catch((function(t){i(t)}))}))},t.prototype.unlock=function(t){var e=this;return new Promise((function(n,i){e.execute("lockUnlock",{windowId:t.id,options:{lock:!1}}).then((function(){n(t)})).catch((function(t){i(t)}))}))},t.prototype.getIcon=function(t){var e=this;return new Promise((function(n,i){e.execute("getIcon",{windowId:t.id,options:{}}).then((function(t){n(t.icon)})).catch((function(t){i(t)}))}))},t.prototype.setIcon=function(t,e){var n=this;return new Promise((function(i,o){n.execute("setIcon",{windowId:t.id,options:{dataURL:e}}).then((function(){i(t)})).catch((function(t){o(t)}))}))},t.prototype.setFrameColor=function(t,e){var n=this;return new Promise((function(i,o){n.execute("setFrameColor",{windowId:t.id,options:{frameColor:e}}).then((function(){i(t)})).catch((function(t){o(t)}))}))},t.prototype.setTabHeaderVisible=function(t,e){var n=this;return new Promise((function(i,o){n.execute("setTabHeaderVisible",{windowId:t.id,options:{toShow:e}}).then((function(){i(t)})).catch((function(t){o(t)}))}))},t.prototype.showPopup=function(t,e){return Gt(this,void 0,void 0,(function(){var n,i;return Bt(this,(function(o){switch(o.label){case 0:return e?((n=Dt({},e)).targetLocation||(n.targetLocation="bottom"),i=Dt(Dt({},n),{popupBounds:n.size,targetId:t.id,popupId:n.windowId}),[4,this.execute("showPopupWindow",{windowId:t.id,options:i})]):[2,Promise.reject("The options object is not valid!")];case 1:return o.sent(),[2,t]}}))}))},t.prototype.createFlydown=function(t,e){return Gt(this,void 0,void 0,(function(){var n,i,o=this;return Bt(this,(function(r){return e?((n=Dt({},e)).horizontalOffset||(n.horizontalOffset=0),n.verticalOffset||(n.verticalOffset=0),i=this.reformatFlydownOptions(t,n),[2,this.execute("setFlydownArea",{windowId:t,options:i}).then((function(){var t=i.zones.map((function(t){return t.id}));return i.zones.forEach((function(t){var n="function"==typeof t.flydownSize?t.flydownSize:function(){return t.flydownSize};e.size instanceof Function&&t.flydownSize&&(n=function(n,i){return Gt(o,void 0,void 0,(function(){var o;return Bt(this,(function(r){switch(r.label){case 0:return e.size instanceof Function?[4,e.size(n,i)]:[3,2];case 1:o=r.sent(),r.label=2;case 2:return t.flydownSize instanceof Function&&t.flydownSize!==e.size?[4,t.flydownSize(n,i)]:[3,4];case 3:return[2,r.sent()||o];case 4:return[2,o||t.flydownSize]}}))}))}),o._registry.clearKey(i.targetId+"_"+t.id),o._registry.add(i.targetId+"_"+t.id,n)})),{destroy:function(){return o.clearFlydownArea(i.targetId,t)},options:n}}))]):[2,Promise.reject("The options object is not valid!")]}))}))},t.prototype.setModalState=function(t,e){return Gt(this,void 0,void 0,(function(){return Bt(this,(function(n){return[2,this.execute("setModalState",{windowId:t,options:{isModal:e}})]}))}))},t.prototype.handleFlydownBoundsRequested=function(t,e){return Gt(this,void 0,void 0,(function(){var n,i,o,r,s;return Bt(this,(function(a){switch(a.label){case 0:return n=function(){return e.cancel=!0},i={zoneId:e.flydownId,flydownWindowBounds:e.flydownWindowBounds,flydownWindowId:e.flydownWindowId},[4,Promise.all(this._registry.execute(t+"_"+e.flydownId,i,n))];case 1:return 1===(o=a.sent()).length?(r={height:0,width:0,top:0,left:0},s="object"!=typeof o[0]||Array.isArray(o[0])?r:o[0],[2,Dt(Dt({},e),{flydownWindowBounds:s})]):[2]}}))}))},t.prototype.zoomIn=function(t){return Gt(this,void 0,void 0,(function(){return Bt(this,(function(e){switch(e.label){case 0:return[4,this.execute("zoomIn",{windowId:t.id})];case 1:return e.sent(),[2,t]}}))}))},t.prototype.zoomOut=function(t){return Gt(this,void 0,void 0,(function(){return Bt(this,(function(e){switch(e.label){case 0:return[4,this.execute("zoomOut",{windowId:t.id})];case 1:return e.sent(),[2,t]}}))}))},t.prototype.setZoomFactor=function(t,e){return Gt(this,void 0,void 0,(function(){return Bt(this,(function(n){switch(n.label){case 0:return[4,this.execute("setZoomFactor",{windowId:t.id,options:{zoomFactor:e}})];case 1:return n.sent(),[2,t]}}))}))},t.prototype.showDevTools=function(t){return Gt(this,void 0,void 0,(function(){return Bt(this,(function(e){switch(e.label){case 0:return[4,this.execute("showDevTools",{windowId:t.id})];case 1:return e.sent(),[2,t]}}))}))},t.prototype.capture=function(t,e){return Gt(this,void 0,void 0,(function(){return Bt(this,(function(n){switch(n.label){case 0:return[4,this.execute("captureScreenshot",{windowId:t.id,options:Dt({},e)})];case 1:return[2,n.sent().data]}}))}))},t.prototype.captureGroup=function(t,e){return Gt(this,void 0,void 0,(function(){return Bt(this,(function(n){switch(n.label){case 0:return[4,this.execute("captureGroupScreenshot",{windowId:t[0],options:Dt({groupWindowIds:t},e)})];case 1:return[2,n.sent().data]}}))}))},t.prototype.flash=function(t,e){return Gt(this,void 0,void 0,(function(){return Bt(this,(function(n){switch(n.label){case 0:return[4,this.execute("flash",{windowId:t.id,options:Dt({},e)})];case 1:return n.sent(),[2,t]}}))}))},t.prototype.execute=function(t,e){var n=this;return new Promise((function(i,o){var r=Dt(Dt({},e),{command:t});n.agm.invoke("T42.Wnd.Execute",r,n.agmTarget).then((function(t){t.returned&&t.returned.errorMsg?o(t):i(t.returned)})).catch((function(t){o(t)}))}))},t.prototype.setGroupHeaderVisible=function(t,e){return this.execute("setGroupHeaderVisibility",{windowId:t,options:{toShow:e}})},t.prototype.getGroupTitle=function(t){return this.execute("getGroupTitle",{windowId:t,options:{}}).then((function(t){return t.title}))},t.prototype.setGroupTitle=function(t,e){return this.execute("setGroupTitle",{windowId:t,options:{title:e}})},t.prototype.onClosing=function(t,e){var n="undefined"!=typeof window&&window.glue42gd;if(n)return n.addCloseHandler(t,e)},t.prototype.onRefreshing=function(t,e){var n="undefined"!=typeof window&&window.glue42gd;if(n)return n.addRefreshHandler(t,e)},t.prototype.reformatFlydownOptions=function(t,e){var n=function(t,n){if(e[n]&&(void 0===t[n]||null===t[n])){var i=e[n];t[n]=i}},i=e.zones.map((function(t){return n(t,"windowId"),n(t,"targetLocation"),!e.size||void 0!==t.flydownSize&&null!==t.flydownSize||(t.flydownSize=e.size),t.flydownBounds=t.flydownSize,t.flydownId=t.windowId,t.targetLocation||(t.targetLocation="bottom"),t}));return Dt(Dt({},e),{zones:i,targetId:t,flydownBounds:e.size,flydownActiveArea:e.activeArea})},t.prototype.clearFlydownArea=function(t,e){var n=this;return this.execute("clearFlydownWindowArea",{windowId:t,options:{}}).then((function(){e.forEach((function(e){n._registry.clearKey(t+"_"+e)}))}))},t}());function We(t,e){var n=Me.list;return Object.keys(n).reduce((function(i,o){var r=n[o];return r.API.tabGroupId===e&&r.API.id!==t&&(i[o]=r),i}),{})}var Re=function(){function t(t,e,n,i,o){this._registry=_e(),this._waitTimeout=1e4,this._agm=t,this._logger=e.subLogger("gd-env"),this._agmInstance=this.normalizeInstance(i),this._windowId=o,this._appManagerGetter=n}return t.prototype.init=function(){var t=this;return new Promise((function(e,n){void 0===t._agmInstance&&(t._agmInstance="best"),t._agm.registerAsync("T42.Wnd.OnEventWithResponse",(function(e,n,i,o){t.respondToEvent(e).then(i).catch(o)}));new Promise((function(i,o){t._agm.subscribe("T42.Wnd.OnEvent",{waitTimeoutMs:t._waitTimeout,target:t._agmInstance,onData:function(n){t.updateWindow(n.data,e)},onConnected:function(e){t._agmInstance=t.normalizeInstance(e),Oe.init(t._agm,t._agmInstance)}}).catch((function(t){n("Can not subscribe for stream T42.Wnd.OnEvent. Err: "+t)}))}))}))},Object.defineProperty(t.prototype,"executor",{get:function(){return Oe},enumerable:!0,configurable:!0}),t.prototype.open=function(t,e,n,i,o){var r=Dt({},n=n||{});void 0!==t?(void 0!==r.relativeTo&&"string"!=typeof r.relativeTo&&(r.relativeTo=r.relativeTo.id||""),r.name=t,r.url=e,r.windowState=n.windowState||n.state,delete r.state,this._agm.invoke("T42.Wnd.Create",r,this._agmInstance).then((function(t){if(void 0!==t.returned){var e=t.returned.id;i(e)}else o({message:"failed to execute T42.Wnd.Create - unknown reason"})})).catch(o)):o({message:"The name is undefined"})},t.prototype.createFlydown=function(t,e){return this.executor.createFlydown(t,e)},t.prototype.showPopup=function(t,e){return Gt(this,void 0,void 0,(function(){var n;return Bt(this,(function(i){switch(i.label){case 0:return n=Me.get(t),[4,this.executor.showPopup(n.API,e)];case 1:return i.sent(),[2]}}))}))},t.prototype.tabAttached=function(t){return this._registry.add("tab-attached",t)},t.prototype.tabDetached=function(t){return this._registry.add("tab-detached",t)},t.prototype.onWindowFrameColorChanged=function(t){return this._registry.add("frame-color-changed",t)},t.prototype.onEvent=function(t){return this._registry.add("window-event",t)},t.prototype.my=function(){return this._windowId},t.prototype.execute=function(t,e,n){return this._agm.invoke("T42.Wnd.Execute",{command:t,options:n,windowId:e})},t.prototype.setGroupHeaderVisible=function(t,e){return this._agm.invoke("T42.Wnd.SetGroupHeaderVisible",{windowId:t,toShow:e},this._agmInstance)},t.prototype.onCompositionChanged=function(t){return this._registry.add("composition-changed",t)},t.prototype.onGroupHeaderVisibilityChanged=function(t){return this._registry.add("group-header-changed",t)},t.prototype.onWindowGotFocus=function(t){return this._registry.add("got-focus",t)},t.prototype.onWindowLostFocus=function(t){return this._registry.add("lost-focus",t)},t.prototype.normalizeInstance=function(t){if(t)return{application:t.application,machine:t.machine,user:t.user}},t.prototype.respondToEvent=function(t){return"ShowFlydownBoundsRequested"===t.type?this.executor.handleFlydownBoundsRequested(t.data.windowId,t.data):Promise.reject("There isn't a handler for "+t.type)},t.prototype.updateWindow=function(t,e){var n=this,i=this.getExtendedStreamEvent(t);if("Snapshot"===t.type)return t.windows.forEach((function(t){var e=n.createWindow(t.id,t);Me.markReadyToShow(e.API.id),n._registry.execute("window-event",i)})),void e(this);if("Created"===t.type){var o=t,r=this.createWindow(o.windowId,o.data||{});return Me.setReadyState(r.API.id),void this._registry.execute("window-event",i)}var s=Me.get(t.windowId);if(s){var a=s.API,c=s.Events;if("BoundsChanged"===t.type){var u=t;c.handleBoundsChanged(u.data)}if("UrlChanged"===t.type){var d=t;Me.setUrlChangedState(d.windowId),c.handleUrlChanged(d.data)}if("TitleChanged"===t.type){var p=t;c.handleTitleChanged(p.data)}if("VisibilityChanged"===t.type&&c.handleVisibilityChanged(t.data),"ContextChanged"===t.type&&c.handleContextUpdated(t.data),"StateChanged"===t.type&&c.handleWindowChangeState(t.data),"FrameColorChanged"===t.type&&(c.handleFrameColorChanged(t.data),this._registry.execute("frame-color-changed",a)),"CompositionChanged"===t.type){var h=t;c.handleCompositionChanged(h.data.neighbors,h.data.groupId),this._registry.execute("composition-changed",h.data)}if("GroupHeaderVisibilityChanged"===t.type){var f=t;c.handleGroupHeaderVisibilityChanged(f.data.groupHeaderVisible),this._registry.execute("group-header-changed",f.data)}if("FocusChanged"===t.type){var l=t;this.focusChanged(c,a,l.data)}if("WindowFrameChanged"===t.type&&(c.handleFrameAttached(t.data.frameId,t.data.isTabHeaderVisible),this._registry.execute("frame-changed")),"WindowFrameAdded"===t.type){c.handleAttached(t.data.frameId,t.data.isTabHeaderVisible);var y=We(a.id,t.data.frameId);Object.keys(y).forEach((function(t){y[t].Events.handleWindowAttached(a)})),this._registry.execute("tab-attached",a,t.data.frameId,t.data.isTabHeaderVisible)}if("WindowFrameRemoved"===t.type){var g=a.tabGroupId;c.handleDetached(t.data.frameId);var v=We(a.id,g);Object.keys(v).forEach((function(t){v[t].Events.handleWindowDetached(a)}));var m=this._registry.add("frame-changed",(function(){m(),n._registry.execute("tab-detached",a,t.data.frameId,a.tabGroupId)}))}"TabHeaderVisibilityChanged"===t.type&&c.handleTabHeaderVisibilityChanged(t.data.isTabHeaderVisible),"FrameSelectionChanged"===t.type&&c.handleFrameSelectionChanged(t.data.newWindowId,t.data.prevWindowId),"ButtonClicked"===t.type&&c.handleFrameButtonClicked(t.data),"ButtonAdded"===t.type&&c.handleFrameButtonAdded(t.data),"ButtonRemoved"===t.type&&c.handleFrameButtonRemoved(t.data),"WindowZoomFactorChanged"===t.type&&c.handleZoomFactorChanged(t.data),"Closed"===t.type&&(Me.remove(s),c.handleWindowClose()),"FrameIsLockedChanged"===t.type&&c.handleFrameIsLockedChanged(t.data),this._registry.execute("window-event",i)}else this._logger.error("received update for unknown window. Stream:', "+JSON.stringify(t,null,4))},t.prototype.createWindow=function(t,e){var n=Ee(t,this.mapToWindowConstructorOptions(e),Oe,this._logger,this._appManagerGetter,this._agm);return Me.add(n),n},t.prototype.focusChanged=function(t,e,n){t.handleFocusChanged(n),n?this._registry.execute("got-focus",e):this._registry.execute("lost-focus",e)},t.prototype.mapToWindowConstructorOptions=function(t){return{name:t.name,context:t.context,bounds:t.bounds,url:t.url,title:t.title,isVisible:t.isVisible,focus:t.isFocused,state:t.state,frameColor:t.frameColor,groupId:t.groupId,neighbours:t.neighbors,isFocused:t.isFocused,isGroupHeaderVisible:t.groupHeaderVisible,isCollapsed:t.isCollapsed,tabGroupId:t.frameId,mode:t.mode,isTabHeaderVisible:t.isTabHeaderVisible,isTabSelected:t.isActiveTab,settings:t.settings,windowType:t.windowType,zoomFactor:t.zoomFactor,isLocked:t.isLocked}},t.prototype.getExtendedStreamEvent=function(t){try{var e=Dt({state:t.type,windowName:Me.get(t.windowId).API.name},t);return"WindowFrameAdded"===e.state&&(e.state="TabAttached"),"StateChanged"===e.state&&(e.state=e.data.charAt(0).toUpperCase()+e.data.slice(1)),"ButtonAdded"===e.state&&(e.state="FrameButtonAdded"),"ButtonRemoved"===e.state&&(e.state="FrameButtonRemoved"),e}catch(e){return t}},t}(),Fe=function(t,e){var n=_e(),i=[];function o(){return new Promise((function(t,e){var n=c((function(e){n(),t()}))}))}function r(t,n,i,o){return new Promise((function(o,r){e.execute(t,n).then((function(t){"function"==typeof i&&i(u),o(u)})).catch((function(t){r(t)}))}))}function s(){var t=[];return i.forEach((function(e){var n=a(e);void 0!==n&&t.push(n)})),t}function a(t){return Me.get(t)?Me.get(t).API:void 0}function c(t){return n.add("header-visibility-changed",t)}var u={id:t,get windows(){return e=s(),"function"==typeof t&&t(e),e;var t,e},find:function(t,e){var n;n="string"==typeof t?t:t.id;var o=i.indexOf(n);if(-1!==o){var r=a(i[o]);return"function"==typeof e&&e(r),r}},get isHeaderVisible(){return void 0===s().find((function(t){return!t.isGroupHeaderVisible}))},showHeader:function(t,n){return new Promise((function(n,r){Promise.all([e.setGroupHeaderVisible(i[0],!0),o()]).then((function(){"function"==typeof t&&t(u),n(u)})).catch((function(t){r(t)}))}))},hideHeader:function(t,n){return new Promise((function(n,r){Promise.all([e.setGroupHeaderVisible(i[0],!1),o()]).then((function(){"function"==typeof t&&t(u),n(u)})).catch((function(t){}))}))},getTitle:function(){return e.getGroupTitle(i[0])},setTitle:function(t){return e.setGroupTitle(i[0],t)},capture:function(t){return e.captureGroup(i,t)},maximize:function(e,n){return r("maximize",{groupId:t},e)},restore:function(e,n){return r("restore",{groupId:t},e)},onHeaderVisibilityChanged:c,onWindowAdded:function(t){return n.add("window-added",t)},onWindowRemoved:function(t){return n.add("window-removed",t)}};return{groupAPI:u,groupInternal:{addWindow:function(t){if(-1===i.indexOf(t)){i.push(t);var e=Me.get(t);e.Events.handleGroupAssociation(u),n.execute("window-added",u,e.API)}},removeWindow:function(t){var e=i.indexOf(t);if(-1!==e){i.splice(e,1);var o=a(t);n.execute("window-removed",u,o)}},handleGroupHeaderVisibilityChanged:function(t){n.execute("header-visibility-changed",u)}}}},Le=function(t,e){var n=e.subLogger("groups"),i=_e(),o={},r=-1,s=Me.list;function a(t,n){var i,r;if(void 0!==t)return i="string"==typeof t?t:t.id,Object.keys(o).forEach((function(t){var e=o[t].groupAPI;void 0===e.find(i)||(r=e)})),"function"==typeof n&&n(r),r;e.debug("trying to find a group by a window, but winId is undefined")}function c(t){n.trace("Adding new window "+t.API.id+" to win.API.groupId "+t.API.groupId);var e=u(t);e&&(n.trace("handleGroupAssociation "+t.API.id+" to group.groupAPI.id "+e.groupAPI.id),t.Events.handleGroupAssociation(e.groupAPI))}function u(e,i){var r=i||e.API.groupId,s=e.API.id;if(void 0!==r&&void 0!==s){var a=function(e){if(o.hasOwnProperty(e))return o[e];var n=Fe(e,t.executor);return o[e]=n,n}(r);return a.groupInternal.addWindow(s),a}n.debug("trying to add a window without group - winId: "+s)}function d(t,e){var n=t.API.id,i=e||t.API.groupId;void 0!==i&&(o[i].groupInternal.removeWindow(n),t.Events.handleGroupAssociation(void 0),function(t){o.hasOwnProperty(t)&&void 0!==o[t]&&0===o[t].groupAPI.windows.length&&delete o[t]}(i))}return Object.keys(s).forEach((function(t){c(s[t])})),t.onCompositionChanged((function(t){!function(t){var e=t.groupId,o=t.windowId,r=a(o),s=r?r.id:void 0;if(n.trace("handleCompositionChanged newGroupId: "+e+" windowId: "+o+" oldGroup: "+s),s===e)return void n.trace("handleCompositionChanged newGroupId: "+e+" windowId: "+o+" oldGroup: "+s+" are the same - returning...");var c=Me.get(o)||Me.get(o),p=u(c,e);r&&(d(c,s),i.execute("window-moved",o,r,e));c.Events.handleGroupChanged(p.groupAPI,r)}(t)})),t.onGroupHeaderVisibilityChanged((function(t){var e=a(t.windowId);if(void 0!==e){var n=o[e.id];-1===r&&(r=e.windows.length),0===--r&&(r=-1,n.groupInternal.handleGroupHeaderVisibilityChanged(t))}})),Me.onAdded((function(t){c(t)})),Me.onRemoved((function(t){d(t)})),{groupsAPI:{get my(){return a(t.my())},list:function(t){var e=Object.keys(o).map((function(t){if(o[t])return o[t].groupAPI}));return"function"==typeof t&&t(e),e},findGroupByWindow:a},groupsEvents:{onWindowMoved:function(t){return i.add("window-moved",t)}}}},Ne=function(t,e,n,i){var o,r,s=_e(),a=e;Me.init(a);var c=new Promise((function(e,s){(function(t,e,n,i){var o=e;return new Promise((function(e,r){if(2===i)throw o.trace("running in HC"),new Error("GD2 not supported");if(i>=3){o.trace("running in GD 3"),new Re(t,o,n,void 0,window.glue42gd.windowId).init().then(e).catch(r)}else{var s=new Re(t,o,n).init();Promise.race([s,(a=1e4,new Promise((function(t,e){return setTimeout((function(){e("timeout waiting for streams")}),a)})))]).then(e).catch(r)}var a}))})(t,a,n,i).then((function(t){r=t,o=Le(t,a),e()})).catch((function(t){var e="Environment detector fails with: "+t;a.error(e),s(e)}))}));function u(t){return s.add("window-added",t)}function d(t){return s.add("window-removed",t)}return Me.onReadyWindow((function(t){s.execute("window-added",t.API)})),Me.onRemoved((function(t){s.execute("window-removed",t.API)})),{my:function(){var t=Me.getIfReady(r.my());return t?t.API:void 0},open:function(t,e,n,i,o){return new Promise((function(s,a){var c=function(t){"function"==typeof o&&o(t),a(t)};r.open(t,e,n,(function(t){Me.waitFor(t).then((function(t){"function"==typeof i&&i(t.API),s(t.API),"electron"===t.API.windowType&&t.Events.handleUrlChanged(t.API.url)})).catch(c)}),c)}))},find:function(t,e,n){var i=Me.list,o=Object.keys(i).reduce((function(e,n){var o=i[n];return o&&o.API.name===t&&e.push(o.API),e}),[]);if("function"!=typeof e)return o[0];o.length>0?e(o[0]):"function"==typeof n&&n("There is no window with name:"+t)},findById:function(t,e,n){var i=Me.list,o=Object.keys(i).reduce((function(e,n){var o=i[n];return void 0!==o&&o.API.id===t&&e.push(o.API),e}),[]);if("function"!=typeof e)return o[0];o.length>0?e(o[0]):"function"==typeof n&&n("There is no window with such id:"+t)},list:function(t){var e=Me.list,n=Object.keys(e).map((function(t){return e[t].API}));if("function"!=typeof t)return n;t(n)},ready:function(){return c},onWindowAdded:u,windowAdded:u,onWindowRemoved:d,windowRemoved:d,onTabAttached:function(t){return c.then((function(){r.tabAttached(t)}))},onTabDetached:function(t){return c.then((function(){r.tabDetached(t)}))},onWindowFrameColorChanged:function(t){return c.then((function(){return r.onWindowFrameColorChanged(t)}))},get groups(){return o.groupsAPI},onWindowGotFocus:function(t){var e;return c.then((function(){e=r.onWindowGotFocus(t)})),function(){e&&e()}},onWindowLostFocus:function(t){var e;return c.then((function(){e=r.onWindowLostFocus(t)})),function(){e&&e()}},onEvent:function(t){var e,n=!1;return c.then((function(){n||(e=r.onEvent(t))})),function(){n=!0,e&&e()}},createFlydown:function(t,e){return r.createFlydown(t,e)},showPopup:function(t,e){return r.showPopup(t,e)}}},De=new(function(){function t(){this.layouts=[]}return t.prototype.removeWhere=function(t){this.layouts=this.layouts.filter(t)},t.prototype.add=function(t){this.layouts.push(t)},Object.defineProperty(t.prototype,"all",{get:function(){return this.layouts},enumerable:!0,configurable:!0}),t.prototype.where=function(t){return this.layouts.filter(t)},t.prototype.first=function(t){return this.where(t)[0]},t}());var Ge=1;var Be,He,qe,Ue={nextValue:function(){return(Ge=(9301*Ge+49297)%233280)/233280},seed:function(t){Ge=t}},Ve="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ_-";function ze(){qe=!1}function Je(t){if(t){if(t!==Be){if(t.length!==Ve.length)throw new Error("Custom alphabet for shortid must be "+Ve.length+" unique characters. You submitted "+t.length+" characters: "+t);var e=t.split("").filter((function(t,e,n){return e!==n.lastIndexOf(t)}));if(e.length)throw new Error("Custom alphabet for shortid must be "+Ve.length+" unique characters. These characters were not unique: "+e.join(", "));Be=t,ze()}}else Be!==Ve&&(Be=Ve,ze())}function Ke(){return qe||(qe=function(){Be||Je(Ve);for(var t,e=Be.split(""),n=[],i=Ue.nextValue();e.length>0;)i=Ue.nextValue(),t=Math.floor(i*e.length),n.push(e.splice(t,1)[0]);return n.join("")}())}var Ze={characters:function(t){return Je(t),Be},seed:function(t){Ue.seed(t),He!==t&&(ze(),He=t)},lookup:function(t){return Ke()[t]},shuffled:Ke},Ye="object"==typeof window&&(window.crypto||window.msCrypto);var Xe=function(){if(!Ye||!Ye.getRandomValues)return 48&Math.floor(256*Math.random());var t=new Uint8Array(1);return Ye.getRandomValues(t),48&t[0]};var Qe=function(t,e){for(var n,i=0,o="";!n;)o+=t(e>>4*i&15|Xe()),n=e<Math.pow(16,i+1),i++;return o};var $e,tn,en=function(t){var e=Ze.shuffled();return{version:15&e.indexOf(t.substr(0,1)),worker:15&e.indexOf(t.substr(1,1))}};var nn=function(t){var e="",n=Math.floor(.001*(Date.now()-1459707606518));return n===tn?$e++:($e=0,tn=n),e+=Qe(Ze.lookup,6),e+=Qe(Ze.lookup,t),$e>0&&(e+=Qe(Ze.lookup,$e)),e+=Qe(Ze.lookup,n)};var on=function(t){if(!t||"string"!=typeof t||t.length<6)return!1;for(var e=Ze.characters(),n=t.length,i=0;i<n;i++)if(-1===e.indexOf(t[i]))return!1;return!0},rn=function(t,e){return t(e={exports:{}},e.exports),e.exports}((function(t){var e=0;function n(){return nn(e)}t.exports=n,t.exports.generate=n,t.exports.seed=function(e){return Ze.seed(e),t.exports},t.exports.worker=function(n){return e=n,t.exports},t.exports.characters=function(t){return void 0!==t&&Ze.characters(t),Ze.shuffled()},t.exports.decode=en,t.exports.isValid=on})),sn=(rn.generate,rn.seed,rn.worker,rn.characters,rn.decode,rn.isValid,rn),an=function(){function t(t,e,n){this.agm=t,this.activitiesGetter=e,this.callbacks=n,this.registeredRequestsMethods=!1}return t.prototype.onSaveRequested=function(t){return this.registeredRequestsMethods||(this.registerRequestMethods(),this.registeredRequestsMethods=!0),this.callbacks.add("saveRequested",t)},t.prototype.isActivityOwner=function(){if("undefined"!=typeof htmlContainer){var t=htmlContainer.getContext();return t&&t._t42&&t._t42.activityIsOwner}var e=this.activitiesGetter();if(!e)return!1;if(!e.inActivity)return!1;var n=e.my.window,i=e.my.activity;return!(!i&&!n)&&i.owner.id===n.id},t.prototype.registerRequestMethods=function(){var t=this;this.agm.register("T42.HC.GetSaveContext",(function(e){var n=t.callbacks.execute("saveRequested",e)[0];if(!n)return{};n.activityContext=n.activityContext||{},n.windowContext=n.windowContext||{};var i={windowContext:n.windowContext,activityContext:void 0};return t.isActivityOwner()&&(i.activityContext=n.activityContext),i}))},t}();function cn(t){if(!t)return t;if(Array.isArray(t))return t.map((function(t){return cn(t)}));if("string"==typeof t||"number"==typeof t||"boolean"==typeof t)return t;return Object.keys(t).reduce((function(e,n){var i=cn(t[n]),o=n;return n[0].toLowerCase()!==n[0]&&(o=n[0].toLowerCase()+n.substr(1)),e[o]=i,e}),{})}var un=function(t){this.name=t.name,this.type=t.type,this.components=t.components,this.context=t.context,this.metadata=t.metadata},dn=function(){function t(t,e,n){this.config=t,this.stream=e,this.callbacks=n,this.appManager=t.appManager,this.onEvent=e.onEvent,this.provider=new an(t.agm,t.activityGetter,n),e.subscribe()}return t.prototype.setDefaultGlobal=function(t){return Gt(this,void 0,void 0,(function(){return Bt(this,(function(e){switch(e.label){case 0:return[4,this.config.agm.invoke("T42.ACS.SelectDefaultLayout",{name:t})];case 1:return e.sent(),[2]}}))}))},t.prototype.clearDefaultGlobal=function(){return Gt(this,void 0,void 0,(function(){return Bt(this,(function(t){switch(t.label){case 0:return[4,this.config.agm.invoke("T42.ACS.DeselectDefaultLayout")];case 1:return t.sent(),[2]}}))}))},t.prototype.getDefaultGlobal=function(){return Gt(this,void 0,void 0,(function(){var t,e;return Bt(this,(function(n){switch(n.label){case 0:return[4,this.config.agm.invoke("T42.ACS.GetDefaultLayout")];case 1:return t=n.sent(),(e=t.returned)?this.isSlimMode()?[2,e]:[2,this.list().find((function(t){return t.name===e.name&&"Global"===t.type}))]:[2,void 0]}}))}))},t.prototype.ready=function(){return"fullWaitSnapshot"===this.config.mode?this.stream.gotSnapshot:this.stream.ready},t.prototype.save=function(t){var e=this;return new Promise((function(n,i){if(e.verifyNotSlimMode(),!t.name)throw Error("layout.name argument is required");t.type||(t.type="Global"),t.activityId&&(t.type="Activity"),void 0===t.ignoreHidden&&(t.ignoreHidden=!0);var o={name:t.name,actIds:[],appIds:[],type:t.type,context:t.context,metadata:t.metadata||{},options:{ignoreLayoutRestrictions:!1}};if("Activity"===t.type){var r=t.activityId;if(!r){if(!e.appManager.myInstance.inActivity)throw new Error("Current application is not in activity. Can not save activity layout for it");r=e.appManager.myInstance.activityId}o.actIds.push(r),o.options={ignoreLayoutRestrictions:!0}}else{if("Global"!==t.type)throw new Error("layout type "+t.type+" not supported");if(2===e.config.gdMajorVersion){var s=e.appManager.instances();t.ignoreHidden&&(s=s.filter((function(t){return e.isVisibleWindow(t)}))),t.ignoreMyInstance&&e.appManager.myInstance&&(s=s.filter((function(t){return t.id!==e.appManager.myInstance.id}))),s.reduce((function(t,e){if(!e.id)return t;if(e.inActivity){var n=e.activityId;-1===t.actIds.indexOf(n)&&t.actIds.push(n)}else t.appIds.push(e.id);return t}),o)}else o.autoCollectApps=!0}e.invokeMethodAndTrack("T42.ACS.SaveLayout",o,n,i)}))},t.prototype.restore=function(t){var e=this;return new Promise((function(n,i){if(e.verifyNotSlimMode(),void 0===t)throw Error("options argument is required");if(!t.name)throw Error("options.name argument is required");t.type||(t.type="Global"),t.activityIdToJoin&&(t.type="Activity"),void 0===t.restoreActivityOwner&&(t.restoreActivityOwner=!1),void 0===t.ignoreActivityWindowTypes&&(t.ignoreActivityWindowTypes=[]),void 0===t.setActivityContext&&(t.setActivityContext=!0),void 0===t.closeRunningInstance&&("Global"===t.type?t.closeRunningInstance=!0:"Activity"===t.type&&(t.closeRunningInstance=!1)),void 0===t.reuseWindows&&(t.reuseWindows=!0),t.context=t.context||{};var o={restoreOptions:{activityToJoin:t.activityIdToJoin,setActivityContext:t.setActivityContext,ignoreActivityWindowTypes:t.ignoreActivityWindowTypes,restoreActivityOwner:t.restoreActivityOwner,closeOldWindows:t.closeRunningInstance,reuseExistingWindows:t.reuseWindows}},r={type:t.type,name:t.name,context:t.context,toClose:[],splash:t.splash};2===e.config.gdMajorVersion&&t.closeRunningInstance&&(r.toClose=e.getInstancesToClose(t)),t.timeout&&(r.timeout=t.timeout),r.context._t42=o,e.invokeMethodAndTrack("T42.ACS.RestoreLayout",r,n,i,!0)}))},t.prototype.remove=function(t,e){var n=this;return new Promise((function(i,o){if(n.verifyNotSlimMode(),!e)throw Error("name argument is required");if(!t)throw Error("type argument is required");var r={type:t,name:e};n.invokeMethodAndTrack("T42.ACS.RemoveLayout",r,i,o)}))},t.prototype.list=function(){return this.verifyNotSlimMode(),De.all},t.prototype.import=function(t,e){var n=this;return new Promise((function(i,o){n.verifyNotSlimMode();var r={mode:e||"replace",layouts:t};n.invokeMethodAndTrack("T42.ACS.ImportLayouts",r,i,o)}))},t.prototype.export=function(){var t=this;return new Promise((function(e,n){t.invokeMethodAndTrack("T42.ACS.ExportLayouts",{},(function(n){var i=t.getObjectValues(n.Layouts).map((function(t){return new un(cn(t))}));e(i)}),n,!0)}))},t.prototype.rename=function(t,e){var n=this;return new Promise((function(i,o){if(n.verifyNotSlimMode(),!t)throw Error("layout argument is required");if(!t.name)throw Error("name argument is required");if(!t.type)throw Error("type argument is required");var r={type:t.type,oldName:t.name,newName:e};n.invokeMethodAndTrack("T42.ACS.RenameLayout",r,i,o)}))},t.prototype.updateMetadata=function(t){var e=this;return new Promise((function(n,i){if(!t)throw Error("layout argument is required");if(!t.name)throw Error("name argument is required");if(!t.type)throw Error("type argument is required");if(!t.metadata)throw Error("metadata argument is required");var o={name:t.name,type:t.type,metadata:t.metadata};e.invokeMethodAndTrack("T42.ACS.UpdateMetadata",o,n,i,!0)}))},t.prototype.hibernate=function(t,e){var n=this;return new Promise((function(i,o){if(!t)return o("name cannot be empty");var r={name:t,type:"Global",context:(e=e||{}).context||{},metadata:e.metadata||{}};n.invokeMethodAndTrack("T42.ACS.HibernateLayout",r,i,o,!0)}))},t.prototype.resume=function(t,e,n){var i=this;return new Promise((function(o,r){if(!t)return r("name cannot be empty");var s=Dt({name:t,type:"Global",context:e},n);i.invokeMethodAndTrack("T42.ACS.ResumeLayout",s,o,r,!0)}))},t.prototype.getCurrentLayout=function(){return Gt(this,void 0,void 0,(function(){var t,e;return Bt(this,(function(n){switch(n.label){case 0:return[4,this.config.agm.invoke("T42.ACS.GetCurrentLayout",{},"best",{methodResponseTimeoutMs:12e4})];case 1:return t=n.sent(),(e=t.returned.layout)?(this.isSlimMode()||(e=this.list().find((function(t){return t.name===e.name&&t.type===e.type}))),[2,e]):[2,void 0]}}))}))},t.prototype.onAdded=function(t){var e=this.callbacks.add("added",t);return De.all.length>0&&De.all.forEach((function(e){try{t(e)}catch(t){}})),e},t.prototype.onRemoved=function(t){return this.callbacks.add("removed",t)},t.prototype.onChanged=function(t){return this.callbacks.add("changed",t)},t.prototype.onRestored=function(t){return this.callbacks.add("restored",t)},t.prototype.onRenamed=function(t){return this.callbacks.add("renamed",t)},t.prototype.onEvent=function(t){return this.stream.onEvent(t)},t.prototype.onSaveRequested=function(t){return this.provider.onSaveRequested(t)},t.prototype.updateAppContextInCurrent=function(t){var e=this;return new Promise((function(n,i){t&&"object"!=typeof t&&i("context must be an object");var o={context:t=null!=t?t:{}};e.invokeMethodAndTrack("T42.ACS.UpdateLayoutComponentContext",o,n,i,!1)}))},t.prototype.isSlimMode=function(){return"slim"===this.config.mode},t.prototype.verifyNotSlimMode=function(){if(this.isSlimMode())throw Error("Operation not allowed in slim mode. Run in full mode.")},t.prototype.isVisibleWindow=function(t){return"exe"===t.application.type||"node"===t.application.type||("activity"===t.application.type||!(!t||!t.window)&&t.window.isVisible)},t.prototype.invokeMethodAndTrack=function(t,e,n,i,o){var r,s=o,a=sn();e.token=a;var c=function(){s&&r&&n(r)};o||this.stream.waitFor(a).then((function(){s=!0,c()})).catch((function(t){i(t)}));this.config.agm.invoke(t,e,"best",{methodResponseTimeoutMs:12e4}).then((function(e){e.returned||i("No result from method "+t),e.returned.status&&"Success"!==e.returned.status&&"PartialSuccess"!==e.returned.status&&i(e.returned),r=e.returned,c()})).catch((function(t){return i(t)}))},t.prototype.getInstancesToClose=function(t){var e=this,n=[],i=this.appManager.applications().filter((function(t){return t.isShell}))[0],o=i?i.name:"AppManager";return this.appManager.instances().forEach((function(i){e.appManager.myInstance&&i.id===e.appManager.myInstance.id||i.application.name!==o&&e.isVisibleWindow(i)&&("Activity"===t.type&&i.activityId!==t.activityIdToJoin||n.push({application:i.application.name,instance:i.id}))})),n},t.prototype.getObjectValues=function(t){return t?Object.keys(t).map((function(e){return t[e]})):[]},t}(),pn=function(){function t(t,e){var n=this;this.agm=t,this.callbacks=e,this.ready=new Promise((function(t,e){n.resolveReady=t,n.rejectReady=e})),this.gotSnapshot=new Promise((function(t,e){n.resolveGotSnapshot=t,n.rejectGotSnapshot=e}))}return t.prototype.subscribe=function(t){var e=this,n=function(t){return e.getObjectValues(t).map((function(t){return cn(t)}))};this.checkForLayoutEventMethod()?this.agm.subscribe("T42.ACS.OnLayoutEvent",{waitTimeoutMs:1e4}).then((function(t){t.onData((function(t){var i=t.data;i.IsSnapshot&&e.resolveGotSnapshot(),e.addLayouts(n(i.OnLayoutAdded)),e.removeLayouts(n(i.OnLayoutRemoved)),e.changeLayouts(n(i.OnLayoutChanged)),e.renameLayouts(n(i.OnLayoutRenamed)),e.restoredLayout(n(i.OnLayoutRestored)),e.callbacks.execute("streamEvent",i)})),t.onFailed((function(t){var n="can not subscribe to T42.ACS.OnLayoutEvent "+t;e.rejectReady(n),e.rejectGotSnapshot(n)})),e.resolveReady()})).catch((function(t){var n="Error subscribing for T42.ACS.OnLayoutEvent stream. Err: "+t;e.rejectReady(n),e.rejectGotSnapshot(n)})):(t&&this.resolveReady(),setTimeout((function(){e.subscribe(!0)}),500))},t.prototype.onEvent=function(t){return this.callbacks.add("streamEvent",t)},t.prototype.waitFor=function(t,e){var n=this;return e||(e=1e4),new Promise((function(i,o){var r=!1,s=n.onEvent((function(e){e.Token===t&&(r=!0,s(),i())}));setTimeout((function(){r||o("timed out")}),e)}))},t.prototype.checkForLayoutEventMethod=function(){try{return-1!==this.agm.methods().map((function(t){return t.name})).indexOf("T42.ACS.OnLayoutEvent")}catch(t){return!1}},t.prototype.addLayouts=function(t){var e=this;t&&t.forEach((function(t){var n=new un(t);De.add(n),e.callbacks.execute("added",n)}))},t.prototype.removeLayouts=function(t){var e=this;t&&t.forEach((function(t){De.removeWhere((function(n){return!e.compareLayouts(n,t)})),e.callbacks.execute("removed",t)}))},t.prototype.changeLayouts=function(t){var e=this;t&&t.forEach((function(t){De.removeWhere((function(n){return!e.compareLayouts(n,t)})),De.add(new un(t)),e.callbacks.execute("changed",t)}))},t.prototype.renameLayouts=function(t){var e=this;t&&t.forEach((function(t){var n=De.first((function(n){return e.compareLayouts(n,{type:t.type,name:t.oldName})}));if(!n)throw Error("received rename event for unknown layout with type "+t.type+" and name "+t.oldName);n.name=t.newName,e.callbacks.execute("renamed",n)}))},t.prototype.compareLayouts=function(t,e){return t.name===e.name&&t.type===e.type},t.prototype.getObjectValues=function(t){return t?Object.keys(t).map((function(e){return t[e]})):[]},t.prototype.restoredLayout=function(t){var e=this;t&&t.forEach((function(t){var n=De.first((function(n){return e.compareLayouts(n,{type:t.type,name:t.name})}));e.callbacks.execute("restored",n)}))},t}();function hn(t){if(!t.agm)throw Error("config.agm is required");if(!t.logger)throw Error("config.logger is required");t.mode=t.mode||"slim";t.logger;var e,n=_e();return t.mode,e=new pn(t.agm,n),new dn(t,e,n)}var fn,ln,yn,gn=function(t,e){var n=this;this._agm=t,this._logger=e,this.all=function(){return Gt(n,void 0,void 0,(function(){return Bt(this,(function(t){switch(t.label){case 0:return[4,this.callGD(fn.GetAll,{})];case 1:return[2,t.sent().map(this.decorateDisplay)]}}))}))},this.get=function(t){return Gt(n,void 0,void 0,(function(){var e;return Bt(this,(function(n){switch(n.label){case 0:return[4,this.callGD(fn.Get,{id:t})];case 1:return e=n.sent(),[2,this.decorateDisplay(e)]}}))}))},this.getPrimary=function(){return Gt(n,void 0,void 0,(function(){return Bt(this,(function(t){switch(t.label){case 0:return[4,this.all()];case 1:return[2,t.sent().find((function(t){return t.isPrimary}))]}}))}))},this.capture=function(t){return Gt(n,void 0,void 0,(function(){return Bt(this,(function(e){switch(e.label){case 0:return[4,this.callGD(fn.Capture,Dt({},t))];case 1:return[2,e.sent()]}}))}))},this.captureAll=function(t){return Gt(n,void 0,void 0,(function(){return Bt(this,(function(e){switch(e.label){case 0:return[4,this.callGD(fn.CaptureAll,Dt({},t))];case 1:return[2,e.sent()]}}))}))},this.getMousePosition=function(){return Gt(n,void 0,void 0,(function(){return Bt(this,(function(t){switch(t.label){case 0:return[4,this.callGD(fn.GetMousePosition)];case 1:return[2,t.sent()]}}))}))},this.callGD=function(t,e){return Gt(n,void 0,void 0,(function(){return Bt(this,(function(n){switch(n.label){case 0:return[4,this._agm.invoke("T42.Displays.Command",{options:Dt({},e),command:t})];case 1:return[2,n.sent().returned.data]}}))}))},this.decorateDisplay=function(t){return Dt(Dt({},t),{capture:function(e){return n.capture({id:t.id,size:e})}})}};function vn(t,e){return Gt(this,void 0,void 0,(function(){return Bt(this,(function(n){return ln.invoke("T42.Channels.Announce",{swId:null!=e?e:yn,command:"switchChannel",data:{newChannel:t}}),[2]}))}))}!function(t){t.Capture="capture",t.CaptureAll="captureAll",t.GetAll="getAll",t.Get="get",t.GetMousePosition="getMousePosition"}(fn||(fn={}));var mn=function(){function t(t){this.contexts=t}return t.prototype.subscribe=function(t){this.callback=t},t.prototype.subscribeFor=function(t,e){if(!this.isChannel(t))return Promise.reject(new Error("Channel with name: "+t+" doesn't exist!"));var n=this.createContextName(t);return this.contexts.subscribe(n,(function(t,n,i,o,r){var s;e(t.data,t,null===(s=r)||void 0===s?void 0:s.updaterId)}))},t.prototype.switchChannel=function(t){return Gt(this,void 0,void 0,(function(){var e,n,i=this;return Bt(this,(function(o){switch(o.label){case 0:return this.unsubscribe(),e=this.createContextName(t),n=this,[4,this.contexts.subscribe(e,(function(t,e,n,o,r){var s;i.callback&&i.callback(t.data,t,null===(s=r)||void 0===s?void 0:s.updaterId)}))];case 1:return n.unsubscribeFunc=o.sent(),[2]}}))}))},t.prototype.unsubscribe=function(){this.unsubscribeFunc&&this.unsubscribeFunc()},t.prototype.add=function(t,e){var n=this.createContextName(t);return this.contexts.set(n,e)},t.prototype.all=function(){return this.contexts.all().filter((function(t){return t.startsWith("___channel___")})).map((function(t){return t.substr("___channel___".length)}))},t.prototype.getContextData=function(t){var e=this;return new Promise((function(n,i){if(!e.isChannel(t))return i(new Error("A channel with name: "+t+" doesn't exist!"));var o=e.createContextName(t);e.contexts.subscribe(o,(function(t){n(t)})).then((function(t){return t()}))}))},t.prototype.update=function(t,e){var n=this.createContextName(t);return this.contexts.update(n,e)},t.prototype.createContextName=function(t){return"___channel___"+t},t.prototype.isChannel=function(t){return this.all().some((function(e){return e===t}))},t}(),wn=function(){function t(t){this.shared=t,this.subsKey="subs",this.changedKey="changed",this.registry=_e(),this.shared.subscribe(this.handler.bind(this))}return t.prototype.subscribe=function(t){if("function"!=typeof t)throw new Error("Please provide the callback as a function!");return this.registry.add(this.subsKey,t)},t.prototype.subscribeFor=function(t,e){return Gt(this,void 0,void 0,(function(){return Bt(this,(function(n){switch(n.label){case 0:if("string"!=typeof t)throw new Error("Please provide the name as a string!");if("function"!=typeof e)throw new Error("Please provide the callback as a function!");return[4,this.shared.subscribeFor(t,e)];case 1:return[2,n.sent()]}}))}))},t.prototype.publish=function(t,e){return Gt(this,void 0,void 0,(function(){var n;return Bt(this,(function(i){switch(i.label){case 0:if("object"!=typeof t)throw new Error("Please provide the data as an object!");if(!e)return[3,2];if("string"!=typeof e)throw new Error("Please provide the name as a string!");return[4,this.get(e)];case 1:return n=i.sent(),[2,this.shared.update(n.name,{data:t})];case 2:if(!this.currentContext)throw new Error("Not joined to any channel!");return[2,this.shared.update(this.currentContext,{data:t})]}}))}))},t.prototype.all=function(){var t=this.shared.all();return Promise.resolve(t)},t.prototype.list=function(){return Gt(this,void 0,void 0,(function(){var t,e=this;return Bt(this,(function(n){switch(n.label){case 0:return[4,this.all()];case 1:return t=n.sent(),[4,Promise.all(t.map((function(t){return e.get(t)})))];case 2:return[2,n.sent()]}}))}))},t.prototype.get=function(t){return"string"!=typeof t?Promise.reject(new Error("Please provide the channel name as a string!")):this.shared.getContextData(t)},t.prototype.join=function(t){return Gt(this,void 0,void 0,(function(){return Bt(this,(function(e){return[2,this.joinCore(t)]}))}))},t.prototype.joinNoSelectorSwitch=function(t){return Gt(this,void 0,void 0,(function(){return Bt(this,(function(e){return[2,this.joinCore(t,!1)]}))}))},t.prototype.leave=function(){return this.leaveCore()},t.prototype.leaveNoSelectorSwitch=function(){return this.leaveCore(!1)},t.prototype.current=function(){return this.currentContext},t.prototype.my=function(){return this.current()},t.prototype.changed=function(t){if("function"!=typeof t)throw new Error("Please provide the callback as a function!");return this.registry.add(this.changedKey,t)},t.prototype.onChanged=function(t){return this.changed(t)},t.prototype.add=function(t){return Gt(this,void 0,void 0,(function(){var e;return Bt(this,(function(n){switch(n.label){case 0:if("object"!=typeof t)throw new Error("Please provide the info as an object!");if(void 0===t.name)throw new Error("info.name is missing!");if("string"!=typeof t.name)throw new Error("Please provide the info.name as a string!");if(void 0===t.meta)throw new Error("info.meta is missing!");if("object"!=typeof t.meta)throw new Error("Please provide the info.meta as an object!");if(void 0===t.meta.color)throw new Error("info.meta.color is missing!");if("string"!=typeof t.meta.color)throw new Error("Please provide the info.meta.color as a string!");return e={name:t.name,meta:t.meta||{},data:t.data||{}},[4,this.shared.update(t.name,e)];case 1:return n.sent(),[2,e]}}))}))},t.prototype.handler=function(t,e,n){this.registry.execute(this.subsKey,t,e,n)},t.prototype.joinCore=function(t,e){return void 0===e&&(e=!0),Gt(this,void 0,void 0,(function(){var n,i=this;return Bt(this,(function(o){switch(o.label){case 0:if("string"!=typeof t)throw new Error("Please provide the channel name as a string!");return t===this.currentContext?[2]:(n=function(t){return i.shared.all().includes(t)})(t)?[3,2]:[4,new Promise((function(e,i){var o,r=setInterval((function(){n(t)&&(clearTimeout(o),clearInterval(r),e())}),100);o=setTimeout((function(){return clearInterval(r),i(new Error("A channel with name: "+t+" doesn't exist!"))}),3e3)}))];case 1:o.sent(),o.label=2;case 2:return[4,this.shared.switchChannel(t)];case 3:return o.sent(),e&&vn(t),this.currentContext=t,this.registry.execute(this.changedKey,t),[2]}}))}))},t.prototype.leaveCore=function(t){return void 0===t&&(t=!0),this.currentContext=void 0,this.registry.execute(this.changedKey,void 0),this.shared.unsubscribe(),t&&vn(),Promise.resolve()},t}();function bn(t,e){var n=new mn(t),i=new wn(n);return function(t,e){Gt(this,void 0,void 0,(function(){return Bt(this,(function(n){switch(n.label){case 0:return ln=t,"undefined"!=typeof window&&window.glue42gd&&(yn=window.glue42gd.windowId),yn?[4,ln.register("T42.Channels.Command",(function(t){var n=t.command;if(!n)throw new Error("missing command argument");if("join"!==n){if("leave"!==n){if("get"===n)return{id:i=e.current()};throw new Error("unknown command "+n)}e.leaveNoSelectorSwitch()}else{var i;if(!(i=t.channel))throw new Error("missing argument id");e.joinNoSelectorSwitch(i)}}))]:[2];case 1:return n.sent(),ln.invoke("T42.Channels.Announce",{swId:yn,instance:ln.instance.instance}),[2]}}))}))}(e,i),{subscribe:i.subscribe.bind(i),subscribeFor:i.subscribeFor.bind(i),publish:i.publish.bind(i),all:i.all.bind(i),list:i.list.bind(i),get:i.get.bind(i),join:i.join.bind(i),leave:i.leave.bind(i),current:i.current.bind(i),my:i.my.bind(i),changed:i.changed.bind(i),onChanged:i.onChanged.bind(i),add:i.add.bind(i),ready:function(){return t.ready()}}}var _n=function(){function t(t){this.agm=t,this.registry=_e(),this.firstHotkey=!0,this.hotkeys=new Map}return t.prototype.register=function(t,e){return Gt(this,void 0,void 0,(function(){var n;return Bt(this,(function(i){switch(i.label){case 0:if(void 0===t)throw new Error("Hotkey parameter missing");if("string"==typeof t)t={hotkey:t};else{if(!t.hotkey)throw new Error("Info's hotkey parameter missing");t={hotkey:t.hotkey,description:t.description}}if(n=this.formatHotkey(t.hotkey),this.hotkeys.has(n))throw new Error("Shortcut for "+n+" already registered");return this.firstHotkey?(this.firstHotkey=!1,[4,this.registerInvokeAGMMethod()]):[3,2];case 1:i.sent(),i.label=2;case 2:return this.registry.add(n,e),[4,this.agm.invoke("T42.Hotkeys.Command",{command:"register",hotkey:n,description:t.description})];case 3:return i.sent(),this.hotkeys.set(n,t),[2]}}))}))},t.prototype.unregister=function(t){return Gt(this,void 0,void 0,(function(){var e;return Bt(this,(function(n){switch(n.label){case 0:if(void 0===t)throw new Error("hotkey parameter missing");if("string"!=typeof t)throw new Error("hotkey parameter must be string");return e=this.formatHotkey(t),[4,this.agm.invoke("T42.Hotkeys.Command",{command:"unregister",hotkey:e})];case 1:return n.sent(),this.hotkeys.delete(e),this.registry.clearKey(e),[2]}}))}))},t.prototype.unregisterAll=function(){return Gt(this,void 0,void 0,(function(){return Bt(this,(function(t){switch(t.label){case 0:return[4,this.agm.invoke("T42.Hotkeys.Command",{command:"unregisterAll"})];case 1:return t.sent(),this.hotkeys.clear(),this.registry.clear(),[2]}}))}))},t.prototype.isRegistered=function(t){var e=this.formatHotkey(t);return this.hotkeys.has(e)},t.prototype.registerInvokeAGMMethod=function(){var t=this;this.agm.register("T42.Hotkeys.Invoke",(function(e){var n=e.key.toLowerCase(),i=t.hotkeys.get(n);t.registry.execute(n,i)}))},t.prototype.formatHotkey=function(t){if(t)return t.replace(/\s/g,"").toLowerCase()},t}();var In,An,Cn=function(t){function e(t,e,n){if("boolean"!=typeof t||t){var i=function t(e,n,i){if("object"==typeof e)return t(e.mode,n,i)+"";if(void 0===e)return"boolean"!=typeof n||n?n+"":void 0;if("boolean"==typeof e)return e?(void 0===i?n:i)+"":void 0;return e+""}(t,e,n);return"object"==typeof t?(t.mode=i,t):{mode:i}}}return{layouts:e(t.layouts,"slim"),activities:e(t.activities,"trackMyTypeAndInitiatedFromMe"),appManager:e(t.appManager,!1,"startOnly"),windows:e(t.windows,!0),channels:e(t.channels||!1,!1),displays:e(t.displays,!0)}};!function(t){t.Find="find",t.FindByContext="findByContext",t.GetAll="all",t.Raise="raise"}(An||(An={}));var Tn,Sn={};function kn(t){return Gt(this,void 0,void 0,(function(){return Bt(this,(function(e){return"string"==typeof t&&(t={intent:t}),[2,En(An.Raise,t)]}))}))}function xn(t){return Gt(this,void 0,void 0,(function(){return Bt(this,(function(e){return"string"==typeof t&&(t={name:t}),[2,En(An.Find,{intentFilter:t})]}))}))}function Pn(t){return Gt(this,void 0,void 0,(function(){return Bt(this,(function(e){return t&&"string"==typeof t?[2,En(An.FindByContext,{contextType:t})]:[2,Promise.reject(Error("findByContext called with invalid contextType: "+t))]}))}))}function Mn(){return Gt(this,void 0,void 0,(function(){return Bt(this,(function(t){return[2,En(An.GetAll)]}))}))}function jn(t,e){Sn[t]||(Sn[t]=[]);var n=sn();return Sn[t].push({unsubId:n,callback:e}),function(){Sn[t]=Sn[t].filter((function(t){return t.unsubId!==n}))}}function En(t,e){return Gt(this,void 0,void 0,(function(){return Bt(this,(function(n){switch(n.label){case 0:return[4,In.invoke("T42.Intents.Command",{options:Dt({},e),command:t})];case 1:return[2,n.sent().returned.result]}}))}))}function On(t){var e,n=t.type,i=t.intent,o=t.context;switch(n){case Tn.IntentListenerRaised:var r=null===(e=Sn[i])||void 0===e?void 0:e.map((function(t){return t.callback}));r&&r.length>0&&r.forEach((function(t){return t(o)}))}}!function(t){t.IntentListenerRaised="intentListenerRaised"}(Tn||(Tn={}));var Wn=function(){function t(t){this.options=t,this.callbacks=_e(),this.actions=t.actions,this.body=t.body,this.badge=t.badge,this.data=t.data,this.dir=t.dir,this.icon=t.icon,this.image=t.image,this.lang=t.lang,this.renotify=t.renotify,this.requireInteraction=t.requireInteraction,this.silent=t.silent,this.tag=t.tag,this.timestamp=t.timestamp,this.title=t.title}return t.prototype.close=function(){throw new Error("Method not implemented.")},t.prototype.addEventListener=function(t,e,n){this.callbacks.add(t,e)},t.prototype.removeEventListener=function(t,e,n){},t.prototype.dispatchEvent=function(t){return this.callbacks.execute(t.type,t),!0},t}(),Rn=function(){function t(t){this.interop=t,this.methodRegistered=!1,this.methodName="T42.Notifications.Handler-"+sn(),this.nextId=0,this.notifications={}}return t.prototype.raise=function(t){var e,n;return Gt(this,void 0,void 0,(function(){var i,o,r,s,a,c,u,d;return Bt(this,(function(p){switch(p.label){case 0:if(!t)throw new Error("invalid options - should be an object");if(!t.title)throw new Error("invalid options - should have title");return this.methodRegistered?[3,2]:[4,this.interop.register(this.methodName,this.handleNotificationAction.bind(this))];case 1:p.sent(),this.methodRegistered=!0,p.label=2;case 2:if(i=String(this.nextId++),o={title:t.title,severity:"Medium",description:t.body,glueRoutingDetailMethodName:this.methodName,actions:[],source:i},t.actions)for(r=function(t){var r={g42notificationId:i,g42action:t.action,g42interopMethod:null===(e=t.interop)||void 0===e?void 0:e.method,g42interopTarget:null===(n=t.interop)||void 0===n?void 0:n.target},a=Object.keys(r).map((function(t){return{name:t,value:{stringValue:r[t]}}})),c={name:s.methodName,description:t.title,displayName:t.title,parameters:a};o.actions.push(c)},s=this,a=0,c=t.actions;a<c.length;a++)u=c[a],r(u);return[4,this.interop.invoke("T42.GNS.Publish.RaiseNotification",{notification:o})];case 3:return p.sent(),d=new Wn(t),this.notifications[i]=d,[2,d]}}))}))},t.prototype.handleNotificationAction=function(t){if(t.g42notificationId){var e=t,n=e.g42notificationId;if(!(r=this.notifications[n]))return;var i=new Event("onaction");i.action=e.g42action,r.onaction&&r.onaction(i);var o=(r.actions||[]).find((function(t){return t.action===e.g42action})).interop;o&&this.interop.invoke(o.method,o.arguments||{},o.target||"best"),r.dispatchEvent(i)}else if(t.notification&&t.notification.source){var r;n=t.notification.source;if(!(r=this.notifications[n]))return;var s=new Event("onclick");r.onclick&&r.onclick(s);var a=r.options.clickInterop;a&&this.interop.invoke(a.method,a.arguments||{},a.target||"best"),r.dispatchEvent(s)}},t}(),Fn=function(){function t(t){this.core=t,this.registry=_e(),this.getConfiguration()}return t.prototype.list=function(){return Gt(this,void 0,void 0,(function(){return Bt(this,(function(t){switch(t.label){case 0:return[4,this.getConfiguration()];case 1:if(t.sent(),!this.getMethodName)throw new Error("not supported");return[4,this.getAll()];case 2:return[2,t.sent().returned.all]}}))}))},t.prototype.getCurrent=function(){return Gt(this,void 0,void 0,(function(){var t;return Bt(this,(function(e){switch(e.label){case 0:return[4,this.getConfiguration()];case 1:if(e.sent(),!this.getMethodName)throw new Error("not supported");return[4,this.getAll()];case 2:return[2,(t=e.sent()).returned.all.find((function(e){return e.name===t.returned.selected}))]}}))}))},t.prototype.select=function(t){return Gt(this,void 0,void 0,(function(){return Bt(this,(function(e){switch(e.label){case 0:return[4,this.getConfiguration()];case 1:if(e.sent(),!this.setMethodName)throw new Error("not supported");return[4,this.core.interop.invoke(this.setMethodName,{theme:t})];case 2:return e.sent(),[2]}}))}))},t.prototype.onChanged=function(t){return this.subscribe(),this.registry.add("changed",t)},t.prototype.getConfiguration=function(){return Gt(this,void 0,void 0,(function(){var t;return Bt(this,(function(e){switch(e.label){case 0:return e.trys.push([0,2,,3]),this.sharedContextName?[2]:[4,this.core.interop.invoke("T42.Themes.Configuration")];case 1:return t=e.sent(),this.sharedContextName=t.returned.sharedContextName,this.getMethodName=t.returned.getThemesMethodName,this.setMethodName=t.returned.setThemesMethodName,[3,3];case 2:return e.sent(),[2];case 3:return[2]}}))}))},t.prototype.getAll=function(){return Gt(this,void 0,void 0,(function(){return Bt(this,(function(t){switch(t.label){case 0:return[4,this.getConfiguration()];case 1:return t.sent(),[4,this.core.interop.invoke(this.getMethodName)];case 2:return[2,t.sent()]}}))}))},t.prototype.subscribe=function(){return Gt(this,void 0,void 0,(function(){var t=this;return Bt(this,(function(e){switch(e.label){case 0:return[4,this.getConfiguration()];case 1:return e.sent(),this.core.contexts.subscribe(this.sharedContextName,(function(e){e&&e.all&&e.selected&&t.registry.execute("changed",e.all.find((function(t){return t.name===e.selected})))})),[2]}}))}))},t}();var Ln=function(t){var e,n,i,o,r=je.getGDMajorVersion(),s=Cn(t=t||{});function a(t,e,n){var i=e.subLogger(t);if(n&&n.logger){var o=n.logger;o.console&&i.consoleLevel(o.console),o.publish&&i.publishLevel(o.publish)}return i}t.gateway=t.gateway||{};var c={libs:[{name:"windows",create:function(t){if(s.windows){var n=a("windows",t.logger,s.windows);return d(i=Ne(t.agm,n,(function(){return e}),r)),i}}},{name:"activities",create:function(t){if(s.activities&&we.checkIsUsingGW3Implementation&&we.checkIsUsingGW3Implementation(t.connection)){var o=a("activity",t.logger,s.activities);return d(n=new we({connection:t.connection,contexts:t.contexts,agm:t.agm,logger:o,logLevel:"info",disableAutoAnnounce:!1,disposeRequestHandling:"ignore",announcementInfo:null,windows:i,appManagerGetter:function(){return e},mode:s.activities.mode,typesToTrack:s.activities.typesToTrack,activityId:"undefined"!=typeof window&&window.glue42gd&&window.glue42gd.activityInfo&&window.glue42gd.activityInfo.activityId,gdMajorVersion:r}).api),n}}},{name:"appManager",create:function(t){if(s.appManager){var o=a("appManager",t.logger,s.appManager);return d(e=Pe({agm:t.agm,windows:i,logger:o,activities:n,mode:s.appManager.mode,gdMajorVersion:r})),e}}},{name:"layouts",create:function(t){if(s.layouts){var i=a("layouts",t.logger,s.layouts),o=hn({agm:t.agm,appManager:e,activityGetter:function(){return n},logger:i,mode:s.layouts.mode,gdMajorVersion:r});return d(o),o}}},{name:"channels",create:function(t){if(s.channels&&t.contexts){var e=bn(t.contexts,t.agm);return d(e),e}}},{name:"hotkeys",create:function(t){var e=function(t){var e=new _n(t);return{register:e.register.bind(e),unregister:e.unregister.bind(e),unregisterAll:e.unregisterAll.bind(e),isRegistered:e.isRegistered.bind(e),ready:function(){return Promise.resolve()}}}(t.agm);return d(e),e}},{name:"displays",create:function(t){if(s.displays){var e=a("displays",t.logger,s.displays);return d(o=new gn(t.agm,e)),o}}},{name:"intents",create:function(t){var e,n=(e=t.agm,(In=e).register("T42.Intents.Events",On),{raise:kn,find:xn,findByContext:Pn,all:Mn,addIntentListener:jn,ready:function(){return Promise.resolve()}});return d(n),n}},{name:"notifications",create:function(t){var e=new Rn(t.interop);return d(e),e}},{name:"themes",create:function(t){if(t.contexts){var e=function(t){var e=new Fn(t);return{list:e.list.bind(e),getCurrent:e.getCurrent.bind(e),select:e.select.bind(e),onChanged:e.onChanged.bind(e),ready:function(){return Promise.resolve()}}}(t);return d(e),e}}}],version:"5.1.4",enrichGlue:function(t){t.config.activities=s.activities,t.config.windows=s.windows,t.config.appManager=s.appManager,t.config.layouts=s.layouts,t.config.channels=s.channels,t.config.displays=s.displays}},u=[];function d(t){u.push(t)}return"undefined"!=typeof window&&(window.glueFactoryLog||(window.glueFactoryLog=[]),window.glueFactoryLog.push(u)),Ft(t,c)};Ln.coreVersion=Ft.version,Ln.version="5.1.4";var Nn=Ln,Dn=!0;if("undefined"!=typeof window){var Gn=window.glue42gd;Gn&&Gn.autoInjected&&(Nn=window.Glue,Dn=!1),Dn&&(window.Glue=Nn),delete window.GlueCore}return Nn.default=Nn,Nn}));
//# sourceMappingURL=desktop.umd.min.js.map
