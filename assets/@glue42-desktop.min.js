!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.Glue=e():t.Glue=e()}(window,(function(){return function(t){var e={};function n(i){if(e[i])return e[i].exports;var o=e[i]={i:i,l:!1,exports:{}};return t[i].call(o.exports,o,o.exports,n),o.l=!0,o.exports}return n.m=t,n.c=e,n.d=function(t,e,i){n.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:i})},n.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},n.t=function(t,e){if(1&e&&(t=n(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var i=Object.create(null);if(n.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var o in t)n.d(i,o,function(e){return t[e]}.bind(null,o));return i},n.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return n.d(e,"a",e),e},n.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},n.p="",n(n.s=28)}([function(t,e,n){"use strict";function i(t){if(t&&t.errorHandling&&"function"!=typeof t.errorHandling&&"log"!==t.errorHandling&&"silent"!==t.errorHandling&&"throw"!==t.errorHandling)throw new Error('Invalid options passed to createRegistry. Prop errorHandling should be ["log" | "silent" | "throw" | (err) => void], but '+typeof t.errorHandling+" was passed");var e=t&&"function"==typeof t.errorHandling&&t.errorHandling,n={};return{add:function(t,e){var i=n[t];return i||(i=[],n[t]=i),i.push(e),function(){var i=n[t];i&&(i=i.reduce((function(t,n,i){return n===e&&t.length===i||t.push(n),t}),[]),n[t]=i)}},execute:function(i){for(var o=[],r=1;r<arguments.length;r++)o[r-1]=arguments[r];var s=n[i];if(!s||0===s.length)return[];var a=[];return s.forEach((function(n){try{var r=n.apply(void 0,o);a.push(r)}catch(n){a.push(void 0),function(n,i){var o=n instanceof Error?n:new Error(n);if(e)return void e(o);var r='[ERROR] callback-registry: User callback for key "'+i+'" failed: '+o.stack;if(t)switch(t.errorHandling){case"log":return console.error(r);case"silent":return;case"throw":throw new Error(r)}console.error(r)}(n,i)}})),a},clear:function(){n={}},clearKey:function(t){n[t]&&delete n[t]}}}i.default=i,t.exports=i},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.isNumber=function(t){return"number"==typeof t},e.isString=function(t){return"string"==typeof t},e.isObject=function(t){return"object"==typeof t&&null!==t},e.isArray=function(t){return Array.isArray?Array.isArray(t):"[object Array]"===toString.call(t)},e.isUndefined=function(t){return void 0===t},e.isUndefinedOrNull=function(t){return!t||void 0===t},e.isEmpty=function(t){for(var e in t)if(t.hasOwnProperty(e))return!1;return!0},e.isFunction=function(t){return!!(t&&t.constructor&&t.call&&t.apply)},e.some=function(t,e){for(var n=0;n<t.length;n++)if(e(t[n],n))return!0;return!1},e.first=function(t,e){for(var n=0;n<t.length;n++)if(e(t[n],n))return t[n]},e.ifNotUndefined=function(t,e){void 0!==t&&e(t)},e.promisify=function(t,e,n){if("function"!=typeof e&&"function"!=typeof n)return t;"function"!=typeof e?e=function(){}:"function"!=typeof n&&(n=function(){}),t.then(e,n)}},function(t,e,n){"use strict";var i,o=this&&this.__extends||(i=function(t,e){return(i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(t,e)},function(t,e){function n(){this.constructor=t}i(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)});Object.defineProperty(e,"__esModule",{value:!0});var r=function(t,e){this.entity=t,this.context=e};e.EntityEvent=r;var s=function(t){this.type=t};e.EntityEventContext=s;var a=function(t){function e(e,n){var i=t.call(this,u.StatusChange)||this;return i.newStatus=e,i.oldStatus=n,i}return o(e,t),e}(s);e.ActivityStatusChangeEventContext=a;var c=function(t){function e(e,n,i){var o=t.call(this,u.ActivityContextChange)||this;return o.context="string"==typeof e?JSON.parse(e):e,o.updated=n,o.removed=i,o}return o(e,t),e}(s);e.ActivityContextChangedEventContext=c;var u=function(){function t(){}return t.Added="added",t.Removed="removed",t.Updated="updated",t.Closed="closed",t.StatusChange="statusChange",t.ActivityContextChange="activityContextUpdate",t.ActivityWindowEvent="activityWindowEvent",t.ActivityWindowJoinedActivity="joined",t.ActivityWindowLeftActivity="left",t}();e.EntityEventType=u;var d=function(){function t(){}return t.Created="created",t.Started="started",t.Destroyed="destroyed",t}();e.ActivityState=d},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var i=n(0),o=function(){function t(){this.waitForTimeoutInMilliseconds=6e4,this._windows={},this._pendingWindows={},this._pendingWindowsStates={},this._registry=i()}return t.prototype.init=function(t){this._logger=t},t.prototype.get=function(t){return this._windows[t]||this._pendingWindows[t]},t.prototype.getIfReady=function(t){return this._windows[t]},Object.defineProperty(t.prototype,"list",{get:function(){return this._windows},enumerable:!0,configurable:!0}),t.prototype.add=function(t){if(!!this._pendingWindows[t.API.id])this._logger.error("trying to add window with id "+t.API.id+" from windowStore, which already exists");else{var e="remote"===t.API.windowType;this._pendingWindows[t.API.id]=t,this._pendingWindowsStates[t.API.id]={ready:!1,urlChanged:e},this._registry.execute("on-added",t)}},t.prototype.remove=function(t){delete this._windows[t.API.id],delete this._pendingWindows[t.API.id],delete this._pendingWindowsStates[t.API.id],this._registry.execute("on-removed",t)},t.prototype.setReadyState=function(t){var e=this._pendingWindowsStates[t];void 0!==e&&(e.ready=!0,e.urlChanged&&this.markReadyToShow(t))},t.prototype.setUrlChangedState=function(t){var e=this._pendingWindowsStates[t];void 0!==e&&(e.urlChanged=!0,e.ready&&this.markReadyToShow(t))},t.prototype.waitFor=function(t){var e=this;return new Promise((function(n,i){var o,r=setTimeout((function(){o(),i("waitFor timed out.")}),e.waitForTimeoutInMilliseconds),s=e._windows[t];s?(clearTimeout(r),n(s)):o=e.onReadyWindow((function(e){e.API.id===t&&(clearTimeout(r),o(),n(e))}))}))},t.prototype.onReadyWindow=function(t){return this._registry.add("on-ready",t)},t.prototype.onAdded=function(t){return this._registry.add("on-added",t)},t.prototype.onRemoved=function(t){return this._registry.add("on-removed",t)},t.prototype.markReadyToShow=function(t){this._pendingWindows[t]&&(this._windows[t]=this._pendingWindows[t],delete this._pendingWindows[t],delete this._pendingWindowsStates[t]),this._registry.execute("on-ready",this._windows[t])},t}();e.WindowStore=o,e.default=new o},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var i=n(1),o=function(){function t(){}return t.Trace="trace",t.Debug="debug",t.Info="info",t.Warn="warn",t.Error="error",t}();e.LogLevel=o;var r=function(){function t(e){this._name=e,i.isUndefinedOrNull(t.GlueLogger)||(this._glueLogger=t.GlueLogger.subLogger(e))}return t.GetNamed=function(e){return new t(e)},t.Get=function(e){return new t(t.GetTypeName(e))},t.prototype.trace=function(e){i.isUndefinedOrNull(this._glueLogger)?t.Level===o.Trace&&console.info(this._getMessage(e,o.Trace)):this._glueLogger.trace(e)},t.prototype.debug=function(e){i.isUndefinedOrNull(this._glueLogger)?t.Level!==o.Debug&&t.Level!==o.Trace||console.info(this._getMessage(e,o.Debug)):this._glueLogger.debug(e)},t.prototype.info=function(e){i.isUndefinedOrNull(this._glueLogger)?t.Level!==o.Debug&&t.Level!==o.Trace&&t.Level!==o.Info||console.info(this._getMessage(e,o.Info)):this._glueLogger.info(e)},t.prototype.warn=function(e){i.isUndefinedOrNull(this._glueLogger)?t.Level!==o.Debug&&t.Level!==o.Trace&&t.Level!==o.Info&&t.Level!==o.Warn||console.info(this._getMessage(e,o.Info)):this._glueLogger.warn(e)},t.prototype.error=function(t){i.isUndefinedOrNull(this._glueLogger)?(console.error(this._getMessage(t,o.Error)),console.trace()):this._glueLogger.error(t)},t.prototype._getMessage=function(t,e){return"["+e+"] "+this._name+" - "+t},t.GetTypeName=function(t){var e=/function (.{1,})\(/.exec(t.constructor.toString());return e&&e.length>1?e[1]:""},t.Level=o.Info,t}();e.Logger=r},function(t,e,n){"use strict";t.exports=n(31)},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.ShutdownMethodName="T42.ACS.Shutdown",e.FeedackMethodName="T42.ACS.Feedback",e.GetConfigurationRegionMethodName="T42.ACS.GetConfigurationRegion",e.SetConfigurationRegionMethodName="T42.ACS.SetConfigurationRegion",e.GetUserMethodName="T42.ACS.GetUser",e.GetBranchesMethodName="T42.ACS.GetBranches",e.GetCurrentBranchMethodName="T42.ACS.GetCurrentBranch",e.SetCurrentBranchMethodName="T42.ACS.SetCurrentBranch",e.GetFunctionalEntitlementMethodName="T42.ACS.GetFunctionalEntitlement",e.CanIMethodName="T42.ACS.CanI",e.StartApplicationMethodName="T42.ACS.StartApplication",e.StopApplicationMethodName="T42.ACS.StopApplication",e.ActivateApplicationMethodName="T42.ACS.ActivateApplication",e.RunApplicationMethodName="T42.ACS.RunApplication",e.OnEventMethodName="T42.ACS.OnEvent",e.GetApplicationsMethodName="T42.ACS.GetApplications"},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var i=function(){function t(t){this._id=t}return Object.defineProperty(t.prototype,"id",{get:function(){return this._id},enumerable:!0,configurable:!0}),t.prototype._update=function(t){if(t._id!==this._id)throw Error("Can not update from entity with different id.");this._updateCore(t)},t.prototype._updateCore=function(t){},t.prototype._beforeDelete=function(t){},t}();e.default=i},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var i=n(1),o=function(t){setTimeout(t,0)};e.nodeify=function(t,e){if(!i.isFunction(e))return t;t.then((function(t){o((function(){e(null,t)}))}),(function(t){o((function(){e(t,null)}))}))}},function(t,e,n){"use strict";var i,o,r,s=n(68),a="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ_-";function c(){r=!1}function u(t){if(t){if(t!==i){if(t.length!==a.length)throw new Error("Custom alphabet for shortid must be "+a.length+" unique characters. You submitted "+t.length+" characters: "+t);var e=t.split("").filter((function(t,e,n){return e!==n.lastIndexOf(t)}));if(e.length)throw new Error("Custom alphabet for shortid must be "+a.length+" unique characters. These characters were not unique: "+e.join(", "));i=t,c()}}else i!==a&&(i=a,c())}function d(){return r||(r=function(){i||u(a);for(var t,e=i.split(""),n=[],o=s.nextValue();e.length>0;)o=s.nextValue(),t=Math.floor(o*e.length),n.push(e.splice(t,1)[0]);return n.join("")}())}t.exports={characters:function(t){return u(t),i},seed:function(t){s.seed(t),o!==t&&(c(),o=t)},lookup:function(t){return d()[t]},shuffled:d}},function(t,e,n){"use strict";var i,o,r,s=n(32),a="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ_-";function c(){r=!1}function u(t){if(t){if(t!==i){if(t.length!==a.length)throw new Error("Custom alphabet for shortid must be "+a.length+" unique characters. You submitted "+t.length+" characters: "+t);var e=t.split("").filter((function(t,e,n){return e!==n.lastIndexOf(t)}));if(e.length)throw new Error("Custom alphabet for shortid must be "+a.length+" unique characters. These characters were not unique: "+e.join(", "));i=t,c()}}else i!==a&&(i=a,c())}function d(){return r||(r=function(){i||u(a);for(var t,e=i.split(""),n=[],o=s.nextValue();e.length>0;)o=s.nextValue(),t=Math.floor(o*e.length),n.push(e.splice(t,1)[0]);return n.join("")}())}t.exports={characters:function(t){return u(t),i},seed:function(t){s.seed(t),o!==t&&(c(),o=t)},lookup:function(t){return d()[t]},shuffled:d}},function(t,e,n){"use strict";var i,o=this&&this.__extends||(i=function(t,e){return(i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(t,e)},function(t,e){function n(){this.constructor=t}i(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)});Object.defineProperty(e,"__esModule",{value:!0});var r=n(7),s=n(1),a=function(t){function e(e,n,i,o){var r=t.call(this,e)||this;return r._name=e,r._description=o,r._ownerWindow=n,r._helperWindows=i||[],r}return o(e,t),Object.defineProperty(e.prototype,"name",{get:function(){return this._name},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"description",{get:function(){return this._description},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"helperWindows",{get:function(){return this._helperWindows},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"ownerWindow",{get:function(){return this._ownerWindow},enumerable:!0,configurable:!0}),e.prototype.initiate=function(t,e,n){return this._manager.initiate(this._name,t,e,n)},e.prototype._updateCore=function(e){var n=this;t.prototype._updateCore.call(this,e),s.ifNotUndefined(e._description,(function(t){return n._description=t})),s.ifNotUndefined(e._ownerWindow,(function(t){return n._ownerWindow=t})),s.ifNotUndefined(e._helperWindows,(function(t){return n._helperWindows=t}))},e}(r.default);e.default=a},function(t,e,n){"use strict";var i,o=this&&this.__extends||(i=function(t,e){return(i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(t,e)},function(t,e){function n(){this.constructor=t}i(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)});Object.defineProperty(e,"__esModule",{value:!0});var r=function(t){function e(e,n){var i=t.call(this,e)||this;return i._name=e,i._appByWindowTypeGetter=n,i}return o(e,t),Object.defineProperty(e.prototype,"name",{get:function(){return this._name},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"config",{get:function(){return this._appByWindowTypeGetter(this._name)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"windows",{get:function(){return this._manager.getWindows({type:this._name})},enumerable:!0,configurable:!0}),e.prototype.create=function(t,e){var n=Object.assign({type:this.name,name:this.name,isIndependent:!1},e);return this._manager.createWindow(t,n)},e}(n(7).default);e.default=r},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var i=n(1),o=n(1),r=function(){function t(t){this._activity=t}return t.prototype.register=function(e,n){this._ensureHasAgm(),t.AGM.register(e,n)},t.prototype.servers=function(){return this._ensureHasAgm(),i.isUndefinedOrNull(this._activity)?[]:this._activity.windows.map((function(t){return t.instance}))},t.prototype.methods=function(){var t=this;if(this._ensureHasAgm(),i.isUndefinedOrNull(this._activity))return[];var e=this._activity.windows,n=[],o=[];return e.forEach((function(e){t.methodsForWindow(e).forEach((function(t){-1===n.indexOf(t.name)&&(n.push(t.name),o.push(t))}))})),o},t.prototype.methodsForWindow=function(e){return this._ensureHasAgm(),e.instance?t.AGM.methodsForInstance(e.instance):[]},t.prototype.invoke=function(e,n,r,s,a,c){this._ensureHasAgm();var u=this.servers();if(i.isUndefinedOrNull(r)&&(r="activity.all"),i.isString(r))if("activity.all"===r)u;else{if("activity.best"!==r){if("all"===r||"best"===r)return o.promisify(t.AGM.invoke(e,n,r,s),a,c);throw new Error("Invalid invoke target "+r)}var d=u.filter((function(n){return t.AGM.methodsForInstance(n).filter((function(t){return t.name===e})).length>0}));d.length>0&&[d[0]]}else if(i.isArray(r)){if(r.length>=0){var p=r[0];if(this._isInstance(p))r.map((function(t){return t}));else{if(!this._isActivityWindow(p))throw new Error("Unknown target object");r.map((function(t){return t.instance}))}}}else if(this._isInstance(r))[r];else{if(!this._isActivityWindow(r))throw new Error("Unknown target object");[r.instance]}throw new Error("Not implemented")},t.prototype.unregister=function(e){return this._ensureHasAgm(),t.AGM.unregister(e)},t.prototype.createStream=function(e,n,i){this._ensureHasAgm(),t.AGM.createStream(e,{subscriptionAddedHandler:n,subscriptionRemovedHandler:i,subscriptionRequestHandler:void 0})},t.prototype.subscribe=function(e,n,i){return this._ensureHasAgm(),t.AGM.subscribe(e,n)},t.prototype._ensureHasAgm=function(){if(i.isUndefinedOrNull(t.AGM))throw new Error("Agm should be configured to be used in activity")},t.prototype._isInstance=function(t){return void 0!==t.application},t.prototype._isActivityWindow=function(t){return void 0!==t.instance},t}();e.ActivityAGM=r},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.objectValues=function(t){return t?Object.keys(t).map((function(e){return t[e]})):[]},e.objectClone=function(t){var e;try{e=JSON.parse(JSON.stringify(t||{}))}catch(t){e={}}return e}},function(t,e,n){"use strict";var i,o=this&&this.__extends||(i=function(t,e){return(i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(t,e)},function(t,e){function n(){this.constructor=t}i(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)});Object.defineProperty(e,"__esModule",{value:!0});var r=n(7),s=n(13),a=n(42),c=n(8),u=n(1),d=function(t){function e(e,n,i,o,r){var a=t.call(this,e)||this;return a._id=e,a._actType=n,a._status=i,a._context=o,a._ownerId=r,a._agm=new s.ActivityAGM(a),a}return o(e,t),Object.defineProperty(e.prototype,"type",{get:function(){if(this._manager)return this._manager.getActivityType(this._actType)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"context",{get:function(){return this._context},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"status",{get:function(){return this._status},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"owner",{get:function(){return this._ownerId?this._manager.getWindows({id:this._ownerId})[0]:null},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"windows",{get:function(){return this._manager.getWindows({activityId:this._id})},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"agm",{get:function(){return this._agm},enumerable:!0,configurable:!0}),e.prototype.addWindow=function(t,e){return this._manager.addWindowToActivity(this,t,e)},e.prototype.createWindow=function(t,e){return this._manager.createWindow(this,t,e)},e.prototype.createStackedWindows=function(t,e,n){return this._manager.createStackedWindows(this,t,e,n)},e.prototype.leave=function(t,e){return this._manager.leaveWindowFromActivity(this,t,e)},e.prototype.getWindowsByType=function(t){var e={activityId:this._id,type:t};return this._manager.getWindows(e)},e.prototype.setContext=function(t,e){return this._manager.setActivityContext(this,t,e)},e.prototype.updateContext=function(t,e){return this._manager.updateActivityContext(this,t,e)},e.prototype.onStatusChange=function(t){var e=this;return this._manager.subscribeActivityEvents((function(n,i,o){n.id===e.id&&t(n,i,o)}))},e.prototype.onWindowEvent=function(t){var e=this;return this._manager.subscribeWindowEvents((function(n,i,o){n.id===e.id&&t(n,i,o)}))},e.prototype.onContextChanged=function(t){var e=this;this._manager.subscribeActivityContextChanged((function(n,i,o,r){n.id===e.id&&t(i,o,r,n)}));try{t(this.context,this.context,[],this)}catch(t){return}},e.prototype.stop=function(){this._manager.stopActivity(this)},e.prototype.clone=function(t){return this._manager.clone(this,t)},e.prototype.attach=function(t,e){var n;return n="string"==typeof t?t:t.id,this._manager.attachActivities(n,this.id,e)},e.prototype.onActivityAttached=function(t){var e=this;this._manager.subscribeActivitiesAttached((function(n,i,o){n===e._id&&t(o)}))},e.prototype.onDetached=function(t){var e=this;this._manager.subscribeActivitiesDetached((function(n,i,o){i.id===e._id&&t(n,o)}))},e.prototype._updateCore=function(e){var n=this;t.prototype._updateCore.call(this,e),u.ifNotUndefined(e._actType,(function(t){return n._actType=t})),u.ifNotUndefined(e._context,(function(t){return n._context=t})),u.ifNotUndefined(e._ownerId,(function(t){return n._ownerId=t})),!e._status||this._status&&this._status.state===e._status.state||(this._status=e._status)},e.prototype._updateDescriptors=function(t){var e=this;this._attached=t.map((function(t){return new a.AttachedActivityDescriptor(e._manager,e._id,t)}))},Object.defineProperty(e.prototype,"attached",{get:function(){return this._attached},enumerable:!0,configurable:!0}),e.prototype.setFrameColor=function(t,e){var n=this,i=new Promise((function(e,i){var o=n.windows.length;0===o&&e(n),n.windows.forEach((function(i){i.underlyingWindow.setFrameColor(t,(function(){--o<=0&&e(n)}))})),setTimeout((function(){o>0&&i(n.id+" - timed out waiting for setFrameColor with"+t)}),5e3)}));return c.nodeify(i,e)},e.prototype.getFrameColor=function(){return this.windows&&0!==this.windows.length?this.windows[0].underlyingWindow.frameColor:""},e}(r.default);e.default=d},function(t,e,n){"use strict";var i,o=this&&this.__extends||(i=function(t,e){return(i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(t,e)},function(t,e){function n(){this.constructor=t}i(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)});Object.defineProperty(e,"__esModule",{value:!0});var r=n(7),s=n(4),a=n(1),c=n(1),u=n(2),d=function(t){function e(e,n,i,o,r,a,c,u){var d=t.call(this,e)||this;return d._logger=s.Logger.Get("window"),d._type=i,d._activityId=o,d._name=n,d._instance=r,d._isIndependent=a,d._windowGetter=c,d._hcWindowId=u,d}return o(e,t),e.prototype.getBounds=function(){return this._manager.getWindowBounds(this.id)},Object.defineProperty(e.prototype,"name",{get:function(){return this._name},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"isIndependent",{get:function(){return this._isIndependent},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"type",{get:function(){if(this._manager)return this._manager.getWindowType(this._type)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"activity",{get:function(){if(!a.isUndefined(this._activityId))return this._manager.getActivityById(this._activityId)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"isOwner",{get:function(){var t=this.activity;return!a.isUndefined(t)&&t.owner.id===this.id},enumerable:!0,configurable:!0}),e.prototype.setVisible=function(t,e){return this._manager.setWindowVisibility(this.id,t)},e.prototype.activate=function(t){return this._manager.activateWindow(this.id,t)},e.prototype.setBounds=function(t,e){return this._manager.setWindowBounds(this.id,t,e)},e.prototype.close=function(){return this._manager.closeWindow(this.id)},Object.defineProperty(e.prototype,"instance",{get:function(){return this._instance},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"underlyingWindow",{get:function(){var t=this._windowGetter();return t||{id:this._hcWindowId}},enumerable:!0,configurable:!0}),e.prototype.onActivityJoined=function(t){this._subscribeForActivityWindowEvent(u.EntityEventType.ActivityWindowJoinedActivity,t)},e.prototype.onActivityRemoved=function(t){this._subscribeForActivityWindowEvent(u.EntityEventType.ActivityWindowLeftActivity,t)},e.prototype._updateCore=function(t){var e=this;c.ifNotUndefined(t._activityId,(function(t){return e._activityId=t})),c.ifNotUndefined(t._isIndependent,(function(t){return e._isIndependent=t})),c.ifNotUndefined(t._hcWindowId,(function(t){return e._hcWindowId=t})),c.ifNotUndefined(t._type,(function(t){return e._type=t})),c.ifNotUndefined(t._name,(function(t){return e._name=t})),a.isUndefinedOrNull(t._instance)||(this._instance=t._instance)},e.prototype._subscribeForActivityWindowEvent=function(t,e){var n=this;this._manager.subscribeWindowEvents((function(i,o,r){o.id===n.id&&r===t&&e(i)}))},e.prototype._beforeDelete=function(t){this._hcWindowId=t._hcWindowId},e}(r.default);e.default=d},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var i=function(){function t(t,e,n){this.state=t,this.message=e,this.time=n}return t.prototype.getState=function(){return this.state},t.prototype.getMessage=function(){return this.message},t.prototype.getTime=function(){return this.time},t}();e.ActivityStatus=i},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var i=n(2),o=n(17),r=n(11),s=n(12),a=n(15),c=n(16),u=n(4),d=n(19),p=n(1),f=function(){function t(t,e,n,i,o){this._activityTypeEntityName="activityType",this._windowTypeEntityName="windowType",this._activityEntityName="activity",this._windowEntityName="activityWindow",this._logger=u.Logger.Get("hcBridge"),this._lastSeq=0,this._eventQueue=[],this._activityTypeCallbacks=[],this._windowTypeCallbacks=[],this._activityCallbacks=[],this._windowCallbacks=[],this._agm=t,this._windows=e,this._appManagerGetter=n,this._mode=i,this._typesToTrack=o}return t._hcToJsActivityType=function(t){return new r.default(t.name,t.ownerWindowType,t.helperWindowTypes,t.description)},t._getURLParameter=function(t){return decodeURIComponent((new RegExp("[?|&]"+t+"=([^&;]+?)(&|#|;|$)").exec(location.search)||[,""])[1].replace(/\+/g,"%20"))||null},Object.defineProperty(t.prototype,"bridgeType",{get:function(){return"HC"},enumerable:!0,configurable:!0}),t.prototype.joinActivity=function(t,e){throw new Error("Not implemented")},t.prototype.leaveActivity=function(t,e){throw new Error("Not implemented")},t.prototype.init=function(){var t=this;this._readyMarker=new d.ReadyMarker("HC Bridge",1),this._htmlContainer=window.htmlContainer.activityFacade,this._htmlContainer.subscribeForJoinBreakEvents&&this._htmlContainer.subscribeForJoinBreakEvents((function(e){t._handleGenericEvents(e)}));var e=this._agm?this._agm.instance:void 0,n=this._htmlContainer.init;this._htmlContainer.init2&&(n=this._htmlContainer.init2,e={jsAgmInstance:e,glueVersion:3,mode:this._mode,typesToTrack:this._typesToTrack}),n(e,this._hcEventHandler.bind(this),(function(){t._readyMarker.signal("Init done from HC")}),(function(e){t._readyMarker.error(e)}))},t.prototype.initReady=function(){var t=this;return new Promise((function(e,n){t._readyMarker.setCallback((function(i){i?(t._logger.error("Error initializing HC bridge - "+i),n(t._readyMarker.getError())):e(t)}))}))},t.prototype.ready=function(){return this.initReady()},t.prototype._handleGenericEvents=function(t){this._processEventBySeq(t)},t.prototype._hcEventHandler=function(t){this._logger.trace(t);var e=JSON.parse(t);this._processEventBySeq(e)},t.prototype._processEventBySeq=function(t){var e=t.sequence;if(e===this._lastSeq+1){this._processEvent(t),this._lastSeq++;var n=this._eventQueue[e+1];p.isUndefined(n)||(this._logger.debug("replaying message number "+e),this._processEventBySeq(n),delete this._eventQueue[e+1])}else this._eventQueue[e]=t,this._logger.debug("Got out of order event with number "+e+". Will wait for previous event(s) before replaying.")},t.prototype._processEvent=function(e){var n=this;if(e.genericEvent)this._processGenericEvent(e);else{var o,r=e.entityType,s=this._convertContext(e.context);if(e.context.type!==i.EntityEventType.ActivityContextChange||this._htmlContainer.contextUpdateRaceFixed)switch(r){case this._activityTypeEntityName:o=t._hcToJsActivityType(e.entity),this._publishActivityTypeStatusChange(o,s);break;case this._windowTypeEntityName:o=this._hcToJsWindowType(e.entity),this._publishWindowTypeStatusChange(o,s);break;case this._activityEntityName:o=this._hcToJsActivity(e.entity),this._publishActivityStatusChange(o,s);break;case this._windowEntityName:o=this._hcToJsWindow(e.entity),this._publishActivityWindowEvent(o,s)}else this.getActivities().then((function(t){var o=e.context.updated,r=e.context.removed,s=n._hcToJsActivity(e.entity),a=e.entity.context;t.forEach((function(t){if(t.id===s.id){var e=new i.ActivityContextChangedEventContext(a,o,r);n._publishActivityStatusChange(s,e)}}))}))}},t.prototype._processGenericEvent=function(t){var e=t.data;"ActivitiesAttached"===t.type?this._activitiesAttachedHandler&&this._activitiesAttachedHandler(e):"ActivitiesDetached"===t.type?this._activitiesDetached&&this._activitiesDetached(e):"ActivityAttachedDescriptorsRefreshed"===t.type&&this._activityAttachedDescriptorsRefreshed&&this._activityAttachedDescriptorsRefreshed(e)},t.prototype._convertContext=function(t){if(t.type===i.EntityEventType.StatusChange){var e=new o.ActivityStatus(t.oldStatus.state,t.oldStatus.statusMessage,t.oldStatus.statusTime),n=new o.ActivityStatus(t.newStatus.state,t.newStatus.statusMessage,t.newStatus.statusTime);return new i.ActivityStatusChangeEventContext(n,e)}return t.type===i.EntityEventType.ActivityWindowEvent?new i.EntityEventContext(t.event):t.type===i.EntityEventType.ActivityContextChange?new i.ActivityContextChangedEventContext(t.newContext,t.updated,t.removed):new i.EntityEventContext(t.type)},t.prototype._hcToJsActivity=function(t){var e=t.owner?this._hcToJsWindow(t.owner):null,n=e?e.id:null,i=new o.ActivityStatus(t.status.state,t.status.statusMessage,t.status.statusTime),r=JSON.parse(t.context);return new a.default(t.id,t.type.name,i,r,n)},t.prototype._hcToJsWindowType=function(t){var e=this;return p.isUndefined(t.factories)&&(t.factories=[]),this._appByWindowTypeGetter||(this._appManagerGetter||(this._appByWindowTypeGetter=function(){}),this._appByWindowTypeGetter=function(t){return e._appManagerGetter().applications().filter((function(e){return e.activityWindowType===t}))[0]}),new s.default(t.name,this._appByWindowTypeGetter)},t.prototype.getActivityTypes=function(){var e=this;return new Promise((function(n,i){e._htmlContainer.getActivityTypes((function(e){var i=e.map((function(e){return t._hcToJsActivityType(e)}));n(i)}),(function(t){i(t)}))}))},t.prototype.registerActivityType=function(e,n,i,o,r){var s=this;return new Promise((function(a,c){void 0===i&&(i=[]);var u={name:e,ownerWindowType:n,helperWindowTypes:i,description:r,layoutConfig:JSON.stringify(o)};s._htmlContainer.registerActivityType(JSON.stringify(u),(function(e){var n=t._hcToJsActivityType(e);a(n)}),(function(t){c(t)}))}))},t.prototype.unregisterActivityType=function(t){var e=this;return new Promise((function(n,i){e._htmlContainer.unregisterActivityType(t,(function(){n()}),(function(t){i(t)}))}))},t.prototype.getWindowTypes=function(){var t=this;return new Promise((function(e,n){t._htmlContainer.getWindowTypes((function(n){var i=n.map((function(e){return t._hcToJsWindowType(e)}));e(i)}),(function(t){n(t)}))}))},t.prototype.registerWindowFactory=function(t,e,n){var i=this;return new Promise((function(n,o){p.isUndefinedOrNull(t)?o("windowTypeName should be provided"):i._htmlContainer.registerWindowFactory(t,e,(function(){n()}),(function(t){o(t)}))}))},t.prototype.initiateActivity=function(t,e,n){var i=this;return new Promise((function(n,o){p.isUndefinedOrNull(t)?o("windowTypeName should be provided"):(p.isUndefinedOrNull(e)&&(e={}),i._htmlContainer.initiate(t,JSON.stringify(e),(function(t){n(t)}),(function(t){o(t)})))}))},t.prototype.getAnnouncementInfo=function(){var e=window.htmlContainer.getContext(),n={activityWindowId:"",activityWindowType:"",activityWindowIndependent:!1,activityWindowName:""};return e.activityId?(n.activityWindowType=e.activityWindowType,p.isUndefined(n.activityWindowType)&&(n.activityWindowType=t._getURLParameter("activityWindowType")),n.activityWindowId=e.activityWindowId,p.isUndefined(n.activityWindowId)&&(n.activityWindowId=t._getURLParameter("activityWindowId")),n.activityWindowIndependent=e.activityWindowIndependent,p.isUndefined(n.activityWindowIndependent),n.activityWindowName=e.activityWindowName,p.isUndefined(n.activityWindowName)&&(n.activityWindowName=t._getURLParameter("activityWindowName")),n):n},t.prototype.announceWindow=function(t,e){var n=this;if(p.isUndefined(t))throw new Error("can not determine window type");if(p.isUndefined(t))throw new Error("can not determine window activityWindowId");this._htmlContainer.announceWindow(t,e,(function(t){n._logger.error("Error announcing activity window with id '"+e+"'. "+t)}))},t.prototype.getActivities=function(){var t=this;return new Promise((function(e,n){t._logger.trace("Executing getActivities()"),t._htmlContainer.getActivities((function(n){t._logger.trace("Got getActivities() :"+n);var i=JSON.parse(n).map((function(e){return t._hcToJsActivity(e)}));e(i)}),(function(e){t._logger.trace("Error in getActivities() :"+e),n(e)}))}))},t.prototype.updateActivityContext=function(t,e,n,i){var o=this;return new Promise((function(r,s){p.isUndefined(i)&&(i=[]);var a={fullReplace:n,removedKeys:i};o._htmlContainer.setActivityContext(t.id,JSON.stringify(e),JSON.stringify(a),(function(t){var e=JSON.parse(t);r(e)}),(function(t){return s(t)}))}))},t.prototype.getActivityWindows=function(){var t=this;return new Promise((function(e,n){t._htmlContainer.getWindows((function(n){var i=n.map((function(e){return t._hcToJsWindow(e)}));e(i)}),(function(t){n(t)}))}))},t.prototype.stopActivity=function(t){var e=this;return new Promise((function(n,i){e._htmlContainer.stopActivity(t.id,(function(t){n(t)}),(function(t){i(t)}))}))},t.prototype.unregisterWindowFactory=function(t){var e=this;return new Promise((function(n,i){e._htmlContainer.registerWindowFactory(t,(function(){n()}),(function(t){i(t)}))}))},t.prototype.createWindow=function(t,e){var n=this;return new Promise((function(i,o){var r=e,s=n._htmlContainer.createWindow2;s||(s=n._htmlContainer.createWindow,r=JSON.stringify(e)),s(t,r,(function(t){i(t)}),(function(t){o(t)}))}))},t.prototype.createStackedWindows=function(t,e,n){var i=this;return new Promise((function(o,r){var s=e,a=i._htmlContainer.createStackedWindows2;a||(a=i._htmlContainer.createStackedWindows,s=JSON.stringify(e)),a(t,s,n,(function(t){o(t)}),(function(t){r(t)}))}))},t.prototype.onActivityTypeStatusChange=function(t){this._activityTypeCallbacks.push(t)},t.prototype.onWindowTypeStatusChange=function(t){this._windowTypeCallbacks.push(t)},t.prototype.onActivityStatusChange=function(t){this._activityCallbacks.push(t)},t.prototype.onActivityWindowChange=function(t){this._windowCallbacks.push(t)},t.prototype.getWindowBounds=function(t){var e=this;return new Promise((function(n,i){e._htmlContainer.getWindowBounds(t,(function(t){n(t)}),(function(t){i(t)}))}))},t.prototype.setWindowBounds=function(t,e){var n=this;return new Promise((function(i,o){n._htmlContainer.setWindowBounds(t,JSON.stringify(e),(function(){i()}),(function(t){o(t)}))}))},t.prototype.registerWindow=function(t,e,n){var i=this;return new Promise((function(o,r){i._htmlContainer.registerWindow(t,e,n,(function(t){o(t)}),(function(t){r(t)}))}))},t.prototype.closeWindow=function(t){var e=this;return new Promise((function(n,i){e._htmlContainer.closeWindow(t,(function(){n()}),(function(t){i(t)}))}))},t.prototype.activateWindow=function(t,e){var n=this;return new Promise((function(i,o){n._htmlContainer.activateWindow(t,e,(function(){i()}),(function(t){o(t)}))}))},t.prototype.setWindowVisibility=function(t,e){var n=this;return new Promise((function(i,o){n._htmlContainer.setWindowVisibility(t,e,(function(){i()}),(function(t){o(t)}))}))},t.prototype.cloneActivity=function(t,e){var n=this;return new Promise((function(i,o){n._htmlContainer.cloneActivity(t,e,(function(t){i(t)}),(function(t){o(t)}))}))},t.prototype._publishStatusChange=function(t,e,n){var o=new i.EntityEvent(t,e);n.forEach((function(t){t(o)}))},t.prototype._publishActivityTypeStatusChange=function(t,e){this._publishStatusChange(t,e,this._activityTypeCallbacks)},t.prototype._publishWindowTypeStatusChange=function(t,e){this._publishStatusChange(t,e,this._windowTypeCallbacks)},t.prototype._publishActivityStatusChange=function(t,e){this._publishStatusChange(t,e,this._activityCallbacks)},t.prototype._publishActivityWindowEvent=function(t,e){this._publishStatusChange(t,e,this._windowCallbacks)},t.prototype.attachActivities=function(t,e,n){var i=this;return new Promise((function(o,r){i._htmlContainer.attachActivities(t,e,n,(function(t){o(t)}),(function(t){r(t)}))}))},t.prototype.detachActivities=function(t,e){var n=this;return new Promise((function(i,o){n._htmlContainer.detachActivities(t,e,(function(t){i(t)}),(function(t){o(t)}))}))},t.prototype.onActivitiesAttached=function(t){this._activitiesAttachedHandler=t},t.prototype.onActivitiesDetached=function(t){this._activitiesDetached=t},t.prototype.onActivityAttachedDescriptorsRefreshed=function(t){this._activityAttachedDescriptorsRefreshed=t},t.prototype.getAttachedDescriptors=function(){var t=this;return new Promise((function(e,n){t._htmlContainer.getAttachedDescriptors?t._htmlContainer.getAttachedDescriptors((function(t){e(t)}),(function(t){n(t)})):e([])}))},t.prototype._hcToJsWindow=function(t){var e=this,n=function(){};return this._windows&&(n=t.hcWindowId?function(){return e._windows.list().filter((function(e){return e.id===t.hcWindowId}))[0]}:function(){return e._windows.list().filter((function(e){return e.application===t.instance.application}))[0]}),new c.default(t.id,t.name,t.type,t.activityId,t.instance,t.isIndependent,n,t.hcWindowId)},t}();e.default=f},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var i=n(4),o=n(1),r=function(){function t(t,e){if(this._logger=i.Logger.Get("ReadyMarker ["+t+"]"),this._logger.debug("Initializing ready marker for '"+t+"' with "+e+" signals to wait"),e<=0)throw new Error("Invalid signal number. Should be > 0");this._signals=e,this._callbacks=[],this._name=t}return t.prototype.setCallback=function(t){this.isSet()?t(void 0):this.isError()?t(this._error):this._callbacks.push(t)},t.prototype.signal=function(t){if(this._logger.debug("Signaled - "+t+" - signals left "+(this._signals-1)),this._signals--,this._signals<0)throw new Error("Error in ready marker '"+this._name+" - signals are "+this._signals);this.isSet()&&this._callbacks.forEach((function(t){t(void 0)}))},t.prototype.error=function(t){this._error=t,this._callbacks.forEach((function(e){e(t)}))},t.prototype.isSet=function(){return!this.isError()&&0===this._signals},t.prototype.isError=function(){return!o.isUndefined(this._error)},t.prototype.getError=function(){return this._error},t}();e.ReadyMarker=r},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var i=n(0),o=n(1),r=n(21),s=n(3);e.default=function(t,e,n,a,c,u){var d,p,f=i.default(),h=a.subLogger("window "+t),l=e.name,y=e.mode,v=e.url,g=e.title,m=e.context||{},b=e.bounds,w=e.frameColor,_=e.focus,S=e.neighbours||{},I=e.groupId,A=e.isGroupHeaderVisible,C=e.isTabHeaderVisible,T=e.isTabSelected,M=e.settings,x=e.isVisible,k=e.isCollapsed,E=e.state,P=e.tabGroupId,j=e.isLocked,O=[],R=e.zoomFactor;function W(t,e,i){return new Promise((function(o,r){var s,a,c=X(t,b),u=!1,d=function(){u||(u=!0,"function"==typeof e&&e(p),o(p),a&&(a(),a=void 0),s&&(clearTimeout(s),s=void 0))};c||(a=z((function(e){e.id===p.id&&X(t,e.bounds)&&d()}))),n.moveResize(p,t).then((function(){c?d():s=setTimeout((function(){d()}),1e3)})).catch((function(t){"function"==typeof i&&i(t),r(t)}))}))}function N(e,i,o){return new Promise((function(r,s){n.setVisible(p,e).then((function(){var n=void 0===e?!0===x:x===e;if(n)return"function"==typeof i&&i(p),r(p);var o=V((function(s){n=void 0===e?!0===s.isVisible:s.isVisible===e,s.id===t&&n&&("function"==typeof i&&i(p),o(),r(p))}))})).catch((function(t){"function"==typeof o&&o(t),s(t)}))}))}function F(){return new Promise((function(t){var e=J((function(n){n.id===p.id&&(e(),t())}))}))}function L(t){return f.add("onUrlChanged",t)}function U(t){return k&&t(p),f.add("collapsed",t)}function D(t){return k||t(p),f.add("expanded",t)}function G(t){return"maximized"===E&&t(p),f.add("maximized",t)}function B(t){return"minimized"===E&&t(p),f.add("minimized",t)}function H(t){return"normal"===E&&t(p),f.add("normal",t)}function q(t){return f.add("detached",t)}function V(t){return f.add("visibility-changed",t)}function J(t){return f.add("lock-changed",t)}function z(t){return f.add("bounds-changed",t)}function K(t){return f.add("tab-header-visibility-changed",t)}function Z(t){var e=S[t];if(void 0!==e)return e.reduce((function(t,e){var n=s.default.get(e);return n&&t.push(n.API),t}),[])}function Y(){if(m._APPLICATION_NAME)return m._APPLICATION_NAME;if(m&&m._t42&&m._t42.application)return m._t42.application;var t=Q();return t?t.applicationName:void 0}function Q(){if(void 0!==window.glue42gd&&window.glue42gd.getWindowInfo){var e=window.glue42gd.getWindowInfo(t);return e||void 0}}function X(t,e){var n=t.height,i=t.width;t.height<M.minHeight&&(n=M.minHeight),t.height>M.maxHeight&&(n=M.maxHeight),t.width<M.minWidth&&(i=M.minWidth),t.width>M.maxWidth&&(i=M.maxWidth);var o=!n||e.height===n,r=!i||e.width===i,s=!t.left||e.left===t.left,a=!t.top||e.top===t.top;return o&&r&&s&&a}var $={handleWindowClose:function(){void 0!==p.id&&(p.id=void 0,f.execute("onClose",p))},handleWindowChangeState:function(t){"collapsed"===t?k=!0:"expanded"===t?k=!1:E=t,f.execute(t,p)},handleTitleChanged:function(t){g=t,f.execute("onTitleChanged",t,p)},handleVisibilityChanged:function(t){t!==x&&(x=t,f.execute("visibility-changed",p))},handleUrlChanged:function(t){v=t,f.execute("onUrlChanged",t,p)},handleWindowSettingsChanged:function(t){M=t,f.execute("settings-changed",p)},handleContextUpdated:function(t){m=t,f.execute("context-updated",m,p)},handleFrameIsLockedChanged:function(t){j=t,f.execute("lock-changed",p)},handleBoundsChanged:function(t){b.top===t.top&&b.left===t.left&&b.width===t.width&&b.height===t.height||(b.top=t.top,b.left=t.left,b.width=t.width,b.height=t.height,f.execute("bounds-changed",p))},handleFocusChanged:function(t){_=t,f.execute("focus-changed",p)},handleFrameButtonAdded:function(t){var e=["buttonId","imageBase64","order","tooltip"].reduce((function(e,n){return e[n]=t[n],e}),{});-1===O.map((function(t){return t.buttonId})).indexOf(t.buttonId)&&O.push(e),f.execute("onFrameButtonAdded",e,p)},handleFrameButtonRemoved:function(t){var e;O=O.reduce((function(n,i){return i.buttonId===t?e=i:n.push(i),n}),[]),void 0!==e&&f.execute("onFrameButtonRemoved",e,p)},handleFrameButtonClicked:function(t){var e=O.filter((function(e){return e.buttonId===t.buttonId}));e.length>0&&f.execute("onFrameButtonClicked",e[0],p)},handleFrameColorChanged:function(t){w=t,f.execute("frame-color-changed",p)},handleFrameAttached:function(t,e){P=t,C=e,f.execute("frame-attached",p)},handleFrameSelectionChanged:function(e,n){var i;void 0!==e&&e===t?(T=!0,i=p):(T=!1,i=s.default.get(e)?s.default.get(e).API:void 0);var o=s.default.get(n)?s.default.get(n).API:void 0;if(T&&o)var r=o.onTabSelectionChanged((function(t,e){(e&&e.id)===o.id&&(r(),f.execute("tab-selection-changed",i,o,p))}));else f.execute("tab-selection-changed",i,o,p)},handleCompositionChanged:function(t,e){S=t||{},I=e},handleGroupHeaderVisibilityChanged:function(t){A=t},handleTabHeaderVisibilityChanged:function(t){C!==t&&(C=t,f.execute("tab-header-visibility-changed",p))},handleGroupChanged:function(e,n){a.trace("handle group changed to win: "+t+" with group id: "+e.id),d=e,I=e.id,f.execute("group-changed",p,e,n)},handleGroupAssociation:function(e){e&&h.trace("setting group to win: "+t+" with group id: "+e.id),d=e},handleAttached:function(t,e){P=t,C=e,f.execute("attached",p)},handleDetached:function(e){P=e;var n=f.add("frame-attached",(function(e){e.id===t&&(n(),f.execute("detached",p))}))},handleWindowAttached:function(t){f.execute("window-attached",t)},handleWindowDetached:function(t){f.execute("window-detached",t)},handleZoomFactorChanged:function(t){R=t,f.execute("zoom-factor-changed",p)}};return{API:p={get name(){return l},get application(){var t=c();return t?t.application(Y()):void 0},get hostInstance(){return n.hostInstance},get agmInstance(){var t=this;if(window.glue42gd)return u.servers().find((function(e){return e.windowId===t.id}));var e=Y();return e?{application:e}:void 0},get url(){return v},id:t,get title(){return g},get windowStyleAttributes(){return M},get settings(){return M},get tabGroupId(){return"tab"===y.toLowerCase()?P:void 0},get frameButtons(){return O},get mode(){return y},get state(){return E},get isCollapsed(){return k},get isVisible(){return x},get isLocked(){return j},get context(){return m},get bounds(){return b},get minHeight(){return M.minHeight},get maxHeight(){return M.maxHeight},get minWidth(){return M.minWidth},get maxWidth(){return M.maxWidth},get isFocused(){return _},get frameColor(){return w},get opened(){return void 0!==p.id},get group(){return d},get groupId(){return I},get topNeighbours(){return Z("top")},get leftNeighbours(){return Z("left")},get rightNeighbours(){return Z("right")},get bottomNeighbours(){return Z("bottom")},get isGroupHeaderVisible(){return A},get activityId(){if(m._t42)return m._t42.activityId;var t=Q();return t?t.activityId:void 0},get activityWindowId(){if(m._t42)return m._t42.activityWindowId;var t=Q();return t?t.activityWindowId:void 0},get windowType(){return e.windowType||"electron"},get zoomFactor(){return R},get screen(){return r.default.getMonitor(p.bounds,window.glue42gd.monitors)},maximize:function(e,i){return new Promise((function(o,r){n.maximize(p).then((function(){if("maximized"===E)return"function"==typeof e&&e(p),o(p);var n=G((function(i){i.id===t&&"maximized"===i.state&&("function"==typeof e&&e(p),n(),o(p))}))})).catch((function(t){"function"==typeof i&&i(t),r(t)}))}))},restore:function(e,i){return new Promise((function(o,r){n.restore(p).then((function(){if("normal"===E)return"function"==typeof e&&e(p),o(p);var n=H((function(i){t===i.id&&"normal"===i.state&&("function"==typeof e&&e(p),n(),o(p))}))})).catch((function(t){"function"==typeof i&&i(t),r(t)}))}))},minimize:function(e,i){return new Promise((function(o,r){n.minimize(p).then((function(){if("minimized"===E)return"function"==typeof e&&e(p),o(p);var n=B((function(i){if(t===i.id&&"minimized"===i.state)return"function"==typeof e&&e(p),n(),o(p)}))})).catch((function(t){"function"==typeof i&&i(t),r(t)}))}))},maximizeRestore:function(t,e){return new Promise((function(i,o){var r="normal"===E?G:H;n.maximizeRestore(p).then((function(){var e=r((function(){"function"==typeof t&&t(p),e&&e(),i(p)}))})).catch((function(t){"function"==typeof e&&e(t),o(t)}))}))},collapse:function(e,i){return new Promise((function(o,r){if(k)return"function"==typeof e&&e(p),o(p);n.collapse(p).then((function(){if(k)return"function"==typeof e&&e(p),o(p);var n=U((function(i){i.id===t&&("function"==typeof e&&e(p),n(),o(p))}))})).catch((function(t){"function"==typeof i&&i(t),r(t)}))}))},expand:function(e,i){return new Promise((function(o,r){if(!k)return"function"==typeof e&&e(p),o(p);n.expand(p).then((function(){if(!k)return"function"==typeof e&&e(p),o(p);var n=D((function(i){i.id===t&&("function"==typeof e&&e(p),n(),o(p))}))})).catch((function(t){"function"==typeof i&&i(t),r(t)}))}))},toggleCollapse:function(e,i){return new Promise((function(o,r){var s=k?D:U;n.toggleCollapse(p).then((function(){s((function(n){n.id===t&&("function"==typeof e&&e(p),o(p))}))})).catch((function(t){"function"==typeof i&&i(t),r(t)}))}))},focus:function(t,e){return new Promise((function(i,o){n.focus(p).then((function(){"function"==typeof t&&t(p),i(p)})).catch((function(t){"function"==typeof e&&e(t),o(t)}))}))},activate:function(t,e){return new Promise((function(i,o){n.activate(p).then((function(){"function"==typeof t&&t(p),i(p)})).catch((function(t){"function"==typeof e&&e(t),o(t)}))}))},moveResize:W,setTitle:function(t,e,i){return new Promise((function(o,r){n.setTitle(p,t).then((function(){"function"==typeof e&&e(p),o(p)})).catch((function(t){"function"==typeof i&&i(t),r(t)}))}))},setStyle:function(t,e,i){if(!t||0===Object.keys(t).length||Object.keys(t).every((function(t){return!t})))return i(o="Invalid style arguments: "+JSON.stringify(t)),Promise.reject(new Error(o));if(t&&void 0!==t.focus){var o;if("boolean"!=typeof t.focus)return i(o="Focus must be boolean. Currently only focus true is supported ! "+JSON.stringify(t)),Promise.reject(new Error(o));!1===t.focus&&console.warn("Focus false is not supported ! ")}return t&&void 0!==t.hidden&&"boolean"!=typeof t.hidden?(i(o="Hidden must be boolean ! provided: "+JSON.stringify(t)),Promise.reject(new Error(o))):r.default.callbackifyPromise((function(){return n.setStyle(p,t)}),e,i)},resetButtons:function(t,e,i){return r.default.callbackifyPromise((function(){return n.resetButtons(p,t)}),e,i)},setSizeConstraints:function(t,e,i){if(!t||Object.keys(t).every((function(t){return void 0===t}))){var o="Invalid Constraints: "+JSON.stringify(t);return i(o),Promise.reject(new Error(o))}return r.default.callbackifyPromise((function(){return n.setSizeConstraints(p,t)}),e,i)},navigate:function(e,i,o){return new Promise((function(r,s){n.navigate(p,e).then((function(){if(e===v)return"function"==typeof i&&i(p),r(p);var n=L((function(e,o){o.id===t&&e===o.url&&("function"==typeof i&&i(p),n(),r(p))}))})).catch((function(t){"function"==typeof o&&o(t),s(t)}))}))},addFrameButton:function(t,e,i){return new Promise((function(o,r){return void 0===t?"function"==typeof i?void i("No button info"):void r("No button info"):void 0===t.buttonId?"function"==typeof i?void i("No buttonId"):void r("No buttonId"):void 0===t.imageBase64?"function"==typeof i?void i("No imageBase64"):void r("No imageBase64"):void n.addFrameButton(p,t).then((function(){"function"==typeof e&&e(p),o(p)})).catch((function(t){"function"==typeof i&&i(t),r(t)}))}))},removeFrameButton:function(t,e,i){return new Promise((function(o,r){if(void 0===t||""===t)return"function"==typeof i?void i("No buttonId"):void r("No buttonId");n.removeFrameButton(p,t).then((function(){"function"==typeof e&&e(p),o(p)})).catch((function(t){"function"==typeof i&&i(t),r(t)}))}))},setVisible:N,show:function(){return N(!0)},hide:function(){return N(!1)},center:function(t){return W(r.default.getDisplayCenterOfScreen(p.bounds,t||p.screen))},close:function(t,e){return new Promise((function(i,o){n.close(p).then((function(){"function"==typeof t&&t(p),i(p)})).catch((function(t){"function"==typeof e&&e(t),o(t)}))}))},snap:function(t,e,i,o){var r,a;if(!t)return Promise.reject("Please specify a target window! calledWith: "+t);if("string"==typeof t){var c=s.default.get(t);if(!c)return Promise.reject(new Error("Invalid target parameter or no such window. Invoked with:  "+t));r=c.API.group}else r=t.group;return Promise.all([(a=r,new Promise((function(t,e){var n=a.onWindowAdded((function(e,i){p.id===i.id&&(n(),t())}))}))),n.snap(p,t,e)]).then((function(){return"function"==typeof i&&i(p),p})).catch((function(t){return"function"==typeof o&&o(t),t}))},showLoader:function(t){return new Promise((function(e,i){n.showLoader(p,t).then((function(){e(p)})).catch((function(t){i(t)}))}))},hideLoader:function(){return new Promise((function(t,e){n.hideLoader(p).then((function(){t(p)})).catch((function(t){e(t)}))}))},updateContext:function(t,e,i){return new Promise((function(o,r){n.updateContext(p,t).then((function(){"function"==typeof e&&e(p),o(p)})).catch((function(t){"function"==typeof i&&i(t),r(t)}))}))},lock:function(t,e){return p.isLocked?("function"==typeof t&&t(p),Promise.resolve(p)):new Promise((function(i,o){n.lock(p).then((function(){return F()})).then((function(){"function"==typeof t&&t(p),i(p)})).catch((function(t){"function"==typeof e&&e(t),o(t)}))}))},unlock:function(t,e){return p.isLocked?new Promise((function(i,o){n.unlock(p).then((function(){return F()})).then((function(){"function"==typeof t&&t(p),i(p)})).catch((function(t){"function"==typeof e&&e(t),o(t)}))})):("function"==typeof t&&t(p),Promise.resolve(p))},getIcon:function(t,e){return new Promise((function(i,o){n.getIcon(p).then((function(e){"function"==typeof t&&t(e),i(e)})).catch((function(t){"function"==typeof e&&e(t),o(t)}))}))},setIcon:function(t,e,i){return new Promise((function(o,r){n.setIcon(p,t).then((function(){"function"==typeof e&&e(p),o(p)})).catch((function(t){"function"==typeof i&&i(t),r(t)}))}))},setFrameColor:function(t,e,i){return new Promise((function(o,r){n.setFrameColor(p,t).then((function(){"function"==typeof e&&e(p),o(p)})).catch((function(t){"function"==typeof i&&i(t),r(t)}))}))},attachTab:function(t,e,i,o){return new Promise((function(r,a){var c,u=p.id,d="Invalid tab parameter - should be an object with property id or a string. Invoked for source window id:"+p.id;if(t){if("string"==typeof t)c=t;else{if(void 0===t.id)return void a(d);c=t.id}var f={sourceWindowId:c,targetWindowId:u};e&&(f.index=e);var h=s.default.get(f.sourceWindowId).API,l=h.onAttached((function(t){t.id===h.id&&("function"==typeof i&&i(p),l(),r(p))}));n.attachTab(p,f).catch((function(t){"function"==typeof o&&o(t),l(),a(t)}))}else a(d)}))},detachTab:function(e,i,o){return new Promise((function(r,s){var a={windowId:p.id},c=e||{};void 0!==c.relativeTo&&("string"==typeof c.relativeTo?a.relativeTo=c.relativeTo:void 0!==c.relativeTo.id&&(a.relativeTo=c.relativeTo.id),void 0!==c.relativeDirection&&(a.relativeDirection=c.relativeDirection),void 0!==c.width&&(a.width=c.width),void 0!==c.height&&(a.height=c.height)),void 0!==c.bounds&&(a.bounds=c.bounds),void 0!==c.hideTabHeader&&(a.hideTabHeader=c.hideTabHeader);var u=!1,d=!1,h=f.add("frame-attached",(function(e){var n=void 0===c.hideTabHeader||c.hideTabHeader!==e.isTabHeaderVisible;t===e.id&&n&&(u=!0,h(),d&&("function"==typeof i&&i(p),r(p),"function"==typeof l&&l()))})),l=q((function(e){t===e.id&&(d=!0,l(),u&&("function"==typeof i&&i(p),r(p),"function"==typeof h&&h()))}));n.detachTab(p,a).catch((function(t){"function"==typeof o&&o(t),l(),h(),s(t)}))}))},setTabHeaderVisible:function(e,i,o){return new Promise((function(r,s){n.setTabHeaderVisible(p,e).then((function(){if(C===e)return"function"==typeof i&&i(p),r(p);var n=K((function(o){o.id===t&&o.isTabHeaderVisible===e&&("function"==typeof i&&i(p),n(),r(p))}))})).catch((function(t){"function"==typeof o&&o(t),s(t)}))}))},showPopup:function(t){return n.showPopup(p,t)},createFlydown:function(t){return n.createFlydown(p.id,t)},setZoomFactor:function(t,e,i){return r.default.callbackifyPromise((function(){if(isNaN(t))throw new Error("zoomFactor is not a number");return n.setZoomFactor(p,t)}),e,i)},zoomIn:function(t,e){return r.default.callbackifyPromise((function(){return n.zoomIn(p)}),t,e)},zoomOut:function(t,e){return r.default.callbackifyPromise((function(){return n.zoomOut(p)}),t,e)},showDevTools:function(){return n.showDevTools(p)},onClose:function(t){return f.add("onClose",t)},onUrlChanged:L,onTitleChanged:function(t){return t(p.title,p),f.add("onTitleChanged",t)},onFrameButtonAdded:function(t){return f.add("onFrameButtonAdded",t)},onFrameButtonRemoved:function(t){return f.add("onFrameButtonRemoved",t)},onFrameButtonClicked:function(t){return f.add("onFrameButtonClicked",t)},onCollapsed:U,onExpanded:D,onMinimized:B,onMaximized:G,onNormal:H,onAttached:function(t){return f.add("attached",t)},onDetached:q,onVisibilityChanged:V,onContextUpdated:function(t){return f.add("context-updated",t)},onLockingChanged:J,onBoundsChanged:z,onFrameColorChanged:function(t){return f.add("frame-color-changed",t)},onFocusChanged:function(t){return f.add("focus-changed",t)},onGroupChanged:function(t){return f.add("group-changed",t)},onWindowAttached:function(t){return f.add("window-attached",t)},onWindowDetached:function(t){return f.add("window-detached",t)},onTabSelectionChanged:function(t){return f.add("tab-selection-changed",t)},onTabHeaderVisibilityChanged:K,onClosing:function(e){if(!o.isFunction(e))throw new Error("callback should be a function");return n.onClosing((function(t,n){var i=e();i&&i.then?i.then(t).catch(n):t()}),t)},onRefreshing:function(e){if(!o.isFunction(e))throw new Error("callback should be a function");return n.onRefreshing((function(t,n){var i=e();i&&i.then?i.then(t).catch(n):t()}),t)},onZoomFactorChanged:function(t){if(!o.isFunction(t))throw new Error("callback should be a function");return f.add("zoom-factor-changed",t)},capture:function(t){return n.capture(p,t)},get tabs(){return t=s.default.list,"tab"!==y.toLowerCase()?[]:Object.keys(t).reduce((function(e,n){var i=t[n];return i&&i.API.tabGroupId&&void 0!==i.API.tabGroupId&&void 0!==p.tabGroupId&&i.API.tabGroupId===p.tabGroupId&&e.push(i.API),e}),[]);var t},get isTabHeaderVisible(){return C},get isTabSelected(){return T}},Events:$}}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var i=function(){function t(){}return t.getGDMajorVersion=function(){if("undefined"==typeof window)return-1;if(!window.glueDesktop)return-1;if(!window.glueDesktop.version)return-1;var t=Number(window.glueDesktop.version.substr(0,1));return isNaN(t)?-1:t},t.isNode=function(){try{return"[object process]"===Object.prototype.toString.call(global.process)}catch(t){return!1}},t.callbackifyPromise=function(t,e,n){var i=function(t){var e=t;if(t instanceof Error&&(e=t.message),"function"!=typeof n)return Promise.reject(e);n(e)};try{return t().then((function(t){return"function"==typeof e&&e(t),t})).catch((function(t){return i(t)}))}catch(t){return i(t)}},t.getMonitor=function(t,e){var n=this;return e.map((function(e){var i=e.left,o=e.top,r=e.workingAreaWidth,s=e.workingAreaHeight;return{monitor:e,totalOverlap:n.calculateTotalOverlap({left:i,top:o,width:r,height:s},t)}})).sort((function(t,e){return e.totalOverlap-t.totalOverlap}))[0].monitor},t.getDisplayCenterOfScreen=function(t,e){var n=Math.floor(Math.max(e.left,(e.left+(e.workingAreaWidth-t.width))/2));return{top:Math.floor(Math.max(e.top,(e.top+(e.workingAreaHeight-t.height))/2)),left:n}},t.calculateTotalOverlap=function(t,e){var n=t.left,i=t.top,o=n+t.width,r=i+t.height,s=e.left,a=e.top,c=s+e.width,u=a+e.height;return Math.max(0,Math.min(o,c)-Math.max(n,s))*Math.max(0,Math.min(r,u)-Math.max(i,a))},t}();e.default=i},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var i=n(3);e.getWindowsByTabGroupId=function(t,e){var n=i.default.list;return Object.keys(n).reduce((function(i,o){var r=n[o];return r.API.tabGroupId===e&&r.API.id!==t&&(i[o]=r),i}),{})}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var i=function(){function t(){this.layouts=[]}return t.prototype.removeWhere=function(t){this.layouts=this.layouts.filter(t)},t.prototype.add=function(t){this.layouts.push(t)},Object.defineProperty(t.prototype,"all",{get:function(){return this.layouts},enumerable:!0,configurable:!0}),t.prototype.where=function(t){return this.layouts.filter(t)},t.prototype.first=function(t){return this.where(t)[0]},t}();e.LayoutStore=i,e.default=new i},function(t,e,n){"use strict";var i=n(69);t.exports=function(t,e){for(var n,o=0,r="";!n;)r+=t(e>>4*o&15|i()),n=e<Math.pow(16,o+1),o++;return r}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.default=function t(e){if(!e)return e;if(Array.isArray(e))return e.map((function(e){return t(e)}));if("string"==typeof e||"number"==typeof e||"boolean"==typeof e)return e;return Object.keys(e).reduce((function(n,i){var o=t(e[i]),r=i;return i[0].toLowerCase()!==i[0]&&(r=i[0].toLowerCase()+i.substr(1)),n[r]=o,n}),{})}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var i=function(t){this.name=t.name,this.type=t.type,this.components=t.components,this.context=t.context,this.metadata=t.metadata};e.default=i},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.version="4.7.0-alpha.10"},function(t,e,n){"use strict";var i=n(29);t.exports=i.default},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var i=n(30),o=n(27);i.default.version=o.version;var r=i.default,s=!0;if("undefined"!=typeof window){var a=window.glue42gd;a&&a.autoInjected&&(r=window.Glue,s=!1),s&&(window.Glue=r),delete window.GlueCore}r.default=r,e.default=r},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var i=n(85),o=n(39),r=n(48),s=n(56),a=n(64),c=n(77),u=n(78),d=n(82),p=n(27),f=n(84),h=n(21);e.default=function(t){var e=h.default.getGDMajorVersion();t=t||{};var n=f.default(t);t.gateway=t.gateway||{};var l,y,v,g;"undefined"!=typeof window&&window.htmlContainer;function m(t,e,n){var i=e.subLogger(t);if(n&&n.logger){var o=n.logger;o.console&&i.consoleLevel(o.console),o.publish&&i.publishLevel(o.publish),o.metrics&&i.metricsLevel(o.metrics)}return i}var b={libs:[{name:"windows",create:function(t){if(n.windows){var i=m("windows",t.logger,n.windows);return _(v=s.default(t.agm,i,(function(){return l}),e)),v}}},{name:"activities",create:function(t){if(n.activities&&(2===e||o.ActivityModule.checkIsUsingGW3Implementation&&o.ActivityModule.checkIsUsingGW3Implementation(t.connection))){var i=m("activity",t.logger,n.activities);return _(y=new o.ActivityModule({connection:t.connection,contexts:t.contexts,agm:t.agm,logger:i,logLevel:"info",disableAutoAnnounce:!1,disposeRequestHandling:"ignore",announcementInfo:null,windows:v,appManagerGetter:function(){return l},mode:n.activities.mode,typesToTrack:n.activities.typesToTrack,activityId:"undefined"!=typeof window&&window.glue42gd&&window.glue42gd.activityInfo&&window.glue42gd.activityInfo.activityId,gdMajorVersion:e}).api),y}}},{name:"appManager",create:function(t){if(n.appManager){var i=m("appManager",t.logger,n.appManager);return _(l=r.default({agm:t.agm,windows:v,logger:i,activities:y,mode:n.appManager.mode,gdMajorVersion:e})),l}}},{name:"layouts",create:function(t){if(n.layouts){var e=m("layouts",t.logger,n.layouts),i=a.default({agm:t.agm,appManager:l,activityGetter:function(){return y},logger:e,mode:n.layouts.mode});return _(i),i}}},{name:"channels",create:function(t){if(n.channels&&t.contexts){var e=u.factory(t.contexts,t.agm);return _(e),e}}},{name:"hotkeys",create:function(t){var e=d.factory(t.agm);return _(e),e}},{name:"displays",create:function(t){if(n.displays){var e=m("displays",t.logger,n.displays);return _(g=new c.default(t.agm,e)),g}}}],version:p.version,enrichGlue:function(t){t.config.activities=n.activities,t.config.windows=n.windows,t.config.appManager=n.appManager,t.config.layouts=n.layouts,t.config.channels=n.channels,t.config.displays=n.displays}},w=[];function _(t){w.push(t)}return"undefined"!=typeof window&&(window.glueFactoryLog||(window.glueFactoryLog=[]),window.glueFactoryLog.push(w)),i.default(t,b)}},function(t,e,n){"use strict";var i,o,r=n(10),s=n(33),a=n(35),c=n(36),u=1459707606518,d=6,p=n(37)||0;function f(){var t="",e=Math.floor(.001*(Date.now()-u));return e===o?i++:(i=0,o=e),t+=s(r.lookup,d),t+=s(r.lookup,p),i>0&&(t+=s(r.lookup,i)),t+=s(r.lookup,e)}t.exports=f,t.exports.generate=f,t.exports.seed=function(e){return r.seed(e),t.exports},t.exports.worker=function(e){return p=e,t.exports},t.exports.characters=function(t){return void 0!==t&&r.characters(t),r.shuffled()},t.exports.decode=a,t.exports.isValid=c},function(t,e,n){"use strict";var i=1;t.exports={nextValue:function(){return(i=(9301*i+49297)%233280)/233280},seed:function(t){i=t}}},function(t,e,n){"use strict";var i=n(34);t.exports=function(t,e){for(var n,o=0,r="";!n;)r+=t(e>>4*o&15|i()),n=e<Math.pow(16,o+1),o++;return r}},function(t,e,n){"use strict";var i="object"==typeof window&&(window.crypto||window.msCrypto);t.exports=function(){if(!i||!i.getRandomValues)return 48&Math.floor(256*Math.random());var t=new Uint8Array(1);return i.getRandomValues(t),48&t[0]}},function(t,e,n){"use strict";var i=n(10);t.exports=function(t){var e=i.shuffled();return{version:15&e.indexOf(t.substr(0,1)),worker:15&e.indexOf(t.substr(1,1))}}},function(t,e,n){"use strict";var i=n(10);t.exports=function(t){if(!t||"string"!=typeof t||t.length<6)return!1;for(var e=i.characters(),n=t.length,o=0;o<n;o++)if(-1===e.indexOf(t[o]))return!1;return!0}},function(t,e,n){"use strict";t.exports=0},function(t,e,n){"use strict";t.exports=function(){throw new Error("ws does not work in the browser. Browser clients must use the native WebSocket object")}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var i=n(40);e.ActivityModule=i.ActivityModule},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var i=n(41),o=n(18),r=n(43),s=n(44),a=n(46),c=n(13),u=n(4),d=n(1),p=n(8),f=function(){function t(e){var n,p=this;if(!e)throw new Error("config can not be null");if(d.isUndefined(e.logLevel)||(u.Logger.Level=e.logLevel),d.isUndefinedOrNull(e.logger)||(u.Logger.GlueLogger=e.logger),this._isUsingHCImplementation=2===e.gdMajorVersion,this._isUsingGW3Implementation=t.checkIsUsingGW3Implementation(e.connection),this._isUsingHCImplementation)n=new o.default(void 0,e.windows,e.appManagerGetter,e.mode,e.typesToTrack);else{if(!this._isUsingGW3Implementation)throw new Error("Unable to instantiate activity bridge implementation");n=new i.default(e.connection,e.logger,e.contexts,e)}if(!n)throw new Error("A bridge to native activity is needed to create activity lib.");c.ActivityAGM.AGM=e.agm;var f=new s.default(n,!e.disableAutoAnnounce,e.windows),h=new r.default(f,e.windows);this._api=new a.ActivityAPI(f,h),this._readyPromise=f.ready().then((function(t){return p}))}return t.checkIsUsingGW3Implementation=function(t){return 3===t.protocolVersion},Object.defineProperty(t.prototype,"api",{get:function(){return this._api},set:function(t){this._api=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isUsingHCImplementation",{get:function(){return this._isUsingHCImplementation},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isUsingGW3Implementation",{get:function(){return this._isUsingGW3Implementation},enumerable:!0,configurable:!0}),t.prototype.ready=function(t){return p.nodeify(this._readyPromise,t)},t}();e.ActivityModule=f},function(t,e,n){"use strict";var i=this&&this.__assign||function(){return(i=Object.assign||function(t){for(var e,n=1,i=arguments.length;n<i;n++)for(var o in e=arguments[n])Object.prototype.hasOwnProperty.call(e,o)&&(t[o]=e[o]);return t}).apply(this,arguments)},o=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(o,r){function s(t){try{c(i.next(t))}catch(t){r(t)}}function a(t){try{c(i.throw(t))}catch(t){r(t)}}function c(t){var e;t.done?o(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(s,a)}c((i=i.apply(t,e||[])).next())}))},r=this&&this.__generator||function(t,e){var n,i,o,r,s={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return r={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(r[Symbol.iterator]=function(){return this}),r;function a(r){return function(a){return function(r){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,i&&(o=2&r[0]?i.return:r[0]?i.throw||((o=i.return)&&o.call(i),0):i.next)&&!(o=o.call(i,r[1])).done)return o;switch(i=0,o&&(r=[2&r[0],o.value]),r[0]){case 0:case 1:o=r;break;case 4:return s.label++,{value:r[1],done:!1};case 5:s.label++,i=r[1],r=[0];continue;case 7:r=s.ops.pop(),s.trys.pop();continue;default:if(!(o=(o=s.trys).length>0&&o[o.length-1])&&(6===r[0]||2===r[0])){s=0;continue}if(3===r[0]&&(!o||r[1]>o[0]&&r[1]<o[3])){s.label=r[1];break}if(6===r[0]&&s.label<o[1]){s.label=o[1],o=r;break}if(o&&s.label<o[2]){s.label=o[2],s.ops.push(r);break}o[2]&&s.ops.pop(),s.trys.pop();continue}r=e.call(t,s)}catch(t){r=[6,t],i=0}finally{n=o=0}if(5&r[0])throw r[1];return{value:r[0]?r[1]:void 0,done:!0}}([r,a])}}};Object.defineProperty(e,"__esModule",{value:!0});var s=n(11),a=n(12),c=n(2),u=n(15),d=n(16),p=n(17),f=function(){function t(t,e,n,i){var o=this;if(this._activityChangeCallbacks=[],this._activityTypeStatusChangeCallbacks=[],this._activityWindowChangeCallbacks=[],this._windowTypeStatusChangeCallbacks=[],this._peerIdAndFactoryIdToPeerType={},this._peerFactoriesRegisteredByUs={},this._gw3Subscriptions=[],this._contextSubscriptions={},this._activityTypesInitiatedFromMe={},this._config=i,this._connection=t,this._logger=e,this._contexts=n,this._sessionJoinedPromise=new Promise((function(t){o._sessionJoinedPromiseResolve=t})),this._activityJoinedPromise=new Promise((function(t){o._activityJoinedPromiseResolve=t})),this._config.activityId||this._activityJoinedPromiseResolve({}),this._gw3Session=t.domain("activity",e.subLogger("session:com.tick42.activity"),["joined","initiated","peer-created","token"]),"undefined"!=typeof window){var r=window.glue42gd;r&&"function"==typeof r.addRefreshHandler&&r.addRefreshHandler((function(t,e){o._gw3Session.send({type:"reload"}).then((function(n){if(n.token){try{r.setGWToken(n.token)}catch(t){return void e(t.message||t)}t()}else e("Expected gateway token for refreshing.")}),e)}))}}return t.activityTypeGwMessageEntityToActivityType=function(t,e){var n=function(t){return new a.default(t,void 0)};return new s.default(t.name,t.owner_type&&n(t.owner_type),t.helper_types&&t.helper_types.map(n),e)},t.peerFactoryGwMessageEntityToWindowType=function(t){return new a.default(t.peer_type,(function(t){}))},t.activityGwMessageToActivity=function(t,e){var n=void 0!==t.owner?t.owner.peer_id:t.owner_id;return new u.default(t.activity_id,t.activity_type,e,t.context_snapshot,n)},t.activityToActivityStatusChangeEvent=function(t){return new c.EntityEvent(t,new c.ActivityStatusChangeEventContext(t.status,void 0))},Object.defineProperty(t.prototype,"bridgeType",{get:function(){return"GW3"},enumerable:!0,configurable:!0}),t.prototype.init=function(){var t=this;this.forwardActivityTypeMessagesToStatusEventHandlers(),this.subscribe("created",this.handleActivityCreatedMessage),this.subscribe("destroyed",this.handleActivityDestroyedMessage),this.forwardActivityMessagesToStatusEventHandlers(),this.forwardActivityCreatedAndJoinedActivityToActivityWindowEventHandlers(),this.forwardPeerFactoryMessagesToStatusEventHandlers(),this.forwardPeerFactoryMessagesToPeerFactoryRequests(),this.subscribe("peer-factories-added",this.handlePeerFactoriesAdded),this.subscribe("peer-factories-removed",this.handlePeerFactoriesRemoved),this.forwardActivityWindowMessagesToEventHandlers(),this.subscribe("dispose-peer",(function(){if("dispose"!==t._config.disposeRequestHandling){if("exit"===t._config.disposeRequestHandling){if("undefined"!=typeof window&&"function"==typeof window.close)return void window.close();if("undefined"!=typeof process&&"function"==typeof process.exit)return void process.exit()}}else t.dispose()})),this._gw3Session.onJoined((function(){"trackMyOnly"===t._config.mode||"trackMyTypeAndInitiatedFromMe"===t._config.mode?t._sessionJoinedPromiseResolve(t):t._gw3Session.send({type:"subscribe",activity_types:"trackAll"===t._config.mode?[]:"trackTypes"===t._config.mode?t._config.typesToTrack:[]}).then((function(){t._sessionJoinedPromiseResolve(t)}))})),this._gw3Session.join()},t.prototype.dispose=function(){var t=this;this._gw3Subscriptions.forEach((function(e){return e&&t._connection.off(e)})),this._gw3Subscriptions.length=0},t.prototype.ready=function(){return Promise.all([this._sessionJoinedPromise,this._activityJoinedPromise])},t.prototype.initReady=function(){return this._sessionJoinedPromise},t.prototype.onActivityTypeStatusChange=function(t){this._activityTypeStatusChangeCallbacks.push(t)},t.prototype.registerActivityType=function(e,n,i,o,r){var s=this,a={};a.name=e;var u=function(t){return{type:t.type,name:t.name,configuration:t}};return a.owner_type=u(n),a.helper_types=i.map(u),this._gw3Session.send({type:"add-types",types:[a]}).then((function(){var e=t.activityTypeGwMessageEntityToActivityType(a,r);return s.invokeCallbacks(s._activityTypeStatusChangeCallbacks,new c.EntityEvent(e,new c.EntityEventContext(c.EntityEventType.Added)),"add-types"),e}))},t.prototype.unregisterActivityType=function(t){var e=this;return this._gw3Session.send({type:"remove-types",types:[t]}).then((function(){var n=new s.default(t,void 0,void 0,void 0);e.invokeCallbacks(e._activityTypeStatusChangeCallbacks,new c.EntityEvent(n,new c.EntityEventContext(c.EntityEventType.Removed)),"add-types")}))},t.prototype.onWindowTypeStatusChange=function(t){this._windowTypeStatusChangeCallbacks.push(t)},t.prototype.registerWindowFactory=function(e,n,i){var o=this;if(this._peerFactoriesRegisteredByUs[e])return Promise.reject(new Error("Factory for windowType "+e+" already registered."));this._peerFactoriesRegisteredByUs[e]=n;var r={id:e,peer_type:e,configuration:i};return this._gw3Session.send({type:"add-peer-factories",factories:[r]}).then((function(){o.invokeCallbacks(o._windowTypeStatusChangeCallbacks,new c.EntityEvent(t.peerFactoryGwMessageEntityToWindowType(r),new c.EntityEventContext(c.EntityEventType.Added)),"add-peer-factories")})).catch((function(){delete o._peerFactoriesRegisteredByUs[e]}))},t.prototype.unregisterWindowFactory=function(t){var e=this;return this._peerFactoriesRegisteredByUs[t]?(delete this._peerFactoriesRegisteredByUs[t],this._gw3Session.send({type:"remove-peer-factories",factory_ids:[t]}).then((function(){e.invokeCallbacks(e._windowTypeStatusChangeCallbacks,new c.EntityEvent(new a.default(t,void 0),new c.EntityEventContext(c.EntityEventType.Removed)),"add-peer-factories")}))):Promise.reject(new Error("Factory for windowType "+t+" not registered."))},t.prototype.onActivityStatusChange=function(t){this._activityChangeCallbacks.push(t)},t.prototype.initiateActivity=function(t,e,n){var i=this,o={type:"create",activity_type:t,initial_context:e};return this.isOverrideTypeDefinition(n)?o.types_override={owner_type:{type:n.owner.type,name:n.owner.name,configuration:n.owner},helper_types:n.helpers&&n.helpers.map((function(t){return{type:t.type,name:t.name,configuration:t}}))}:o.configuration=n&&n.map((function(t){return{type:t.type,name:t.name,configuration:t}})),this.sendCreateAndMapResultingMessagesToPromise(o,"initiated",(function(t,e){return t.request_id===e}),"created",(function(t,e,n){return t.activity_id===n.activity_id}),"destroyed",(function(t,e,n){return t.activity_id===n.activity_id}),(function(t){return t.activity_id})).then((function(e){return"trackMyTypeAndInitiatedFromMe"!==i._config.mode||i._activityTypesInitiatedFromMe[t]?e:(i._activityTypesInitiatedFromMe[t]=!0,i._gw3Session.send({type:"subscribe",activity_types:[t]}).then((function(){return e})))}))},t.prototype.stopActivity=function(t){return this._gw3Session.send({type:"destroy",activity_id:t.id,reason_uri:"com.tick42.glue.activity.constants.destroyReason.general",reason:"Destroying activity"}).then((function(t){return!0}))},t.prototype.updateActivityContext=function(t,e,n,i){if(n)return this._contexts.set(t.id,e);for(var o=0,r=i=i||[];o<r.length;o++){e[r[o]]=null}return this._contexts.update(t.id,e)},t.prototype.announceWindow=function(t,e){throw new Error("Invalid operation 'announceWindow' for GW3 protocol")},t.prototype.registerWindow=function(t,e,n){var i=this._connection.gatewayToken,o=this._connection.peerId;if("undefined"!=typeof window){var r=window.glue42gd;r&&(i=void 0!==r.activityInfo)}return i&&this._gw3Session.send({type:"ready"}),this.invokeCallbacks(this._activityWindowChangeCallbacks,new c.EntityEvent(new d.default(o,e,t,void 0,this.getAgmInstance(o),n,this.generateWindowGetter(o),void 0),new c.EntityEventContext(c.EntityEventType.Added)),"register window"),Promise.resolve(o)},t.prototype.onActivityWindowChange=function(t){this._activityWindowChangeCallbacks.push(t)},t.prototype.createWindow=function(t,e){var n=this;return e.layout||(e.left||e.width||e.height||e.top)&&(e.layout={mode:"pixels",cellSize:1}),this.sendCreateAndMapResultingMessagesToPromise({type:"create-peer",peer_type:e.type,peer_name:e.name||e.type,configuration:e,activity_id:t},void 0,void 0,"peer-created",(function(t,e){return t.request_id===e}),void 0,void 0,(function(t){return t.created_id})).then((function(i){if(t)return n.joinActivity(t,i,e.name).then((function(){return i}))}))},t.prototype.closeWindow=function(t){return this._gw3Session.send({destroy_peer_id:t}).then((function(t){}))},t.prototype.getAnnouncementInfo=function(){var t=this._config.activityId||this._config.announcementInfo&&this._config.announcementInfo.activityId,e=this._config.announcementInfo&&this._config.announcementInfo.activityWindowType,n=this._config.announcementInfo&&this._config.announcementInfo.activityWindowIndependent,i=this._config.announcementInfo&&this._config.announcementInfo.activityWindowName;if("undefined"!=typeof window&&void 0!==window.location&&window.location.search&&"function"==typeof URLSearchParams){var o=new URLSearchParams(location.search.slice(1));e=(e=e||o.get("t42PeerType"))||o.get("t42ActivityWindowType"),void 0===n&&(n=o.get("t42ActivityWindowIndependent")),i=i||o.get("t42ActivityWindowName"),t=t||o.get("t42ActivityId")}return{activityWindowId:void 0,activityId:t,activityWindowType:e=e||"unknown",activityWindowIndependent:n=n||!1,activityWindowName:i=i||this._connection.peerId}},t.prototype.joinActivity=function(t,e,n){var o=this,r=n&&{name:n}||{};return this._gw3Session.send(i({type:"join-activity",target_id:e,activity_id:t},r)).then((function(){o.invokeCallbacks(o._activityWindowChangeCallbacks,new c.EntityEvent(new d.default(e,void 0,void 0,t,o.getAgmInstance(e),void 0,o.generateWindowGetter(e),void 0),new c.EntityEventContext(c.EntityEventType.ActivityWindowJoinedActivity)),"activity joined - ActivityWindow"),o.invokeCallbacks(o._activityChangeCallbacks,new c.EntityEvent(new u.default(t,void 0,new p.ActivityStatus("created",void 0,void 0),void 0,void 0),new c.EntityEventContext(c.EntityEventType.Updated)),"activity joined - Activity")}))},t.prototype.leaveActivity=function(t,e){var n=this;return this._gw3Session.send({type:"leave-activity",target_id:e,activity_id:t}).then((function(){n.invokeCallbacks(n._activityWindowChangeCallbacks,new c.EntityEvent(new d.default(e,void 0,void 0,null,n.getAgmInstance(e),void 0,n.generateWindowGetter(e),void 0),new c.EntityEventContext(c.EntityEventType.ActivityWindowLeftActivity)),"activity left - ActivityWindow"),n.invokeCallbacks(n._activityChangeCallbacks,new c.EntityEvent(new u.default(t,void 0,new p.ActivityStatus("created",void 0,void 0),void 0,void 0),new c.EntityEventContext(c.EntityEventType.Updated)),"activity left - Activity")}))},t.prototype.getActivityTypes=function(){return Promise.resolve([])},t.prototype.getWindowTypes=function(){return Promise.resolve([])},t.prototype.getActivities=function(){return Promise.resolve([])},t.prototype.getActivityWindows=function(){return Promise.resolve([])},t.prototype.createStackedWindows=function(t,e,n){},t.prototype.getWindowBounds=function(t){},t.prototype.setWindowBounds=function(t,e){},t.prototype.activateWindow=function(t,e){},t.prototype.setWindowVisibility=function(t,e){},t.prototype.cloneActivity=function(t,e){},t.prototype.attachActivities=function(t,e,n){return this._gw3Session.send({type:"merge",into:e,merge:t})},t.prototype.detachActivities=function(t,e){return this._gw3Session.send({type:"split",from:t}).then((function(){return""}))},t.prototype.onActivitiesAttached=function(t){},t.prototype.onActivitiesDetached=function(t){},t.prototype.onActivityAttachedDescriptorsRefreshed=function(t){},t.prototype.getAttachedDescriptors=function(){return Promise.resolve([])},t.prototype.getRandomRequestId=function(){return this._connection.peerId+":"+Math.floor(1e9*Math.random())},t.prototype.forwardAddedAndRemovedMessagesToEventHandler=function(t,e,n,i){var o=function(t){return function(e){return new c.EntityEvent(e,new c.EntityEventContext(t?c.EntityEventType.Added:c.EntityEventType.Removed))}};return[t&&this.forwardMessageToEventHandler(t,(function(t){return n(t,!0)}),o(!0),i),e&&this.forwardMessageToEventHandler(e,(function(t){return n(t,!1)}),o(!1),i)].filter((function(t){return t}))},t.prototype.forwardMessageToEventHandler=function(t,e,n,i){return this.subscribe(t,(function(t){e(t).forEach((function(e){return i.forEach((function(i){return i(n(e,t))}))}))}))},t.prototype.sendCreateAndMapResultingMessagesToPromise=function(t,e,n,i,o,r,s,a){var c,u,d,p,f,h,l=this,y=this.getRandomRequestId(),v=new Promise((function(t,e){c=t,u=e})),g=null,m=function(){l.dropSubscription(d),l.dropSubscription(p),l.dropSubscription(f),l.dropSubscription(h)};d=e&&this.subscribe(e,(function(t){n(t,y)&&(g=t,l.dropSubscription(d))})),p=this.subscribe(i,(function(t){o(t,y,g)&&c(a(t))})),f=r&&this.subscribe(r,(function(t){s(t,y,g)&&u(t)})),h=r&&this.subscribe("error",(function(t){t.request_id===y&&u(t)})),t.request_id=y;var b=this._gw3Session.send(t).then((function(){return v}));return b.then(m,m),b},t.prototype.peerFactoryIdAndOwnerIdToWindowType=function(t,e){var n=this._peerIdAndFactoryIdToPeerType[e+":"+t];return n?new a.default(n,void 0):null},t.prototype.subscribe=function(t,e){var n=this,i=this._connection.on("js-activity",t,(function(t){return e.bind(n)(t)}));return this._gw3Subscriptions.push(i),i},t.prototype.dropSubscription=function(t){t&&(this._connection.off(t),delete this._gw3Subscriptions[this._gw3Subscriptions.indexOf(t)])},t.prototype.invokeCallbacks=function(t,e,n){var i=this;t.forEach((function(t){try{t(e)}catch(t){i._logger.error("Error in "+(n||e.context.type)+" callback: "+JSON.stringify(t))}}))},t.prototype.handleActivityCreatedMessage=function(t){t.context_id?this._contextSubscriptions[t.activity_id]||this.subscribeToContext(t):this._logger.error("Activity created with unknown context_id: "+t.activity_id)},t.prototype.subscribeToContext=function(t){return o(this,void 0,void 0,(function(){var e,n,i,o=this;return r(this,(function(r){switch(r.label){case 0:return e=t.activity_id,n=this._contextSubscriptions,i=e,[4,this._contexts.subscribe(e,(function(t,n,i){var r=new c.EntityEvent(new u.default(e,void 0,void 0,t,void 0),new c.ActivityContextChangedEventContext(t,n,i));o.invokeCallbacks(o._activityChangeCallbacks,r,"context updated")}))];case 1:return n[i]=r.sent(),[2]}}))}))},t.prototype.handleActivityDestroyedMessage=function(t){var e=this._contextSubscriptions[t.activity_id];"function"==typeof e&&e(),delete this._contextSubscriptions[t.activity_id]},t.prototype.handlePeerFactoriesAdded=function(t){var e=this;t.factories.forEach((function(n){e._peerIdAndFactoryIdToPeerType[t.owner_id+":"+n.id]=n.peer_type}))},t.prototype.handlePeerFactoriesRemoved=function(t){var e=this;t.factory_ids.forEach((function(n){delete e._peerIdAndFactoryIdToPeerType[t.owner_id+":"+n]}))},t.prototype.forwardActivityTypeMessagesToStatusEventHandlers=function(){this.forwardAddedAndRemovedMessagesToEventHandler("types-added","types-removed",(function(e,n){return n?e.types.map((function(e){return t.activityTypeGwMessageEntityToActivityType(e,void 0)})):e.types.map((function(t){return new s.default(t.name,void 0,void 0,void 0)}))}),this._activityTypeStatusChangeCallbacks)},t.prototype.forwardActivityCreatedAndJoinedActivityToActivityWindowEventHandlers=function(){for(var t=this,e=0,n=["created","joined","owner-changed"];e<n.length;e++){var o=n[e];this.forwardMessageToEventHandler(o,(function(e){return[e.owner||i(i({},e),{type:e.peer_type,name:e.peer_name,peer_id:e.owner_id})].concat(e.participants||[]).map((function(n){return new d.default(n.peer_id,n.name,n.type,e.activity_id,t.getAgmInstance(n.peer_id),void 0,t.generateWindowGetter(n.peer_id),void 0)}))}),(function(t,e){return new c.EntityEvent(t,new c.EntityEventContext(c.EntityEventType.ActivityWindowJoinedActivity))}),this._activityWindowChangeCallbacks)}},t.prototype.forwardActivityMessagesToStatusEventHandlers=function(){for(var e=0,n=["created","joined"];e<n.length;e++){var i=n[e];this.forwardMessageToEventHandler(i,(function(e){return[t.activityGwMessageToActivity(e,new p.ActivityStatus("started","",new Date))]}),(function(e,n){return t.activityToActivityStatusChangeEvent(e)}),this._activityChangeCallbacks)}this.forwardMessageToEventHandler("destroyed",(function(e){return[t.activityGwMessageToActivity(e,new p.ActivityStatus("destroyed",e.reason,new Date))]}),(function(e,n){return t.activityToActivityStatusChangeEvent(e)}),this._activityChangeCallbacks),this.forwardMessageToEventHandler("initiated",(function(e){return[t.activityGwMessageToActivity(e,new p.ActivityStatus("created","",new Date))]}),(function(e,n){return t.activityToActivityStatusChangeEvent(e)}),this._activityChangeCallbacks),this.forwardMessageToEventHandler("owner-changed",(function(e){return[t.activityGwMessageToActivity(e,new p.ActivityStatus("created","",new Date))]}),(function(e,n){return t.activityToActivityStatusChangeEvent(e)}),this._activityChangeCallbacks)},t.prototype.forwardPeerFactoryMessagesToStatusEventHandlers=function(){var e=this;this.forwardAddedAndRemovedMessagesToEventHandler("peer-factories-added","peer-factories-removed",(function(n,i){return i?n.factories.map(t.peerFactoryGwMessageEntityToWindowType):n.factory_ids.map((function(t){return e.peerFactoryIdAndOwnerIdToWindowType(t,n.owner_id)})).filter((function(t){return null!=t}))}),this._windowTypeStatusChangeCallbacks)},t.prototype.forwardPeerFactoryMessagesToPeerFactoryRequests=function(){var t=this;this.subscribe("peer-requested",(function(e){var n=t._peerFactoriesRegisteredByUs[e.peer_factory];if(n)try{var i=e.configuration||{};i.gateway_token=i.gateway_token||e.gateway_token,i.peer_factory=i.peer_factory||e.peer_factory;var o=n({activityId:e.activity&&e.activity.id,activityType:e.activity&&e.activity.type,type:e.configuration&&e.configuration.type,gwToken:i.gateway_token,configuration:i});o&&o.then&&o.catch&&o.catch((function(n){return t._gw3Session.send({type:"error",request_id:e.request_id,reason:n&&(n.message||JSON.stringify(n))})}))}catch(n){t._gw3Session.send({type:"error",request_id:e.request_id,reason:n&&(n.message||JSON.stringify(n))})}else t._gw3Session.send({type:"error",request_id:e.request_id,reason:"Unknown peer factory "+e.peer_factory})}))},t.prototype.forwardActivityWindowMessagesToEventHandlers=function(){for(var t=this,e=function(e){n.subscribe(e,(function(n){var i="activity-joined"===e?n.joined_id:n.peer_id,o="activity-joined"===e?n.joined_type:n.peer_type,r="activity-joined"===e?n.joined_name:n.peer_name,s=new d.default(i,r,o,n.activity_id,t.getAgmInstance(i),void 0,t.generateWindowGetter(i),void 0);t._contextSubscriptions[n.activity_id]?"joined"===e&&t._activityJoinedPromiseResolve({}):t.subscribeToContext(n).then((function(){"joined"===e&&t._activityJoinedPromiseResolve({})})),t.invokeCallbacks(t._activityWindowChangeCallbacks,new c.EntityEvent(s,new c.EntityEventContext(c.EntityEventType.ActivityWindowJoinedActivity)),e)}))},n=this,i=0,o=["activity-joined","joined"];i<o.length;i++){e(o[i])}this.subscribe("left",(function(e){var n=new d.default(e.left_id,void 0,void 0,null,t.getAgmInstance(e.left_id),void 0,t.generateWindowGetter(e.left_id),void 0);t.invokeCallbacks(t._activityWindowChangeCallbacks,new c.EntityEvent(n,new c.EntityEventContext(c.EntityEventType.ActivityWindowLeftActivity)),"left")})),this.forwardAddedAndRemovedMessagesToEventHandler("peer-created",void 0,(function(e){return[new d.default(e.created_id,void 0,void 0,void 0,void 0,void 0,t.generateWindowGetter(e.created_id),void 0)]}),this._activityWindowChangeCallbacks)},t.prototype.getAgmInstance=function(t){return this._config.agm.servers().find((function(e){return e.peerId===t||e.windowId===t}))},t.prototype.generateWindowGetter=function(t){var e=this;return function(){var n=e.getAgmInstance(t);if(n){var i=n.windowId;return e._config.windows.list().filter((function(t){return t.id===i}))[0]}}},t.prototype.isOverrideTypeDefinition=function(t){return void 0!==t&&!!t.owner},t}();e.default=f},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var i=function(){function t(t,e,n){this._manager=t,this._ownerActivityId=e,this._state=n}return Object.defineProperty(t.prototype,"ownerId",{get:function(){return this._state.ownerId},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"windowIds",{get:function(){return this._state.windowIds},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"frameColor",{get:function(){return this._state.frameColor},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"context",{get:function(){return this._state.context},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"tag",{get:function(){return this._state.tag},enumerable:!0,configurable:!0}),t.prototype.detach=function(t){var e=this;t=t||{};var n={};return Object.keys(this._state).forEach((function(t){n[t]=e._state[t]})),n.context=t.context||n.context,n.frameColor=t.frameColor||n.frameColor,this._manager.detachActivities(this._ownerActivityId,n)},t}();e.AttachedActivityDescriptor=i},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var i=n(2),o=n(4),r=n(1),s=function(){function t(t,e){var n=this;this._myAttached=[],this._myDetached=[],this._myAttachedTo=[],this._myDetachedFrom=[],this._myActivityFrameColorChanged=[],this._myActivityJoinedCallbacks=[],this._myActivityRemovedCallbacks=[],this._myContextUpdateCallbacks=[],this._logger=o.Logger.Get(this),this._m=t,t.ready().then((function(t){t.subscribeActivityContextChanged(n._subscribeMyContextChanged.bind(n)),t.subscribeWindowEvents(n._subscribeMyWindowEvent.bind(n)),t.subscribeActivitiesAttached(n._subscribeActivitiesAttached.bind(n)),t.subscribeActivitiesDetached(n._subscribeActivitiesDetached.bind(n)),e&&e.onWindowFrameColorChanged(n._subscribeWindowFrameColorChanged.bind(n))}))}return Object.defineProperty(t.prototype,"window",{get:function(){if(r.isUndefinedOrNull(this._w)){var t=this._m.announcedWindows;t.length>0&&(this._w=t[0])}return this._w},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"activity",{get:function(){var t=this.window;if(!r.isUndefinedOrNull(t))return t.activity},enumerable:!0,configurable:!0}),t.prototype.createWindow=function(t){return this._m.createWindow(this.activity,t)},t.prototype.createStackedWindows=function(t,e){return this._m.createStackedWindows(this.activity,t,e)},Object.defineProperty(t.prototype,"context",{get:function(){var t=this.activity;return r.isUndefined(t)?{}:t.context},enumerable:!0,configurable:!0}),t.prototype.updateContext=function(t,e){var n=this.activity;return r.isUndefined(n)?new Promise((function(t,e){e("Not in activity")})):n.updateContext(t,e)},t.prototype.setContext=function(t,e){var n=this.activity;return r.isUndefined(n)?new Promise((function(t,e){e("Not in activity")})):n.setContext(t,e)},t.prototype.onActivityJoined=function(t){this._myActivityJoinedCallbacks.push(t);var e=this.window;r.isUndefinedOrNull(e)||r.isUndefinedOrNull(e.activity)||t(e.activity)},t.prototype.onActivityLeft=function(t){this._myActivityRemovedCallbacks.push(t)},t.prototype.onContextChanged=function(t){this._myContextUpdateCallbacks.push(t);var e=this.window;if(!r.isUndefinedOrNull(e)){var n=e.activity;r.isUndefinedOrNull(n)||t(n.context,n.context,[],n)}},t.prototype.clone=function(t,e){var n=this.activity;return this._m.clone(n,t,e)},t.prototype.attach=function(t,e){var n;return n="string"==typeof t?t:t.id,this._m.attachActivities(n,this.activity.id,e)},t.prototype.onActivityAttached=function(t){this._myAttached.push(t)},t.prototype.onActivityDetached=function(t){this._myDetached.push(t)},t.prototype.onAttachedToActivity=function(t){this._myAttachedTo.push(t)},t.prototype.onDetachedFromActivity=function(t){this._myDetachedFrom.push(t)},Object.defineProperty(t.prototype,"attached",{get:function(){return this.activity?this.activity.attached:[]},enumerable:!0,configurable:!0}),t.prototype.setFrameColor=function(t,e){return this.activity?this.activity.setFrameColor(t,e):Promise.resolve(null)},t.prototype.getFrameColor=function(){return this.activity?this.activity.getFrameColor():""},t.prototype.onFrameColorChanged=function(t){this._myActivityFrameColorChanged.push(t)},t.prototype._subscribeMyContextChanged=function(t,e,n,i){var o=this.window;if(!r.isUndefinedOrNull(o)){var s=o.activity;r.isUndefinedOrNull(s)||t.id===s.id&&this._notifyMyContextChanged(t,e,n,i)}},t.prototype._subscribeMyWindowEvent=function(t,e,n){r.isUndefinedOrNull(this.window)||this.window.id===e.id&&(n===i.EntityEventType.ActivityWindowJoinedActivity?(this._notifyMyWindowEvent(t,this._myActivityJoinedCallbacks),this._notifyMyContextChanged(t,t.context,null,null)):n===i.EntityEventType.ActivityWindowLeftActivity&&this._notifyMyWindowEvent(t,this._myActivityRemovedCallbacks))},t.prototype._notifyMyWindowEvent=function(t,e){var n=this;e.forEach((function(e){try{e(t,event)}catch(t){n._logger.warn("error in user callback "+t)}}))},t.prototype._notifyMyContextChanged=function(t,e,n,i){var o=this;n=n||{},i=i||[],this._myContextUpdateCallbacks.forEach((function(r){try{r(e,n,i,t)}catch(t){o._logger.warn("error in user callback "+t)}}))},t.prototype._notifyAttached=function(t){var e=this;this._myAttached.forEach((function(n){try{n(t)}catch(t){e._logger.warn("error in user callback "+t)}}))},t.prototype._notifyDetached=function(t){var e=this;this._myDetached.forEach((function(n){try{n(t)}catch(t){e._logger.warn("error in user callback "+t)}}))},t.prototype._notifyAttachedTo=function(t){var e=this;this._myAttachedTo.forEach((function(n){try{n(e.activity,t)}catch(t){e._logger.warn("error in user callback "+t)}}))},t.prototype._notifyDetachedFrom=function(t,e,n){var i=this;this._myDetachedFrom.forEach((function(o){try{o(t,e,n)}catch(t){i._logger.warn("error in user callback "+t)}}))},t.prototype._subscribeActivitiesAttached=function(t,e){var n=this.window;if(!r.isUndefinedOrNull(n)){var i=n.activity;r.isUndefinedOrNull(i)||t.id===i.id&&(e.windowIds.indexOf(n.id)>=0?this._notifyAttachedTo(e):this._notifyAttached(e))}},t.prototype._subscribeActivitiesDetached=function(t,e,n){var i=this.window;if(!r.isUndefinedOrNull(i)){var o=i.activity;r.isUndefinedOrNull(o)||(e.id===o.id&&this._notifyDetached(n),t.id===o.id&&this._notifyDetachedFrom(t,e,n))}},t.prototype._subscribeWindowFrameColorChanged=function(t){var e=this.activity;e&&e.owner&&e.owner.underlyingWindow.id===t.id&&this._myActivityFrameColorChanged.forEach((function(e){e(t.frameColor)}))},t}();e.default=s},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var i=n(2),o=n(11),r=n(12),s=n(8),a=n(19),c=n(45),u=n(4),d=n(1),p=n(2),f=n(18),h=function(){function t(t,e,n){var i=this;this._logger=u.Logger.Get("activityManager"),this._announcedWindows=[],this._attachedCallbacks=[],this._detachedCallbacks=[],this._frameColorChangesCallbacks=[],this._windowHandlers=[],this._bridge=t,this._activityTypes=new c.EntityObservableCollection((function(t){return i._grabEntity(t)})),this._windowTypes=new c.EntityObservableCollection((function(t){return i._grabEntity(t)})),this._activities=new c.EntityObservableCollection((function(t){return i._grabEntity(t)})),this._windows=new c.EntityObservableCollection((function(t){return i._grabEntity(t)})),this._dataReadyMarker=new a.ReadyMarker("Activity Manager Data",["GetActivityTypes","GetWindowTypes","GetActivities","GetWindows"].length),this._descriptorsMarker=new a.ReadyMarker("Attached Activities Descriptors",["GetDescriptors"].length),e?(this._readyMarker=new a.ReadyMarker("Activity Manager Announce",["Announcement"].length),this._dataReadyMarker.setCallback((function(t){t&&i._readyMarker.error(t),i._descriptorsMarker.setCallback((function(t){t&&i._readyMarker.error(t),i._logger.debug("Auto announcing window"),i.announceWindow().then((function(t){i._announcedWindows.push(t),i._readyMarker.signal("Successfully announced window with id '"+t.id+"'")})).catch((function(t){i._logger.debug("Will not announce window - "+t),i._readyMarker.signal()}))})),i.refreshDescriptors()}))):this._readyMarker=this._dataReadyMarker,this._bridge.onActivitiesAttached((function(t){i._handleActivitiesAttached(t)})),this._bridge.onActivitiesDetached((function(t){i._handleActivitiesDetached(t)})),this._bridge.onActivityAttachedDescriptorsRefreshed((function(t){i._handleActivityDescriptorsRefreshed(t)})),n&&n.onWindowFrameColorChanged(this._handleWindowFrameColorChanged.bind(this)),this._bridge.init(),this._subscribeForData(),this._bridge.initReady().then((function(t){i._getInitialData()})).catch((function(t){console.log(t)}))}return Object.defineProperty(t.prototype,"usingHc",{get:function(){return"HC"===this._bridge.bridgeType},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"announcedWindows",{get:function(){return this._announcedWindows},set:function(t){throw new Error("not allowed")},enumerable:!0,configurable:!0}),t.prototype.ready=function(t){var e=this,n=new Promise((function(t,n){e._readyMarker.setCallback((function(i){i?n(e._readyMarker.getError()):t(e)}))}));return s.nodeify(Promise.all([this._bridge.ready(),n]).then((function(){return e})),t)},t.prototype.getActivityTypes=function(){return this._activityTypes.get()},t.prototype.getActivityType=function(t){return this._activityTypes.getByName(t)},t.prototype.registerActivityType=function(t,e,n,i,o,r){var a=this,c=new Promise((function(r,s){if(d.isUndefinedOrNull(t))s("activityTypeName argument can not be undefined");else if(d.isString(t)){var c,u=a.getActivityType(t);if(d.isUndefinedOrNull(u))if(d.isUndefined(e))s("Owner window type can not be undefined");else{c=d.isString(e)?{type:e,name:"",isIndependent:!1,arguments:{}}:e;var p=[];if(!d.isUndefined(n)&&d.isArray(n))for(var f in n){var h=n[f];if(d.isString(h)){var l={type:h,name:"",isIndependent:!1,arguments:{},relativeTo:"",relativeDirection:"",windowStyleAttributes:{}};p.push(l)}else p.push(h)}a._bridge.registerActivityType(t,c,p,i,o).then((function(t){a._grabEntity(t),r(t)})).catch((function(t){s(t)}))}else s("Activity type '"+t+"' already exists")}else s("activityTypeName should be string")}));return s.nodeify(c,r)},t.prototype.unregisterActivityType=function(t,e){var n=this,i=new Promise((function(e,i){var o=n.getActivityType(t);d.isUndefined(o)?i("Activity type '"+t+"' does not exists"):n._bridge.unregisterActivityType(t).then((function(){return e(o)}),i)}));return s.nodeify(i,e)},t.prototype.initiate=function(t,e,n,i){var o=this,r=new Promise((function(n,r){var s=o.getActivityType(t);d.isUndefined(s)?r("Activity type '"+t+"' does not exists"):o._bridge.initiateActivity(t,e,i).then((function(t){o._activities.getOrWait(t).then((function(t){n(t)})).catch((function(t){return r(t)}))})).catch((function(t){r(t)}))}));return s.nodeify(r,n)},t.prototype.subscribeActivityTypeEvents=function(t){this._activityTypes.subscribe((function(e,n){t(e,n.type)}))},t.prototype.getWindowTypes=function(){return this._windowTypes.get()},t.prototype.getWindowType=function(t){return this._windowTypes.getByName(t)},t.prototype.registerWindowFactory=function(t,e,n){var i=this,o=new Promise((function(n,o){if(d.isUndefinedOrNull(t))o("no windowType specified");else{if(d.isObject(t))t=t.getName();else if(!d.isString(t))return void o("windowType should be string or object that has getName method");i._bridge.registerWindowFactory(t,e).then((function(t){n(t)})).catch((function(t){o(t)}))}}));return s.nodeify(o,n)},t.prototype.unregisterWindowFactory=function(t,e){var n=this,i=new Promise((function(e,i){d.isUndefinedOrNull(t)?i("no windowType specified"):d.isString(t)?n._bridge.unregisterWindowFactory(t).then((function(t){e(t)})).catch((function(t){i(t)})):i("windowType should be a string")}));return s.nodeify(i,e)},t.prototype.getActivities=function(t){var e=this._activities.get();if(e=e.filter((function(t){return t._ownerId})),!t)return e;var n=t;if(d.isString(t))n=[t];else if(t instanceof o.default)n=[t.name];else if(!(t instanceof Array))throw new Error("Invalid input argument 'activityType' = "+t);return e.filter((function(t){var e=t.type;return d.some(n,(function(t){return e.id===t.id}))}))},t.prototype.getActivityById=function(t){return this._activities.getByName(t)},t.prototype.announceWindow=function(t,e){var n=this;return new Promise((function(o,r){var s=n._bridge.getAnnouncementInfo();if(d.isUndefined(t)&&(t=s.activityWindowId),d.isUndefined(e)&&(e=s.activityWindowType),d.isUndefinedOrNull(e))throw new Error("Can not announce - unknown windowType");var a=s&&s.activityId;if(d.isUndefinedOrNull(t))n._logger.debug("Registering window with type:'"+e+"', name:'"+s.activityWindowName+"', ind.:'"+s.activityWindowIndependent+"'"),n._bridge.registerWindow(e,s.activityWindowName,s.activityWindowIndependent).then(n._windows.getOrWait.bind(n._windows)).then((function(t){return a?n._activities.getOrWait(a).then((function(e){return t})):t})).then((function(t){o(t)})).catch((function(t){n._logger.error(t)}));else{n._logger.debug("Announcing window with id '"+t+"' and type '"+e+"'");var c=n._windows.getByName(t);if(!d.isUndefinedOrNull(c))return n._logger.debug("Window with id '"+t+"' already announced - reusing the window"),void o(c);var u=function(e,s,a){if(t===s.id&&a===i.EntityEventType.ActivityWindowJoinedActivity){var c=s.activity;d.isUndefined(c)&&r("UNDEFINED ACTIVITY"),n._logger.trace("Got joined event for id '"+t+"'"),o(s),n.unsubscribeWindowEvents(u)}};n.subscribeWindowEvents(u),n._logger.trace("Waiting for joined event for id '"+t+"'"),n._bridge.announceWindow(e,t)}}))},t.prototype.subscribeWindowTypeEvents=function(t){this._windowTypes.subscribe((function(e,n){t(e,n.type)}))},t.prototype.subscribeActivityEvents=function(t){var e=this;return this._activities.subscribe((function(n,o){if(o.type===i.EntityEventType.StatusChange){var r=o;t(n,r.newStatus,r.oldStatus)}if(o.type===i.EntityEventType.Removed||o.type===i.EntityEventType.StatusChange&&o.newStatus.getState()===p.ActivityState.Destroyed)for(var s=0,a=e._windows.get();s<a.length;s++){var c=a[s];c.activity&&c.activity.id===n.id&&e._windows.process(new i.EntityEvent(c,new i.EntityEventContext(i.EntityEventType.ActivityWindowLeftActivity)))}}))},t.prototype.subscribeWindowEvents=function(t){var e=function(e,n){var o=n.type;o===i.EntityEventType.Added&&(o="opened"),t(e.activity,e,o)};return this._windowHandlers.push([t,e]),this._windows.subscribe(e)},t.prototype.unsubscribeWindowEvents=function(t){var e=this._windowHandlers.find((function(e){return e[0]===t}));e&&(this._windowHandlers.splice(this._windowHandlers.indexOf(e),1),this._windows.unsubscribe(e[1]))},t.prototype.createWindow=function(t,e,n){var i=this,o=new Promise((function(n,o){var s,a;if(d.isUndefinedOrNull(e)&&o("windowType is undefined"),s=d.isString(e)?{type:e,name:"",isIndependent:!1,arguments:{}}:e instanceof r.default?{type:e.type||e.id,name:e.name||e.type||e.id,isIndependent:!1}:e,!d.isUndefinedOrNull(s.relativeTo))if("string"==typeof(a=s.relativeTo)){var c=i.getWindows({type:a});!d.isUndefinedOrNull(c)&&c.length>0&&(s.relativeTo=c[0].id)}else if(d.isUndefinedOrNull(a.type))d.isUndefinedOrNull(a.windowId)||(s.relativeTo=a.windowId);else{c=i.getWindows({type:a.type});!d.isUndefinedOrNull(c)&&c.length>0&&(s.relativeTo=c[0].id)}i._bridge.createWindow(t&&t.id,s).then((function(e){i._logger.debug("Window created, waiting for window entity with id "+e);var o=function(r,s){r.id!==e||t&&!r.activity||(i._logger.debug("Got entity window with id "+e),n(r),i._windows.unsubscribe(o))};i._windows.subscribe(o)})).catch((function(t){o(t)}))}));return s.nodeify(o,n)},t.prototype.createStackedWindows=function(t,e,n,i){var o=this,r=new Promise((function(i,r){d.isUndefinedOrNull(t)&&r("activity is undefined"),d.isUndefinedOrNull(e)&&r("relativeWindowTypes is undefined"),Array.isArray(e)||r("relativeWindowTypes has to be array"),d.isUndefinedOrNull(n)&&(n=2e4);var s=[];e.forEach((function(t){var e,n;if(e=d.isString(t)?{type:t,name:"",isIndependent:!1,arguments:{}}:t,!d.isUndefinedOrNull(e.relativeTo))if(n=e.relativeTo,d.isUndefinedOrNull(n.type)){if(!d.isUndefinedOrNull(n.windowId)){var i=o.getWindows({id:n.windowId});!d.isUndefinedOrNull(i)&&i.length>0&&(e.relativeTo=i[0].type.name,e.useExisting=!0)}}else e.relativeTo=n.type;s.push(e)})),o._bridge.createStackedWindows(t.id,s,n).then((function(t){var e=[],n=[],r=function(o,s){t.indexOf(o.id)>=0&&n.indexOf(o.id)<0&&o.activity&&(this._logger.debug("Got entity window with id "+t),e.push(o),n.push(o.id),e.length===t.length&&(i(e),this._windows.unsubscribe(r)))}.bind(o);o._windows.subscribe(r)})).catch((function(t){r(t)}))}));return s.nodeify(r,i)},t.prototype.addWindowToActivity=function(t,e,n){var i=this._bridge.joinActivity(t.id,e.id).then((function(){return e}));return s.nodeify(i,n),i},t.prototype.leaveWindowFromActivity=function(t,e,n){var i=this._bridge.leaveActivity(t.id,e.id).then((function(){return e}));return s.nodeify(i,n),i},t.prototype.setActivityContext=function(t,e,n){var i=this,o=new Promise((function(n,o){d.isUndefinedOrNull(t)&&o("activity can not be null"),i._bridge.updateActivityContext(t,e,!0).then((function(e){n(t)})).catch((function(t){o(t)}))}));return s.nodeify(o,n)},t.prototype.updateActivityContext=function(t,e,n){var i=this,o=new Promise((function(n,o){d.isUndefinedOrNull(t)&&o("activity can not be null");var r=[];for(var s in e)e.hasOwnProperty(s)&&null===e[s]&&r.push(s);for(var a=0,c=r;a<c.length;a++){var u=c[a];delete e[u]}i._bridge.updateActivityContext(t,e,!1,r).then((function(e){n(t)})).catch((function(t){o(t)}))}));return s.nodeify(o,n)},t.prototype.subscribeActivityContextChanged=function(t){this._activities.subscribe((function(e,n){if(n.type===i.EntityEventType.ActivityContextChange){var o=n;t(e,o.context,o.updated,o.removed)}}))},t.prototype.stopActivity=function(t,e){var n=this._bridge.stopActivity(t);return s.nodeify(n,e)},t.prototype.getWindows=function(t){return d.isUndefined(t)?this._windows.get():d.isUndefined(t.id)?this._windows.get().filter((function(e){if(!d.isUndefined(t.type)&&e.type.id!==t.type)return!1;if(!d.isUndefined(t.name)&&e.name!==t.name)return!1;if(!d.isUndefined(t.activityId)){if(d.isUndefinedOrNull(e.activity))return!1;if(e.activity.id!==t.activityId)return!1}return!0})):[this._windows.getByName(t.id)]},t.prototype.getWindowBounds=function(t){return this._bridge.getWindowBounds(t)},t.prototype.setWindowBounds=function(t,e,n){var i=this,o=new Promise((function(n,o){i._bridge.setWindowBounds(t,e).then((function(){return n()})).catch((function(t){return o(t)}))}));return s.nodeify(o,n)},t.prototype.closeWindow=function(t){return this._bridge.closeWindow(t)},t.prototype.activateWindow=function(t,e){return this._bridge.activateWindow(t,e)},t.prototype.setWindowVisibility=function(t,e){return this._bridge.setWindowVisibility(t,e)},t.prototype.clone=function(t,e,n){var i=this,o=new Promise((function(n,o){t||o("activity can not be null"),i._bridge.cloneActivity(t.id,e).then((function(t){i._activities.getOrWait(t).then((function(t){n(t)})).catch((function(t){return o(t)}))})).catch((function(t){return o(t)}))}));return s.nodeify(o,n)},t.prototype.attachActivities=function(t,e,n,i){var o=this;n=n||{};var r=new Promise((function(i,r){if(o._activities.getByName(t)){if(o._activities.getByName(e))return o._bridge.attachActivities(t,e,n).then((function(t){var e=t.to,n=t.descriptor,r=t.descriptors;o._activities.getOrWait(e).then((function(t){t._updateDescriptors(r);var e=t.attached.filter((function(t){return t.ownerId===n.ownerId}))[0];i(e)}))})).catch((function(t){r(t)}));r("can not find activity with id "+e)}else r("can not find activity with id "+t)}));return s.nodeify(r,i)},t.prototype.detachActivities=function(t,e,n){var i=this,o=new Promise((function(n,o){return i._bridge.detachActivities(t,e).then((function(){i._activities.getOrWait(void 0).then((function(t){t._updateDescriptors(void 0),i._activities.getOrWait(void 0).then((function(t){n(t)}))})).catch((function(t){return o(t)}))})).catch((function(t){o(t)}))}));return s.nodeify(o,n)},t.prototype.subscribeActivitiesAttached=function(t){this._attachedCallbacks.push(t)},t.prototype.subscribeActivitiesDetached=function(t){this._detachedCallbacks.push(t)},t.prototype.subscribeActivityFrameColorChanged=function(t){this._frameColorChangesCallbacks.push(t)},t.prototype._grabEntity=function(t){t._manager=this},t.prototype._getInitialData=function(){var t=this;this._logger.debug("Request initial data..."),this._bridge.getActivityTypes().then((function(e){t._activityTypes.add(e),t._dataReadyMarker.signal("Got act types")})).catch((function(e){t._logger.error(e),t._dataReadyMarker.error("Can not initialize ActivityManager - error getting activity types -"+e)})),this._bridge.getWindowTypes().then((function(e){t._windowTypes.add(e),t._dataReadyMarker.signal("Got window types")})).catch((function(e){t._logger.error(e),t._dataReadyMarker.error("Can not initialize ActivityManager - error getting window types  "+e)})),this._bridge.getActivities().then((function(e){t._activities.add(e),t._dataReadyMarker.signal("Got activities")})).catch((function(e){t._logger.error(e),t._dataReadyMarker.error("Can not initialize ActivityManager - error getting activity instances -"+e)})),this._bridge.getActivityWindows().then((function(e){t._windows.add(e),t._dataReadyMarker.signal("Got windows")})).catch((function(e){t._logger.error(e),t._dataReadyMarker.error("Can not initialize ActivityManager - error getting activity windows -"+e)}))},t.prototype._subscribeForData=function(){var t=this;this._logger.debug("Subscribe for data..."),this._bridge.onActivityTypeStatusChange((function(e){t._activityTypes.process(e)})),this._bridge.onWindowTypeStatusChange((function(e){t._windowTypes.process(e)})),this._bridge.onActivityStatusChange((function(e){var n=t._activities.process(e);e.context.type===i.EntityEventType.ActivityWindowJoinedActivity&&n&&n.context&&t._bridge instanceof f.default&&t._activities.process(new i.EntityEvent(n,new i.ActivityContextChangedEventContext(n.context,n.context,[])))})),this._bridge.onActivityWindowChange((function(e){t._windows.process(e)}))},t.prototype._handleActivitiesAttached=function(t){var e=this,n=t.to,i=t.descriptor,o=t.descriptors;this._activities.getOrWait(n).then((function(t){t._updateDescriptors(o);var n=t.attached.filter((function(t){return t.ownerId===i.ownerId}))[0];e._attachedCallbacks.forEach((function(e){try{e(t,n)}catch(t){return}}))}))},t.prototype._handleActivitiesDetached=function(t){var e=this,n=t.oldActivityId,i=t.newActivityId,o=t.descriptors,r=t.descriptor;this._activities.getOrWait(n).then((function(t){t._updateDescriptors(o),e._activities.getOrWait(i).then((function(n){e._detachedCallbacks.forEach((function(e){try{e(n,t,r)}catch(t){return}}))}))}))},t.prototype._handleActivityDescriptorsRefreshed=function(t){var e=t.id,n=t.descriptors,i=this._activities.getByName(e);i&&i._updateDescriptors(n)},t.prototype.refreshDescriptors=function(){var t=this;this._bridge.getAttachedDescriptors().then((function(e){e&&Object.keys(e).forEach((function(n){var i=n,o=e[n],r=t._activities.getByName(i);r&&r._updateDescriptors(o)})),t._descriptorsMarker.signal("Successfully got descriptors")})).catch((function(e){t._descriptorsMarker.error("failed to get descriptors - "+e)}))},t.prototype._handleWindowFrameColorChanged=function(t){if(t.activityId){var e=this._activities.getByName(t.activityId);e&&e.owner&&e.owner.underlyingWindow.id===t.id&&this._frameColorChangesCallbacks.forEach((function(n){try{n(e,t.frameColor)}catch(t){return}}))}},t}();e.default=h},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var i=n(2),o=n(2),r=function(){function t(t){this._items={},this._listeners=[],this._processNew=t}return t.prototype.addOne=function(t){this.add([t])},t.prototype.add=function(t){var e=this;t.forEach((function(t){e.process(new i.EntityEvent(t,new i.EntityEventContext(i.EntityEventType.Added)))}))},t.prototype.process=function(t){var e=t.context,n=e.type,o=t.entity;if(n===i.EntityEventType.StatusChange&&!e.oldStatus){var r=this._items[o.id];r&&(e.oldStatus=r.status)}n===i.EntityEventType.StatusChange&&e.oldStatus&&e.newStatus&&e.oldStatus.state===e.newStatus.state&&(e.type=i.EntityEventType.Updated),"undefined"==typeof htmlContainer&&(n===i.EntityEventType.ActivityWindowJoinedActivity&&this._items[o.id]&&this._items[o.id].activity&&(e.type=i.EntityEventType.Updated),n===i.EntityEventType.ActivityWindowLeftActivity&&this._items[o.id]&&!this._items[o.id].activity&&(e.type=i.EntityEventType.Updated));var s=this._updateInternalCollections(o,n,e);return this._notifyListeners(s,e),s},t.prototype.get=function(){var t=[];for(var e in this._items)if(this._items.hasOwnProperty(e)){var n=this._items[e];t.push(n)}return t},t.prototype.getByName=function(t){for(var e in this._items)if(e===t)return this._items[e]},t.prototype.getOrWait=function(t){var e=this;return new Promise((function(n){var i=function(o){o.id===t&&(n(o),e.unsubscribe(i))};e.subscribe(i);var o=e.getByName(t);if(o)return e.unsubscribe(i),void n(o)}))},t.prototype.subscribe=function(t){var e=this;return this._listeners.push(t),Object.keys(this._items).forEach((function(n){var o=e._items[n];t(o,new i.EntityEventContext(i.EntityEventType.Added.toString()))})),function(){e.unsubscribe(t)}},t.prototype.unsubscribe=function(t){var e=this._listeners.indexOf(t);-1!==e&&this._listeners.splice(e,1)},t.prototype._notifyListeners=function(t,e){this._listeners.forEach((function(n){try{n(t,e)}catch(t){return}}))},t.prototype._updateInternalCollections=function(t,e,n){var r=t,s=e===i.EntityEventType.StatusChange&&r.status&&r.status.state===o.ActivityState.Destroyed||e===i.EntityEventType.StatusChange&&n&&n.newStatus&&n.newStatus.state===o.ActivityState.Destroyed,a=e===i.EntityEventType.Closed;if(e===i.EntityEventType.Removed&&void 0===r.isIndependent||a||s){var c=this._items[t.id];return delete this._items[t.id],this._processNew(t),c&&t._beforeDelete(c),t}var u=t.id;return this._items.hasOwnProperty(u)?this._items[t.id]._update(t):(this._processNew(t),this._items[t.id]=t),this._items[t.id]},t}();e.EntityObservableCollection=r},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var i=n(8),o=n(47),r=n(13),s=function(){function t(t,e){this._mgr=t,this._my=e,this.all=new o.ActivityManagementAPI(t,e)}return t.prototype.ready=function(t){var e=this,n=new Promise((function(t,n){e._mgr.ready().then((function(){t(e)})).catch((function(t){n(t)}))}));return i.nodeify(n,t)},Object.defineProperty(t.prototype,"my",{get:function(){return this._my},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"aware",{get:function(){return void 0!==this._my.window},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"inActivity",{get:function(){return this.aware&&void 0!==this._my.activity},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"agm",{get:function(){if(this.aware)return this.inActivity?this._my.activity.agm:new r.ActivityAGM(null)},enumerable:!0,configurable:!0}),t.prototype.getAvailableFrameColors=function(){var t,e=window.htmlContainer;return e&&(t=e.getFrameColors()),t=t||[]},t}();e.ActivityAPI=s},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var i=n(1),o=function(){function t(t,e){this._m=t,this._my=e,this.activityTypes={get:this._getActivityTypesWrapper.bind(this),register:this._m.registerActivityType.bind(this._m),unregister:this._m.unregisterActivityType.bind(this._m),subscribe:this._m.subscribeActivityTypeEvents.bind(this._m),unsubscribe:void 0,initiate:this._m.initiate.bind(this._m)},this.windowTypes={get:this._getWindowTypesWrapper.bind(this),registerFactory:this._m.registerWindowFactory.bind(this._m),unregisterFactory:this._m.unregisterWindowFactory.bind(this._m),subscribe:this._m.subscribeWindowTypeEvents.bind(this._m),unsubscribe:void 0},this.windows={get:this._m.getWindows.bind(this._m),subscribe:this._m.subscribeWindowEvents.bind(this._m),announce:this._m.announceWindow.bind(this._m),unsubscribe:void 0,create:this._m.createWindow.bind(this._m)},this.instances={get:this._m.getActivities.bind(this._m),subscribe:this._m.subscribeActivityEvents.bind(this._m),unsubscribe:void 0}}return t.prototype.onAttached=function(t){this._m.subscribeActivitiesAttached(t)},t.prototype.onDetached=function(t){this._m.subscribeActivitiesDetached(t)},t.prototype.onActivityFrameColorChanged=function(t){this._m.subscribeActivityFrameColorChanged(t)},t.prototype._getActivityTypesWrapper=function(t){return i.isUndefined(t)?this._m.getActivityTypes():this._m.getActivityType(t)},t.prototype._getWindowTypesWrapper=function(t){return i.isUndefined(t)?this._m.getWindowTypes():this._m.getWindowType(t)},t}();e.ActivityManagementAPI=o},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var i=n(49),o=n(52),r=n(53),s=n(54);e.default=function(t){if(!t)throw Error("config not set");if(!t.agm)throw Error("config.agm is missing");var e=t.mode||"startOnly";if("startOnly"!==e&&"skipIcons"!==e&&"full"!==e)throw new Error("Invalid mode for appManager lib - "+e+" is not supported");var n,a=t.activities,c=t.agm,u=t.logger,d=t.windows,p=new i.default(c,a,d,u.subLogger("applications"),t.gdMajorVersion),f=new o.default(c);if("startOnly"===e)n=r.default(c,p);else{var h=s.default(c,p,f,"skipIcons"===e);n=h.start()}return{ready:function(){return n},applications:p.applications,application:p.application,onAppAdded:p.onAppAdded,onAppRemoved:p.onAppRemoved,onAppChanged:p.onAppChanged,onAppAvailable:p.onAppAvailable,onAppUnavailable:p.onAppUnavailable,instances:p.instances,get myInstance(){return p.getMyInstance()},onInstanceStarted:p.onInstanceStarted,onInstanceStopped:p.onInstanceStopped,onInstanceUpdated:p.onInstanceUpdated,onInstanceStartFailed:p.onInstanceStartFailed,getRegion:f.getRegion,getBranches:f.getBranches,getCurrentBranch:f.getCurrentBranch,getFunctionalEntitlement:f.getFunctionalEntitlement,getFunctionalEntitlementBranch:f.getFunctionalEntitlementBranch,setCurrentBranch:f.setCurrentBranch,setRegion:f.setRegion,currentUser:f.currentUser,canI:f.canI,canIBranch:f.canIBranch,onBranchesChanged:f.onBranchesChanged,exit:f.exit}}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var i=n(50),o=n(0),r=n(51),s=function(){function t(t,e,n,s,a){var c=this;this._agm=t,this._activities=e,this._windows=n,this._logger=s,this._gdMajorVersion=a,this._apps={},this._instances=[],this._registry=o.default(),this.application=function(t){return c._apps[t]},this.applications=function(){return Object.keys(c._apps).map((function(t){return c._apps[t]}))},this.instances=function(){return c._instances},this.getMyInstance=function(){if(c._gdMajorVersion>=3){var t=window.glue42gd.appInstanceId;return c._instances.filter((function(e){return e.id===t}))[0]}if(2===c._gdMajorVersion){var e=window.htmlContainer.windowId,n=c._instances.filter((function(t){return t.id===e}));return n.length<2?n[0]:n.filter((function(t){return!t.isActivityInstance}))[0]}},this.handleAppAdded=function(t){var e=c._getAppId(t);c._logger.trace("adding app "+e),c._apps[e]=new i.default(c,e,c._agm);var n=c._updateAppFromProps(t);c._registry.execute("appAdded",n)},this.handleAppUpdated=function(t){var e=c._updateAppFromProps(t);c._registry.execute("appChanged",e)},this.handleAppRemoved=function(t){var e=c._getAppId(t);c._logger.trace("removing app "+e);var n=c.application(e);c._instances=c._instances.filter((function(t){return t.application.name!==n.name})),delete c._apps[e],c._registry.execute("appRemoved",n)},this.handleAppReady=function(t){var e=c._getAppId(t),n=c._getAppOrThrow(e);n.updateFromProps(t),n.available?c._registry.execute("appAvailable",n):c._registry.execute("appUnavailable",n)},this.handleInstanceStarted=function(t){c._logger.trace("started app "+t.Name+" "+t.Id);var e=c._getInstanceId(t),n=c._getInstanceAppName(t),i=new r.default(e,n,c,c._agm,c._activities,c._windows);c._updateInstanceFromProps(i,t),c._instances.push(i),c._registry.execute("instanceStarted",i)},this.handleInstanceStopped=function(t){c._logger.trace("failed to start app "+t.Name+" "+t.Id);var e=c._getInstanceId(t),n=c._getInstanceAppName(t),i=c._getInstanceOrThrow(e,n);c._instances=c._instances.filter((function(t){return!c._matchInstance(t,e,n)})),c._registry.execute("instanceStopped",i),i.done()},this.handleInstanceAgmServerReady=function(t){var e=c._getInstanceId(t),n=c._getInstanceAppName(t),i=c._getInstanceOrThrow(e,n);i.updateAgmInstanceFromProps(t),c._registry.execute("instanceAgmServerReady",i)},this.handleInstanceStartFailed=function(t){var e=c._getInstanceId(t),n=c._getInstanceAppName(t),i=new r.default(e,n,void 0,void 0,void 0,void 0,!0);c._updateInstanceFromProps(i,t),c._registry.execute("instanceStartFailed",i)},this.handleInstanceUpdated=function(t){var e=c._getInstanceId(t),n=c._getInstanceAppName(t),i=c._getInstanceOrThrow(e,n);c._updateInstanceFromProps(i,t)},this.onInstanceStarted=function(t){return c._replay(c._instances,t),c._registry.add("instanceStarted",t)},this.onInstanceStartFailed=function(t){return c._registry.add("instanceStartFailed",t)},this.onInstanceStopped=function(t){return c._registry.add("instanceStopped",t)},this.onInstanceUpdated=function(t){return c._registry.add("instanceChanged",t)},this.onInstanceAgmServerReady=function(t){return c._registry.add("instanceAgmServerReady",t)},this.onAppAdded=function(t){return c._replay(c._apps,t),c._registry.add("appAdded",t)},this.onAppRemoved=function(t){return c._registry.add("appRemoved",t)},this.onAppAvailable=function(t){return c._registry.add("appAvailable",t)},this.onAppUnavailable=function(t){return c._registry.add("appUnavailable",t)},this.onAppChanged=function(t){return c._registry.add("appChanged",t)}}return t.prototype._getAppOrThrow=function(t){var e=this.application(t);if(!e)throw Error("app with id "+t+" not found");return e},t.prototype._getAppId=function(t){return t.Name},t.prototype._matchInstance=function(t,e,n){return t.id===e&&t.application.name===n},t.prototype._getInstanceByIdAndName=function(t,e){var n=this;return this._instances.filter((function(i){return n._matchInstance(i,t,e)}))[0]},t.prototype._getInstanceOrThrow=function(t,e){var n=this._getInstanceByIdAndName(t,e);if(!n)throw Error("instance with id "+t+" not found");return n},t.prototype._getInstanceId=function(t){return t.Id},t.prototype._getInstanceAppName=function(t){return t.Name},t.prototype._updateAppFromProps=function(t){var e=this._getAppId(t);this._logger.trace("updating app with  + "+e+", "+t);var n=this._getAppOrThrow(e);return n.updateFromProps(t),n},t.prototype._updateInstanceFromProps=function(t,e){this._logger.trace("updating instance with "+this._getInstanceId(e)+" for app "+this._getInstanceAppName(e)),t.updateFromProps(e)},t.prototype._replay=function(t,e){t&&(Array.isArray(t)?t.forEach((function(t){return e(t)})):Object.keys(t).map((function(e){return t[e]})).forEach((function(t){return e(t)})))},t}();e.default=s},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var i=n(6),o=n(0),r=n(14),s=function(){function t(t,e,n){var i=this;this._appManager=t,this._name=e,this._agm=n,this._registry=o.default(),t.onInstanceStarted((function(t){t.application&&t.application.name!==i._name||i._registry.execute("instanceStarted",t)})),t.onInstanceStopped((function(t){t.application&&t.application.name!==i._name||i._registry.execute("instanceStopped",t)})),t.onAppRemoved((function(t){t.name===i._name&&i._registry.execute("appRemoved",t)})),t.onAppChanged((function(t){t.name===i._name&&i._registry.execute("appChanged",t)})),t.onAppAvailable((function(t){t.name===i._name&&i._registry.execute("appAvailable",t)})),t.onAppUnavailable((function(t){t.name===i._name&&i._registry.execute("appUnavailable",t)}))}return Object.defineProperty(t.prototype,"name",{get:function(){return this._name},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"title",{get:function(){return this._props.Title},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"version",{get:function(){return this._props.Version},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"autoStart",{get:function(){return this._props.AutoStart},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isShell",{get:function(){return this._props.IsShell},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"caption",{get:function(){return this._props.Caption},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"hidden",{get:function(){return this._props.IsHidden},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"container",{get:function(){return this._props.ApplicationName},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"activityType",{get:function(){return this._props.ActivityType},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"activityWindowType",{get:function(){return this._props.ActivityWindowType},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"windowSettings",{get:function(){return this._props.Arguments?r.objectClone(this._props.Arguments):{}},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"allowMultiple",{get:function(){return this._props.AllowMultiple},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"available",{get:function(){return this._props.IsReady||!1},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"icon",{get:function(){return this._props.Icon},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"iconURL",{get:function(){return this._props.IconUrl},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"sortOrder",{get:function(){return this._props.SortOrder},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"userProperties",{get:function(){return this._props.UserProperties?r.objectClone(this._props.UserProperties):{}},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isActivity",{get:function(){return void 0!==this._props.ActivityType&&""!==this._props.ActivityType},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"configuration",{get:function(){return{autoStart:this._props.AutoStart,caption:this._props.Caption,hidden:this._props.IsHidden,container:this._props.ApplicationName,activityType:this._props.ActivityType,allowMultiple:this._props.AllowMultiple}},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"instances",{get:function(){var t=this;return this._appManager.instances().filter((function(e){return e.application.name===t._name}))},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"type",{get:function(){return this._props.Type},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"mode",{get:function(){if(!this._props)return"unknown";if(this._props.Mode&&"string"==typeof this._props.Mode)return this._props.Mode.toLowerCase();if(this.isActivity)return"unknown";if(this._props.Arguments&&this._props.Arguments.mode&&"string"==typeof this._props.Arguments.mode)return this._props.Arguments.mode.toLowerCase();var t=this._props.WindowStyleAttributes;if(t){var e=(t=t.split(" ").join("")).indexOf('mode:"');if(-1!==e){var n=e+'mode:"'.length,i=t.indexOf('"',n),o=t.substr(n,i-n);if(o&&"string"==typeof o)return o.toLowerCase()}}return"flat"},enumerable:!0,configurable:!0}),t.prototype.updateFromProps=function(t){var e=this;this._props||(this._props={Name:t.Name}),Object.keys(t).forEach((function(n){e._props[n]=t[n]}))},t.prototype.start=function(t,e){var n=this,o=this._name;return new Promise((function(r,s){e=e||{},(t=t||{})._t42={createWindowArgs:e},void 0===e.waitForAGMReady&&(e.waitForAGMReady=!0);var a=e.waitForAGMReady,c=!e.waitForAGMReady;n._agm.invoke(i.StartApplicationMethodName,{Name:o,Context:t,WaitForAgmInstance:a,WaitForInstance:c},"best",{methodResponseTimeoutMs:1e4},(function(t){var e=t.returned&&t.returned.Instance_0?t.returned.Instance_0:t.returned;e&&e.Id?function(t){var e,i=function(){var e,i=n._appManager.instances().filter((function(e){return e.id===t}));return(e=2===i.length?i[0].isActivityInstance?i[0]:i[1]:i[0])&&a?e.agm?e:void 0:e},o=setTimeout((function(){e&&e(),s("timeout")}),1e4),c=function(n){n.id===t&&(e&&(e(),e=void 0),clearTimeout(o),setTimeout((function(){r(i())}),1))};e=a?n._appManager.onInstanceAgmServerReady(c):n._appManager.onInstanceStarted(c);var u=i();u&&(e&&(e(),e=void 0),clearTimeout(o),r(u))}(e.Id):r(void 0)}),(function(t){s(t)}))}))},t.prototype.onInstanceStarted=function(t){this._registry.add("instanceStarted",t)},t.prototype.onInstanceStopped=function(t){this._registry.add("instanceStopped",t)},t.prototype.onAvailable=function(t){this._registry.add("appAvailable",t)},t.prototype.onUnavailable=function(t){this._registry.add("appUnavailable",t)},t.prototype.onChanged=function(t){this._registry.add("appChanged",t)},t.prototype.onRemoved=function(t){this._registry.add("appRemoved",t)},t}();e.default=s},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var i=n(6),o=n(0),r=function(){function t(t,e,n,i,r,s,a){var c=this;this._id=t,this._appName=e,this._appManager=n,this._agm=i,this._activities=r,this._windows=s,this.onAgmReady=this._addToRegistry("agmReady"),this.onStopped=this._addToRegistry("stopped"),this._registry=o.default(),a||(this._unsubscribeInstanceStopped=this._appManager.onInstanceStopped((function(t){t.id===c._id&&c._registry.execute("stopped",t)})),this._unsubscribeInstanceAgmServerReady=this._appManager.onInstanceAgmServerReady((function(t){t.id===c._id&&c._registry.execute("agmReady",t)})))}return Object.defineProperty(t.prototype,"id",{get:function(){return this._id},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"application",{get:function(){return this._appManager.application(this._appName)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"activity",{get:function(){var t=this;if(!this._activities)throw new Error("This method requires glue.activities library to be enabled.");return this._activities.all.instances.get().filter((function(e){return e.id===t._activityId}))[0]},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"activityInstances",{get:function(){var t=this;return this._appManager.instances().filter((function(e){return e.context&&e.context.activityId===t._activityId}))},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"activityOwnerInstance",{get:function(){return this._appManager.instances().filter((function(t){if(t.window&&t.window.context){var e=t.window.context;if(e._t42&&e._t42.activityIsOwner)return!0}return!1}))[0]},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"window",{get:function(){var t=this;if(!this._windows)throw new Error("This method requires glue.windows library to be enabled.");var e=this._windows.list().filter((function(e){return e.id===t._id}))[0];return!e&&this.activity&&this.activityOwnerInstance&&(e=this.activityOwnerInstance.window),e},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"context",{get:function(){return this._startUpContext},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"title",{get:function(){return this._title},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isActivityInstance",{get:function(){return this._isActivityInstance},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"activityId",{get:function(){return this._activityId},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"inActivity",{get:function(){return this._inActivity},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isSingleWindowApp",{get:function(){return!this._inActivity},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"agm",{get:function(){return this._agmInstance},enumerable:!0,configurable:!0}),t.prototype.updateFromProps=function(t){this._startUpContext=t.Context,this._title=t.Title,this._isActivityInstance=!1,t.ActivityId&&""!==t.ActivityId&&(this._activityId=t.ActivityId,this._isActivityInstance=!0),!this._activityId&&this._startUpContext&&this._startUpContext.activityId&&(this._activityId=this._startUpContext.activityId),this._inActivity=Boolean(this._activityId),this.updateAgmInstanceFromProps(t)},t.prototype.updateAgmInstanceFromProps=function(t){if(t.AgmServers)if(t.GD3){var e=t.AgmServers;e&&(this._agmInstance=e[0])}else{var n=t.AgmServers,i=Object.keys(n)[0];if(!i)return;var o=n[i];this._agmInstance={machine:o.machineName,user:o.userName,environment:o.environment,application:o.applicationName}}},t.prototype.stop=function(){var t=this;return new Promise((function(e,n){var o=t._appManager.onInstanceStopped((function(n){n.id===t._id&&(o(),e())}));t._agm.invoke(i.StopApplicationMethodName,{Name:t._appName,Id:t._id}).catch((function(t){return n(t)}))}))},t.prototype.activate=function(){return this._agm.invoke(i.ActivateApplicationMethodName,{Name:this._appName,Id:this._id})},t.prototype.done=function(){this._registry.clear(),this._unsubscribeInstanceAgmServerReady(),this._unsubscribeInstanceStopped()},t.prototype._addToRegistry=function(t){var e=this;return function(n){e._registry.add(t,n)}},t}();e.default=r},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var i=n(6),o=n(0);function r(t,e,n){var i=function(t){return!!(t&&t.constructor&&t.call&&t.apply)};if(!i(e)&&!i(n))return t;i(e)?i(n)||(n=function(){}):e=function(){},t.then(e,n)}var s=function(t){var e=this;this._agm=t,this._registry=o.default(),this.handleBranchModified=function(t){e._registry.execute("branchChanged",t)},this.handleBranchesModified=function(t){e._registry.execute("branchesChanged",t)},this.getRegion=function(t,n){return r(e._agmInvoke(i.GetConfigurationRegionMethodName,(function(t){return t.returned.Region})),t,n)},this.getBranches=function(t,n){return r(e._agmInvoke(i.GetBranchesMethodName,(function(t){var e=t.returned.Branches;return Object.keys(e).map((function(t){return e[t]}))})),t,n)},this.getCurrentBranch=function(t,n){return r(e._agmInvoke(i.GetCurrentBranchMethodName,(function(t){return t.returned.Branch}),void 0),t,n)},this.setRegion=function(t,n,o){return r(e._agmInvoke(i.SetConfigurationRegionMethodName,(function(t){return t.returned.ResultMessage}),{Region:t}),n,o)},this.setCurrentBranch=function(t,n,o){return r(e._agmInvoke(i.SetCurrentBranchMethodName,(function(t){return t.returned.ResultMessage}),{Branch:t}),n,o)},this.currentUser=function(t,n){return r(e._agmInvoke(i.GetUserMethodName),t,n)},this.getFunctionalEntitlement=function(t,n,o){return r(e._agmInvoke(i.GetFunctionalEntitlementMethodName,(function(t){return t.returned.Entitlement}),{Function:t}),n,o)},this.getFunctionalEntitlementBranch=function(t,n,o,s){return r(e._agmInvoke(i.GetFunctionalEntitlementMethodName,(function(t){return t.returned.Entitlement}),{Function:t,Branch:n}),o,s)},this.canI=function(t,n,o){return r(e._agmInvoke(i.CanIMethodName,(function(t){return t.returned.Result}),{Function:t}),n,o)},this.canIBranch=function(t,n,o,s){return r(e._agmInvoke(i.CanIMethodName,(function(t){return t.returned.Result}),{Function:t,Branch:n}),o,s)},this.onBranchesChanged=function(t){e._registry.add("branchesChanged",t)},this.onBranchChanged=function(t){e._registry.add("branchChanged",t)},this.exit=function(t){return e._agmInvoke(i.ShutdownMethodName,null,t)},this._agmInvoke=function(t,n,i){return i=i||{},new Promise((function(o,r){e._agm.invoke(t,i).then((function(t){n||(n=function(t){return t.returned}),o(n(t))})).catch((function(t){return r(t)}))}))}};e.default=s},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var i=n(6),o=n(14);e.default=function(t,e){return new Promise((function(n,r){t.invoke(i.GetApplicationsMethodName,{skipIcon:!0}).then((function(t){var i=t.returned;i||n();var r=i.applications;r||n(),o.objectValues(r).map((function(t){return e.handleAppAdded(t)})),n()})).catch((function(t){return r("Error getting application snapshot: "+t.message)}))}))}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var i=n(6),o=n(55),r=n(14);e.default=function(t,e,n,s){var a;return{start:function(){var c,u,d=new Promise((function(t,e){c=t,u=e}));return t.subscribe(i.OnEventMethodName,{arguments:{skipIcon:s},waitTimeoutMs:1e4}).then((function(t){(a=t).onData((function(t){var i=t.data;r.objectValues(i[o.OnApplicationAddedEvent]).map((function(t){return e.handleAppAdded(t)})),r.objectValues(i[o.OnApplicationChangedEvent]).map((function(t){return e.handleAppUpdated(t)})),r.objectValues(i[o.OnApplicationRemovedEvent]).map((function(t){return e.handleAppRemoved(t)})),r.objectValues(i[o.OnApplicationReadyEvent]).map((function(t){return e.handleAppReady(t)})),r.objectValues(i[o.OnApplicationStartedEvent]).map((function(t){return e.handleInstanceStarted(t)})),r.objectValues(i[o.OnApplicationStartFailedEvent]).map((function(t){return e.handleInstanceStartFailed(t)})),r.objectValues(i[o.OnApplicationStoppedEvent]).map((function(t){return e.handleInstanceStopped(t)})),r.objectValues(i[o.OnApplicationUpdatedEvent]).map((function(t){return e.handleInstanceUpdated(t)})),r.objectValues(i[o.OnApplicationAgmServerReadyEvent]).map((function(t){return e.handleInstanceAgmServerReady(t)})),r.objectValues(i[o.OnBranchChangedEvent]).map((function(t){return n.handleBranchModified(t)})),r.objectValues(i[o.OnBranchesModifiedEvent]).map((function(t){return n.handleBranchesModified(t)})),c()})),a.onFailed((function(t){return u(t)}))})).catch((function(t){return u("Error subscribing for "+i.OnEventMethodName+" stream. Err: "+t)})),d},stop:function(){a&&a.close()}}}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.OnNotificationEvent="OnNotification",e.OnBranchChangedEvent="OnBranchChanged",e.OnBranchesModifiedEvent="OnBranchesModified",e.OnApplicationAddedEvent="OnApplicationAdded",e.OnApplicationRemovedEvent="OnApplicationRemoved",e.OnApplicationChangedEvent="OnApplicationChanged",e.OnApplicationReadyEvent="OnApplicationReady",e.OnApplicationStartedEvent="OnApplicationStarted",e.OnApplicationRegisteredEvent="OnApplicationRegistered",e.OnApplicationAgmServerReadyEvent="OnApplicationAgmServerReady",e.OnApplicationUpdatedEvent="OnApplicationUpdated",e.OnApplicationStoppedEvent="OnApplicationStopped",e.OnApplicationStartFailedEvent="OnApplicationStartFailed"},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var i=n(0),o=n(57),r=n(62),s=n(3);e.default=function(t,e,n,a){var c,u,d=i(),p=e;s.default.init(p);var f=new Promise((function(e,i){o.default(t,p,n,a).then((function(t){u=t,c=r.default(t,p),e()})).catch((function(t){var e="Environment detector fails with: "+t;p.error(e),i(e)}))}));function h(t){return d.add("window-added",t)}function l(t){return d.add("window-removed",t)}return s.default.onReadyWindow((function(t){d.execute("window-added",t.API)})),s.default.onRemoved((function(t){d.execute("window-removed",t.API)})),{my:function(){var t=s.default.getIfReady(u.my());return t?t.API:void 0},open:function(t,e,n,i,o){return new Promise((function(r,a){var c=function(t){"function"==typeof o&&o(t),a(t)};u.open(t,e,n,(function(t){s.default.waitFor(t).then((function(t){"function"==typeof i&&i(t.API),r(t.API),"electron"===t.API.windowType&&t.Events.handleUrlChanged(t.API.url)})).catch(c)}),c)}))},find:function(t,e,n){var i=s.default.list,o=Object.keys(i).reduce((function(e,n){var o=i[n];return o&&o.API.name===t&&e.push(o.API),e}),[]);if("function"!=typeof e)return o[0];o.length>0?e(o[0]):"function"==typeof n&&n("There is no window with name:"+t)},findById:function(t,e,n){var i=s.default.list,o=Object.keys(i).reduce((function(e,n){var o=i[n];return void 0!==o&&o.API.id===t&&e.push(o.API),e}),[]);if("function"!=typeof e)return o[0];o.length>0?e(o[0]):"function"==typeof n&&n("There is no window with such id:"+t)},list:function(t){var e=s.default.list,n=Object.keys(e).map((function(t){return e[t].API}));if("function"!=typeof t)return n;t(n)},ready:function(){return f},onWindowAdded:h,windowAdded:h,onWindowRemoved:l,windowRemoved:l,onTabAttached:function(t){return f.then((function(){u.tabAttached(t)}))},onTabDetached:function(t){return f.then((function(){u.tabDetached(t)}))},onWindowFrameColorChanged:function(t){return f.then((function(){return u.onWindowFrameColorChanged(t)}))},get groups(){return c.groupsAPI},onWindowGotFocus:function(t){var e;return f.then((function(){e=u.onWindowGotFocus(t)})),function(){e&&e()}},onWindowLostFocus:function(t){var e;return f.then((function(){e=u.onWindowLostFocus(t)})),function(){e&&e()}},onEvent:function(t){var e,n=!1;return f.then((function(){n||(e=u.onEvent(t))})),function(){n=!0,e&&e()}},createFlydown:function(t,e){return u.createFlydown(t,e)},showPopup:function(t,e){return u.showPopup(t,e)}}}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var i=n(58),o=n(60);e.default=function(t,e,n,r){var s=e;return new Promise((function(e,a){if(2===r)s.trace("running in HC"),o.default(t,s,n,window.htmlContainer.containerName,window.htmlContainer.windowId).then(e).catch(a);else if(r>=3){s.trace("running in GD"),new i.default(t,s,n,void 0,window.glue42gd.windowId).init().then(e).catch(a)}else{var c=o.default(t,s,n),u=new i.default(t,s,n).init();Promise.race([c,u,(d=1e4,new Promise((function(t,e){return setTimeout((function(){e("timeout waiting for streams")}),d)})))]).then(e).catch(a)}var d}))}},function(t,e,n){"use strict";var i=this&&this.__assign||function(){return(i=Object.assign||function(t){for(var e,n=1,i=arguments.length;n<i;n++)for(var o in e=arguments[n])Object.prototype.hasOwnProperty.call(e,o)&&(t[o]=e[o]);return t}).apply(this,arguments)},o=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(o,r){function s(t){try{c(i.next(t))}catch(t){r(t)}}function a(t){try{c(i.throw(t))}catch(t){r(t)}}function c(t){var e;t.done?o(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(s,a)}c((i=i.apply(t,e||[])).next())}))},r=this&&this.__generator||function(t,e){var n,i,o,r,s={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return r={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(r[Symbol.iterator]=function(){return this}),r;function a(r){return function(a){return function(r){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,i&&(o=2&r[0]?i.return:r[0]?i.throw||((o=i.return)&&o.call(i),0):i.next)&&!(o=o.call(i,r[1])).done)return o;switch(i=0,o&&(r=[2&r[0],o.value]),r[0]){case 0:case 1:o=r;break;case 4:return s.label++,{value:r[1],done:!1};case 5:s.label++,i=r[1],r=[0];continue;case 7:r=s.ops.pop(),s.trys.pop();continue;default:if(!(o=(o=s.trys).length>0&&o[o.length-1])&&(6===r[0]||2===r[0])){s=0;continue}if(3===r[0]&&(!o||r[1]>o[0]&&r[1]<o[3])){s.label=r[1];break}if(6===r[0]&&s.label<o[1]){s.label=o[1],o=r;break}if(o&&s.label<o[2]){s.label=o[2],s.ops.push(r);break}o[2]&&s.ops.pop(),s.trys.pop();continue}r=e.call(t,s)}catch(t){r=[6,t],i=0}finally{n=o=0}if(5&r[0])throw r[1];return{value:r[0]?r[1]:void 0,done:!0}}([r,a])}}};Object.defineProperty(e,"__esModule",{value:!0});var s=n(3),a=n(20),c=n(59),u=n(0),d=n(22),p=function(){function t(t,e,n,i,o){this._registry=u(),this._waitTimeout=1e4,this._agm=t,this._logger=e.subLogger("gd-env"),this._agmInstance=this.normalizeInstance(i),this._windowId=o,this._appManagerGetter=n}return t.prototype.init=function(){var t=this;return new Promise((function(e,n){void 0===t._agmInstance&&(t._agmInstance="best"),t._agm.registerAsync("T42.Wnd.OnEventWithResponse",(function(e,n,i,o){t.respondToEvent(e).then(i).catch(o)}));new Promise((function(i,o){t._agm.subscribe("T42.Wnd.OnEvent",{waitTimeoutMs:t._waitTimeout,target:t._agmInstance}).then((function(i){i.onData((function(e){t.updateWindow(e.data)})),i.onFailed((function(t){n(t)})),t._agmInstance=t.normalizeInstance(i.serverInstance),c.default.init(t._agm,t._agmInstance),e(t)})).catch((function(t){n("Can not subscribe for stream T42.Wnd.OnEvent. Err: "+t)}))}))}))},Object.defineProperty(t.prototype,"executor",{get:function(){return c.default},enumerable:!0,configurable:!0}),t.prototype.open=function(t,e,n,o,r){var s=i({},n=n||{});void 0!==t?(void 0!==s.relativeTo&&"string"!=typeof s.relativeTo&&(s.relativeTo=s.relativeTo.id||""),s.name=t,s.url=e,s.windowState=n.windowState||n.state,delete s.state,this._agm.invoke("T42.Wnd.Create",s,this._agmInstance).then((function(t){if(void 0!==t.returned){var e=t.returned.id;o(e)}else r({message:"failed to execute T42.Wnd.Create - unknown reason"})})).catch(r)):r({message:"The name is undefined"})},t.prototype.createFlydown=function(t,e){return this.executor.createFlydown(t,e)},t.prototype.showPopup=function(t,e){return o(this,void 0,void 0,(function(){var n;return r(this,(function(i){switch(i.label){case 0:return n=s.default.get(t),[4,this.executor.showPopup(n.API,e)];case 1:return i.sent(),[2]}}))}))},t.prototype.tabAttached=function(t){return this._registry.add("tab-attached",t)},t.prototype.tabDetached=function(t){return this._registry.add("tab-detached",t)},t.prototype.onWindowFrameColorChanged=function(t){return this._registry.add("frame-color-changed",t)},t.prototype.onEvent=function(t){return this._registry.add("window-event",t)},t.prototype.my=function(){return this._windowId},t.prototype.execute=function(t,e,n){return this._agm.invoke("T42.Wnd.Execute",{command:t,options:n,windowId:e})},t.prototype.setGroupHeaderVisible=function(t,e){return this._agm.invoke("T42.Wnd.SetGroupHeaderVisible",{windowId:t,toShow:e},this._agmInstance)},t.prototype.onCompositionChanged=function(t){return this._registry.add("composition-changed",t)},t.prototype.onGroupHeaderVisibilityChanged=function(t){return this._registry.add("group-header-changed",t)},t.prototype.onWindowGotFocus=function(t){return this._registry.add("got-focus",t)},t.prototype.onWindowLostFocus=function(t){return this._registry.add("lost-focus",t)},t.prototype.normalizeInstance=function(t){if(t)return{application:t.application,machine:t.machine,user:t.user}},t.prototype.respondToEvent=function(t){return"ShowFlydownBoundsRequested"===t.type?this.executor.handleFlydownBoundsRequested(t.data.windowId,t.data):Promise.reject("There isn't a handler for "+t.type)},t.prototype.updateWindow=function(t){var e=this,n=this.getExtendedStreamEvent(t);if("Snapshot"!==t.type){if("Created"===t.type){var i=t,o=this.createWindow(i.windowId,i.data||{});return s.default.setReadyState(o.API.id),void this._registry.execute("window-event",n)}var r=s.default.get(t.windowId);if(r){var a=r.API,c=r.Events;if("BoundsChanged"===t.type){var u=t;c.handleBoundsChanged(u.data)}if("UrlChanged"===t.type){var p=t;s.default.setUrlChangedState(p.windowId),c.handleUrlChanged(p.data)}if("TitleChanged"===t.type){var f=t;c.handleTitleChanged(f.data)}if("VisibilityChanged"===t.type&&c.handleVisibilityChanged(t.data),"ContextChanged"===t.type&&c.handleContextUpdated(t.data),"StateChanged"===t.type&&c.handleWindowChangeState(t.data),"FrameColorChanged"===t.type&&(c.handleFrameColorChanged(t.data),this._registry.execute("frame-color-changed",a)),"CompositionChanged"===t.type){var h=t;c.handleCompositionChanged(h.data.neighbors,h.data.groupId),this._registry.execute("composition-changed",h.data)}if("GroupHeaderVisibilityChanged"===t.type){var l=t;c.handleGroupHeaderVisibilityChanged(l.data.groupHeaderVisible),this._registry.execute("group-header-changed",l.data)}if("FocusChanged"===t.type){var y=t;this.focusChanged(c,a,y.data)}if("WindowFrameChanged"===t.type&&(c.handleFrameAttached(t.data.frameId,t.data.isTabHeaderVisible),this._registry.execute("frame-changed")),"WindowFrameAdded"===t.type){c.handleAttached(t.data.frameId,t.data.isTabHeaderVisible);var v=d.getWindowsByTabGroupId(a.id,t.data.frameId);Object.keys(v).forEach((function(t){v[t].Events.handleWindowAttached(a)})),this._registry.execute("tab-attached",a,t.data.frameId,t.data.isTabHeaderVisible)}if("WindowFrameRemoved"===t.type){var g=a.tabGroupId;c.handleDetached(t.data.frameId);var m=d.getWindowsByTabGroupId(a.id,g);Object.keys(m).forEach((function(t){m[t].Events.handleWindowDetached(a)}));var b=this._registry.add("frame-changed",(function(){b(),e._registry.execute("tab-detached",a,t.data.frameId,a.tabGroupId)}))}"TabHeaderVisibilityChanged"===t.type&&c.handleTabHeaderVisibilityChanged(t.data.isTabHeaderVisible),"FrameSelectionChanged"===t.type&&c.handleFrameSelectionChanged(t.data.newWindowId,t.data.prevWindowId),"ButtonClicked"===t.type&&c.handleFrameButtonClicked(t.data),"ButtonAdded"===t.type&&c.handleFrameButtonAdded(t.data),"ButtonRemoved"===t.type&&c.handleFrameButtonRemoved(t.data),"WindowZoomFactorChanged"===t.type&&c.handleZoomFactorChanged(t.data),"Closed"===t.type&&(s.default.remove(r),c.handleWindowClose()),"FrameIsLockedChanged"===t.type&&c.handleFrameIsLockedChanged(t.data),this._registry.execute("window-event",n)}else this._logger.error("received update for unknown window. Stream:', "+JSON.stringify(t,null,4))}else{t.windows.forEach((function(t){var i=e.createWindow(t.id,t);s.default.markReadyToShow(i.API.id),e._registry.execute("window-event",n)}))}},t.prototype.createWindow=function(t,e){var n=a.default(t,this.mapToWindowConstructorOptions(e),c.default,this._logger,this._appManagerGetter,this._agm);return s.default.add(n),n},t.prototype.focusChanged=function(t,e,n){t.handleFocusChanged(n),n?this._registry.execute("got-focus",e):this._registry.execute("lost-focus",e)},t.prototype.mapToWindowConstructorOptions=function(t){return{name:t.name,context:t.context,bounds:t.bounds,url:t.url,title:t.title,isVisible:t.isVisible,focus:t.isFocused,state:t.state,frameColor:t.frameColor,groupId:t.groupId,neighbours:t.neighbors,isFocused:t.isFocused,isGroupHeaderVisible:t.groupHeaderVisible,isCollapsed:t.isCollapsed,tabGroupId:t.frameId,mode:t.mode,isTabHeaderVisible:t.isTabHeaderVisible,isTabSelected:t.isActiveTab,settings:t.settings,windowType:t.windowType,zoomFactor:t.zoomFactor,isLocked:t.isLocked}},t.prototype.getExtendedStreamEvent=function(t){try{var e=i({state:t.type,windowName:s.default.get(t.windowId).API.name},t);return"WindowFrameAdded"===e.state&&(e.state="TabAttached"),"StateChanged"===e.state&&(e.state=e.data.charAt(0).toUpperCase()+e.data.slice(1)),"ButtonAdded"===e.state&&(e.state="FrameButtonAdded"),"ButtonRemoved"===e.state&&(e.state="FrameButtonRemoved"),e}catch(e){return t}},t}();e.default=p},function(t,e,n){"use strict";var i=this&&this.__assign||function(){return(i=Object.assign||function(t){for(var e,n=1,i=arguments.length;n<i;n++)for(var o in e=arguments[n])Object.prototype.hasOwnProperty.call(e,o)&&(t[o]=e[o]);return t}).apply(this,arguments)},o=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(o,r){function s(t){try{c(i.next(t))}catch(t){r(t)}}function a(t){try{c(i.throw(t))}catch(t){r(t)}}function c(t){var e;t.done?o(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(s,a)}c((i=i.apply(t,e||[])).next())}))},r=this&&this.__generator||function(t,e){var n,i,o,r,s={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return r={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(r[Symbol.iterator]=function(){return this}),r;function a(r){return function(a){return function(r){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,i&&(o=2&r[0]?i.return:r[0]?i.throw||((o=i.return)&&o.call(i),0):i.next)&&!(o=o.call(i,r[1])).done)return o;switch(i=0,o&&(r=[2&r[0],o.value]),r[0]){case 0:case 1:o=r;break;case 4:return s.label++,{value:r[1],done:!1};case 5:s.label++,i=r[1],r=[0];continue;case 7:r=s.ops.pop(),s.trys.pop();continue;default:if(!(o=(o=s.trys).length>0&&o[o.length-1])&&(6===r[0]||2===r[0])){s=0;continue}if(3===r[0]&&(!o||r[1]>o[0]&&r[1]<o[3])){s.label=r[1];break}if(6===r[0]&&s.label<o[1]){s.label=o[1],o=r;break}if(o&&s.label<o[2]){s.label=o[2],s.ops.push(r);break}o[2]&&s.ops.pop(),s.trys.pop();continue}r=e.call(t,s)}catch(t){r=[6,t],i=0}finally{n=o=0}if(5&r[0])throw r[1];return{value:r[0]?r[1]:void 0,done:!0}}([r,a])}}};Object.defineProperty(e,"__esModule",{value:!0});var s=n(0),a=function(){function t(){this._registry=s()}return Object.defineProperty(t.prototype,"hostInstance",{get:function(){return this.agmTarget},enumerable:!0,configurable:!0}),t.prototype.init=function(t,e){this.agm=t,this.agmTarget=e},t.prototype.close=function(t){var e=this;return new Promise((function(n,i){e.execute("close",{windowId:t.id}).then((function(){n(t)})).catch((function(t){i(t)}))}))},t.prototype.navigate=function(t,e){var n=this;return new Promise((function(i,o){n.execute("navigate",{windowId:t.id,options:{url:e}}).then((function(){i(t)})).catch((function(t){o(t)}))}))},t.prototype.setStyle=function(t,e){return o(this,void 0,void 0,(function(){var n,i,o,s,a,c,u,d,p,f,h,l;return r(this,(function(r){switch(r.label){case 0:return n=[],i=function(t){return n.push(t)},void 0===e.focus||t.isFocused||i(t.focus()),void 0!==e.hidden&&(o=!e.hidden,i(t.setVisible(o))),s=e.maxWidth,a=e.maxHeight,c=e.minWidth,u=e.minHeight,d=e.allowClose,p=e.allowCollapse,f=e.allowLockUnlock,h=e.allowMaximize,l=e.allowMinimize,i(t.setSizeConstraints({maxWidth:s,maxHeight:a,minWidth:c,minHeight:u})),i(t.resetButtons({allowClose:d,allowCollapse:p,allowLockUnlock:f,allowMaximize:h,allowMinimize:l})),[4,Promise.all(n)];case 1:return r.sent(),[2,t]}}))}))},t.prototype.setSizeConstraints=function(t,e){var n=this;return new Promise((function(i,o){n.execute("setSizeConstraints",{windowId:t.id,options:e}).then((function(){i(t)})).catch(o)}))},t.prototype.resetButtons=function(t,e){var n=this;return new Promise((function(i,o){n.execute("resetButtons",{windowId:t.id,options:e}).then((function(){i(t)})).catch(o)}))},t.prototype.setTitle=function(t,e){var n=this;return new Promise((function(i,o){var r={windowId:t.id,options:{title:e}};n.execute("setTitle",r).then((function(){i(t)})).catch((function(t){o(t)})),Promise.resolve()}))},t.prototype.moveResize=function(t,e){var n=this;return new Promise((function(i,o){n.execute("moveResize",{windowId:t.id,options:{bounds:e}}).then((function(){i(t)})).catch((function(t){o(t)}))}))},t.prototype.addFrameButton=function(t,e){var n=this;return new Promise((function(i,o){n.execute("addButton",{windowId:t.id,options:e}).then((function(){i(t)})).catch((function(t){o(t)}))}))},t.prototype.removeFrameButton=function(t,e){var n=this;return new Promise((function(i,o){n.execute("removeButton",{windowId:t.id,options:e}).then((function(){i(t)})).catch((function(t){o(t)}))}))},t.prototype.activate=function(t){var e=this;return new Promise((function(n,i){e.execute("activate",{windowId:t.id}).then((function(){n(t)})).catch((function(t){i(t)}))}))},t.prototype.focus=function(t){var e=this;return new Promise((function(n,i){e.execute("focus",{windowId:t.id}).then((function(){n(t)})).catch((function(t){i(t)}))}))},t.prototype.maximizeRestore=function(t){var e=this;return new Promise((function(n,i){e.execute("maximizeRestore",{windowId:t.id}).then((function(){n(t)})).catch((function(t){i(t)}))}))},t.prototype.maximize=function(t){var e=this;return new Promise((function(n,i){e.execute("maximize",{windowId:t.id}).then((function(){n(t)})).catch((function(t){i(t)}))}))},t.prototype.restore=function(t){var e=this;return new Promise((function(n,i){e.execute("restore",{windowId:t.id}).then((function(){n(t)})).catch((function(t){i(t)}))}))},t.prototype.minimize=function(t){var e=this;return new Promise((function(n,i){e.execute("minimize",{windowId:t.id}).then((function(){n(t)})).catch((function(t){i(t)}))}))},t.prototype.collapse=function(t){var e=this;return new Promise((function(n,i){e.execute("collapse",{windowId:t.id}).then((function(){n(t)})).catch((function(t){i(t)}))}))},t.prototype.expand=function(t){var e=this;return new Promise((function(n,i){e.execute("expand",{windowId:t.id}).then((function(){n(t)})).catch((function(t){i(t)}))}))},t.prototype.toggleCollapse=function(t){var e=this;return new Promise((function(n,i){e.execute("toggleCollapse",{windowId:t.id}).then((function(){n(t)})).catch((function(t){i(t)}))}))},t.prototype.snap=function(t,e,n){var i=this;return new Promise((function(o,r){t.id;var s,a="Invalid target parameter - should be an object with property id or a string. Invoked for source window id:"+t.id;if(e){if("string"==typeof e)s=e;else{if(void 0===e.id)return void r(a);s=e.id}var c={targetWindowId:s};n&&(c.snappingEdge=n),i.execute("snap",{windowId:t.id,options:c}).then((function(){o(t)})).catch((function(t){r(t)}))}else r(a)}))},t.prototype.attachTab=function(t,e){var n=this;return new Promise((function(i,o){n.execute("attachTab",{windowId:t.id,options:e}).then((function(){i(t)})).catch((function(t){o(t)}))}))},t.prototype.detachTab=function(t,e){var n=this;return new Promise((function(i,o){n.execute("detachTab",{windowId:t.id,options:e}).then((function(){i(t)})).catch((function(t){o(t)}))}))},t.prototype.setVisible=function(t,e){var n=this;return void 0===e&&(e=!0),new Promise((function(i,o){var r;r=e?"show":"hide",n.execute(r,{windowId:t.id}).then((function(){i(t)})).catch((function(t){o(t)}))}))},t.prototype.showLoader=function(t,e){var n=this;return new Promise((function(i,o){n.execute("showLoadingAnimation",{windowId:t.id,options:e}).then((function(){i(t)})).catch((function(t){o(t)}))}))},t.prototype.hideLoader=function(t){var e=this;return new Promise((function(n,i){e.execute("hideLoadingAnimation",{windowId:t.id}).then((function(){n(t)})).catch((function(t){i(t)}))}))},t.prototype.updateContext=function(t,e){var n=this;return new Promise((function(i,o){n.execute("updateContext",{windowId:t.id,context:e,replace:!(Object.keys(t.context).length>0)}).then((function(){i(t)})).catch((function(t){o(t)}))}))},t.prototype.lock=function(t){var e=this;return new Promise((function(n,i){e.execute("lockUnlock",{windowId:t.id,options:{lock:!0}}).then((function(){n(t)})).catch((function(t){i(t)}))}))},t.prototype.unlock=function(t){var e=this;return new Promise((function(n,i){e.execute("lockUnlock",{windowId:t.id,options:{lock:!1}}).then((function(){n(t)})).catch((function(t){i(t)}))}))},t.prototype.getIcon=function(t){var e=this;return new Promise((function(n,i){e.execute("getIcon",{windowId:t.id,options:{}}).then((function(t){n(t.icon)})).catch((function(t){i(t)}))}))},t.prototype.setIcon=function(t,e){var n=this;return new Promise((function(i,o){n.execute("setIcon",{windowId:t.id,options:{dataURL:e}}).then((function(){i(t)})).catch((function(t){o(t)}))}))},t.prototype.setFrameColor=function(t,e){var n=this;return new Promise((function(i,o){n.execute("setFrameColor",{windowId:t.id,options:{frameColor:e}}).then((function(){i(t)})).catch((function(t){o(t)}))}))},t.prototype.setTabHeaderVisible=function(t,e){var n=this;return new Promise((function(i,o){n.execute("setTabHeaderVisible",{windowId:t.id,options:{toShow:e}}).then((function(){i(t)})).catch((function(t){o(t)}))}))},t.prototype.showPopup=function(t,e){return o(this,void 0,void 0,(function(){var n,o;return r(this,(function(r){switch(r.label){case 0:return e?((n=i({},e)).targetLocation||(n.targetLocation="bottom"),o=i(i({},n),{popupBounds:n.size,targetId:t.id,popupId:n.windowId}),[4,this.execute("showPopupWindow",{windowId:t.id,options:o})]):[2,Promise.reject("The options object is not valid!")];case 1:return r.sent(),[2,t]}}))}))},t.prototype.createFlydown=function(t,e){return o(this,void 0,void 0,(function(){var n,s,a=this;return r(this,(function(c){return e?((n=i({},e)).horizontalOffset||(n.horizontalOffset=0),n.verticalOffset||(n.verticalOffset=0),s=this.reformatFlydownOptions(t,n),[2,this.execute("setFlydownArea",{windowId:t,options:s}).then((function(){var t=s.zones.map((function(t){return t.id}));return s.zones.forEach((function(t){var n="function"==typeof t.flydownSize?t.flydownSize:function(){return t.flydownSize};e.size instanceof Function&&t.flydownSize&&(n=function(n,i){return o(a,void 0,void 0,(function(){var o;return r(this,(function(r){switch(r.label){case 0:return e.size instanceof Function?[4,e.size(n,i)]:[3,2];case 1:o=r.sent(),r.label=2;case 2:return t.flydownSize instanceof Function&&t.flydownSize!==e.size?[4,t.flydownSize(n,i)]:[3,4];case 3:return[2,r.sent()||o];case 4:return[2,o||t.flydownSize]}}))}))}),a._registry.clearKey(s.targetId+"_"+t.id),a._registry.add(s.targetId+"_"+t.id,n)})),{destroy:function(){return a.clearFlydownArea(s.targetId,t)},options:n}}))]):[2,Promise.reject("The options object is not valid!")]}))}))},t.prototype.handleFlydownBoundsRequested=function(t,e){return o(this,void 0,void 0,(function(){var n,o,s,a,c;return r(this,(function(r){switch(r.label){case 0:return n=function(){return e.cancel=!0},o={zoneId:e.flydownId,flydownWindowBounds:e.flydownWindowBounds,flydownWindowId:e.flydownWindowId},[4,Promise.all(this._registry.execute(t+"_"+e.flydownId,o,n))];case 1:return 1===(s=r.sent()).length?(a={height:0,width:0,top:0,left:0},c="object"!=typeof s[0]||Array.isArray(s[0])?a:s[0],[2,i(i({},e),{flydownWindowBounds:c})]):[2]}}))}))},t.prototype.zoomIn=function(t){return o(this,void 0,void 0,(function(){return r(this,(function(e){switch(e.label){case 0:return[4,this.execute("zoomIn",{windowId:t.id})];case 1:return e.sent(),[2,t]}}))}))},t.prototype.zoomOut=function(t){return o(this,void 0,void 0,(function(){return r(this,(function(e){switch(e.label){case 0:return[4,this.execute("zoomOut",{windowId:t.id})];case 1:return e.sent(),[2,t]}}))}))},t.prototype.setZoomFactor=function(t,e){return o(this,void 0,void 0,(function(){return r(this,(function(n){switch(n.label){case 0:return[4,this.execute("setZoomFactor",{windowId:t.id,options:{zoomFactor:e}})];case 1:return n.sent(),[2,t]}}))}))},t.prototype.showDevTools=function(t){return o(this,void 0,void 0,(function(){return r(this,(function(e){switch(e.label){case 0:return[4,this.execute("showDevTools",{windowId:t.id})];case 1:return e.sent(),[2,t]}}))}))},t.prototype.capture=function(t,e){return o(this,void 0,void 0,(function(){return r(this,(function(n){switch(n.label){case 0:return[4,this.execute("captureScreenshot",{windowId:t.id,options:i({},e)})];case 1:return[2,n.sent().data]}}))}))},t.prototype.captureGroup=function(t,e){return o(this,void 0,void 0,(function(){return r(this,(function(n){switch(n.label){case 0:return[4,this.execute("captureGroupScreenshot",{windowId:t[0],options:i({groupWindowIds:t},e)})];case 1:return[2,n.sent().data]}}))}))},t.prototype.execute=function(t,e){var n=this;return new Promise((function(o,r){var s=i(i({},e),{command:t});n.agm.invoke("T42.Wnd.Execute",s,n.agmTarget).then((function(t){t.returned&&t.returned.errorMsg?r(t):o(t.returned)})).catch((function(t){r(t)}))}))},t.prototype.setGroupHeaderVisible=function(t,e){return this.execute("setGroupHeaderVisibility",{windowId:t,options:{toShow:e}})},t.prototype.onClosing=function(t,e){var n="undefined"!=typeof window&&window.glue42gd;if(n)return n.addCloseHandler(t,e)},t.prototype.onRefreshing=function(t,e){var n="undefined"!=typeof window&&window.glue42gd;if(n)return n.addRefreshHandler(t,e)},t.prototype.reformatFlydownOptions=function(t,e){var n=function(t,n){if(e[n]&&(void 0===t[n]||null===t[n])){var i=e[n];t[n]=i}},o=e.zones.map((function(t){return n(t,"windowId"),n(t,"targetLocation"),!e.size||void 0!==t.flydownSize&&null!==t.flydownSize||(t.flydownSize=e.size),t.flydownBounds=t.flydownSize,t.flydownId=t.windowId,t.targetLocation||(t.targetLocation="bottom"),t}));return i(i({},e),{zones:o,targetId:t,flydownBounds:e.size,flydownActiveArea:e.activeArea})},t.prototype.clearFlydownArea=function(t,e){var n=this;return this.execute("clearFlydownWindowArea",{windowId:t,options:{}}).then((function(){e.forEach((function(e){n._registry.clearKey(t+"_"+e)}))}))},t}();e.GDExecutor=a,e.default=new a},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var i=n(0),o=n(3),r=n(20),s=n(61),a=n(22);e.default=function(t,e,n,c,u){return new Promise((function(d,p){var f,h,l=i(),y=e.subLogger("hc-env"),v=u;h=void 0!==c?{application:"HtmlContainer."+c}:"best";var g=new Promise((function(e,n){t.subscribe("T42.Wnd.WindowStateChanged",{waitTimeoutMs:1e4,target:h}).then((function(t){t.onData((function(t){h=t.server,function(t,e){if("Created"===t){var n=w(e.windowId,e);return l.execute("window-event",e),void(e.focus&&b(n.Events,n.API,!0))}var i=o.default.get(e.windowId);if(!i)return void y.error("received update for unknown window. Stream:', "+JSON.stringify(e,null,4));var r=i.API,s=i.Events,c=r.frameColor;"Ready"===t&&o.default.setReadyState(i.API.id);"TitleChanged"===t&&s.handleTitleChanged(e.windowTitle);"UrlChanged"===t&&(o.default.setUrlChangedState(i.API.id),s.handleUrlChanged(e.url));if("WindowStyleChanged"===t){var u=_(e.windowStyleAttributes);s.handleWindowSettingsChanged(u),s.handleVisibilityChanged(!u.hidden)}if("Normal"===t||"Maximized"===t||"Minimized"===t||"Collapsed"===t||"Expanded"===t){var d=t.toLowerCase();s.handleWindowChangeState(d)}"ContextUpdated"===t&&s.handleContextUpdated(e.context);"FrameButtonAdded"===t&&s.handleFrameButtonAdded(e);"FrameButtonRemoved"===t&&s.handleFrameButtonRemoved(e.buttonId);"FrameButtonClicked"===t&&s.handleFrameButtonClicked(e);"FrameSelectionChanged"===t&&s.handleFrameSelectionChanged(e.newWindow,e.prevWindow);"FrameIsLockedChanged"===t&&s.handleFrameIsLockedChanged(e.isLocked);"TabHeaderVisibilityChanged"===t&&s.handleTabHeaderVisibilityChanged(e.tabHeaderVisible);if("BoundsChanged"===t){var p={height:e.height,left:e.left,top:e.top,width:e.width};s.handleBoundsChanged(p)}"FocusChanged"===t&&b(s,r,e.focus);"FrameColorChanged"===t&&c!==e.frameColor&&(s.handleFrameColorChanged(e.frameColor),l.execute("frame-color-changed",r));"FrameAttached"===t&&s.handleFrameAttached(e.tabGroupId,e.tabHeaderVisible);if("TabAttached"===t){s.handleAttached(e.tabGroupId,e.tabHeaderVisible);var f=a.getWindowsByTabGroupId(r.id,e.tabGroupId);Object.keys(f).forEach((function(t){f[t].Events.handleWindowAttached(r)})),l.execute("tab-attached",r,e.tabGroupId,e.tabHeaderVisible)}if("TabDettached"===t){var h=r.tabGroupId;s.handleDetached(e.tabGroupId);var v=a.getWindowsByTabGroupId(r.id,h);Object.keys(v).forEach((function(t){v[t].Events.handleWindowDetached(r)})),l.execute("tab-detached",r,e.tabGroupId,r.tabGroupId)}"CompositionChanged"===t&&(s.handleCompositionChanged(e.neighbours,e.groupId),l.execute("composition-changed",e));"GroupHeaderVisibilityChanged"===t&&(s.handleGroupHeaderVisibilityChanged(e.groupHeaderVisible),l.execute("group-header-changed",e));"Closed"===t&&(e.focus&&b(s,r,!1),o.default.remove(i),s.handleWindowClose());l.execute("window-event",e)}(t.data.state,t.data)})),t.onFailed((function(t){n(t)})),e()})).catch((function(t){n("Can not subscribe for stream T42.Wnd.WindowStateChanged. Err: "+t)}))})),m=new Promise((function(e,n){t.invoke("T42.Wnd.ListWindows",{},h,{waitTimeoutMs:1e4}).then((function(t){h=t.executed_by,Object.keys(t.returned).forEach((function(e){var n=t.returned[e],i=w(n.windowId,n);o.default.markReadyToShow(i.API.id)})),e()})).catch((function(t){n("Can not invoke T42.Wnd.ListWindows method. Err: "+t)}))}));function b(t,e,n){t.handleFocusChanged(n),n?l.execute("got-focus",e):l.execute("lost-focus",e)}function w(e,i){var a=r.default(e,function(t){var e=void 0!==t.WindowState?t.WindowState.toLowerCase():"normal",n=_(t.windowStyleAttributes);return{name:t.windowName,url:t.url,title:t.windowTitle,context:t.context,bounds:{height:t.height,left:t.left,top:t.top,width:t.width},focus:t.focus,frameColor:t.frameColor,groupId:t.groupId,isCollapsed:t.isCollapsed,isGroupHeaderVisible:t.isGroupHeaderVisible,isLocked:t.isLocked,isTabHeaderVisible:t.isTabHeaderVisible,isTabSelected:t.isTabSelected,isVisible:!n.hidden,isFocused:n.focus,mode:n.mode,settings:n,state:e,tabGroupId:t.tabGroupId,neighbours:t.neighbours}}(i),s.default,y,n,t);return o.default.add(a),a}function _(t){return void 0===t?{}:"object"!=typeof t?JSON.parse(t):t}Promise.all([g,m]).then((function(){s.default.init(t,h),d(f)})).catch((function(t){p("can not subscribe for stream T42.Wnd.WindowStateChanged or can not invoke T42.Wnd.ListWindows ")})),f={my:function(){return v},onEvent:function(t){return l.add("window-event",t)},open:function(e,n,i,o,r){void 0!==(i=i||{}).relativeTo&&"string"!=typeof i.relativeTo&&(i.relativeTo=i.relativeTo.id||""),i.windowName=e,i.url=n,t.invoke("T42.Html.CreateWindow",i).then((function(t){if(void 0!==t.returned){var e=t.returned.id;o(e)}else r("failed to execute T42.Html.CreateWindow - unknown reason")})).catch((function(t){"function"==typeof r&&r(t)}))},tabAttached:function(t){return l.add("tab-attached",t)},tabDetached:function(t){return l.add("tab-detached",t)},onWindowFrameColorChanged:function(t){return l.add("frame-color-changed",t)},executor:s.default,onCompositionChanged:function(t){return l.add("composition-changed",t)},onGroupHeaderVisibilityChanged:function(t){return l.add("group-header-changed",t)},onWindowGotFocus:function(t){return l.add("got-focus",t)},onWindowLostFocus:function(t){return l.add("lost-focus",t)},createFlydown:function(t,e){throw new Error("Not implemented")},showPopup:function(t,e){throw new Error("Not implemented")}}}))}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var i=function(){function t(){}return Object.defineProperty(t.prototype,"hostInstance",{get:function(){return this.agmTarget},enumerable:!0,configurable:!0}),t.prototype.init=function(t,e){this.agm=t,this.agmTarget=e},t.prototype.close=function(t){var e=this;return new Promise((function(n,i){return e.agmAction(t,"T42.Wnd.Close",(function(t){n(t)}),(function(t){i(t)}),{},(function(){return void 0===t.url}),t.onClose)}))},t.prototype.navigate=function(t,e){var n=this;return new Promise((function(i,o){return n.agmAction(t,"T42.Html.OpenUrl",(function(t){i(t)}),(function(t){o(t)}),{url:e},(function(){return t.url===e}),t.onUrlChanged,!0)}))},t.prototype.setStyle=function(t,e){var n=this;return new Promise((function(i,o){return n.agmAction(t,"T42.Wnd.SetWindowStyle",(function(t){i(t)}),(function(t){o(t)}),{windowStyleAttributes:JSON.stringify(e)})}))},t.prototype.setTitle=function(t,e){var n=this;return new Promise((function(i,o){return n.agmAction(t,"T42.Wnd.SetWindowTitle",(function(t){i(t)}),(function(t){o(t)}),{title:e},(function(){return t.title===e}),t.onTitleChanged)}))},t.prototype.moveResize=function(t,e){var n=this;return new Promise((function(i,o){return n.agmAction(t,"T42.Wnd.ResizeAndMove",(function(t){i(t)}),(function(t){o(t)}),e)}))},t.prototype.addFrameButton=function(t,e){var n=this;return new Promise((function(i,o){return n.agmAction(t,"T42.Wnd.AddFrameButton",(function(t){i(t)}),(function(t){o(t)}),{buttonInfo:e},(function(){return!1}),t.onFrameButtonAdded)}))},t.prototype.removeFrameButton=function(t,e){var n=this;return new Promise((function(i,o){return n.agmAction(t,"T42.Wnd.RemoveFrameButton",(function(t){i(t)}),(function(t){o(t)}),{buttonId:e},(function(){return!1}),t.onFrameButtonRemoved)}))},t.prototype.activate=function(t){var e=this;return new Promise((function(n,i){return e.agmAction(t,"T42.Wnd.Activate",(function(t){n(t)}),(function(t){i(t)}),{},(function(){return t.isFocused}),t.onFocusChanged)}))},t.prototype.focus=function(t){var e=this;return new Promise((function(n,i){return e.agmAction(t,"T42.Wnd.Activate",(function(t){n(t)}),(function(t){i(t)}),{focus:!0},(function(){return t.isFocused}),t.onFocusChanged)}))},t.prototype.maximizeRestore=function(t){var e=this;return new Promise((function(n,i){var o="maximized"!==t.state?t.onNormal:t.onMaximized;return e.agmAction(t,"T42.Wnd.MaximizeOrRestoreDown",(function(t){n(t)}),(function(t){i(t)}),{},(function(){return!1}),o)}))},t.prototype.maximize=function(t){var e=this;return new Promise((function(n,i){return e.agmAction(t,"T42.Wnd.Maximize",(function(t){n(t)}),(function(t){i(t)}),{},(function(){return"maximized"===t.state}),t.onMaximized)}))},t.prototype.restore=function(t){var e=this;return new Promise((function(n,i){return e.agmAction(t,"T42.Wnd.Restore",(function(t){n(t)}),(function(t){i(t)}),{},(function(){return"normal"===t.state}),t.onNormal)}))},t.prototype.minimize=function(t){var e=this;return new Promise((function(n,i){return e.agmAction(t,"T42.Wnd.Minimize",(function(t){n(t)}),(function(t){i(t)}),{},(function(){return"minimized"===t.state}),t.onMinimized)}))},t.prototype.collapse=function(t){var e=this;return new Promise((function(n,i){return e.agmAction(t,"T42.Wnd.SetCollapsed",(function(t){n(t)}),(function(t){i(t)}),{collapsed:!0},(function(){return t.isCollapsed}),t.onCollapsed)}))},t.prototype.expand=function(t){var e=this;return new Promise((function(n,i){return e.agmAction(t,"T42.Wnd.SetCollapsed",(function(t){n(t)}),(function(t){i(t)}),{collapsed:!1},(function(){return!t.isCollapsed}),t.onExpanded)}))},t.prototype.toggleCollapse=function(t){var e=this;return new Promise((function(n,i){var o=t.isCollapsed?t.onExpanded:t.onCollapsed;return e.agmAction(t,"T42.Wnd.SetCollapsed",(function(t){n(t)}),(function(t){i(t)}),{title:""},(function(){return!1}),o)}))},t.prototype.snap=function(t,e,n){var i=this;return new Promise((function(o,r){var s,a=t.id,c="Invalid target parameter - should be an object with property id or a string. Invoked for source window id:"+t.id;if(e){if("string"==typeof e)s=e;else{if(void 0===e.id)return void r(c);s=e.id}var u={sourceWindowId:a,targetWindowId:s};return n&&(u.snappingEdge=n),i.agmAction(t,"T42.Wnd.Snap",(function(t){o(t)}),(function(t){r(t)}),u)}r(c)}))},t.prototype.attachTab=function(t,e){var n=this;return new Promise((function(i,o){return n.agmAction(t,"T42.Wnd.AttachTab",(function(t){i(t)}),(function(t){o(t)}),e)}))},t.prototype.detachTab=function(t,e){var n=this;return new Promise((function(i,o){return n.agmAction(t,"T42.Wnd.DettachTab",(function(t){i(t)}),(function(t){o(t)}),e)}))},t.prototype.setVisible=function(t,e){var n=this;return new Promise((function(i,o){void 0===e&&(e=!0);var r={Hidden:!e};return n.agmAction(t,"T42.Wnd.SetWindowStyle",(function(t){i(t)}),(function(t){o(t)}),{windowStyleAttributes:JSON.stringify(r)},(function(){return t.isVisible===e}),t.onVisibilityChanged)}))},t.prototype.showLoader=function(t,e){var n=this;return new Promise((function(i,o){var r=e||{};r.enabled=!0,r.timeout=r.timeout||-1;var s={loader:r};return n.agmAction(t,"T42.Wnd.UpdateLoader",(function(t){i(t)}),(function(t){o(t)}),s)}))},t.prototype.hideLoader=function(t){var e=this;return new Promise((function(n,i){return e.agmAction(t,"T42.Wnd.UpdateLoader",(function(t){n(t)}),(function(t){i(t)}),{loader:{enabled:!1}})}))},t.prototype.updateContext=function(t,e){var n=this;return new Promise((function(i,o){if(e){return n.agmAction(t,"T42.Wnd.UpdateContext",(function(t){i(t)}),(function(t){o(t)}),{context:e},(function(){return!1}),t.onContextUpdated)}o("Invalid context parameter - should be an object. Invoked for source window id:"+t.id)}))},t.prototype.lock=function(t){var e=this;return new Promise((function(n,i){return e.agmAction(t,"T42.Wnd.Lock",(function(t){n(t)}),(function(t){i(t)}),{},(function(){return!1}),t.onLockingChanged)}))},t.prototype.unlock=function(t){var e=this;return new Promise((function(n,i){return e.agmAction(t,"T42.Wnd.Unlock",(function(t){n(t)}),(function(t){i(t)}),{},(function(){return!1}),t.onLockingChanged)}))},t.prototype.getIcon=function(t){var e=this;return new Promise((function(n,i){return e.agmAction(t,"T42.Wnd.GetIcon",(function(t){n(t)}),(function(t){i(t)}))}))},t.prototype.setIcon=function(t,e){var n=this;return new Promise((function(i,o){if(e)return n.agmAction(t,"T42.Wnd.SetIcon",(function(t){i(t)}),(function(t){o(t)}),{base64ImageSource:e});o("Invalid base64Image parameter. Invoked for source window id:"+t.id)}))},t.prototype.setFrameColor=function(t,e){var n=this;return new Promise((function(i,o){if(e){return n.agmAction(t,"T42.Wnd.SetWindowStyle",(function(t){i(t)}),(function(t){o(t)}),{windowStyleAttributes:JSON.stringify({stickyFrameColor:e})},(function(){return!1}),t.onFrameColorChanged)}o("Invalid frameColor parameter. Invoked for source window id:"+t.id)}))},t.prototype.setTabHeaderVisible=function(t,e){var n=this;return new Promise((function(i,o){void 0===e&&(e=!0);return n.agmAction(t,"T42.Wnd.SetTabHeaderVisible",(function(t){i(t)}),(function(t){o(t)}),{toShow:e},(function(){return t.isTabHeaderVisible===e}),t.onTabHeaderVisibilityChanged)}))},t.prototype.showPopup=function(t,e){throw new Error("Not implemented")},t.prototype.createFlydown=function(t,e){throw new Error("Method not implemented.")},t.prototype.handleFlydownBoundsRequested=function(t,e){throw new Error("Method not implemented.")},t.prototype.execute=function(t,e){return this.agm.invoke("T42.Wnd.Execute",{command:t,options:e})},t.prototype.setGroupHeaderVisible=function(t,e){return this.agm.invoke("T42.Wnd.SetGroupHeaderVisible",{windowId:t,toShow:e},this.agmTarget)},t.prototype.onClosing=function(t,e){return function(){}},t.prototype.onRefreshing=function(t,e){return function(){}},t.prototype.zoomIn=function(t){return console.warn("zoomIn method is not supported"),Promise.resolve(t)},t.prototype.zoomOut=function(t){return console.warn("zoomIn method is not supported"),Promise.resolve(t)},t.prototype.setZoomFactor=function(t,e){return console.warn("zoomIn method is not supported"),Promise.resolve(t)},t.prototype.showDevTools=function(t){return Promise.resolve(t)},t.prototype.setSizeConstraints=function(t,e){return console.warn("setSizeConstraints method is not supported"),Promise.resolve(t)},t.prototype.resetButtons=function(t,e){return console.warn("setButtons method is not supported"),Promise.resolve(t)},t.prototype.capture=function(t,e){return console.warn("setButtons method is not supported"),Promise.resolve(void 0)},t.prototype.captureGroup=function(t,e){return console.warn("setButtons method is not supported"),Promise.resolve(void 0)},t.prototype.agmAction=function(t,e,n,i,o,r,s,a){if(a=a||!1,void 0!==t.url)if(void 0===r||r())this.agmInvoke(t,e,o,n,i);else{var c=function(){},u=!1;c=s((function(){u=!0,c(),"function"==typeof n&&n(t)})),a||setTimeout((function(){u||"function"==typeof i&&i("Agm invoke timeout! action: "+e)}),2e3),this.agmInvoke(t,e,o,(function(){}),i)}else"function"==typeof i&&i("Cannot execute a command on a closed window.")},t.prototype.agmInvoke=function(t,e,n,i,o){(n=n||{}).windowId=t.id,this.agm.invoke(e,n,this.agmTarget,{},(function(){"function"==typeof i&&i(t)}),(function(t){"function"==typeof o&&(t.all_return_values&&t.all_return_values.length>0?o(t.all_return_values[0].message):o(t))}))},t}();e.HcExecutor=i,e.default=new i},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var i=n(0),o=n(63),r=n(3);e.default=function(t,e){var n=e.subLogger("groups"),s=i.default(),a={},c=-1,u=r.default.list;function d(t,n){var i,o;if(void 0!==t)return i="string"==typeof t?t:t.id,Object.keys(a).forEach((function(t){var e=a[t].groupAPI;void 0===e.find(i)||(o=e)})),"function"==typeof n&&n(o),o;e.debug("trying to find a group by a window, but winId is undefined")}function p(t){n.trace("Adding new window "+t.API.id+" to win.API.groupId "+t.API.groupId);var e=f(t);e&&(n.trace("handleGroupAssociation "+t.API.id+" to group.groupAPI.id "+e.groupAPI.id),t.Events.handleGroupAssociation(e.groupAPI))}function f(e,i){var r=i||e.API.groupId,s=e.API.id;if(void 0!==r&&void 0!==s){var c=function(e){if(a.hasOwnProperty(e))return a[e];var n=o.default(e,t.executor);return a[e]=n,n}(r);return c.groupInternal.addWindow(s),c}n.debug("trying to add a window without group - winId: "+s)}function h(t,e){var n=t.API.id,i=e||t.API.groupId;void 0!==i&&(a[i].groupInternal.removeWindow(n),t.Events.handleGroupAssociation(void 0),function(t){a.hasOwnProperty(t)&&void 0!==a[t]&&0===a[t].groupAPI.windows.length&&delete a[t]}(i))}return Object.keys(u).forEach((function(t){p(u[t])})),t.onCompositionChanged((function(t){!function(t){var e=t.groupId,i=t.windowId,o=d(i),a=o?o.id:void 0;if(n.trace("handleCompositionChanged newGroupId: "+e+" windowId: "+i+" oldGroup: "+a),a===e)return void n.trace("handleCompositionChanged newGroupId: "+e+" windowId: "+i+" oldGroup: "+a+" are the same - returning...");var c=r.default.get(i)||r.default.get(i),u=f(c,e);o&&(h(c,a),s.execute("window-moved",i,o,e));c.Events.handleGroupChanged(u.groupAPI,o)}(t)})),t.onGroupHeaderVisibilityChanged((function(t){var e=d(t.windowId);if(void 0!==e){var n=a[e.id];-1===c&&(c=e.windows.length),0===--c&&(c=-1,n.groupInternal.handleGroupHeaderVisibilityChanged(t))}})),r.default.onAdded((function(t){p(t)})),r.default.onRemoved((function(t){h(t)})),{groupsAPI:{get my(){return d(t.my())},list:function(t){var e=Object.keys(a).map((function(t){if(a[t])return a[t].groupAPI}));return"function"==typeof t&&t(e),e},findGroupByWindow:d},groupsEvents:{onWindowMoved:function(t){return s.add("window-moved",t)}}}}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var i=n(0),o=n(3);e.default=function(t,e){var n=i.default(),r=[];function s(){return new Promise((function(t,e){var n=d((function(e){n(),t()}))}))}function a(t,n,i,o){return new Promise((function(o,r){e.execute(t,n).then((function(t){"function"==typeof i&&i(p),o(p)})).catch((function(t){r(t)}))}))}function c(){var t=[];return r.forEach((function(e){var n=u(e);void 0!==n&&t.push(n)})),t}function u(t){return o.default.get(t)?o.default.get(t).API:void 0}function d(t){return n.add("header-visibility-changed",t)}var p={id:t,get windows(){return e=c(),"function"==typeof t&&t(e),e;var t,e},find:function(t,e){var n;n="string"==typeof t?t:t.id;var i=r.indexOf(n);if(-1!==i){var o=u(r[i]);return"function"==typeof e&&e(o),o}},get isHeaderVisible(){return void 0===c().find((function(t){return!t.isGroupHeaderVisible}))},showHeader:function(t,n){return new Promise((function(n,i){Promise.all([e.setGroupHeaderVisible(r[0],!0),s()]).then((function(){"function"==typeof t&&t(p),n(p)})).catch((function(t){i(t)}))}))},hideHeader:function(t,n){return new Promise((function(n,i){Promise.all([e.setGroupHeaderVisible(r[0],!1),s()]).then((function(){"function"==typeof t&&t(p),n(p)})).catch((function(t){}))}))},capture:function(t){return e.captureGroup(r,t)},maximize:function(e,n){return a("maximize",{groupId:t},e)},restore:function(e,n){return a("restore",{groupId:t},e)},onHeaderVisibilityChanged:d,onWindowAdded:function(t){return n.add("window-added",t)},onWindowRemoved:function(t){return n.add("window-removed",t)}};return{groupAPI:p,groupInternal:{addWindow:function(t){if(-1===r.indexOf(t)){r.push(t);var e=o.default.get(t);e.Events.handleGroupAssociation(p),n.execute("window-added",p,e.API)}},removeWindow:function(t){var e=r.indexOf(t);if(-1!==e){r.splice(e,1);var i=u(t);n.execute("window-removed",p,i)}},handleGroupHeaderVisibilityChanged:function(t){n.execute("header-visibility-changed",p)}}}}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var i=n(65),o=n(75),r=(n(76),n(0));e.default=function(t){if(!t.agm)throw Error("config.agm is required");if(!t.logger)throw Error("config.logger is required");t.mode=t.mode||"slim",t.logger;var e,n=r.default();return t.mode,e=new o.default(t.agm,n),new i.default(t,e,n)}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var i=n(23),o=n(66),r=n(74),s=n(25),a=n(26),c=function(){function t(t,e,n){this.config=t,this.stream=e,this.callbacks=n,this.appManager=t.appManager,this.onEvent=e.onEvent,this.provider=new r.default(t.agm,t.activityGetter,n),e.subscribe()}return t.prototype.ready=function(){return"fullWaitSnapshot"===this.config.mode?this.stream.gotSnapshot:this.stream.ready},t.prototype.save=function(t){var e=this;return new Promise((function(n,i){if(e.verifyNotSlimMode(),!t.name)throw Error("layout.name argument is required");t.type||(t.type="Global"),t.activityId&&(t.type="Activity"),void 0===t.ignoreHidden&&(t.ignoreHidden=!0);var o={name:t.name,actIds:[],appIds:[],type:t.type,context:t.context,metadata:t.metadata||{},options:{ignoreLayoutRestrictions:!1}};if("Activity"===t.type){var r=t.activityId;if(!r){if(!e.appManager.myInstance.inActivity)throw new Error("Current application is not in activity. Can not save activity layout for it");r=e.appManager.myInstance.activityId}o.actIds.push(r),o.options={ignoreLayoutRestrictions:!0}}else{if("Global"!==t.type)throw new Error("layout type "+t.type+" not supported");var s=e.appManager.instances();t.ignoreHidden&&(s=s.filter((function(t){return e.isVisibleWindow(t)}))),t.ignoreMyInstance&&e.appManager.myInstance&&(s=s.filter((function(t){return t.id!==e.appManager.myInstance.id}))),s.reduce((function(t,e){if(!e.id)return t;if(e.inActivity){var n=e.activityId;-1===t.actIds.indexOf(n)&&t.actIds.push(n)}else t.appIds.push(e.id);return t}),o)}e.invokeMethodAndTrack("T42.ACS.SaveLayout",o,n,i)}))},t.prototype.restore=function(t){var e=this;return new Promise((function(n,i){if(e.verifyNotSlimMode(),void 0===t)throw Error("options argument is required");if(!t.name)throw Error("options.name argument is required");t.type||(t.type="Global"),t.activityIdToJoin&&(t.type="Activity"),void 0===t.restoreActivityOwner&&(t.restoreActivityOwner=!1),void 0===t.ignoreActivityWindowTypes&&(t.ignoreActivityWindowTypes=[]),void 0===t.setActivityContext&&(t.setActivityContext=!0),void 0===t.closeRunningInstance&&("Global"===t.type?t.closeRunningInstance=!0:"Activity"===t.type&&(t.closeRunningInstance=!1)),void 0===t.reuseWindows&&(t.reuseWindows=!0),t.context=t.context||{};var o={restoreOptions:{activityToJoin:t.activityIdToJoin,setActivityContext:t.setActivityContext,ignoreActivityWindowTypes:t.ignoreActivityWindowTypes,restoreActivityOwner:t.restoreActivityOwner,closeOldWindows:!0,reuseExistingWindows:t.reuseWindows}},r={type:t.type,name:t.name,context:t.context,toClose:[],splash:t.splash};t.closeRunningInstance&&(r.toClose=e.getInstancesToClose(t)),t.timeout&&(r.timeout=t.timeout),r.context._t42=o,e.invokeMethodAndTrack("T42.ACS.RestoreLayout",r,n,i,!0)}))},t.prototype.remove=function(t,e){var n=this;return new Promise((function(i,o){if(n.verifyNotSlimMode(),!e)throw Error("name argument is required");if(!t)throw Error("type argument is required");var r={type:t,name:e};n.invokeMethodAndTrack("T42.ACS.RemoveLayout",r,i,o)}))},t.prototype.list=function(){return this.verifyNotSlimMode(),i.default.all},t.prototype.import=function(t,e){var n=this;return new Promise((function(i,o){n.verifyNotSlimMode();var r={mode:e||"replace",layouts:t};n.invokeMethodAndTrack("T42.ACS.ImportLayouts",r,i,o)}))},t.prototype.export=function(){var t=this;return new Promise((function(e,n){t.invokeMethodAndTrack("T42.ACS.ExportLayouts",{},(function(n){var i=t.getObjectValues(n.Layouts).map((function(t){return new a.default(s.default(t))}));e(i)}),n,!0)}))},t.prototype.rename=function(t,e){var n=this;return new Promise((function(i,o){if(n.verifyNotSlimMode(),!t)throw Error("layout argument is required");if(!t.name)throw Error("name argument is required");if(!t.type)throw Error("type argument is required");var r={type:t.type,oldName:t.name,newName:e};n.invokeMethodAndTrack("T42.ACS.RenameLayout",r,i,o)}))},t.prototype.updateMetadata=function(t){var e=this;return new Promise((function(n,i){if(!t)throw Error("layout argument is required");if(!t.name)throw Error("name argument is required");if(!t.type)throw Error("type argument is required");if(!t.metadata)throw Error("metadata argument is required");var o={name:t.name,type:t.type,metadata:t.metadata};e.invokeMethodAndTrack("T42.ACS.UpdateMetadata",o,n,i,!0)}))},t.prototype.onAdded=function(t){var e=this.callbacks.add("added",t);return i.default.all.length>0&&i.default.all.forEach((function(e){try{t(e)}catch(t){}})),e},t.prototype.onRemoved=function(t){return this.callbacks.add("removed",t)},t.prototype.onChanged=function(t){return this.callbacks.add("changed",t)},t.prototype.onRenamed=function(t){return this.callbacks.add("renamed",t)},t.prototype.onEvent=function(t){return this.stream.onEvent(t)},t.prototype.onSaveRequested=function(t){return this.provider.onSaveRequested(t)},t.prototype.filterInstance=function(t,e){var n=this,i=this.appManager.instances();return t&&(i=i.filter((function(t){return n.isVisibleWindow(t)}))),e&&this.appManager.myInstance&&(i=i.filter((function(t){return t.id!==n.appManager.myInstance.id}))),i.reduce((function(t,e){if(!e.id)return t;if(e.inActivity){var n=e.activityId;-1===t.actIds.indexOf(n)&&t.actIds.push(n)}else t.appIds.push(e.id);return t}),{actIds:[],appIds:[]})},t.prototype.verifyNotSlimMode=function(){if("slim"===this.config.mode)throw Error("Operation not allowed in slim mode. Run in full mode.")},t.prototype.isVisibleWindow=function(t){return"exe"===t.application.type||"node"===t.application.type||("activity"===t.application.type||!(!t||!t.window)&&t.window.isVisible)},t.prototype.invokeMethodAndTrack=function(t,e,n,i,r){var s,a=r,c=o.generate();e.token=c;var u=function(){a&&s&&n(s)};r||this.stream.waitFor(c).then((function(){a=!0,u()})).catch((function(t){i(t)}));this.config.agm.invoke(t,e,"best",{methodResponseTimeoutMs:12e4}).then((function(e){e.returned||i("No result from method "+t),e.returned.status&&"Success"!==e.returned.status&&"PartialSuccess"!==e.returned.status&&i(e.returned),s=e.returned,u()})).catch((function(t){return i(t)}))},t.prototype.getInstancesToClose=function(t){var e=this,n=[],i=this.appManager.applications().filter((function(t){return t.isShell}))[0],o=i?i.name:"AppManager";return this.appManager.instances().forEach((function(i){e.appManager.myInstance&&i.id===e.appManager.myInstance.id||i.application.name!==o&&e.isVisibleWindow(i)&&("Activity"===t.type&&i.activityId!==t.activityIdToJoin||n.push({application:i.application.name,instance:i.id}))})),n},t.prototype.getObjectValues=function(t){return t?Object.keys(t).map((function(e){return t[e]})):[]},t}();e.default=c},function(t,e,n){"use strict";t.exports=n(67)},function(t,e,n){"use strict";var i=n(9),o=(n(24),n(70)),r=n(71),s=n(72),a=n(73)||0;function c(){return r(a)}t.exports=c,t.exports.generate=c,t.exports.seed=function(e){return i.seed(e),t.exports},t.exports.worker=function(e){return a=e,t.exports},t.exports.characters=function(t){return void 0!==t&&i.characters(t),i.shuffled()},t.exports.decode=o,t.exports.isValid=s},function(t,e,n){"use strict";var i=1;t.exports={nextValue:function(){return(i=(9301*i+49297)%233280)/233280},seed:function(t){i=t}}},function(t,e,n){"use strict";var i="object"==typeof window&&(window.crypto||window.msCrypto);t.exports=function(){if(!i||!i.getRandomValues)return 48&Math.floor(256*Math.random());var t=new Uint8Array(1);return i.getRandomValues(t),48&t[0]}},function(t,e,n){"use strict";var i=n(9);t.exports=function(t){var e=i.shuffled();return{version:15&e.indexOf(t.substr(0,1)),worker:15&e.indexOf(t.substr(1,1))}}},function(t,e,n){"use strict";var i,o,r=n(24),s=n(9),a=1459707606518,c=6;t.exports=function(t){var e="",n=Math.floor(.001*(Date.now()-a));return n===o?i++:(i=0,o=n),e+=r(s.lookup,c),e+=r(s.lookup,t),i>0&&(e+=r(s.lookup,i)),e+=r(s.lookup,n)}},function(t,e,n){"use strict";var i=n(9);t.exports=function(t){if(!t||"string"!=typeof t||t.length<6)return!1;for(var e=i.characters(),n=t.length,o=0;o<n;o++)if(-1===e.indexOf(t[o]))return!1;return!0}},function(t,e,n){"use strict";t.exports=0},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var i=function(){function t(t,e,n){this.agm=t,this.activitiesGetter=e,this.callbacks=n,this.registeredRequestsMethods=!1}return t.prototype.onSaveRequested=function(t){return this.registeredRequestsMethods||(this.registerRequestMethods(),this.registeredRequestsMethods=!0),this.callbacks.add("saveRequested",t)},t.prototype.isActivityOwner=function(){if("undefined"!=typeof htmlContainer){var t=htmlContainer.getContext();return t&&t._t42&&t._t42.activityIsOwner}var e=this.activitiesGetter();if(!e)return!1;if(!e.inActivity)return!1;var n=e.my.window,i=e.my.activity;return!(!i&&!n)&&i.owner.id===n.id},t.prototype.registerRequestMethods=function(){var t=this;this.agm.register("T42.HC.GetSaveContext",(function(e){var n=t.callbacks.execute("saveRequested",e)[0];if(!n)return{};n.activityContext=n.activityContext||{},n.windowContext=n.windowContext||{};var i={windowContext:n.windowContext,activityContext:void 0};return t.isActivityOwner()&&(i.activityContext=n.activityContext),i}))},t}();e.default=i},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var i=n(23),o=n(26),r=n(25),s=function(){function t(t,e){var n=this;this.agm=t,this.callbacks=e,this.ready=new Promise((function(t,e){n.resolveReady=t,n.rejectReady=e})),this.gotSnapshot=new Promise((function(t,e){n.resolveGotSnapshot=t,n.rejectGotSnapshot=e}))}return t.prototype.subscribe=function(t){var e=this,n=function(t){return e.getObjectValues(t).map((function(t){return r.default(t)}))};this.checkForLayoutEventMethod()?this.agm.subscribe("T42.ACS.OnLayoutEvent",{waitTimeoutMs:1e4}).then((function(t){t.onData((function(t){var i=t.data;i.IsSnapshot&&e.resolveGotSnapshot(),e.addLayouts(n(i.OnLayoutAdded)),e.removeLayouts(n(i.OnLayoutRemoved)),e.changeLayouts(n(i.OnLayoutChanged)),e.renameLayouts(n(i.OnLayoutRenamed)),e.callbacks.execute("streamEvent",i)})),t.onFailed((function(t){var n="can not subscribe to T42.ACS.OnLayoutEvent "+t;e.rejectReady(n),e.rejectGotSnapshot(n)})),e.resolveReady()})).catch((function(t){var n="Error subscribing for T42.ACS.OnLayoutEvent stream. Err: "+t;e.rejectReady(n),e.rejectGotSnapshot(n)})):(t&&this.resolveReady(),setTimeout((function(){e.subscribe(!0)}),500))},t.prototype.onEvent=function(t){return this.callbacks.add("streamEvent",t)},t.prototype.waitFor=function(t,e){var n=this;return e||(e=1e4),new Promise((function(i,o){var r=!1,s=n.onEvent((function(e){e.Token===t&&(r=!0,s(),i())}));setTimeout((function(){r||o("timed out")}),e)}))},t.prototype.checkForLayoutEventMethod=function(){try{return-1!==this.agm.methods().map((function(t){return t.name})).indexOf("T42.ACS.OnLayoutEvent")}catch(t){return!1}},t.prototype.addLayouts=function(t){var e=this;t&&t.forEach((function(t){var n=new o.default(t);i.default.add(n),e.callbacks.execute("added",n)}))},t.prototype.removeLayouts=function(t){var e=this;t&&t.forEach((function(t){i.default.removeWhere((function(n){return!e.compareLayouts(n,t)})),e.callbacks.execute("removed",t)}))},t.prototype.changeLayouts=function(t){var e=this;t&&t.forEach((function(t){i.default.removeWhere((function(n){return!e.compareLayouts(n,t)})),i.default.add(new o.default(t)),e.callbacks.execute("changed",t)}))},t.prototype.renameLayouts=function(t){var e=this;t&&t.forEach((function(t){var n=i.default.first((function(n){return e.compareLayouts(n,{type:t.type,name:t.oldName})}));if(!n)throw Error("received rename event for unknown layout with type "+t.type+" and name "+t.oldName);n.name=t.newName,e.callbacks.execute("renamed",n)}))},t.prototype.compareLayouts=function(t,e){return t.name===e.name&&t.type===e.type},t.prototype.getObjectValues=function(t){return t?Object.keys(t).map((function(e){return t[e]})):[]},t}();e.default=s},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.default=function(){return{ready:Promise.resolve(void 0),subscribe:function(){},onEvent:function(t){return function(){}},waitFor:function(t,e){return Promise.resolve(void 0)},gotSnapshot:Promise.resolve(void 0)}}},function(t,e,n){"use strict";var i=this&&this.__assign||function(){return(i=Object.assign||function(t){for(var e,n=1,i=arguments.length;n<i;n++)for(var o in e=arguments[n])Object.prototype.hasOwnProperty.call(e,o)&&(t[o]=e[o]);return t}).apply(this,arguments)},o=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(o,r){function s(t){try{c(i.next(t))}catch(t){r(t)}}function a(t){try{c(i.throw(t))}catch(t){r(t)}}function c(t){var e;t.done?o(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(s,a)}c((i=i.apply(t,e||[])).next())}))},r=this&&this.__generator||function(t,e){var n,i,o,r,s={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return r={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(r[Symbol.iterator]=function(){return this}),r;function a(r){return function(a){return function(r){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,i&&(o=2&r[0]?i.return:r[0]?i.throw||((o=i.return)&&o.call(i),0):i.next)&&!(o=o.call(i,r[1])).done)return o;switch(i=0,o&&(r=[2&r[0],o.value]),r[0]){case 0:case 1:o=r;break;case 4:return s.label++,{value:r[1],done:!1};case 5:s.label++,i=r[1],r=[0];continue;case 7:r=s.ops.pop(),s.trys.pop();continue;default:if(!(o=(o=s.trys).length>0&&o[o.length-1])&&(6===r[0]||2===r[0])){s=0;continue}if(3===r[0]&&(!o||r[1]>o[0]&&r[1]<o[3])){s.label=r[1];break}if(6===r[0]&&s.label<o[1]){s.label=o[1],o=r;break}if(o&&s.label<o[2]){s.label=o[2],s.ops.push(r);break}o[2]&&s.ops.pop(),s.trys.pop();continue}r=e.call(t,s)}catch(t){r=[6,t],i=0}finally{n=o=0}if(5&r[0])throw r[1];return{value:r[0]?r[1]:void 0,done:!0}}([r,a])}}};Object.defineProperty(e,"__esModule",{value:!0});var s,a="T42.Displays.Command",c=function(t,e){var n=this;this._agm=t,this._logger=e,this.all=function(){return o(n,void 0,void 0,(function(){return r(this,(function(t){switch(t.label){case 0:return[4,this.callGD(s.GetAll,{})];case 1:return[2,t.sent().map(this.decorateDisplay)]}}))}))},this.get=function(t){return o(n,void 0,void 0,(function(){var e;return r(this,(function(n){switch(n.label){case 0:return[4,this.callGD(s.Get,{id:t})];case 1:return e=n.sent(),[2,this.decorateDisplay(e)]}}))}))},this.capture=function(t){return o(n,void 0,void 0,(function(){return r(this,(function(e){switch(e.label){case 0:return[4,this.callGD(s.Capture,i({},t))];case 1:return[2,e.sent()]}}))}))},this.captureAll=function(t){return o(n,void 0,void 0,(function(){return r(this,(function(e){switch(e.label){case 0:return[4,this.callGD(s.CaptureAll,i({},t))];case 1:return[2,e.sent()]}}))}))},this.callGD=function(t,e){return o(n,void 0,void 0,(function(){return r(this,(function(n){switch(n.label){case 0:return[4,this._agm.invoke(a,i(i({},e),{command:t}))];case 1:return[2,n.sent().returned.data]}}))}))},this.decorateDisplay=function(t){return i(i({},t),{capture:function(e){return n.capture({id:t.id,size:e})}})}};e.default=c,function(t){t.Capture="capture",t.CaptureAll="captureAll",t.GetAll="getAll",t.Get="get"}(s||(s={}))},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var i=n(79),o=n(80),r=n(81);e.factory=function(t,e){var n=new o.SharedContextSubscriber(t),s=new r.ChannelsImpl(n);return i.setupAGM(e,s),{subscribe:s.subscribe.bind(s),publish:s.publish.bind(s),all:s.all.bind(s),current:s.current.bind(s),join:s.join.bind(s),leave:s.leave.bind(s),add:s.add.bind(s),changed:s.changed.bind(s),ready:function(){return t.ready()}}}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.setupAGM=function(t,e){var n;"undefined"!=typeof window&&(window.htmlContainer?n=window.htmlContainer.windowId:window.glue42gd&&(n=window.glue42gd.windowId)),n&&(t.invoke("T42.Channels.Announce",{swId:n,instance:t.instance.instance}),t.register("T42.Channels.Command",(function(t){var n=t.command;if(!n)throw new Error("missing command argument");if("join"!==n){if("leave"!==n){if("get"===n)return{id:i=e.current()};throw new Error("unknown command "+n)}e.leave()}else{var i;if(!(i=t.channel))throw new Error("missing argument id");e.join(i)}})))}},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(o,r){function s(t){try{c(i.next(t))}catch(t){r(t)}}function a(t){try{c(i.throw(t))}catch(t){r(t)}}function c(t){var e;t.done?o(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(s,a)}c((i=i.apply(t,e||[])).next())}))},o=this&&this.__generator||function(t,e){var n,i,o,r,s={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return r={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(r[Symbol.iterator]=function(){return this}),r;function a(r){return function(a){return function(r){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,i&&(o=2&r[0]?i.return:r[0]?i.throw||((o=i.return)&&o.call(i),0):i.next)&&!(o=o.call(i,r[1])).done)return o;switch(i=0,o&&(r=[2&r[0],o.value]),r[0]){case 0:case 1:o=r;break;case 4:return s.label++,{value:r[1],done:!1};case 5:s.label++,i=r[1],r=[0];continue;case 7:r=s.ops.pop(),s.trys.pop();continue;default:if(!(o=(o=s.trys).length>0&&o[o.length-1])&&(6===r[0]||2===r[0])){s=0;continue}if(3===r[0]&&(!o||r[1]>o[0]&&r[1]<o[3])){s.label=r[1];break}if(6===r[0]&&s.label<o[1]){s.label=o[1],o=r;break}if(o&&s.label<o[2]){s.label=o[2],s.ops.push(r);break}o[2]&&s.ops.pop(),s.trys.pop();continue}r=e.call(t,s)}catch(t){r=[6,t],i=0}finally{n=o=0}if(5&r[0])throw r[1];return{value:r[0]?r[1]:void 0,done:!0}}([r,a])}}};Object.defineProperty(e,"__esModule",{value:!0});var r=function(){function t(t){this.contexts=t,this.unsubscribeFunc=void 0,this.current=void 0}return t.prototype.subscribe=function(t){this.callback=t},t.prototype.switchChannel=function(t){return i(this,void 0,void 0,(function(){var e,n,i=this;return o(this,(function(o){switch(o.label){case 0:return this.unsubscribe(),this.current=t,e=this.createContextName(t),n=this,[4,this.contexts.subscribe(e,(function(t){i.callback&&i.callback(t)}))];case 1:return n.unsubscribeFunc=o.sent(),[2]}}))}))},t.prototype.unsubscribe=function(){return this.unsubscribeFunc&&this.unsubscribeFunc(),Promise.resolve()},t.prototype.add=function(t,e){return i(this,void 0,void 0,(function(){var n;return o(this,(function(i){return n=this.createContextName(t),[2,this.contexts.set(n,e)]}))}))},t.prototype.all=function(){var t=this.contexts.all().filter((function(t){return t.startsWith("___channel___")})).map((function(t){return t.substr("___channel___".length)}));return Promise.resolve(t)},t.prototype.update=function(t,e){var n=this.createContextName(t);return this.contexts.update(n,e)},t.prototype.createContextName=function(t){return"___channel___"+t},t}();e.SharedContextSubscriber=r},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(o,r){function s(t){try{c(i.next(t))}catch(t){r(t)}}function a(t){try{c(i.throw(t))}catch(t){r(t)}}function c(t){var e;t.done?o(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(s,a)}c((i=i.apply(t,e||[])).next())}))},o=this&&this.__generator||function(t,e){var n,i,o,r,s={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return r={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(r[Symbol.iterator]=function(){return this}),r;function a(r){return function(a){return function(r){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,i&&(o=2&r[0]?i.return:r[0]?i.throw||((o=i.return)&&o.call(i),0):i.next)&&!(o=o.call(i,r[1])).done)return o;switch(i=0,o&&(r=[2&r[0],o.value]),r[0]){case 0:case 1:o=r;break;case 4:return s.label++,{value:r[1],done:!1};case 5:s.label++,i=r[1],r=[0];continue;case 7:r=s.ops.pop(),s.trys.pop();continue;default:if(!(o=(o=s.trys).length>0&&o[o.length-1])&&(6===r[0]||2===r[0])){s=0;continue}if(3===r[0]&&(!o||r[1]>o[0]&&r[1]<o[3])){s.label=r[1];break}if(6===r[0]&&s.label<o[1]){s.label=o[1],o=r;break}if(o&&s.label<o[2]){s.label=o[2],s.ops.push(r);break}o[2]&&s.ops.pop(),s.trys.pop();continue}r=e.call(t,s)}catch(t){r=[6,t],i=0}finally{n=o=0}if(5&r[0])throw r[1];return{value:r[0]?r[1]:void 0,done:!0}}([r,a])}}};Object.defineProperty(e,"__esModule",{value:!0});var r=n(0),s=function(){function t(t){this.shared=t,this.subsKey="subs",this.changedKey="changed",this.registry=r.default(),this.shared.subscribe(this.handler.bind(this))}return t.prototype.current=function(){return this.currentContext},t.prototype.subscribe=function(t){return this.registry.add(this.subsKey,t)},t.prototype.publish=function(t){return i(this,void 0,void 0,(function(){return o(this,(function(e){if(!this.currentContext)throw new Error("not joined to any channel");return[2,this.shared.update(this.currentContext,{data:t})]}))}))},t.prototype.join=function(t){return this.currentContext=t,this.registry.execute(this.changedKey,t),this.shared.switchChannel(t)},t.prototype.leave=function(){return this.currentContext=void 0,this.registry.execute(this.changedKey,void 0),this.shared.unsubscribe()},t.prototype.all=function(){return this.shared.all()},t.prototype.changed=function(t){this.registry.add(this.changedKey,t)},t.prototype.meta=function(t,e){throw new Error("Method not implemented.")},t.prototype.add=function(t){return i(this,void 0,void 0,(function(){var e;return o(this,(function(n){switch(n.label){case 0:if(!t)throw new Error("info argument can not be undefined");if(!t.name)throw new Error("info.name is missing");return e={name:t.name,meta:t.meta||{},data:t.data||{}},[4,this.shared.add(t.name,e)];case 1:return n.sent(),[2,e]}}))}))},t.prototype.remove=function(t){throw new Error("Method not implemented.")},t.prototype.onChannelAdded=function(t){throw new Error("Method not implemented.")},t.prototype.onChannelRemoved=function(t){throw new Error("Method not implemented.")},t.prototype.apps=function(t){throw new Error("Method not implemented.")},t.prototype.handler=function(t){this.registry.execute(this.subsKey,t.data,t)},t}();e.ChannelsImpl=s},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var i=n(83);e.factory=function(t){var e=new i.HotkeysImpl(t);return{register:e.register.bind(e),unregister:e.unregister.bind(e),unregisterAll:e.unregisterAll.bind(e),isRegistered:e.isRegistered.bind(e),ready:function(){return Promise.resolve()}}}},function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(o,r){function s(t){try{c(i.next(t))}catch(t){r(t)}}function a(t){try{c(i.throw(t))}catch(t){r(t)}}function c(t){var e;t.done?o(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(s,a)}c((i=i.apply(t,e||[])).next())}))},o=this&&this.__generator||function(t,e){var n,i,o,r,s={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return r={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(r[Symbol.iterator]=function(){return this}),r;function a(r){return function(a){return function(r){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,i&&(o=2&r[0]?i.return:r[0]?i.throw||((o=i.return)&&o.call(i),0):i.next)&&!(o=o.call(i,r[1])).done)return o;switch(i=0,o&&(r=[2&r[0],o.value]),r[0]){case 0:case 1:o=r;break;case 4:return s.label++,{value:r[1],done:!1};case 5:s.label++,i=r[1],r=[0];continue;case 7:r=s.ops.pop(),s.trys.pop();continue;default:if(!(o=(o=s.trys).length>0&&o[o.length-1])&&(6===r[0]||2===r[0])){s=0;continue}if(3===r[0]&&(!o||r[1]>o[0]&&r[1]<o[3])){s.label=r[1];break}if(6===r[0]&&s.label<o[1]){s.label=o[1],o=r;break}if(o&&s.label<o[2]){s.label=o[2],s.ops.push(r);break}o[2]&&s.ops.pop(),s.trys.pop();continue}r=e.call(t,s)}catch(t){r=[6,t],i=0}finally{n=o=0}if(5&r[0])throw r[1];return{value:r[0]?r[1]:void 0,done:!0}}([r,a])}}};Object.defineProperty(e,"__esModule",{value:!0});var r=n(0),s=function(){function t(t){this.agm=t,this.registry=r.default(),this.firstHotkey=!0,this.hotkeys=new Map}return t.prototype.register=function(t,e){return i(this,void 0,void 0,(function(){var n;return o(this,(function(i){switch(i.label){case 0:if(void 0===t)throw new Error("Hotkey parameter missing");if("string"==typeof t)t={hotkey:t};else{if(!t.hotkey)throw new Error("Info's hotkey parameter missing");t={hotkey:t.hotkey,description:t.description}}if(n=this.formatHotkey(t.hotkey),this.hotkeys.has(n))throw new Error("Shortcut for "+n+" already registered");return this.firstHotkey?(this.firstHotkey=!1,[4,this.registerInvokeAGMMethod()]):[3,2];case 1:i.sent(),i.label=2;case 2:return this.registry.add(n,e),[4,this.agm.invoke("T42.Hotkeys.Command",{command:"register",hotkey:n,description:t.description})];case 3:return i.sent(),this.hotkeys.set(n,t),[2]}}))}))},t.prototype.unregister=function(t){return i(this,void 0,void 0,(function(){var e;return o(this,(function(n){switch(n.label){case 0:if(void 0===t)throw new Error("hotkey parameter missing");if("string"!=typeof t)throw new Error("hotkey parameter must be string");return e=this.formatHotkey(t),[4,this.agm.invoke("T42.Hotkeys.Command",{command:"unregister",hotkey:e})];case 1:return n.sent(),this.hotkeys.delete(e),this.registry.clearKey(e),[2]}}))}))},t.prototype.unregisterAll=function(){return i(this,void 0,void 0,(function(){return o(this,(function(t){switch(t.label){case 0:return[4,this.agm.invoke("T42.Hotkeys.Command",{command:"unregisterAll"})];case 1:return t.sent(),this.hotkeys.clear(),this.registry.clear(),[2]}}))}))},t.prototype.isRegistered=function(t){var e=this.formatHotkey(t);return this.hotkeys.has(e)},t.prototype.registerInvokeAGMMethod=function(){var t=this;this.agm.register("T42.Hotkeys.Invoke",(function(e){var n=e.key.toLowerCase(),i=t.hotkeys.get(n);t.registry.execute(n,i)}))},t.prototype.formatHotkey=function(t){if(t)return t.replace(/\s/g,"").toLowerCase()},t}();e.HotkeysImpl=s},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.default=function(t){function e(t,e,n){if("boolean"!=typeof t||t){var i=function t(e,n,i){if("object"==typeof e)return t(e.mode,n,i)+"";if(void 0===e)return"boolean"!=typeof n||n?n+"":void 0;if("boolean"==typeof e)return e?(void 0===i?n:i)+"":void 0;return e+""}(t,e,n);return"object"==typeof t?(t.mode=i,t):{mode:i}}}return{layouts:e(t.layouts,"slim"),activities:e(t.activities,"trackMyTypeAndInitiatedFromMe"),appManager:e(t.appManager,!1,"startOnly"),windows:e(t.windows,!0),channels:e(t.channels||!1,!1),displays:e(t.displays,!0)}}},function(t,e,n){"use strict";n.r(e);var i={DEFAULT:0,STRING:1,NUMBER:2,COUNT:3,RATE:4,STATISTICS:6,TIMESTAMP:7,ADDRESS:8,TIMESPAN:10,OBJECT:11};function o(t){return t.value&&t.value.constructor===Date||t.type===i.TIMESPAN||t.type===i.TIMESTAMP?"timestamp":"number"==typeof t.value?"number":"string"==typeof t.value||t.type===i.STRING||t.type===i.RATE?"string":"object"==typeof t.value?"object":void 0}function r(t){return t.constructor===Date?"timestamp":"number"==typeof t?"number":"string"==typeof t?"string":"object"==typeof t?"object":"string"}function s(t){var e={},n=o(t);if("object"===n){var i=Object.keys(t.value).reduce((function(e,n){var i=r(t.value[n]);if("object"===i){var o=function t(e){return Object.keys(e).reduce((function(n,i){var o=r(e[i]);return n[i]="object"===o?{type:"object",description:"",context:{},composite:t(e[i])}:{type:o,description:"",context:{}},n}),{})}(t.value[n]);e[n]={type:"object",description:"",context:{},composite:o}}else e[n]={type:i,description:"",context:{}};return e}),{});e.composite=i}return e.name=a(t.path.join("/")+"/"+t.name),e.type=n,e.description=t.description,e.context={},e}function a(t){return void 0!==t&&t.length>0&&"/"!==t[0]?"/"+t:t}function c(t){return"timestamp"===o(t)?Date.now():function t(e){if("object"!=typeof e)return e;return Object.keys(e).reduce((function(n,i){var o=e[i];return"object"==typeof o&&o.constructor!==Date?n[i]=t(o):o.constructor===Date?n[i]=new Date(o).getTime():o.constructor===Boolean?n[i]=o.toString():n[i]=o,n}),{})}(t.value)}function u(t){var e=function t(e){return e.reduce((function(e,n){return e.concat(Array.isArray(n)?t(n):n)}),[])}(t.root.getAggregateState()),n=e.sort((function(t,e){return e.state-t.state}))[0];return{description:function(t){var e="";return t.forEach((function(t,n,i){var o=t.path.join(".");n===i.length-1?e+=o+"."+t.name+": "+t.description:e+=o+"."+t.name+": "+t.description+","})),e.length>100?e.slice(0,100)+"...":e}(e),value:n.state}}var d=function(){return(d=Object.assign||function(t){for(var e,n=1,i=arguments.length;n<i;n++)for(var o in e=arguments[n])Object.prototype.hasOwnProperty.call(e,o)&&(t[o]=e[o]);return t}).apply(this,arguments)};function p(t){var e=function t(e,o,r,s,a,c,u,d){var p={name:e,description:a,type:s||n(o),path:r,resolution:u,period:c,conflation:d};p.type===i.OBJECT&&(p.Composite=Object.keys(o).reduce((function(e,n){var i=o[n];return e.push(t(n,i,r)),e}),[]));return p}(t.name,t.value,t.path,t.type,t.description,t.period,t.resolution,t.conflation);function n(t){switch(t.constructor===Date?"timestamp":typeof t){case"string":return i.STRING;case"number":return i.NUMBER;case"timestamp":return i.TIMESTAMP;case"object":return i.OBJECT}return 0}var o=["boolean","int","number","long","string","date","object"];return{id:t.id,instance:t.repo.instance,definition:e,value:function t(e,n){if(e&&e.constructor===Date)return{value:{type:o.indexOf("date"),value:e.valueOf(),isArray:!1}};if("object"==typeof e)return{CompositeValue:Object.keys(e).reduce((function(n,i){var o=t(e[i]);return o.InnerMetricName=i,n.push(o),n}),[])};var i=n?n.getValueType():void 0;return{value:{type:i=i||o.indexOf(typeof e),value:e,isArray:!1}}}(t.value,t)}}var f=function(t,e){var n;if(!t||"object"!=typeof t)throw new Error("Connection is required parameter");var i=t,o=e.heartbeatInterval||3e3,r=function(t,e){i.send("metrics",t,e)};function s(t){t.root&&0!==t.root.subSystems.length&&function t(e){c(e);e.subSystems.forEach((function(e){t(e)}));e.metrics.forEach((function(t){u(t)}))}(t.root)}function a(t){r("HeartbeatMetrics",{publishingInterval:o,instance:t.instance})}function c(t){void 0!==t.parent&&r("CreateMetricSystem",{id:t.id,instance:t.repo.instance,definition:{name:t.name,description:t.description,path:t.path}})}function u(t){r("CreateMetric",p(t))}return{createSystem:c,updateSystem:function(t,e){r("UpdateMetricSystem",{id:t.id,instance:t.repo.instance,state:e})},createMetric:u,updateMetric:function(t){r("UpdateMetric",p(t))},init:function(t){a(t),i.on("metrics","MetricsSnapshotRequest",(function(e){e.Instance===t.instance&&s(t)})),i.disconnected((function(){return clearInterval(n)})),"undefined"!=typeof window&&void 0===window.htmlContainer&&(n=setInterval((function(){a(t)}),o))}}},h={validate:function(t,e,n){if(null===t||"object"!=typeof t)throw new Error("Missing definition");if(null===e||"object"!=typeof e)throw new Error("Missing parent");if(null===n||"object"!=typeof n)throw new Error("Missing transport")}};function l(t,e,n,o){h.validate(t,e,n);var r=n,s=o||"",a=e.path.slice(0);a.push(e.name);var c=t.name,u=t.description,d=t.period,p=t.resolution,f=t.conflation;var l={name:c,description:u,period:d,resolution:p,system:e,repo:e.repo,id:e.path+"/"+c,type:i.OBJECT,conflation:f,get value(){return s},get path(){return a},update:function(t){var e;e=t,Object.keys(s).forEach((function(t){void 0!==e[t]&&(s[t]=e[t])})),r.updateMetric(l)},getValueType:function(){}};return r.createMetric(l),l}function y(t,e,n,o,r){if(!e)throw new Error("Repository is required");if(!n)throw new Error("Transport is required");var s,a,c=n,u=t,d=r||"",p=e,f=o,v=function t(e){if(!e||!e.parent)return[];var n=t(e.parent);n.push(e.name);return n}(o),g={},m=(a="/",((s=v)&&s.length>0?s.join(a):"")+t),b=e.identity,w=e.root,_=[],S=[];function I(t,e,n,i){var o=function(t){var e={};if("string"==typeof t?e.name=t:e=t,void 0===e.name)throw new Error("Metric name is required");return e}(t),r=S.filter((function(t){return t.name===o.name}));if(r.length>0){var s=r[0];if(s.type!==e)throw new Error("A metric named "+o.name+" is already defined with different type.");return void 0!==n&&s.update(n),s}var a=i(o);return S.push(a),a}var A={get name(){return u},get description(){return d},get repo(){return p},get parent(){return f},path:v,id:m,identity:b,root:w,get subSystems(){return _},get metrics(){return S},subSystem:function(t,e){if(!t||0===t.length)throw new Error("name is required");var n=_.filter((function(e){return e.name===t}));if(n.length>0)return n[0];var i=y(t,p,c,A,e);return _.push(i),i},getState:function(){return g},setState:function(t,e){g={state:t,description:e},c.updateSystem(A,g)},stringMetric:function(t,e){return I.call(A,t,i.STRING,e,(function(t){return function(t,e,n,o){h.validate(t,e,n);var r=n,s=o||"",a=e.path.slice(0);a.push(e.name);var c=t.name,u=t.description,d=t.period,p=t.resolution,f=t.conflation,l={name:c,description:u,period:d,resolution:p,system:e,repo:e.repo,id:e.path+"/"+c,conflation:f,get value(){return s},get path(){return a},type:i.STRING,update:function(t){s=t,r.updateMetric(l)},getValueType:function(){}};return r.createMetric(l),l}(t,A,c,e)}))},statisticsMetric:function(t,e){return I.call(this,t,i.STATISTICS,e,(function(t){return function(t,e,n,o){h.validate(t,e,n);var r=n,s=o||"",a=e.path.slice(0);a.push(e.name);var c=t.name,u=t.description,d=t.period,p=t.resolution,f=t.conflation,l={name:c,description:u,period:d,resolution:p,system:e,repo:e.repo,id:e.path+"/"+c,type:i.STATISTICS,conflation:f,get value(){return s},get path(){return a},update:function(t){s=t,r.updateMetric(l)},getValueType:function(){}};return r.createMetric(l),l}(t,A,c,e)}))},rateMetric:function(t,e){return I.call(this,t,i.RATE,e,(function(t){return function(t,e,n,o){h.validate(t,e,n);var r=n,s=o||"",a=e.path.slice(0);a.push(e.name);var c=t.name,u=t.description,d=t.period,p=t.resolution,f=t.conflation,l={name:c,description:u,period:d,resolution:p,system:e,repo:e.repo,id:e.path+"/"+c,type:i.RATE,conflation:f,get value(){return s},get path(){return a},update:function(t){s=t,r.updateMetric(l)},getValueType:function(){}};return r.createMetric(l),l}(t,A,c,e)}))},timestampMetric:function(t,e){return I.call(this,t,i.TIMESTAMP,e,(function(t){return function(t,e,n,o){h.validate(t,e,n);var r=n,s=o||"",a=e.path.slice(0);a.push(e.name);var c=t.name,u=t.description,d=t.period,p=t.resolution,f=t.conflation;function l(t){s=t,r.updateMetric(y)}var y={name:c,description:u,period:d,resolution:p,system:e,repo:e.repo,id:e.path+"/"+c,type:i.TIMESTAMP,conflation:f,get value(){return s},get path(){return a},update:l,now:function(){l(new Date)},getValueType:function(){}};return r.createMetric(y),y}(t,A,c,e)}))},timespanMetric:function(t,e){return I.call(this,t,i.TIMESPAN,e,(function(t){return function(t,e,n,o){h.validate(t,e,n);var r=n,s=o||"",a=e.path.slice(0);a.push(e.name);var c=t.name,u=t.description,d=t.period,p=t.resolution,f=t.conflation;function l(t){s=t,r.updateMetric(y)}var y={name:c,description:u,period:d,resolution:p,system:e,repo:e.repo,id:e.path+"/"+c,type:i.TIMESPAN,conflation:f,get value(){return s},get path(){return a},update:l,start:function(){l(!0)},stop:function(){l(!1)},getValueType:function(){}};return r.createMetric(y),y}(t,A,c,e)}))},objectMetric:function(t,e){return I.call(this,t,i.OBJECT,e,(function(t){return l(t,A,c,e)}))},addressMetric:function(t,e){return I.call(this,t,i.ADDRESS,e,(function(t){return function(t,e,n,o){h.validate(t,e,n);var r=n,s=o||"",a=e.path.slice(0);a.push(e.name);var c=t.name,u=t.description,d=t.period,p=t.resolution,f=e,l=e.repo,y=t.conflation,v={name:c,description:u,period:d,resolution:p,system:f,repo:l,id:e.path+"/"+c,type:i.ADDRESS,conflation:y,get value(){return s},get path(){return a},update:function(t){s=t,r.updateMetric(v)},getValueType:function(){}};return r.createMetric(v),v}(t,A,c,e)}))},countMetric:function(t,e){return I.call(this,t,i.COUNT,e,(function(t){return function(t,e,n,o){h.validate(t,e,n);var r=n,s=o||0,a=e.path.slice(0);a.push(e.name);var c=t.name,u=t.description,d=t.period,p=t.resolution,f=t.conflation;function l(t){s=t,r.updateMetric(v)}function y(t){l(s+t)}var v={name:c,description:u,period:d,resolution:p,system:e,repo:e.repo,id:e.path+"/"+c,type:i.COUNT,conflation:f,get path(){return a},get value(){return s},update:l,getValueType:function(){},incrementBy:y,increment:function(){y(1)},decrement:function(){y(-1)},decrementBy:function(t){y(-1*t)}};return r.createMetric(v),v}(t,A,c,e)}))},numberMetric:function(t,e){return I.call(A,t,i.NUMBER,e,(function(t){return function(t,e,n,o){h.validate(t,e,n);var r=n,s=e.path.slice(0),a=o||0,c=t.name,u=t.description,d=t.period,p=t.resolution,f=t.conflation,l=e,y=e.repo,v=e.path+"/"+c,g=i.NUMBER;function m(t){a=t,r.updateMetric(w)}function b(t){m(a+t)}s.push(e.name);var w={name:c,description:u,period:d,resolution:p,system:l,repo:y,id:v,conflation:f,get value(){return a},type:g,get path(){return s},update:m,getValueType:function(){},incrementBy:b,increment:function(){b(1)},decrement:function(){b(-1)},decrementBy:function(t){b(-1*t)}};return r.createMetric(w),w}(t,A,c,e)}))},getAggregateState:function(){var t=[];return Object.keys(g).length>0&&t.push({name:u,path:v,state:g.state,description:g.description}),_.forEach((function(e){var n=e.getAggregateState();n.length>0&&t.push.apply(t,n)})),t}};return c.createSystem(A),A}var v,g=function(t){var e={connection:t.connection,identity:t.identity,logger:t.logger,heartbeatInterval:t.heartbeatInterval,settings:{},clickStream:t.clickStream};if(!e.connection||"object"!=typeof e.connection)throw new Error("Connection is required parameter");return function(t,e){if(!t.identity)throw new Error("Identity missing from metrics configuration");if(!t.identity.service||"string"!=typeof t.identity.service)throw new Error("Service missing or invalid in metrics identity configuration");if(!t.identity.system||"string"!=typeof t.identity.system)throw new Error("System missing or invalid in metrics identity configuration");if(!t.identity.instance||"string"!=typeof t.identity.instance)throw new Error("Instance missing or invalid in metrics identity configuration");var n,i={identity:t.identity,instance:t.identity.system+"/"+t.identity.service+"/"+t.identity.instance,get root(){return n}};return e.init(i),function(t,e){if("undefined"!=typeof navigator&&t.stringMetric("UserAgent",navigator.userAgent),e&&"undefined"!=typeof document){var n=t.subSystem("ClickStream"),i=function(t){if(t.target){var e=t.target;n.objectMetric("LastBrowserEvent",{type:"click",timestamp:new Date,target:{className:t.target?e.className:"",id:e.id,type:"<"+e.tagName.toLowerCase()+">",href:e.href||""}})}};n.objectMetric("Page",{title:document.title,page:window.location.href}),document.addEventListener?document.addEventListener("click",i):document.attachEvent("onclick",i)}t.stringMetric("StartTime",(new Date).toString());var o=t.stringMetric("StartURL",""),r=t.stringMetric("AppName","");if("undefined"!=typeof window){if(void 0!==window.location){var s=window.location.href;o.update(s)}void 0!==window.glue42gd&&r.update(window.glue42gd.appName)}}(n=y("",i,e),t.clickStream||void 0===t.clickStream),i}(e,3===e.connection.protocolVersion?function(t,e){if(!t||"object"!=typeof t)throw new Error("Connection is required parameter");var n,i,o=function(t){r(t.root)},r=function(t){p(t),t.metrics.forEach((function(t){f(t)})),t.subSystems.forEach((function(t){r(t)}))},p=function(t){void 0!==t.parent&&n.then((function(){var e={type:"define",metrics:[{name:a(t.path.join("/")+"/"+t.name+"/State"),type:"object",composite:{Description:{type:"string",description:""},Value:{type:"number",description:""}},description:"System state",context:{}}]};i.send(e)}))},f=function(t){n.then((function(){var e={type:"define",metrics:[s(t)]};i.send(e),void 0!==t.value&&h(t)}))},h=function(t){var e=d({},t);e.value=d({},t.value),n.then((function(){var t=c(e),n={type:"publish",values:[{name:a(e.path.join("/")+"/"+e.name),value:t,timestamp:Date.now()}]};i.send(n)}))};return{init:function(r){var s;n=new Promise((function(t){s=t})),(i=t.domain("metrics",e.logger)).onJoined((function(t){t||(s(),s=void 0);var e={type:"define",metrics:[{name:"/State",type:"object",composite:{Description:{type:"string",description:""},Value:{type:"number",description:""}},description:"System state",context:{}}]};i.send(e),t&&o(r)})),i.join(e.identity)},createSystem:p,updateSystem:function(e,o){n.then((function(){var n={type:"publish",values:[{name:a(e.path.join("/")+"/"+e.name+"/State"),value:{Description:o.description,Value:o.state},timestamp:Date.now()}]};i.send(n);var r=u(e),s={type:"publish",peer_id:t.peerId,values:[{name:"/State",value:{Description:r.description,Value:r.value},timestamp:Date.now()}]};i.send(s)}))},createMetric:f,updateMetric:h}}(e.connection,t):f(e.connection,t)).root},m=n(0),b=n.n(m),w=function(){function t(t){this.messageHandlers={},this.ids=1,this.registry=b()(),this._connected=!1,this._settings=t,this._logger=t.logger}return t.prototype.init=function(t,e){this._protocol=e,this._transport=t,this._transport.onConnectedChanged(this.handleConnectionChanged.bind(this)),this._transport.onMessage(this.handleTransportMessage.bind(this))},t.prototype.send=function(t,e,n,i,o){if(this._transport.isObjectBasedTransport){var r=this._protocol.createObjectMessage(t,e,n,i);return this._transport.sendObject(r,t,e,o)}var s=this._protocol.createStringMessage(t,e,n,i);return this._transport.send(s,t,e,o)},t.prototype.on=function(t,e,n){e=e.toLowerCase(),void 0===this.messageHandlers[e]&&(this.messageHandlers[e]={});var i=this.ids++;return this.messageHandlers[e][i]=n,{type:e,id:i}},t.prototype.off=function(t){delete this.messageHandlers[t.type.toLowerCase()][t.id]},Object.defineProperty(t.prototype,"isConnected",{get:function(){return this._connected},enumerable:!0,configurable:!0}),t.prototype.connected=function(t){return this._connected&&t(this._settings.ws||this._settings.http),this.registry.add("connected",t)},t.prototype.disconnected=function(t){return this.registry.add("disconnected",t)},t.prototype.login=function(t){return this._transport.open(),this._protocol.login(t)},t.prototype.logout=function(){this._protocol.logout(),this._transport.close()},t.prototype.loggedIn=function(t){return this._protocol.loggedIn(t)},Object.defineProperty(t.prototype,"protocolVersion",{get:function(){return this._settings.protocolVersion||1},enumerable:!0,configurable:!0}),t.prototype.toAPI=function(){var t=this;return{send:t.send.bind(t),on:t.on.bind(t),off:t.off.bind(t),login:t.login.bind(t),logout:t.logout.bind(t),loggedIn:t.loggedIn.bind(t),connected:t.connected.bind(t),disconnected:t.disconnected.bind(t),get protocolVersion(){return t.protocolVersion}}},t.prototype.distributeMessage=function(t,e){var n=this,i=this.messageHandlers[e.toLowerCase()];void 0!==i&&Object.keys(i).forEach((function(e){var o=i[e];if(void 0!==o)try{o(t)}catch(t){n._logger.error("Message handler failed with "+t.stack)}}))},t.prototype.handleConnectionChanged=function(t){this._connected!==t&&(this._connected=t,t?this.registry.execute("connected"):this.registry.execute("disconnected"))},t.prototype.handleTransportMessage=function(t){var e;e="string"==typeof t?this._protocol.processStringMessage(t):this._protocol.processObjectMessage(t),this.distributeMessage(e.msg,e.msgType)},t}(),_=n(5),S=n(0),I=function(t,e,n,i,o){null==t&&(t="global"),i=i||["success"],o=o||["error"];var r,s=!1,a=!1,c=!1,u=S();e.disconnected((function(){c=!1,n.warn("connection is down"),s=!1,a=!0,u.execute("onLeft",{disconnected:!0})})),e.loggedIn((function(){c=!0,a&&(n.info("connection is now up - trying to reconnect..."),p(r))})),e.on(t,"success",(function(t){return h(t)})),e.on(t,"error",(function(t){return f(t)})),e.on(t,"result",(function(t){return h(t)})),i&&i.forEach((function(n){e.on(t,n,(function(t){return h(t)}))})),o&&o.forEach((function(n){e.on(t,n,(function(t){return f(t)}))}));var d={};function p(e){return r=e,new Promise((function(i,o){if(s)i();else{var r;if("global"===t)r=c?Promise.resolve({}):Promise.reject("not connected to gateway");else n.debug("joining "+t),r=y({type:"join",destination:t,domain:"global",options:e});r.then((function(){!function(){n.debug("did join "+t),s=!0;var e=a;a=!1,u.execute("onJoined",e)}(),i()})).catch((function(e){n.debug("error joining "+t+" domain: "+JSON.stringify(e)),o(e)}))}}))}function f(e){if(t===e.domain){var n=e.request_id,i=d[n];i&&i.error(e)}}function h(e){if(e.domain===t){var n=e.request_id,i=d[n];i&&i.success(e)}}function l(){return Object(_.generate)()}function y(i,o,r){r=r||{},i.request_id=i.request_id||l(),i.domain=i.domain||t,r.skipPeerId||(i.peer_id=e.peerId);var s=i.request_id;return new Promise((function(a,c){d[s]={success:function(t){delete d[s],t._tag=o,a(t)},error:function(t){n.warn("GW error - "+JSON.stringify(t)+" for request "+JSON.stringify(i)),delete d[s],t._tag=o,c(t)}},e.send(t,t,i,void 0,r).catch((function(t){d[s].error({err:t})}))}))}return{join:p,leave:function(){"global"!==t&&(n.debug("stopping session "+t+"..."),y({type:"leave",destination:t,domain:"global"}).then((function(){s=!1,u.execute("onLeft")})))},onJoined:function(t){return s&&t(!1),u.add("onJoined",t)},onLeft:function(t){return s||t(),u.add("onLeft",t)},send:y,sendFireAndForget:function(n){n.request_id=n.request_id?n.request_id:l(),n.domain=n.domain||t,n.peer_id=e.peerId,e.send(t,t,n)},on:function(i,o){e.on(t,i,(function(e){if(e.domain===t)try{o(e)}catch(t){n.error("Callback  failed: "+t+" \n msg was: "+JSON.stringify(e))}}))},loggedIn:function(t){return e.loggedIn(t)},connected:function(t){return e.connected(t)},disconnected:function(t){return e.disconnected(t)},get peerId(){return e.peerId},get domain(){return t}}},A=function(t,e,n,i){return new(n||(n=Promise))((function(o,r){function s(t){try{c(i.next(t))}catch(t){r(t)}}function a(t){try{c(i.throw(t))}catch(t){r(t)}}function c(t){var e;t.done?o(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(s,a)}c((i=i.apply(t,e||[])).next())}))},C=function(t,e){var n,i,o,r,s={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return r={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(r[Symbol.iterator]=function(){return this}),r;function a(r){return function(a){return function(r){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,i&&(o=2&r[0]?i.return:r[0]?i.throw||((o=i.return)&&o.call(i),0):i.next)&&!(o=o.call(i,r[1])).done)return o;switch(i=0,o&&(r=[2&r[0],o.value]),r[0]){case 0:case 1:o=r;break;case 4:return s.label++,{value:r[1],done:!1};case 5:s.label++,i=r[1],r=[0];continue;case 7:r=s.ops.pop(),s.trys.pop();continue;default:if(!(o=(o=s.trys).length>0&&o[o.length-1])&&(6===r[0]||2===r[0])){s=0;continue}if(3===r[0]&&(!o||r[1]>o[0]&&r[1]<o[3])){s.label=r[1];break}if(6===r[0]&&s.label<o[1]){s.label=o[1],o=r;break}if(o&&s.label<o[2]){s.label=o[2],s.ops.push(r);break}o[2]&&s.ops.pop(),s.trys.pop();continue}r=e.call(t,s)}catch(t){r=[6,t],i=0}finally{n=o=0}if(5&r[0])throw r[1];return{value:r[0]?r[1]:void 0,done:!0}}([r,a])}}},T=function(){function t(){}return t.prototype.processStringMessage=function(t){var e=JSON.parse(t);return{msg:e,msgType:e.type}},t.prototype.createStringMessage=function(t,e,n,i){return JSON.stringify(n)},t.prototype.login=function(t){return Promise.resolve({application:void 0})},t.prototype.logout=function(){},t.prototype.loggedIn=function(t){return t(),function(){}},t.prototype.processObjectMessage=function(t){throw new Error("not supported")},t.prototype.createObjectMessage=function(t,e,n,i){throw new Error("not supported")},t}(),M=function(){function t(){}return t.getGDMajorVersion=function(){if("undefined"==typeof window)return-1;if(!window.glueDesktop)return-1;if(!window.glueDesktop.version)return-1;var t=Number(window.glueDesktop.version.substr(0,1));return isNaN(t)?-1:t},t.isNode=function(){try{return"[object process]"===Object.prototype.toString.call(global.process)}catch(t){return!1}},t}(),x=M.isNode()?n(38):window.WebSocket,k=function(){function t(t,e){this._running=!0,this._initied=!1,this._registry=b()(),this._settings=t,this._logger=e}return t.prototype.onMessage=function(t){return this._registry.add("onMessage",t)},t.prototype.send=function(t,e,n,i){var o=this;return new Promise((function(e,n){i=i||{},o.waitForSocketConnection((function(){try{o._ws.send(t),e()}catch(t){n(t)}}),n,i.maxRetries,i.retryInterval)}))},t.prototype.open=function(){this._running=!0},t.prototype.close=function(){this._running=!1,this._ws&&this._ws.close()},t.prototype.onConnectedChanged=function(t){return this._registry.add("onConnectedChanged",t)},t.prototype.initiateSocket=function(){var t=this;this._logger.debug("initiating _ws to "+this._settings.ws+"..."),this._ws=new x(this._settings.ws),this._ws.onerror=function(e){t.notifyStatusChanged(!1,JSON.stringify(e))},this._ws.onclose=function(){t._logger.debug("_ws closed"),t.notifyStatusChanged(!1)},this._ws.onopen=function(){t._logger.debug("_ws opened"),t.notifyStatusChanged(!0)},this._ws.onmessage=function(e){t._registry.execute("onMessage",e.data)}},t.prototype.waitForSocketConnection=function(t,e,n,i){var o=this;if(t||(t=function(){}),e||(e=function(){}),void 0===i&&(i=this._settings.reconnectInterval),void 0!==n){if(0===n)return void e("wait for socket on "+this._settings.ws+" failed - no more retries left");this._logger.debug("will retry "+n+" more times (every "+i+" ms)")}if(this._running){if(!this._ws||this._ws.readyState>1)this.initiateSocket();else if(1===this._ws.readyState)return t();setTimeout((function(){var r=void 0===n?void 0:n-1;o.waitForSocketConnection(t,e,r,i)}),i)}else e("wait for socket on "+this._settings.ws+" failed - socket closed by user")},t.prototype.notifyStatusChanged=function(t,e){this._registry.execute("onConnectedChanged",t,e)},t}(),E=function(){function t(t){this.specsNames=[],this.messages={},this.subs={},this.subsRefCount={},this.specs={};for(var e=0,n=t;e<n.length;e++){var i=n[e];this.specs[i.name]=i,this.specsNames.push(i.name)}}return t.prototype.init=function(t){var e=this;this.connection=t;for(var n=0,i=this.specsNames;n<i.length;n++)for(var o=i[n],r=function(n){var i=s.subsRefCount[n];if(i||(i=0),i+=1,s.subsRefCount[n]=i,i>1)return"continue";var o=t.on("glue-core",n,(function(t){return e.processMessage(n,t)}));s.subs[n]=o},s=this,a=0,c=this.specs[o].types;a<c.length;a++){r(c[a])}},t.prototype.processMessage=function(t,e){if(!this.isDone&&e)for(var n=0,i=this.specsNames;n<i.length;n++){var o=i[n];if(-1!==this.specs[o].types.indexOf(t)){var r=this.messages[o]||[];this.messages[o]=r,r.push(e)}}},t.prototype.drain=function(t,e){e&&(this.messages[t]||[]).forEach(e),delete this.messages[t];for(var n=0,i=this.specs[t].types;n<i.length;n++){var o=i[n];this.subsRefCount[o]-=1,this.subsRefCount[o]<=0&&(this.connection.off(this.subs[o]),delete this.subs[o],delete this.subsRefCount[o])}delete this.specs[t],this.specs.length||(this.isDone=!0)},t}(),P=(v=function(t,e){return(v=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(t,e)},function(t,e){function n(){this.constructor=t}v(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)}),j=function(t){function e(e){var n=t.call(this,e)||this;return e.replaySpecs&&e.replaySpecs.length&&(n.replayer=new E(e.replaySpecs)),n}return P(e,t),e.prototype.init=function(e,n){t.prototype.init.call(this,e,n),this.replayer&&this.replayer.init(this),this.gw3Protocol=n},e.prototype.toAPI=function(){var e=this,n=t.prototype.toAPI.call(this);return{domain:e.domain.bind(e),get peerId(){return e.peerId},get token(){return e.token},get info(){return e.info},get resolvedIdentity(){return e.resolvedIdentity},get availableDomains(){return e.availableDomains},get gatewayToken(){return e.gatewayToken},get replayer(){return e.replayer},on:n.on,send:n.send,off:n.off,login:n.login,logout:n.logout,loggedIn:n.loggedIn,connected:n.connected,disconnected:n.disconnected,authToken:e.authToken.bind(e),get protocolVersion(){return n.protocolVersion}}},e.prototype.domain=function(t,e,n,i){return this.gw3Protocol.domain(t,e,n,i)},e.prototype.authToken=function(){return this.gw3Protocol.authToken()},e}(w),O=function(){function t(t,e){this._connection=t,this._settings=e}return t.prototype.processStringMessage=function(t){var e=JSON.parse(t);return{msg:e.message,msgType:e.type}},t.prototype.createStringMessage=function(t,e,n,i){return JSON.stringify({type:e,message:n,id:i})},t.prototype.login=function(t){var e=this;return new Promise((function(t,n){var i={retryInterval:e._settings.reconnectInterval,maxRetries:e._settings.reconnectAttempts};e._connection.send("hello","hello",{},null,i).then((function(){return t({application:void 0})})).catch(n)}))},t.prototype.logout=function(){},t.prototype.loggedIn=function(t){return t(),function(){}},t.prototype.processObjectMessage=function(t){throw new Error("not supported")},t.prototype.createObjectMessage=function(t,e,n,i){throw new Error("not supported")},t}(),R=function(){function t(){this.connectionId=Math.floor(1e10*Math.random()).toString()}return t.prototype.send=function(t,e,n){return"metrics"===e?window.htmlContainer.metricsFacade.send(n,t):"log"===e&&window.htmlContainer.loggingFacade.send(n,t),Promise.resolve(void 0)},t.prototype.onConnectedChanged=function(t){t(!0)},t.prototype.onMessage=function(t){},t.prototype.close=function(){},t.prototype.open=function(){},t}(),W=function(){function t(t,e,n){this.registry=b()(),this.gw=e,this.gwToken=t,this.logger=n,this.connectToken=this.gw.connect(this.gwToken,this.messageHandler.bind(this))}return Object.defineProperty(t.prototype,"isObjectBasedTransport",{get:function(){return!0},enumerable:!0,configurable:!0}),t.prototype.sendObject=function(t){return this.logger.debug(JSON.stringify(t)),this.gw.send(this.connectToken,t),Promise.resolve(void 0)},t.prototype.send=function(t,e,n){return Promise.reject("not supported")},t.prototype.onMessage=function(t){return this.registry.add("onMessage",t)},t.prototype.onConnectedChanged=function(t){t(!0)},t.prototype.close=function(){},t.prototype.open=function(){},t.prototype.messageHandler=function(t){"trace"===this.logger.consoleLevel()&&this.logger.debug(JSON.stringify(t)),this.registry.execute("onMessage",t)},t}(),N=function(t){(t=t||{}).reconnectAttempts=t.reconnectAttempts||10,t.reconnectInterval=t.reconnectInterval||500;var e=new w(t),n=t.logger;if(!n)throw new Error("please pass a logger object");var i=new T,o=new R;if(2!==t.gdVersion||t.force){if(t.gw&&t.gw.facade&&t.gw.token&&3===t.protocolVersion)o=new W(t.gw.token,t.gw.facade,n.subLogger("inproc"));else{if(void 0===t.ws)throw new Error("No connection information specified");o=new k(t,n.subLogger("ws"))}if(3===t.protocolVersion){var r=new j(t),s=function(t,e,n){var i,o,r,s="#T42_DATE#",a=s.length,c=a+1,u=s[0],d=b()(),p=!1,f=!0,h=!0,l=3,y=[];function v(t){(p=t)&&d.execute("onLoggedIn")}return t.disconnected(function e(){v(!1);var i=f;if(i&&h){if(l<=0)return;l--}n.debug("disconnected - will try new login?"+f);f&&t.login(r).catch((function(){setTimeout(e,1e3)}))}.bind(this)),function e(){if(!f)return;p&&t.send("","",{type:"ping"});o=setTimeout(e,3e4)}(),{processStringMessage:function(t){var e=JSON.parse(t,(function(t,e){if("string"!=typeof e)return e;if(e.length<c)return e;if(e[0]!==u)return e;if(e.substring(0,a)!==s)return e;try{var n=parseInt(e.substring(a,e.length),10);return isNaN(n)?e:new Date(n)}catch(t){return e}}));return{msg:e,msgType:e.type}},createStringMessage:function(t,e,n,i){var o=Date.prototype.toJSON;try{return Date.prototype.toJSON=function(){return s+this.getTime()},JSON.stringify(n)}finally{Date.prototype.toJSON=o}},createObjectMessage:function(t,e,n,i){return n},processObjectMessage:function(t){if(!t.type)throw new Error("Object should have type property");return{msg:t,msgType:t.type}},login:function(o){return A(this,void 0,void 0,(function(){var s,a,c,u,d,p,l,y,g;return C(this,(function(m){switch(m.label){case 0:return n.debug("logging in..."),(r=o)||(r={username:"",password:""}),f=!0,s={},t.gatewayToken=o.gatewayToken,t.gatewayToken?(s.method="gateway-token",s.token=t.gatewayToken,[3,4]):[3,1];case 1:return"sspi"!==o.flowName?[3,3]:(s.provider="win",s.method="access-token",a=s,[4,o.flowCallback(o.sessionId,null)]);case 2:return a.token=m.sent().data.toString("base64"),[3,4];case 3:if(o.token)s.method="access-token",s.token=o.token;else{if(!o.username)throw new Error("invalid auth message"+JSON.stringify(o));s.method="secret",s.login=o.username,s.secret=o.password}m.label=4;case 4:c={type:"hello",identity:e.identity,authentication:s},o.sessionId&&(c.request_id=o.sessionId),i=I("global",t,n,["welcome","token","authentication-request"]),u={skipPeerId:!0},h&&(u.retryInterval=e.reconnectInterval,u.maxRetries=e.reconnectAttempts),m.label=5;case 5:m.trys.push([5,12,13,14]),d=void 0,m.label=6;case 6:return[4,i.send(c,void 0,u)];case 7:return"authentication-request"!==(p=m.sent()).type?[3,9]:(l=Buffer.from(p.authentication.token,"base64"),y=c.authentication,[4,o.flowCallback(o.sessionId,l)]);case 8:return y.token=m.sent().data.toString("base64"),c.request_id=o.sessionId,[3,6];case 9:if("welcome"===p.type)return d=p,[3,11];throw"error"===p.type?new Error("Authentication failed: "+p.reason):new Error("Unexpected message type during authentication: "+p.type);case 10:return[3,6];case 11:return h=!1,n.debug("login successful with PeerId "+d.peer_id),t.peerId=d.peer_id,t.resolvedIdentity=d.resolved_identity,t.availableDomains=d.available_domains,d.options&&(t.token=d.options.access_token,t.info=d.options.info),v(!0),[2,d.resolved_identity];case 12:throw g=m.sent(),n.error("error sending hello message - "+(g.message||g.msg||g.reason||g)),g;case 13:return o&&o.flowCallback&&o.sessionId&&o.flowCallback(o.sessionId,null),[7];case 14:return[2]}}))}))},logout:function(){n.debug("logging out..."),f=!1,o&&clearTimeout(o),y.forEach((function(t){t.leave()}))},loggedIn:function(t){return p&&t(),d.add("onLoggedIn",t)},domain:function(e,n,i,o){var r=y.filter((function(t){return t.domain===e}))[0];return r||(r=I(e,t,n,i,o),y.push(r)),r},authToken:function(){return i.send({type:"create-token"}).then((function(t){return t.token}))}}}(r,t,n.subLogger("gw3"));return r.init(o,s),r.toAPI()}i=new O(e,t)}return e.init(o,i),e.toAPI()},F=function(){function t(){}return t.canPublish=function(e,n){return t.order.indexOf(e)>=t.order.indexOf(n)},t.off="off",t.trace="trace",t.debug="debug",t.info="info",t.warn="warn",t.error="error",t.order=[t.trace,t.debug,t.info,t.warn,t.error,t.off],t}(),L=function(){function t(t,e,n){this._subloggers=[],this._name=t,this._parent=e,this._path=e?e.path+"."+t:t,this._loggerFullName="["+this._path+"]",void 0!==n&&this.metricsLevel("warn",n.subSystem(t))}return Object.defineProperty(t.prototype,"name",{get:function(){return this._name},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"path",{get:function(){return this._path},enumerable:!0,configurable:!0}),t.prototype.subLogger=function(e){var n=this._subloggers.filter((function(t){return t.name===e}))[0];if(void 0!==n)return n;Object.keys(this).forEach((function(t){if(t===e)throw new Error("This sub logger name is not allowed.")}));var i=new t(e,this);return this._subloggers.push(i),i},t.prototype.publishLevel=function(t){return null!=t&&(this._publishLevel=t),this._publishLevel||this._parent.publishLevel()},t.prototype.consoleLevel=function(t){return null!=t&&(this._consoleLevel=t),this._consoleLevel||this._parent.consoleLevel()},t.prototype.metricsLevel=function(t,e){if(null!=t&&(this._metricLevel=t),void 0!==e){if("object"!=typeof e||"function"!=typeof e.objectMetric)throw new Error("Please specify metric system");this._metricSystem=e}return this._metricLevel||this._parent.metricsLevel()},t.prototype.log=function(t,e){this.publishMessage(e||F.info,t)},t.prototype.trace=function(t){this.log(t,F.trace)},t.prototype.debug=function(t){this.log(t,F.debug)},t.prototype.info=function(t){this.log(t,F.info)},t.prototype.warn=function(t){this.log(t,F.warn)},t.prototype.error=function(t){this.log(t,F.error)},t.prototype.toAPIObject=function(){return{name:this.name,subLogger:this.subLogger.bind(this),publishLevel:this.publishLevel.bind(this),consoleLevel:this.consoleLevel.bind(this),metricsLevel:this.metricsLevel.bind(this),log:this.log.bind(this),trace:this.trace.bind(this),debug:this.debug.bind(this),info:this.info.bind(this),warn:this.warn.bind(this),error:this.error.bind(this)}},t.prototype.publishMessage=function(e,n){var i=this._loggerFullName;if(e===F.error){var o=new Error;o.stack&&(n=n+"\n"+o.stack.split("\n").slice(3).join("\n"))}if(F.canPublish(e,this.consoleLevel())){var r=i+": "+n;switch(e){case F.trace:console.trace(r);break;case F.debug:console.debug?console.debug(r):console.log(r);break;case F.info:console.info(r);break;case F.warn:console.warn(r);break;case F.error:console.error(r)}}var s=t.GetConnection()&&t.GetConnection().protocolVersion>=3;F.canPublish(e,this.publishLevel())&&!s&&t.GetConnection().send("log","LogMessage",{instance:t.Instance,level:F.order.indexOf(e),logger:i,message:n}),F.canPublish(e,this.metricsLevel())&&void 0!==this._metricSystem&&(this._metricSystem.objectMetric("LogMessage",{Level:e,Logger:i,Message:n,Time:new Date}),e===F.error&&this._metricSystem.setState(100,n))},t}(),U=function(t){var e=t.identity;if(!e)throw new Error("identity is missing");var n=e.system+"\\"+e.service+"\\"+e.instance;L.Instance=n,L.GetConnection=t.getConnection;var i=new L("main");return i.publishLevel(t.publish||"off"),i.consoleLevel(t.console||"info"),i.metricsLevel(t.metrics||"off"),i.toAPIObject()},D=_;var G=function(t,e,n){if("function"!=typeof e&&"function"!=typeof n)return t;"function"!=typeof e?e=function(){}:"function"!=typeof n&&(n=function(){}),t.then(e,n)},B=function(){function t(t,e,n){this.instance=t,this.helpers=e,this.agmFacade=n,this.protocolVersion=this.agmFacade.protocolVersion}return t.prototype.register=function(t,e){var n=this.helpers.stringToObject(t,"name");this.helpers.validateMethodInfo(n),this.protocolVersion&&this.protocolVersion>=3?this.agmFacade.register(JSON.stringify(n),e,!0):this.agmFacade.register(JSON.stringify(n),(function(t,n){var i=e(JSON.parse(t),n);return JSON.stringify(i)}))},t.prototype.registerAsync=function(t,e){if(!this.agmFacade.registerAsync)throw new Error("not supported in that version of HtmlContainer");var n=this.helpers.stringToObject(t,"name");this.helpers.validateMethodInfo(n),this.agmFacade.registerAsync(n,(function(t,n,i){e(t,n,(function(t){i.success(t)}),(function(t){i.error(t)}))}))},t.prototype.unregister=function(t){this.agmFacade.unregister(JSON.stringify(this.helpers.stringToObject(t,"name")))},t.prototype.invoke=function(t,e,n,i,o,r){var s=this,a=new Promise((function(o,r){if(void 0===e&&(e={}),"object"!=typeof e&&r({message:"The method arguments must be an object."}),void 0===i&&(i={}),n=s.helpers.targetArgToObject(n),s.agmFacade.invoke2)s.agmFacade.invoke2(JSON.stringify(s.helpers.stringToObject(t,"name")),e,JSON.stringify(n),JSON.stringify(i),(function(t){o(t)}),(function(t){r(t)}));else{var a,c;a=function(t){var e=JSON.parse(t);o(e)},c=function(t){var e=JSON.parse(t);r(e)},s.agmFacade.invoke(JSON.stringify(s.helpers.stringToObject(t,"name")),JSON.stringify(e),JSON.stringify(n),JSON.stringify(i),a,c)}}));return G(a,o,r)},t.prototype.createStream=function(t,e,n,i){var o=this,r=new Promise((function(n,i){"string"==typeof t&&(t={name:t,getServers:function(){return[]}}),e||(e={subscriptionRequestHandler:void 0,subscriptionAddedHandler:void 0,subscriptionRemovedHandler:void 0}),o.agmFacade.createStream2(JSON.stringify(t),e.subscriptionRequestHandler,e.subscriptionAddedHandler,e.subscriptionRemovedHandler,(function(t){n(t)}),(function(t){i(t)}))}));return G(r,n,i)},t.prototype.subscribe=function(t,e,n,i){var o=this,r=new Promise((function(n,i){var r;void 0===t&&i("method definition param is required"),void 0===e&&(e={}),e.args=JSON.stringify(e.arguments||{}),e.target=o.helpers.targetArgToObject(e.target),r="string"==typeof t?t:t.name,o.agmFacade.subscribe2(r,JSON.stringify(e),(function(t){n(t)}),(function(t){i(t)}))}));return G(r,n,i)},t.prototype.servers=function(t){var e=this,n=this.agmFacade.servers(JSON.stringify(this.helpers.stringToObject(t,"name")));return this.helpers.agmParse(n).map((function(t){return e.transformServerObject(t)}))},t.prototype.methods=function(t){var e=this,n=this.agmFacade.methods(JSON.stringify(this.helpers.stringToObject(t,"name")));return this.helpers.agmParse(n).map((function(t){return e.transformMethodObject(t)}))},t.prototype.methodAdded=function(t){var e=this,n=!0;return this.agmFacade.methodAdded((function(i){n&&t(e.transformMethodObject(i))})),function(){n=!1}},t.prototype.methodRemoved=function(t){var e=this,n=!0;return this.agmFacade.methodRemoved((function(i){n&&t(e.transformMethodObject(i))})),function(){n=!1}},t.prototype.serverAdded=function(t){var e=this,n=!0;return this.agmFacade.serverAdded((function(i){n&&t(e.transformServerObject(i))})),function(){n=!1}},t.prototype.serverRemoved=function(t){var e=this,n=!0;return this.agmFacade.serverRemoved((function(i){n&&t(e.transformServerObject(i))})),function(){n=!1}},t.prototype.serverMethodAdded=function(t){var e=this,n=!0;return this.agmFacade.serverMethodAdded((function(i){n&&t({server:e.transformServerObject(i.server),method:e.transformMethodObject(i.method)})})),function(){n=!1}},t.prototype.serverMethodRemoved=function(t){var e=this,n=!0;return this.agmFacade.serverMethodRemoved((function(i){n&&t({server:e.transformServerObject(i.server),method:e.transformMethodObject(i.method)})})),function(){n=!1}},t.prototype.methodsForInstance=function(t){var e=this.agmFacade.methodsForInstance(JSON.stringify(t));return this.helpers.agmParse(e).map(this.transformMethodObject)},t.prototype.transformMethodObject=function(t){var e=this;if(t)return t.displayName||(t.displayName=t.display_name),t.objectTypes||(t.objectTypes=t.object_types),t.getServers=function(){return e.servers(t.name)},t},t.prototype.transformServerObject=function(t){var e=this;if(t)return t.getMethods=function(){return e.methodsForInstance(t)},t.getStreams=function(){return e.methodsForInstance(t).filter((function(t){return t.supportsStreaming}))},t},t}(),H=function(){function t(t){this.facade=t,this.dateTimeIdentifier=t.jsonValueDatePrefix,this.lenOfIdentifier=this.dateTimeIdentifier.length}return t.prototype.agmParse=function(t){var e=this;return JSON.parse(t,(function(t,n){if("string"!=typeof n)return n;if(n[0]!==e.dateTimeIdentifier[0])return n;if(0!==n.indexOf(e.dateTimeIdentifier))return n;var i=n.substr(e.lenOfIdentifier);return new Date(parseFloat(i))}))},t.prototype.targetArgToObject=function(t){var e=this;if("string"==typeof(t=t||"best")){if("all"!==t&&"best"!==t)throw new Error(t+" is not a valid target. Valid targets are 'all' and 'best'");return{target:t}}return Array.isArray(t)||(t=[t]),{serverFilter:t=t.map((function(t){return e.convertInstanceToRegex(t)}))}},t.prototype.convertInstanceToRegex=function(t){var e={};return Object.keys(t).forEach((function(n){var i=t[n];e[n]=i,null!=i&&("string"==typeof i&&""!==i?e[n]="^"+t[n]+"$":t[n].constructor===RegExp?e[n]=t[n].source:e[n]=t[n])})),e},t.prototype.validateMethodInfo=function(t){if(void 0===t)throw Error("methodInfo is required argument");if(!t.name)throw Error("methodInfo object must contain name property");t.objectTypes&&(t.object_types=t.objectTypes),t.displayName&&(t.display_name=t.displayName)},t.prototype.stringToObject=function(t,e){if("string"==typeof t){var n={};return n[e]=t,n}return t},t}(),q=function(t){if(void 0!==t&&void 0!==t.metrics){t.metrics.metricsIdentity=t.metrics.identity;var e={metricsIdentity:t.metrics.metricsIdentity,path:t.metrics.path};t.metrics=e}return delete t.logger,JSON.stringify(t)};function V(t){return"object"!=typeof t&&(t={}),{application:t.ApplicationName,environment:t.Environment,machine:t.MachineName,pid:t.ProcessId,region:t.Region,service:t.ServiceName,user:t.UserName,started:t.ProcessStartTime}}function J(t){if("number"!=typeof t||isNaN(t))return!1;return 32===(32&t)}function z(t){return{ApplicationName:t.application,ProcessId:t.pid,MachineName:t.machine,UserName:t.user,Environment:t.environment,Region:t.region}}var K=function(){function t(t,e){this.connection=t,this.instance=e}return t.prototype.isStreamMsg=function(t,e){return t&&t.EventStreamAction&&0!==t.EventStreamAction&&"object"==typeof e&&!0===e.definition.supportsStreaming},t.prototype.pushData=function(t,e,n){var i=this;if("object"==typeof t&&Array.isArray(t.protocolState.branchKeyToStreamIdMap)){if("object"!=typeof e)throw new Error("Invalid arguments. Data must be an object.");"string"==typeof n?n=[n]:(!Array.isArray(n)||n.length<=0)&&(n=null);var o=t.protocolState.branchKeyToStreamIdMap.filter((function(t){return null===n||Boolean(t)&&"string"==typeof t.key&&n.indexOf(t.key)>=0})).map((function(t){return t.streamId})),r=z(this.instance);o.forEach((function(n){i.sendResult({EventStreamAction:5,EventStreamSubject:t.protocolState.globalEventStreamSubject,MethodName:t.protocolState.method.Method.Name,MethodRequestSubject:t.protocolState.method.MethodRequestSubject,ResultContextJson:e,Server:r,StreamId:n})}))}},t.prototype.closeAllSubscriptions=function(t,e){var n=this;if("object"==typeof t&&Array.isArray(t.protocolState.branchKeyToStreamIdMap)){var i=t.protocolState.branchKeyToStreamIdMap;"string"==typeof e&&(i=t.protocolState.branchKeyToStreamIdMap.filter((function(t){return"object"==typeof t&&t.key===e}))),i.forEach((function(e){var i=e.streamId;n.sendResult({EventStreamAction:2,EventStreamSubject:t.protocolState.globalEventStreamSubject,MethodName:t.protocolState.method.Method.Name,MethodRequestSubject:t.protocolState.method.MethodRequestSubject,Server:z(n.instance),StreamId:i,Status:0})}))}},t.prototype.getBranchList=function(t){return"object"!=typeof t?[]:this.getUniqueBranchNames(t)},t.prototype.getSubscriptionList=function(t,e){if("object"!=typeof t)return[];return"string"!=typeof e?t.protocolState.subscriptions:t.protocolState.subscriptions.filter((function(t){return t.branchKey===e}))},t.prototype.onSubAdded=function(t){"function"==typeof t&&(this.subAddedHandler=t)},t.prototype.onSubRemoved=function(t){"function"==typeof t&&(this.subRemovedHandler=t)},t.prototype.onSubRequest=function(t){"function"==typeof t&&(this.requestHandler=t)},t.prototype.generateNewStreamId=function(t){return"streamId-jsb_of_"+t+"__by_"+z(this.instance).ApplicationName+"_"+D()},t.prototype.rejectRequest=function(t,e,n){"string"!=typeof n&&(n="");var i=t.msg;this.sendResult({EventStreamAction:2,EventStreamSubject:e.protocolState.globalEventStreamSubject,MethodName:e.protocolState.method.Method.Name,MethodRequestSubject:e.protocolState.method.MethodRequestSubject,MethodResponseSubject:i.MethodResponseSubject,MethodVersion:e.protocolState.method.Method.Version,ResultMessage:n,Server:z(this.instance),StreamId:"default_rejection_streamId"})},t.prototype.pushDataToSingle=function(t,e,n){if("object"!=typeof n)throw new Error("Invalid arguments. Data must be an object.");this.sendResult({EventStreamAction:5,EventStreamSubject:e.privateEventStreamSubject,MethodName:t.protocolState.method.Method.Name,MethodRequestSubject:t.protocolState.method.MethodRequestSubject,ResultContextJson:n,Server:z(this.instance),StreamId:e.streamId})},t.prototype.closeSingleSubscription=function(t,e){this.closeIndividualSubscription(t,e.streamId,e.privateEventStreamSubject,!0)},t.prototype.acceptRequestOnBranch=function(t,e,n){"string"!=typeof n&&(n="");var i=this.getStreamId(e,n),o=t.msg;this.sendResult({EventStreamAction:3,EventStreamSubject:e.protocolState.globalEventStreamSubject,InvocationId:o.Context.InvocationId,MethodName:e.protocolState.method.Method.Name,MethodRequestSubject:e.protocolState.method.MethodRequestSubject,MethodResponseSubject:o.MethodResponseSubject,MethodVersion:e.protocolState.method.Method.Version,ResultMessage:"Accepted",Server:z(this.instance),StreamId:i})},t.prototype.processSubscriberMsg=function(t,e){t&&t.EventStreamAction&&0!==t.EventStreamAction&&(1===t.EventStreamAction?this.clientWishesToSubscribe(t,e):2===t.EventStreamAction?this.clientWishesToUnsubscribe(t,e):3===t.EventStreamAction?this.clientAcknowledgesItDidSubscribe(t,e):4===t.EventStreamAction&&this.clientPerSubHeartbeat(t))},t.prototype.sendResult=function(t){if("object"!=typeof t)throw new Error("Invalid message.");"number"!=typeof t.Status&&(t.Status=0),this.connection.send("agm","MethodInvocationResultMessage",t)},t.prototype.clientWishesToSubscribe=function(t,e){var n={msg:t,arguments:t.Context.ArgumentsJson||{},instance:V(t.Client)};"function"==typeof this.requestHandler&&this.requestHandler(n,e)},t.prototype.clientWishesToUnsubscribe=function(t,e){e&&Array.isArray(e.protocolState.subscriptions)&&e.protocolState.subscriptions.length>0&&this.closeIndividualSubscription(e,t.StreamId,t.EventStreamSubject,!1)},t.prototype.clientAcknowledgesItDidSubscribe=function(t,e){if("string"==typeof t.StreamId&&""!==t.StreamId){var n=this.getBranchKey(e,t.StreamId);if("string"==typeof n&&Array.isArray(e.protocolState.subscriptions)){var i={branchKey:n,instance:V(t.Client),arguments:t.Context.ArgumentsJson,streamId:t.StreamId,privateEventStreamSubject:t.EventStreamSubject,methodResponseSubject:t.MethodResponseSubject};e.protocolState.subscriptions.push(i),"function"==typeof this.subAddedHandler&&this.subAddedHandler(i,e)}}},t.prototype.clientPerSubHeartbeat=function(t){},t.prototype.getBranchKey=function(t,e){if("string"==typeof e&&"object"==typeof t){var n=t.protocolState.branchKeyToStreamIdMap.filter((function(t){return t.streamId===e}))[0];if("object"==typeof n&&"string"==typeof n.key)return n.key}},t.prototype.getStreamId=function(t,e){"string"!=typeof e&&(e="");var n=t.protocolState.branchKeyToStreamIdMap.filter((function(t){return t.key===e}))[0],i=n?n.streamId:void 0;return"string"==typeof i&&""!==i||(i=this.generateNewStreamId(t.protocolState.method.Method.Name),t.protocolState.branchKeyToStreamIdMap.push({key:e,streamId:i})),i},t.prototype.closeIndividualSubscription=function(t,e,n,i){var o=t.protocolState.subscriptions.filter((function(t){return t.privateEventStreamSubject===n&&t.streamId===e}))[0];if("object"==typeof o){var r=t.protocolState.subscriptions.length;t.protocolState.subscriptions=t.protocolState.subscriptions.filter((function(t){return!(t.privateEventStreamSubject===o.privateEventStreamSubject&&t.streamId===o.streamId)})),t.protocolState.subscriptions.length===r-1&&(!0===i&&this.sendResult({EventStreamAction:2,EventStreamSubject:n,MethodName:t.protocolState.method.Method.Name,MethodRequestSubject:t.protocolState.method.MethodRequestSubject,MethodResponseSubject:o.methodResponseSubject,MethodVersion:t.protocolState.method.Method.Version,ResponseContextJson:{},Server:z(this.instance),StreamId:o.streamId,Status:0}),"function"==typeof this.subRemovedHandler&&this.subRemovedHandler(o,t))}},t.prototype.getUniqueBranchNames=function(t){var e=t.protocolState.subscriptions.map((function(t){var e=null;return"object"==typeof t&&"string"==typeof t.branchKey&&(e=t.branchKey),e})),n=[];return e.filter((function(t){return!(null===t||n.indexOf(t)>=0)&&(n.push(t),!0)}))},t}(),Z=5e3,Y=function(){function t(t,e,n,i){var o=this;this.connection=t,this.instance=e,this.serverRepository=i,this.invocationMessagesMap={},this.reqCounter=0,this.callbacks=b()(),this.streaming=new K(t,e),t.on("agm","MethodInvocationRequestMessage",(function(t){return o.handleMethodInvocationMessage(t)})),t.disconnected(this.stopTimers.bind(this)),this.sendHeartbeat(),void 0===this.heartbeatTimer&&(this.heartbeatTimer=setInterval((function(){return o.sendHeartbeat()}),Z)),this.getBranchList=this.streaming.getBranchList,this.getSubscriptionList=this.streaming.getSubscriptionList,this.closeAllSubscriptions=this.streaming.closeAllSubscriptions,this.closeSingleSubscription=this.streaming.closeSingleSubscription,this.pushDataToSingle=this.streaming.pushDataToSingle,this.pushData=this.streaming.pushData,this.onSubRequest=this.streaming.onSubRequest,this.acceptRequestOnBranch=this.streaming.acceptRequestOnBranch,this.rejectRequest=this.streaming.rejectRequest,this.onSubAdded=this.streaming.onSubAdded,this.onSubRemoved=this.streaming.onSubRemoved}return t.prototype.stopTimers=function(){clearInterval(this.presenceTimer),clearInterval(this.heartbeatTimer)},t.prototype.unregister=function(t){return this.sendPresence(),Promise.resolve()},t.prototype.register=function(t){var e=this.nextRequestSubject();return t.protocolState.method=this.createNewMethodMessage(t.definition,e,!1),this.announceNewMethod(),Promise.resolve()},t.prototype.createStream=function(t){var e=this.nextRequestSubject(),n=this.createNewMethodMessage(t.definition,e,!0);return t.protocolState.method=n,t.protocolState.globalEventStreamSubject=t.definition.name+".jsStream."+D(),t.protocolState.subscriptions=[],t.protocolState.branchKeyToStreamIdMap=[],this.announceNewMethod(),Promise.resolve()},t.prototype.onInvoked=function(t){this.callbacks.add("onInvoked",t)},t.prototype.methodInvocationResult=function(t,e,n,i){var o=this.invocationMessagesMap[e];if(o&&"null"!==o.MethodResponseSubject&&void 0!==t){var r={MethodRequestSubject:o.MethodRequestSubject,MethodResponseSubject:o.MethodResponseSubject,MethodName:t.protocolState.method.Method.Name,InvocationId:e,ResultContextJson:i,Server:z(this.instance),ResultMessage:n,Status:n?1:0};this.connection.send("agm","MethodInvocationResultMessage",r),delete this.invocationMessagesMap[e]}},t.prototype.nextRequestSubject=function(){return"req_"+this.reqCounter+++"_"+D()},t.prototype.sendHeartbeat=function(){this.connection.send("agm","ServerHeartbeatMessage",this.constructHeartbeat())},t.prototype.constructHeartbeat=function(){return{PublishingInterval:Z,Instance:z(this.instance)}},t.prototype.constructPresence=function(){var t=this.serverRepository.getList();return{PublishingInterval:1e4,Instance:z(this.instance),MethodDefinitions:t.map((function(t){return t.protocolState.method}))}},t.prototype.sendPresence=function(){this.connection.send("agm","ServerPresenceMessage",this.constructPresence())},t.prototype.announceNewMethod=function(){var t=this;this.sendPresence(),void 0===this.presenceTimer&&(this.presenceTimer=setInterval((function(){return t.sendPresence()}),1e4))},t.prototype.handleMethodInvocationMessage=function(t){var e=t.MethodRequestSubject,n=this.serverRepository.getList().filter((function(t){return t.protocolState.method.MethodRequestSubject===e}))[0];if(void 0!==n)if(this.streaming.isStreamMsg(t,n))this.streaming.processSubscriberMsg(t,n);else{var i=t.Context.InvocationId;this.invocationMessagesMap[i]=t;var o={args:t.Context.ArgumentsJson,instance:V(t.Client)};this.callbacks.execute("onInvoked",n,i,o)}},t.prototype.createNewMethodMessage=function(t,e,n){return"string"==typeof t&&(t={name:t}),"number"!=typeof t.version&&(t.version=0),{Method:{Name:t.name,InputSignature:t.accepts,ResultSignature:t.returns,Description:t.description,DisplayName:t.displayName,Version:t.version,ObjectTypeRestrictions:t.objectTypes,Flags:n?32:void 0},MethodRequestSubject:e}},t}(),Q=function(){function t(t,e,n,i){this.configuration=t,this.instance=e,this.sendRequest=n,this.nextResponseSubject=i,this.subscriptionsList={}}return t.prototype.subscribe=function(t,e,n,i,o,r){var s=this;if(0!==n.length){var a="subscriptionId_"+D(),c=this.registerSubscription(a,t,e,o,r,i.methodResponseTimeout);"object"==typeof c?n.forEach((function(n){var o=s.nextResponseSubject(),r=t.info.requestSubject;c.trackedServers.push({server:void 0,streamId:void 0,streamSubjects:{global:void 0,private:void 0},methodRequestSubject:r,methodResponseSubject:o});var u={EventStreamAction:1,MethodRequestSubject:r,MethodResponseSubject:o,Client:z(s.instance),Context:{ArgumentsJson:e,InvocationId:a,MethodName:t.info.name,ExecutionServer:n.server.info,Timeout:i.methodResponseTimeout}};s.sendRequest(u)})):r({method:t.getInfoForUser(),message:"Subscription failed. Unable to register the user callbacks.",called_with:e})}else r({method:t.getInfoForUser(),message:"Subscription failed. No available servers matched the target params.",called_with:e})},t.prototype.processPublisherMsg=function(t){t&&t.EventStreamAction&&0!==t.EventStreamAction&&(2===t.EventStreamAction?this.serverIsKickingASubscriber(t):3===t.EventStreamAction?this.serverAcknowledgesGoodSubscription(t):5===t.EventStreamAction&&this.serverHasPushedSomeDataIntoTheStream(t))},t.prototype.registerSubscription=function(t,e,n,i,o,r){var s=this;return this.subscriptionsList[t]={status:"awaitingAccept",method:e,arguments:n,success:i,error:o,trackedServers:[],handlers:{onData:[],onClosed:[]},queued:{data:[],closers:[]},timeoutId:void 0},this.subscriptionsList[t].timeoutId=setTimeout((function(){if(void 0!==s.subscriptionsList[t]){var i=s.subscriptionsList[t];if("awaitingAccept"===i.status)o({method:e,called_with:n,message:"Subscription failed. Subscription attempt timed out after "+r+"ms."}),delete s.subscriptionsList[t];else if("subscribed"===i.status&&i.trackedServers.length>0&&(i.trackedServers=i.trackedServers.filter((function(t){return"string"==typeof t.streamId&&""!==t.streamId})),i.timeoutId=void 0,0===i.trackedServers.length)){var a=i.queued.closers.length,c=a>0?i.queued.closers[a-1]:null;i.handlers.onClosed.forEach((function(t){"function"==typeof t&&t({message:"ServerInitiated",requestArguments:i.arguments,server:c,stream:i.method})})),delete s.subscriptionsList[t]}}}),r),this.subscriptionsList[t]},t.prototype.serverIsKickingASubscriber=function(t){var e=this,n=Object.keys(this.subscriptionsList);"string"==typeof t.InvocationId&&""!==t.InvocationId&&(n=n.filter((function(e){return e===t.InvocationId})));var i=[];n.forEach((function(n){"object"==typeof e.subscriptionsList[n]&&(e.subscriptionsList[n].trackedServers=e.subscriptionsList[n].trackedServers.filter((function(e){var n=e.methodRequestSubject===t.MethodRequestSubject&&e.methodResponseSubject===t.MethodResponseSubject,i=e.streamId===t.StreamId&&(e.streamSubjects.global===t.EventStreamSubject||e.streamSubjects.private===t.EventStreamSubject);return!(n||i)})),0===e.subscriptionsList[n].trackedServers.length&&i.push(n))})),i.forEach((function(n){if("object"==typeof e.subscriptionsList[n]){if("awaitingAccept"===e.subscriptionsList[n].status&&"number"==typeof e.subscriptionsList[n].timeoutId){var i="string"==typeof t.ResultMessage&&""!==t.ResultMessage?' Publisher said "'+t.ResultMessage+'".':" No reason given.",o="object"==typeof e.subscriptionsList[n].arguments?JSON.stringify(e.subscriptionsList[n].arguments):"{}";e.subscriptionsList[n].error("Subscription rejected."+i+" Called with:"+o),clearTimeout(e.subscriptionsList[n].timeoutId)}else e.subscriptionsList[n].handlers.onClosed.forEach((function(i){"function"==typeof i&&i({message:"ServerInitiated",requestArguments:e.subscriptionsList[n].arguments,server:V(t.Server),stream:e.subscriptionsList[n].method})}));delete e.subscriptionsList[n]}}))},t.prototype.serverAcknowledgesGoodSubscription=function(t){var e=this,n=t.InvocationId,i=this.subscriptionsList[n];if("object"==typeof i){var o=i.trackedServers.filter((function(e){return e.methodRequestSubject===t.MethodRequestSubject&&e.methodResponseSubject===t.MethodResponseSubject}))[0];if("object"==typeof o){var r="awaitingAccept"===i.status;i.status="subscribed";var s=this.generatePrivateStreamSubject(i.method.name);if("string"!=typeof o.streamId||""===o.streamId){o.server=V(t.Server),o.streamId=t.StreamId,o.streamSubjects.global=t.EventStreamSubject,o.streamSubjects.private=s;var a={EventStreamAction:3,EventStreamSubject:s,StreamId:t.StreamId,MethodRequestSubject:t.MethodRequestSubject,MethodResponseSubject:o.methodResponseSubject,Client:z(this.instance),Context:{ArgumentsJson:i.arguments,MethodName:i.method.name}};this.sendRequest(a),r&&i.success({onData:function(t){if("function"!=typeof t)throw new TypeError("The data callback must be a function.");this.handlers.onData.push(t),1===this.handlers.onData.length&&this.queued.data.length>0&&this.queued.data.forEach((function(e){t(e)}))}.bind(i),onClosed:function(t){if("function"!=typeof t)throw new TypeError("The callback must be a function.");this.handlers.onClosed.push(t)}.bind(i),onFailed:function(){},close:function(){return e.closeSubscription(i,n)},requestArguments:i.arguments,serverInstance:V(t.Server),stream:i.method})}}}},t.prototype.serverHasPushedSomeDataIntoTheStream=function(t){var e=function(e){if(n.subscriptionsList.hasOwnProperty(e)&&"object"==typeof n.subscriptionsList[e]){var i=void 0,o=n.subscriptionsList[e].trackedServers.filter((function(e){return e.streamId===t.StreamId&&(e.streamSubjects.global===t.EventStreamSubject||e.streamSubjects.private===t.EventStreamSubject)}));if(0===o.length?i=void 0:o[0].streamSubjects.global===t.EventStreamSubject?i=!1:o[0].streamSubjects.private===t.EventStreamSubject&&(i=!0),void 0!==i){var r={data:t.ResultContextJson,server:V(t.Server),requestArguments:n.subscriptionsList[e].arguments||{},message:t.ResultMessage,private:i},s=n.subscriptionsList[e].handlers.onData,a=n.subscriptionsList[e].queued.data;Array.isArray(s)&&(s.length>0?s.forEach((function(t){"function"==typeof t&&t(r)})):a.push(r))}}},n=this;for(var i in this.subscriptionsList)e(i)},t.prototype.closeSubscription=function(t,e){var n=this,i=this.nextResponseSubject();t.trackedServers.forEach((function(t){n.sendRequest({EventStreamAction:2,Client:z(n.instance),MethodRequestSubject:t.methodRequestSubject,MethodResponseSubject:i,StreamId:t.streamId,EventStreamSubject:t.streamSubjects.private})})),t.handlers.onClosed.forEach((function(e){"function"==typeof e&&e({message:"ClientInitiated",requestArguments:t.arguments||{},server:t.trackedServers[t.trackedServers.length-1].server,stream:t.method})})),delete this.subscriptionsList[e]},t.prototype.generatePrivateStreamSubject=function(t){return"ESSpriv-jsb_"+z(this.instance).ApplicationName+"_on_"+t+"_"+D()},t}();function X(t,e){return void 0===t&&(t=0),new Promise((function(n,i){return setTimeout((function(){return i(e)}),t)}))}var $,tt=function(){return(tt=Object.assign||function(t){for(var e,n=1,i=arguments.length;n<i;n++)for(var o in e=arguments[n])Object.prototype.hasOwnProperty.call(e,o)&&(t[o]=e[o]);return t}).apply(this,arguments)},et=function(t,e,n,i){return new(n||(n=Promise))((function(o,r){function s(t){try{c(i.next(t))}catch(t){r(t)}}function a(t){try{c(i.throw(t))}catch(t){r(t)}}function c(t){var e;t.done?o(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(s,a)}c((i=i.apply(t,e||[])).next())}))},nt=function(t,e){var n,i,o,r,s={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return r={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(r[Symbol.iterator]=function(){return this}),r;function a(r){return function(a){return function(r){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,i&&(o=2&r[0]?i.return:r[0]?i.throw||((o=i.return)&&o.call(i),0):i.next)&&!(o=o.call(i,r[1])).done)return o;switch(i=0,o&&(r=[2&r[0],o.value]),r[0]){case 0:case 1:o=r;break;case 4:return s.label++,{value:r[1],done:!1};case 5:s.label++,i=r[1],r=[0];continue;case 7:r=s.ops.pop(),s.trys.pop();continue;default:if(!(o=(o=s.trys).length>0&&o[o.length-1])&&(6===r[0]||2===r[0])){s=0;continue}if(3===r[0]&&(!o||r[1]>o[0]&&r[1]<o[3])){s.label=r[1];break}if(6===r[0]&&s.label<o[1]){s.label=o[1],o=r;break}if(o&&s.label<o[2]){s.label=o[2],s.ops.push(r);break}o[2]&&s.ops.pop(),s.trys.pop();continue}r=e.call(t,s)}catch(t){r=[6,t],i=0}finally{n=o=0}if(5&r[0])throw r[1];return{value:r[0]?r[1]:void 0,done:!0}}([r,a])}}},it=function(){for(var t=0,e=0,n=arguments.length;e<n;e++)t+=arguments[e].length;var i=Array(t),o=0;for(e=0;e<n;e++)for(var r=arguments[e],s=0,a=r.length;s<a;s++,o++)i[o]=r[s];return i};!function(t){t[t.Success=0]="Success",t[t.Error=1]="Error"}($||($={}));var ot=function(){function t(t,e,n,i){this.protocol=t,this.repo=e,this.instance=n,this.configuration=i}return t.prototype.subscribe=function(t,e,n,i){var o=this,r=function(t,n,i,r){o.protocol.client.subscribe(n,e.arguments,t,{methodResponseTimeout:e.waitTimeoutMs},i,r)},s=new Promise((function(n,i){var s,a=function(t){n(t)},c=function(t){i(t)};t||i("Method definition is required. Please, provide either a unique string for a method name or a “methodDefinition” object with a required “name” property."),(s="string"==typeof t?{name:t}:t).name||i("Method definition is required. Please, provide either a unique string for a method name or a “methodDefinition” object with a required “name” property."),void 0===e&&(e={});var u=e.target;void 0===u&&(u="best"),"string"==typeof u&&"all"!==u&&"best"!==u&&i({message:'"'+u+'" is not a valid target. Valid targets are "all", "best", or an instance.'}),void 0===e.methodResponseTimeout&&(e.methodResponseTimeout=e.method_response_timeout,void 0===e.methodResponseTimeout&&(e.methodResponseTimeout=o.configuration.methodResponseTimeout)),void 0===e.waitTimeoutMs&&(e.waitTimeoutMs=e.wait_for_method_timeout,void 0===e.waitTimeoutMs&&(e.waitTimeoutMs=o.configuration.waitTimeoutMs));var d=0,p=o.getServerMethodsByFilterAndTarget(s,u);if(p.length>0)r(p,p[0].methods[0],a,c);else{var f=function(){if(d+=500,(p=o.getServerMethodsByFilterAndTarget(s,u)).length>0){var n=p[0].methods[0];r(p,n,a,c)}else if(d>=e.waitTimeoutMs){r(p,{id:void 0,info:"string"==typeof t?{name:t}:t,getInfoForUser:function(){return s},protocolState:void 0},a,c)}else setTimeout(f,500)};setTimeout(f,500)}}));return G(s,n,i)},t.prototype.servers=function(t){var e=void 0===t?void 0:tt({},t);return this.getServers(e).map((function(t){return t.server.getInfoForUser()}))},t.prototype.methods=function(t){var e=tt({},t);return this.getMethods(e).map((function(t){return t.getInfoForUser()}))},t.prototype.methodsForInstance=function(t){return this.getMethodsForInstance(t).map((function(t){return t.getInfoForUser()}))},t.prototype.methodAdded=function(t){return this.repo.onMethodAdded((function(e){t(e.getInfoForUser())}))},t.prototype.methodRemoved=function(t){return this.repo.onMethodRemoved((function(e){t(e.getInfoForUser())}))},t.prototype.serverAdded=function(t){return this.repo.onServerAdded((function(e){t(e.getInfoForUser())}))},t.prototype.serverRemoved=function(t){return this.repo.onServerRemoved((function(e,n){t(e.getInfoForUser(),n)}))},t.prototype.serverMethodAdded=function(t){return this.repo.onServerMethodAdded((function(e,n){t({server:e.getInfoForUser(),method:n.getInfoForUser()})}))},t.prototype.serverMethodRemoved=function(t){return this.repo.onServerMethodRemoved((function(e,n){t({server:e.getInfoForUser(),method:n.getInfoForUser()})}))},t.prototype.invoke=function(t,e,n,i,o,r){return et(this,void 0,void 0,(function(){var s=this;return nt(this,(function(a){return[2,G(function(){return et(s,void 0,void 0,(function(){var o,r,s,a,c,u,d,p=this;return nt(this,(function(f){switch(f.label){case 0:if(!(o="string"==typeof t?{name:t}:tt({},t)).name)return[2,Promise.reject("Method definition is required. Please, provide either a unique string for a method name or a “methodDefinition” object with a required “name” property.")];if(e||(e={}),n||(n="best"),"string"==typeof n&&"all"!==n&&"best"!==n)return[2,Promise.reject({message:'"'+n+'" is not a valid target. Valid targets are "all" and "best".'})];if(i||(i={}),void 0===i.methodResponseTimeoutMs&&(i.methodResponseTimeoutMs=i.method_response_timeout,void 0===i.methodResponseTimeoutMs&&(i.methodResponseTimeoutMs=this.configuration.methodResponseTimeout)),void 0===i.waitTimeoutMs&&(i.waitTimeoutMs=i.wait_for_method_timeout,void 0===i.waitTimeoutMs&&(i.waitTimeoutMs=this.configuration.waitTimeoutMs)),void 0!==i.waitTimeoutMs&&"number"!=typeof i.waitTimeoutMs)return[2,Promise.reject({message:'"'+i.waitTimeoutMs+"\" is not a valid number for 'waitTimeoutMs'"})];if("object"!=typeof e)return[2,Promise.reject({message:"The method arguments must be an object. method: "+o.name})];if(0!==(r=this.getServerMethodsByFilterAndTarget(o,n)).length)return[3,4];f.label=1;case 1:return f.trys.push([1,3,,4]),[4,this.tryToAwaitForMethods(o,n,i)];case 2:return r=f.sent(),[3,4];case 3:return f.sent(),s={method:o,called_with:e,message:"Can not find a method matching "+JSON.stringify(t)+" with server filter "+JSON.stringify(n)+". Is the object a valid instance ?",executed_by:void 0,returned:void 0,status:void 0},[2,Promise.reject(s)];case 4:return a=i.methodResponseTimeoutMs,c=r.map((function(t){var n=D();return Promise.race([p.protocol.client.invoke(n,t.methods[0],e,t.server,i),X(a,{invocationId:n,message:"Invocation timeout ("+a+" ms) reached",status:$.Error})])})),[4,Promise.all(c)];case 5:return u=f.sent(),d=this.getInvocationResultObj(u,o,e),u.every((function(t){return t.status===$.Error}))?[2,Promise.reject(d)]:[2,d]}}))}))}(),o,r)]}))}))},t.prototype.getInvocationResultObj=function(t,e,n){var i=t.filter((function(t){return t.status===$.Success})).reduce((function(t,i){return t=it(t,[{executed_by:i.instance,returned:i.result,called_with:n,method:e,message:i.message,status:i.status}])}),[]),o=t.filter((function(t){return t.status===$.Error})).reduce((function(t,i){return t=it(t,[{executed_by:i.instance,called_with:n,name:e.name,message:i.message}])}),[]),r=t[0];return{method:e,called_with:n,returned:r.result,executed_by:r.instance,all_return_values:i,all_errors:o,message:r.message,status:r.status}},t.prototype.tryToAwaitForMethods=function(t,e,n){var i=this;return new Promise((function(o,r){0===n.waitTimeoutMs&&r();var s=0,a=setInterval((function(){s+=500;var c=i.getServerMethodsByFilterAndTarget(t,e);c.length>0?(clearInterval(a),o(c)):s>=n.waitTimeoutMs&&(clearInterval(a),r())}),500)}))},t.prototype.filterByTarget=function(t,e){var n=this;if("string"!=typeof t){return(Array.isArray(t)?t:[t]).reduce((function(t,i){var o=e.filter((function(t){return n.instanceMatch(i,t.server.info)}));return t.concat(o)}),[])}if("all"===t)return it(e);if("best"===t){var i=e.find((function(t){return t.server.info.isLocal}));if(i)return[i];if(void 0!==e[0])return[e[0]]}return[]},t.prototype.instanceMatch=function(t,e){return this.containsProps(t,e)},t.prototype.methodMatch=function(t,e){return this.containsProps(t,e)},t.prototype.containsProps=function(t,e){return Object.keys(t).filter((function(e){return void 0!==t[e]&&"function"!=typeof t[e]&&"object_types"!==e&&"display_name"!==e})).reduce((function(n,i){var o=t[i],r=e[i];if("objectTypes"===i){(o.length>r.length||!1===function(t,e){var n=t.reduce((function(t,e){return t[e]=!1,t}),{});e.forEach((function(t){void 0!==n[t]&&(n[t]=!0)}));return Object.keys(n).reduce((function(t,e){return n[e]||(t=!1),t}),!0)}(o,r))&&(n=!1)}else String(o).toLowerCase()!==String(r).toLowerCase()&&(n=!1);return n}),!0)},t.prototype.getMethods=function(t){var e=this;return void 0===t?this.repo.getMethods():("string"==typeof t&&(t={name:t}),this.repo.getMethods().filter((function(n){return e.methodMatch(t,n.info)})))},t.prototype.getMethodsForInstance=function(t){var e=this,n=this.repo.getServers().filter((function(n){return e.instanceMatch(t,n.info)}));if(0===n.length)return[];var i={};return 1===n.length?i=n[0].methods:n.forEach((function(t){Object.keys(t.methods).forEach((function(e){var n=t.methods[e];i[n.id]=n}))})),Object.keys(i).map((function(t){return i[t]}))},t.prototype.getServers=function(t){var e=this,n=this.repo.getServers();return void 0===t?n.map((function(t){return{server:t}})):n.reduce((function(n,i){var o=e.repo.getServerMethodsById(i.id).filter((function(n){return e.methodMatch(t,n.info)}));return o.length>0&&n.push({server:i,methods:o}),n}),[])},t.prototype.getServerMethodsByFilterAndTarget=function(t,e){var n=this.getServers(t);return this.filterByTarget(e,n)},t}(),rt=function(){function t(t,e,n,i){var o=this;this.connection=t,this.instance=e,this.configuration=n,this.repository=i,this.respCounter=0,this.callbacks=b()(),this.timers={},this._pendingCallbacks={},this.timers={},this.streaming=new Q(n,e,(function(e){t.send("agm","MethodInvocationRequestMessage",e)}),(function(){return o.nextResponseSubject()})),this.listenForEvents()}return t.prototype.subscribe=function(t,e,n,i,o,r){this.streaming.subscribe(t,e,n,i,o,r)},t.prototype.onInvocationResult=function(t){this.callbacks.add("onResult",t)},t.prototype.invoke=function(t,e,n,i,o){var r=this,s=D(),a=e.info,c={MethodRequestSubject:a.requestSubject,MethodResponseSubject:this.nextResponseSubject(),Client:z(this.instance),Context:{ArgumentsJson:n,InvocationId:s,MethodName:a.name,ExecutionServer:i.info,Timeout:o.methodResponseTimeoutMs}};return this.onInvocationResult((function(t,e,n,i,o){return r.processInvocationResult(t,e,n,i,o)})),new Promise((function(t,i){r._pendingCallbacks[s]={invocationInfo:{method:e,calledWith:n},success:function(e){return t(e)},error:function(t){return i(t)}},r.connection.send("agm","MethodInvocationRequestMessage",c)}))},t.prototype.nextResponseSubject=function(){return"resp_"+this.respCounter+++"_"+D()},t.prototype.createServerInfo=function(t){return{machine:t.MachineName,pid:t.ProcessId,user:t.UserName,application:t.ApplicationName,environment:t.Environment,region:t.Region}},t.prototype.createMethod=function(t){var e=t.Method;return{name:e.Name,accepts:e.InputSignature,returns:e.ResultSignature,requestSubject:t.MethodRequestSubject,description:e.Description,displayName:e.DisplayName,version:e.Version,objectTypes:e.ObjectTypeRestrictions,supportsStreaming:J(e.Flags)}},t.prototype.createServerId=function(t){if(void 0!==t)return[t.application,t.user,t.machine,t.started,t.pid].join("/").toLowerCase()},t.prototype.processServerPresence=function(t,e){var n=t.Instance,i=this.createServerInfo(n),o=this.createServerId(i);if(e)o=this.repository.addServer(i,o),t.PublishingInterval&&this.scheduleTimeout(o,t.PublishingInterval);else if(0===t.PublishingInterval){void 0!==this.repository.getServerById(o)&&this.repository.removeServerById(o)}void 0!==t.MethodDefinitions&&this.updateServerMethods(o,t.MethodDefinitions)},t.prototype.scheduleTimeout=function(t,e){var n=this;if(-1!==e){var i=this.timers[t];void 0!==i&&clearTimeout(i),this.timers[t]=setTimeout((function(){n.repository.removeServerById(t)}),4*e)}},t.prototype.updateServerMethods=function(t,e){var n=this,i=this.repository.getServerMethodsById(t),o=e.map((function(t){return n.createMethod(t)})).reduce((function(t,e){return t[n.repository.createMethodId(e)]=e,t}),{});i.forEach((function(e){void 0===o[e.id]?n.repository.removeServerMethod(t,e.id):delete o[e.id]})),Object.keys(o).forEach((function(e){var i=o[e];n.repository.addServerMethod(t,i)}))},t.prototype.handleInvokeResultMessage=function(t){if(t&&t.EventStreamAction&&0!==t.EventStreamAction)this.streaming.processPublisherMsg(t);else{var e=t.Server?this.createServerInfo(t.Server):void 0,n=t.ResultContextJson;n&&0===Object.keys(n).length&&(n=void 0),this.callbacks.execute("onResult",t.InvocationId,e,t.Status,n,t.ResultMessage)}},t.prototype.listenForEvents=function(){var t=this;this.connection.on("agm","ServerPresenceMessage",(function(e){t.processServerPresence(e,!0)})),this.connection.on("agm","ServerHeartbeatMessage",(function(e){t.processServerPresence(e,!1)})),this.connection.on("agm","MethodInvocationResultMessage",(function(e){t.handleInvokeResultMessage(e)}))},t.prototype.processInvocationResult=function(t,e,n,i,o){var r=this._pendingCallbacks[t];void 0!==r&&(n===$.Success&&"function"==typeof r.success?r.success({invocationId:t,instance:e,result:i,message:o,status:$.Success}):"function"==typeof r.error&&r.error({invocationId:t,instance:e,result:i,message:o,status:$.Error}),delete this._pendingCallbacks[t])},t}(),st=function(){function t(t,e,n,i,o){var r=this;this.instance=t,this.session=e,this.repository=n,this.serverRepository=i,this.logger=o,this.ERR_URI_SUBSCRIPTION_FAILED="com.tick42.agm.errors.subscription.failure",this.callbacks=b()(),this.nextStreamId=0,e.on("add-interest",(function(t){r.handleAddInterest(t)})),e.on("remove-interest",(function(t){r.handleRemoveInterest(t)}))}return t.prototype.acceptRequestOnBranch=function(t,e,n){if("string"!=typeof n&&(n=""),"object"!=typeof e.protocolState.subscriptionsMap)throw new TypeError("The streaming method is missing its subscriptions.");if(!Array.isArray(e.protocolState.branchKeyToStreamIdMap))throw new TypeError("The streaming method is missing its branches.");var i=this.getStreamId(e,n),o=t.msg.subscription_id,r={id:o,arguments:t.arguments,instance:t.instance,branchKey:n,streamId:i,subscribeMsg:t.msg};e.protocolState.subscriptionsMap[o]=r,this.session.sendFireAndForget({type:"accepted",subscription_id:o,stream_id:i}),this.callbacks.execute("onSubscriptionAdded",r,e)},t.prototype.rejectRequest=function(t,e,n){"string"!=typeof n&&(n=""),this.sendSubscriptionFailed("Subscription rejected by user. "+n,t.msg.subscription_id)},t.prototype.pushData=function(t,e,n){var i=this;if("object"==typeof t&&Array.isArray(t.protocolState.branchKeyToStreamIdMap)){if("object"!=typeof e)throw new Error("Invalid arguments. Data must be an object.");"string"==typeof n?n=[n]:(!Array.isArray(n)||n.length<=0)&&(n=null),t.protocolState.branchKeyToStreamIdMap.filter((function(t){return null===n||Boolean(t)&&"string"==typeof t.key&&n.indexOf(t.key)>=0})).map((function(t){return t.streamId})).forEach((function(t){var n={type:"publish",stream_id:t,data:e};i.session.sendFireAndForget(n)}))}},t.prototype.pushDataToSingle=function(t,e,n){if("object"!=typeof n)throw new Error("Invalid arguments. Data must be an object.");var i={type:"post",subscription_id:e.id,data:n};this.session.sendFireAndForget(i)},t.prototype.closeSingleSubscription=function(t,e){delete t.protocolState.subscriptionsMap[e.id];var n={type:"drop-subscription",subscription_id:e.id,reason:"Server dropping a single subscription"};this.session.sendFireAndForget(n);e.instance;this.callbacks.execute("onSubscriptionRemoved",e,t)},t.prototype.closeMultipleSubscriptions=function(t,e){var n=this;if("object"==typeof t&&"object"==typeof t.protocolState.subscriptionsMap){var i=Object.keys(t.protocolState.subscriptionsMap).map((function(e){return t.protocolState.subscriptionsMap[e]}));"string"==typeof e&&(i=i.filter((function(t){return t.branchKey===e}))),i.forEach((function(e){delete t.protocolState.subscriptionsMap[e.id];var i={type:"drop-subscription",subscription_id:e.id,reason:"Server dropping all subscriptions on stream_id: "+e.streamId};n.session.sendFireAndForget(i)}))}},t.prototype.getSubscriptionList=function(t,e){if("object"!=typeof t)return[];var n=Object.keys(t.protocolState.subscriptionsMap).map((function(e){return t.protocolState.subscriptionsMap[e]}));return"string"!=typeof e?n:n.filter((function(t){return t.branchKey===e}))},t.prototype.getBranchList=function(t){if("object"!=typeof t)return[];var e=Object.keys(t.protocolState.subscriptionsMap).map((function(e){return t.protocolState.subscriptionsMap[e]})).map((function(t){var e=null;return"object"==typeof t&&"string"==typeof t.branchKey&&(e=t.branchKey),e})),n=[];return e.filter((function(t){return!(null===t||n.indexOf(t)>=0)&&(n.push(t),!0)}))},t.prototype.onSubAdded=function(t){this.onSubscriptionLifetimeEvent("onSubscriptionAdded",t)},t.prototype.onSubRequest=function(t){this.onSubscriptionLifetimeEvent("onSubscriptionRequest",t)},t.prototype.onSubRemoved=function(t){this.onSubscriptionLifetimeEvent("onSubscriptionRemoved",t)},t.prototype.handleRemoveInterest=function(t){var e=this.serverRepository.getById(t.method_id);if("string"==typeof t.subscription_id&&"object"==typeof e&&"object"==typeof e.protocolState.subscriptionsMap[t.subscription_id]){var n=e.protocolState.subscriptionsMap[t.subscription_id];delete e.protocolState.subscriptionsMap[t.subscription_id],this.callbacks.execute("onSubscriptionRemoved",n,e)}},t.prototype.onSubscriptionLifetimeEvent=function(t,e){this.callbacks.add(t,e)},t.prototype.getNextStreamId=function(){return this.nextStreamId+++""},t.prototype.handleAddInterest=function(t){var e=this.repository.getServerById(t.caller_id),n="function"==typeof e.getInfoForUser?e.getInfoForUser():null,i={msg:t,arguments:t.arguments_kv||{},instance:n},o=this.serverRepository.getById(t.method_id);if(void 0!==o)o.protocolState.subscriptionsMap&&o.protocolState.subscriptionsMap[t.subscription_id]?this.sendSubscriptionFailed("A subscription with id "+t.subscription_id+" already exists.",t.subscription_id):this.callbacks.execute("onSubscriptionRequest",i,o);else{var r="No method with id "+t.method_id+" on this server.";this.sendSubscriptionFailed(r,t.subscription_id)}},t.prototype.sendSubscriptionFailed=function(t,e){var n={type:"error",reason_uri:this.ERR_URI_SUBSCRIPTION_FAILED,reason:t,request_id:e};this.session.sendFireAndForget(n)},t.prototype.getStreamId=function(t,e){"string"!=typeof e&&(e="");var n=t.protocolState.branchKeyToStreamIdMap.filter((function(t){return t.key===e}))[0],i=n?n.streamId:void 0;return"string"==typeof i&&""!==i||(i=this.getNextStreamId(),t.protocolState.branchKeyToStreamIdMap.push({key:e,streamId:i})),i},t}(),at=function(t,e,n,i){return new(n||(n=Promise))((function(o,r){function s(t){try{c(i.next(t))}catch(t){r(t)}}function a(t){try{c(i.throw(t))}catch(t){r(t)}}function c(t){var e;t.done?o(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(s,a)}c((i=i.apply(t,e||[])).next())}))},ct=function(t,e){var n,i,o,r,s={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return r={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(r[Symbol.iterator]=function(){return this}),r;function a(r){return function(a){return function(r){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,i&&(o=2&r[0]?i.return:r[0]?i.throw||((o=i.return)&&o.call(i),0):i.next)&&!(o=o.call(i,r[1])).done)return o;switch(i=0,o&&(r=[2&r[0],o.value]),r[0]){case 0:case 1:o=r;break;case 4:return s.label++,{value:r[1],done:!1};case 5:s.label++,i=r[1],r=[0];continue;case 7:r=s.ops.pop(),s.trys.pop();continue;default:if(!(o=(o=s.trys).length>0&&o[o.length-1])&&(6===r[0]||2===r[0])){s=0;continue}if(3===r[0]&&(!o||r[1]>o[0]&&r[1]<o[3])){s.label=r[1];break}if(6===r[0]&&s.label<o[1]){s.label=o[1],o=r;break}if(o&&s.label<o[2]){s.label=o[2],s.ops.push(r);break}o[2]&&s.ops.pop(),s.trys.pop();continue}r=e.call(t,s)}catch(t){r=[6,t],i=0}finally{n=o=0}if(5&r[0])throw r[1];return{value:r[0]?r[1]:void 0,done:!0}}([r,a])}}},ut=function(){function t(t,e,n,i,o){var r=this;this.session=e,this.clientRepository=n,this.serverRepository=i,this.logger=o,this.callbacks=b()(),this.streaming=new st(t,e,n,i,o),this.session.on("invoke",(function(t){return r.handleInvokeMessage(t)}))}return t.prototype.createStream=function(t){return t.protocolState.subscriptionsMap={},t.protocolState.branchKeyToStreamIdMap=[],this.register(t,!0)},t.prototype.register=function(t,e){var n=this,i=t.definition,o={streaming:e||!1};this.logger.debug('registering method "'+i.name+'"');var r={type:"register",methods:[{id:t.repoId,name:i.name,display_name:i.displayName,description:i.description,version:i.version,flags:o,object_types:i.objectTypes||i.object_types,input_signature:i.accepts,result_signature:i.returns,restrictions:void 0}]};return this.session.send(r,{methodId:t.repoId}).then((function(){n.logger.debug("registered method "+t.definition.name+" with id "+t.repoId)})).catch((function(e){throw n.logger.warn(JSON.stringify(e)),n.logger.debug("failed to register method "+t.definition.name+" with id "+t.repoId),e}))},t.prototype.onInvoked=function(t){this.callbacks.add("onInvoked",t)},t.prototype.methodInvocationResult=function(t,e,n,i){var o;o=n||""===n?{type:"error",request_id:e,reason_uri:"agm.errors.client_error",reason:n,context:i,peer_id:void 0}:{type:"yield",invocation_id:e,peer_id:this.session.peerId,result:i,request_id:void 0},this.session.sendFireAndForget(o)},t.prototype.unregister=function(t){return at(this,void 0,void 0,(function(){var e;return ct(this,(function(n){switch(n.label){case 0:return e={type:"unregister",methods:[t.repoId]},[4,this.session.send(e)];case 1:return n.sent(),[2]}}))}))},t.prototype.getBranchList=function(t){return this.streaming.getBranchList(t)},t.prototype.getSubscriptionList=function(t,e){return this.streaming.getSubscriptionList(t,e)},t.prototype.closeAllSubscriptions=function(t,e){this.streaming.closeMultipleSubscriptions(t,e)},t.prototype.pushData=function(t,e,n){this.streaming.pushData(t,e,n)},t.prototype.pushDataToSingle=function(t,e,n){this.streaming.pushDataToSingle(t,e,n)},t.prototype.closeSingleSubscription=function(t,e){this.streaming.closeSingleSubscription(t,e)},t.prototype.acceptRequestOnBranch=function(t,e,n){this.streaming.acceptRequestOnBranch(t,e,n)},t.prototype.rejectRequest=function(t,e,n){this.streaming.rejectRequest(t,e,n)},t.prototype.onSubRequest=function(t){this.streaming.onSubRequest(t)},t.prototype.onSubAdded=function(t){this.streaming.onSubAdded(t)},t.prototype.onSubRemoved=function(t){this.streaming.onSubRemoved(t)},t.prototype.handleInvokeMessage=function(t){var e=t.invocation_id,n=t.caller_id,i=t.method_id,o=t.arguments_kv;this.logger.debug('received invocation for method id "'+i+'" from peer '+n);var r=this.serverRepository.getList().filter((function(t){return t.repoId===i}))[0];if(void 0!==r){var s={args:o,instance:this.clientRepository.getServerById(n).getInfoForUser()};this.callbacks.execute("onInvoked",r,e,s)}},t}(),dt="awaitingAccept",pt="subscribed",ft="Subscription rejected.",ht=function(){function t(t,e,n,i){var o=this;this.instance=t,this.session=e,this.repository=n,this.logger=i,this.subscriptionsList={},this.subscriptionIdToLocalKeyMap={},this.nextSubLocalKey=0,this.handleErrorSubscribing=function(t){var e=t._tag,n=e.subLocalKey,i=o.subscriptionsList[n];if("object"==typeof i&&(i.trackedServers=i.trackedServers.filter((function(t){return t.serverId!==e.serverId})),i.trackedServers.length<=0)){if(clearTimeout(i.timeoutId),i.status===dt){var r="string"==typeof t.reason&&""!==t.reason?' Publisher said "'+t.reason+'".':" No reason given.",s="object"==typeof i.arguments?JSON.stringify(i.arguments):"{}";i.error({message:ft+r+" Called with:"+s,called_with:i.arguments,method:i.method.getInfoForUser()})}else i.status===pt&&o.callOnClosedHandlers(i);delete o.subscriptionsList[n]}},this.handleSubscribed=function(t){var e=t._tag.subLocalKey,n=o.subscriptionsList[e];if("object"==typeof n){var i=t._tag.serverId,r=n.trackedServers.filter((function(t){return t.serverId===i}))[0];if("object"==typeof r){r.subscriptionId=t.subscription_id,o.subscriptionIdToLocalKeyMap[t.subscription_id]=e;var s=n.status===dt;n.status=pt;var a=o;s&&n.success({onData:function(t){if("function"!=typeof t)throw new TypeError("The data callback must be a function.");n.handlers.onData.push(t),1===n.handlers.onData.length&&n.queued.data.length>0&&n.queued.data.forEach((function(e){t(e)}))},onClosed:function(t){if("function"!=typeof t)throw new TypeError("The callback must be a function.");n.handlers.onClosed.push(t)},onFailed:function(){},close:function(){return a.closeSubscription(e)},requestArguments:n.arguments,serverInstance:a.repository.getServerById(i).getInfoForUser(),stream:n.method.info})}}},this.handleEventData=function(t){var e=o.subscriptionIdToLocalKeyMap[t.subscription_id];if(void 0!==e){var n=o.subscriptionsList[e];if("object"==typeof n){var i=n.trackedServers.filter((function(e){return e.subscriptionId===t.subscription_id}));if(1===i.length){var r=t.oob,s=i[0].serverId,a=function(){return{data:t.data,server:o.repository.getServerById(s).getInfoForUser(),requestArguments:n.arguments,message:null,private:r}},c=n.handlers.onData,u=n.queued.data;c.length>0?c.forEach((function(t){"function"==typeof t&&t(a())})):u.push(a())}}}},this.handleSubscriptionCancelled=function(t){var e=o.subscriptionIdToLocalKeyMap[t.subscription_id];if(void 0!==e){var n=o.subscriptionsList[e];if("object"==typeof n){var i=n.trackedServers.length-1;n.trackedServers=n.trackedServers.filter((function(e){return e.subscriptionId!==t.subscription_id||(n.queued.closers.push(e.serverId),!1)})),n.trackedServers.length===i&&(n.trackedServers.length<=0&&(clearTimeout(n.timeoutId),o.callOnClosedHandlers(n),delete o.subscriptionsList[e]),delete o.subscriptionIdToLocalKeyMap[t.subscription_id])}}},e.on("subscribed",this.handleSubscribed),e.on("event",this.handleEventData),e.on("subscription-cancelled",this.handleSubscriptionCancelled)}return t.prototype.subscribe=function(t,e,n,i,o,r){var s=this;if(0!==n.length){var a=this.getNextSubscriptionLocalKey(),c=this.registerSubscription(a,t,e,o,r,i.methodResponseTimeout);"object"==typeof c?n.forEach((function(n){var i=n.server.id,o=n.methods.find((function(e){return e.info.name===t.info.name}));c.trackedServers.push({serverId:i,subscriptionId:void 0});var r={type:"subscribe",server_id:i,method_id:o.protocolState.id,arguments_kv:e};s.session.send(r,{serverId:i,subLocalKey:a}).then((function(t){return s.handleSubscribed(t)})).catch((function(t){return s.handleErrorSubscribing(t)}))})):r({method:t.getInfoForUser(),called_with:e,message:"Subscription failed. Unable to register the user callbacks."})}else r({method:t.getInfoForUser(),called_with:e,message:"Subscription failed. No available servers matched the target params."})},t.prototype.getNextSubscriptionLocalKey=function(){var t=this.nextSubLocalKey;return this.nextSubLocalKey+=1,t},t.prototype.registerSubscription=function(t,e,n,i,o,r){var s=this;return this.subscriptionsList[t]={status:dt,method:e,arguments:n,success:i,error:o,trackedServers:[],handlers:{onData:[],onClosed:[]},queued:{data:[],closers:[]},timeoutId:void 0},this.subscriptionsList[t].timeoutId=setTimeout((function(){if(void 0!==s.subscriptionsList[t]){var i=s.subscriptionsList[t];i.status===dt?(o({method:e.getInfoForUser(),called_with:n,message:"Subscription failed. Subscription attempt timed out after "+r+" ms."}),delete s.subscriptionsList[t]):i.status===pt&&i.trackedServers.length>0&&(i.trackedServers=i.trackedServers.filter((function(t){return void 0!==t.subscriptionId})),delete i.timeoutId,i.trackedServers.length<=0&&(s.callOnClosedHandlers(i),delete s.subscriptionsList[t]))}}),r),this.subscriptionsList[t]},t.prototype.callOnClosedHandlers=function(t,e){var n=t.queued.closers.length,i=n>0?t.queued.closers[n-1]:null,o=null;void 0!==i&&"string"==typeof i&&(o=this.repository.getServerById(i).getInfoForUser()),t.handlers.onClosed.forEach((function(n){"function"==typeof n&&n({message:e||"ServerInitiated",requestArguments:t.arguments,server:o,stream:t.method})}))},t.prototype.closeSubscription=function(t){var e=this,n=this.subscriptionsList[t];"object"==typeof n&&(n.trackedServers.forEach((function(t){void 0!==t.subscriptionId&&(n.queued.closers.push(t.serverId),e.session.sendFireAndForget({type:"unsubscribe",subscription_id:t.subscriptionId,reason_uri:"",reason:"ClientInitiated"}),delete e.subscriptionIdToLocalKeyMap[t.subscriptionId])})),n.trackedServers=[],this.callOnClosedHandlers(n,"ClientInitiated"),delete this.subscriptionsList[t])},t}(),lt=function(){function t(t,e,n,i){var o=this;this.instance=t,this.session=e,this.repository=n,this.logger=i,this.callbacks=b()(),e.on("peer-added",(function(t){return o.handlePeerAdded(t)})),e.on("peer-removed",(function(t){return o.handlePeerRemoved(t)})),e.on("methods-added",(function(t){return o.handleMethodsAddedMessage(t)})),e.on("methods-removed",(function(t){return o.handleMethodsRemovedMessage(t)})),this.streaming=new ht(t,e,n,i)}return t.prototype.subscribe=function(t,e,n,i,o,r){this.streaming.subscribe(t,e,n,i,o,r)},t.prototype.invoke=function(t,e,n,i){var o=this,r=i.id,s={type:"call",server_id:r,method_id:e.protocolState.id,arguments_kv:n};return this.session.send(s,{invocationId:t,serverId:r}).then((function(t){return o.handleResultMessage(t)})).catch((function(t){return o.handleInvocationError(t)}))},t.prototype.handlePeerAdded=function(t){var e=t.new_peer_id,n=t.identity,i=!t.meta||t.meta.local,o=Number(n.process),r={machine:n.machine,pid:isNaN(o)?n.process:o,instance:n.instance,application:n.application,applicationName:n.applicationName,environment:n.environment,region:n.region,user:n.user,windowId:n.windowId,peerId:e,api:n.api,isLocal:i};this.repository.addServer(r,e)},t.prototype.handlePeerRemoved=function(t){var e=t.removed_id,n=t.reason;this.repository.removeServerById(e,n)},t.prototype.handleMethodsAddedMessage=function(t){var e=this,n=t.server_id;t.methods.forEach((function(t){var i={name:t.name,displayName:t.display_name,description:t.description,version:t.version,objectTypes:t.object_types||[],accepts:t.input_signature,returns:t.result_signature,supportsStreaming:void 0!==t.flags&&t.flags.streaming};e.repository.addServerMethod(n,i,{id:t.id})}))},t.prototype.handleMethodsRemovedMessage=function(t){var e=this,n=t.server_id,i=t.methods,o=this.repository.getServerById(n);Object.keys(o.methods).forEach((function(t){var r=o.methods[t];i.indexOf(r.protocolState.id)>-1&&e.repository.removeServerMethod(n,t)}))},t.prototype.handleResultMessage=function(t){var e=t._tag.invocationId,n=t.result,i=t._tag.serverId;return{invocationId:e,result:n,instance:this.repository.getServerById(i).getInfoForUser(),status:$.Success,message:""}},t.prototype.handleInvocationError=function(t){this.logger.debug("handle invocation error "+JSON.stringify(t));var e=t._tag.invocationId,n=t._tag.serverId,i=this.repository.getServerById(n),o=t.reason;return{invocationId:e,result:t.context,instance:i.getInfoForUser(),status:$.Error,message:o}},t}(),yt=function(t,e,n,i,o,r){var s,a=o.logger.subLogger("gw3-protocol"),c=new Promise((function(t){s=t})),u=e.domain("agm",a.subLogger("domain"),["subscribed"]),d=new ut(t,u,n,i,a.subLogger("server")),p=new lt(t,u,n,a.subLogger("client"));return u.onJoined((function(o){o?function(){a.info("reconnected - will replay registered methods and subscriptions"),n.reset(),n.addServer(t,e.peerId);var o=i.getList();i.reset(),o.forEach((function(t){var e=t.definition;t.theFunction.userCallback?r().register(e,t.theFunction.userCallback):t.theFunction.userCallbackAsync&&r().registerAsync(e,t.theFunction.userCallbackAsync)}))}():(n.addServer(t,e.peerId),s({client:p,server:d}),s=void 0)})),u.join(),c},vt=function(){function t(t,e,n){this.protocol=t,this.repoMethod=e,this.subscription=n}return Object.defineProperty(t.prototype,"stream",{get:function(){return this.repoMethod.stream},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"arguments",{get:function(){return this.subscription.arguments||{}},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"branchKey",{get:function(){return this.subscription.branchKey},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"instance",{get:function(){return this.subscription.instance},enumerable:!0,configurable:!0}),t.prototype.close=function(){this.protocol.server.closeSingleSubscription(this.repoMethod,this.subscription)},t.prototype.push=function(t){this.protocol.server.pushDataToSingle(this.repoMethod,this.subscription,t)},t}(),gt=function(){function t(t,e,n){this.protocol=t,this.repoMethod=e,this.requestContext=n,this.arguments=n.arguments,this.instance=n.instance}return t.prototype.accept=function(){this.protocol.server.acceptRequestOnBranch(this.requestContext,this.repoMethod,"")},t.prototype.acceptOnBranch=function(t){this.protocol.server.acceptRequestOnBranch(this.requestContext,this.repoMethod,t)},t.prototype.reject=function(t){this.protocol.server.rejectRequest(this.requestContext,this.repoMethod,t)},t}(),mt=function(){function t(t,e){var n=this;this.protocol=t,this.server=e,t.server.onSubRequest((function(t,e){return n.handleSubRequest(t,e)})),t.server.onSubAdded((function(t,e){return n.handleSubAdded(t,e)})),t.server.onSubRemoved((function(t,e){return n.handleSubRemoved(t,e)}))}return t.prototype.handleSubRequest=function(t,e){if(e&&e.streamCallbacks&&"function"==typeof e.streamCallbacks.subscriptionRequestHandler){var n=new gt(this.protocol,e,t);e.streamCallbacks.subscriptionRequestHandler(n)}},t.prototype.handleSubAdded=function(t,e){if(e&&e.streamCallbacks&&"function"==typeof e.streamCallbacks.subscriptionAddedHandler){var n=new vt(this.protocol,e,t);e.streamCallbacks.subscriptionAddedHandler(n)}},t.prototype.handleSubRemoved=function(t,e){if(e&&e.streamCallbacks&&"function"==typeof e.streamCallbacks.subscriptionRemovedHandler){var n=new vt(this.protocol,e,t);e.streamCallbacks.subscriptionRemovedHandler(n)}},t}(),bt=function(){function t(t,e,n){this.key=t,this.protocol=e,this.repoMethod=n}return t.prototype.subscriptions=function(){var t=this;return this.protocol.server.getSubscriptionList(this.repoMethod,this.key).map((function(e){return new vt(t.protocol,t.repoMethod,e)}))},t.prototype.close=function(){this.protocol.server.closeAllSubscriptions(this.repoMethod,this.key)},t.prototype.push=function(t){this.protocol.server.pushData(this.repoMethod,t,[this.key])},t}(),wt=function(){function t(t,e,n){this.protocol=t,this.repoMethod=e,this.server=n,this.def=e.definition}return Object.defineProperty(t.prototype,"name",{get:function(){return this.def.name},enumerable:!0,configurable:!0}),t.prototype.branches=function(t){var e=this,n=this.protocol.server.getBranchList(this.repoMethod);return t?n.indexOf(t)>-1?new bt(t,this.protocol,this.repoMethod):void 0:n.map((function(t){return new bt(t,e.protocol,e.repoMethod)}))},t.prototype.subscriptions=function(){var t=this;return this.protocol.server.getSubscriptionList(this.repoMethod).map((function(e){return new vt(t.protocol,t.repoMethod,e)}))},Object.defineProperty(t.prototype,"definition",{get:function(){var t=this.def;return{accepts:t.accepts,description:t.description,displayName:t.displayName,name:t.name,objectTypes:t.objectTypes,returns:t.returns,supportsStreaming:t.supportsStreaming}},enumerable:!0,configurable:!0}),t.prototype.close=function(){this.protocol.server.closeAllSubscriptions(this.repoMethod),this.server.unregister(this.repoMethod.definition,!0)},t.prototype.push=function(t,e){if("string"!=typeof e&&!Array.isArray(e)&&void 0!==e)throw new Error("invalid branches should be string or string array");if("object"!=typeof t)throw new Error("Invalid arguments. Data must be an object.");this.protocol.server.pushData(this.repoMethod,t,e)},t}(),_t=function(){return(_t=Object.assign||function(t){for(var e,n=1,i=arguments.length;n<i;n++)for(var o in e=arguments[n])Object.prototype.hasOwnProperty.call(e,o)&&(t[o]=e[o]);return t}).apply(this,arguments)},St=function(t,e,n,i){return new(n||(n=Promise))((function(o,r){function s(t){try{c(i.next(t))}catch(t){r(t)}}function a(t){try{c(i.throw(t))}catch(t){r(t)}}function c(t){var e;t.done?o(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(s,a)}c((i=i.apply(t,e||[])).next())}))},It=function(t,e){var n,i,o,r,s={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return r={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(r[Symbol.iterator]=function(){return this}),r;function a(r){return function(a){return function(r){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,i&&(o=2&r[0]?i.return:r[0]?i.throw||((o=i.return)&&o.call(i),0):i.next)&&!(o=o.call(i,r[1])).done)return o;switch(i=0,o&&(r=[2&r[0],o.value]),r[0]){case 0:case 1:o=r;break;case 4:return s.label++,{value:r[1],done:!1};case 5:s.label++,i=r[1],r=[0];continue;case 7:r=s.ops.pop(),s.trys.pop();continue;default:if(!(o=(o=s.trys).length>0&&o[o.length-1])&&(6===r[0]||2===r[0])){s=0;continue}if(3===r[0]&&(!o||r[1]>o[0]&&r[1]<o[3])){s.label=r[1];break}if(6===r[0]&&s.label<o[1]){s.label=o[1],o=r;break}if(o&&s.label<o[2]){s.label=o[2],s.ops.push(r);break}o[2]&&s.ops.pop(),s.trys.pop();continue}r=e.call(t,s)}catch(t){r=[6,t],i=0}finally{n=o=0}if(5&r[0])throw r[1];return{value:r[0]?r[1]:void 0,done:!0}}([r,a])}}},At=function(){for(var t=0,e=0,n=arguments.length;e<n;e++)t+=arguments[e].length;var i=Array(t),o=0;for(e=0;e<n;e++)for(var r=arguments[e],s=0,a=r.length;s<a;s++,o++)i[o]=r[s];return i},Ct=function(){function t(t,e,n,i){this.protocol=t,this.serverRepository=e,this.instance=n,this.configuration=i,this.invocations=0,this.currentlyUnregistering={},this.streaming=new mt(t,this),this.protocol.server.onInvoked(this.onMethodInvoked.bind(this))}return t.prototype.createStream=function(t,e,n,i){var o=this,r=new Promise((function(n,i){var r;if(t||i("The stream name must be unique! Please, provide either a unique string for a stream name to “glue.interop.createStream()” or a “methodDefinition” object with a unique “name” property for the stream."),!(r="string"==typeof t?{name:""+t}:_t({},t)).name)return i("The “name” property is required for the “streamDefinition” object and must be unique. Stream definition: "+JSON.stringify(r));if(o.serverRepository.getList().some((function(t){return t.definition.name===r.name})))return i('A stream with the name "'+r.name+'" already exists! Please, provide a unique name for the stream.');r.supportsStreaming=!0,e||(e={}),"function"!=typeof e.subscriptionRequestHandler&&(e.subscriptionRequestHandler=function(t){t.accept()});var s={definition:r,streamCallbacks:e,protocolState:{}};o.serverRepository.add(s),o.protocol.server.createStream(s).then((function(){var t=new wt(o.protocol,s,o);s.stream=t,n(t)})).catch((function(t){o.serverRepository.remove(s.repoId),i(t)}))}));return G(r,n,i)},t.prototype.register=function(t,e){var n=this;if(!t)return Promise.reject("Method definition is required. Please, provide either a unique string for a method name or a “methodDefinition” object with a required “name” property.");if("function"!=typeof e)return Promise.reject("The second parameter must be a callback function. Method: "+("string"==typeof t?t:t.name));var i=function(t,i){return St(n,void 0,void 0,(function(){var n,o,r;return It(this,(function(s){switch(s.label){case 0:return s.trys.push([0,4,,5]),(n=e(t.args,t.instance))&&"function"==typeof n.then?[4,n]:[3,2];case 1:return o=s.sent(),i(null,o),[3,3];case 2:i(null,n),s.label=3;case 3:return[3,5];case 4:return(r=s.sent())||(r=""),i(r,r),[3,5];case 5:return[2]}}))}))};return i.userCallback=e,this.registerCore(t,i)},t.prototype.registerAsync=function(t,e){if(!t)return Promise.reject("Method definition is required. Please, provide either a unique string for a method name or a “methodDefinition” object with a required “name” property.");if("function"!=typeof e)return Promise.reject("The second parameter must be a callback function. Method: "+("string"==typeof t?t:t.name));var n=function(t,n){try{var i=!1,o=function(t){i||n(null,t),i=!0},r=function(t){i||(t||(t=""),n(t,t)),i=!0},s=e(t.args,t.instance,o,r);s&&"function"==typeof s.then&&s.then(o).catch(r)}catch(t){n(t,null)}};return n.userCallbackAsync=e,this.registerCore(t,n)},t.prototype.unregister=function(t,e){return void 0===e&&(e=!1),St(this,void 0,void 0,(function(){var n,i;return It(this,(function(o){switch(o.label){case 0:return void 0===t?[2,Promise.reject("Please, provide either a unique string for a name or an object containing a “name” property.")]:"function"!=typeof t?[3,2]:[4,this.unregisterWithPredicate(t,e)];case 1:return o.sent(),[2];case 2:return void 0===(n="string"==typeof t?{name:t}:t).name?[2,Promise.reject("Method name is required. Cannot find a method if the method name is undefined!")]:(i=this.serverRepository.getList().find((function(t){return t.definition.name===n.name&&(t.definition.supportsStreaming||!1)===e})))?[4,this.removeMethodsOrStreams([i])]:[2,Promise.reject('Method with a name "'+n.name+'" does not exist or is not registered by your application!')];case 3:return o.sent(),[2]}}))}))},t.prototype.unregisterWithPredicate=function(t,e){return St(this,void 0,void 0,(function(){var n;return It(this,(function(i){switch(i.label){case 0:return(n=this.serverRepository.getList().filter((function(e){return t(e.definition)})).filter((function(t){return(t.definition.supportsStreaming||!1)===e})))&&0!==n.length?[4,this.removeMethodsOrStreams(n)]:[2,Promise.reject("Could not find a "+(e?"stream":"method")+" matching the specified condition!")];case 1:return i.sent(),[2]}}))}))},t.prototype.removeMethodsOrStreams=function(t){var e=this,n=[];return t.forEach((function(t){var i=e.protocol.server.unregister(t).then((function(){e.serverRepository.remove(t.repoId)}));n.push(i),e.addAsCurrentlyUnregistering(t.definition.name,i)})),Promise.all(n)},t.prototype.addAsCurrentlyUnregistering=function(t,e){return St(this,void 0,void 0,(function(){var n=this;return It(this,(function(i){return this.currentlyUnregistering[t]=e.then((function(){var e,i;e=n.currentlyUnregistering,i=t,Object.keys(e).reduce((function(t,n){return n!==i&&(t[n]=e[n]),t}),{})})),[2]}))}))},t.prototype.registerCore=function(t,e){return St(this,void 0,void 0,(function(){var n,i,o,r=this;return It(this,(function(s){switch(s.label){case 0:return(n="string"==typeof t?{name:""+t}:_t({},t)).name?(i=this.currentlyUnregistering[n.name])?[4,i]:[3,2]:[2,Promise.reject("Please, provide a (unique) string value for the “name” property in the “methodDefinition” object: "+JSON.stringify(t))];case 1:s.sent(),s.label=2;case 2:return this.serverRepository.getList().some((function(t){return t.definition.name===n.name}))?[2,Promise.reject('A method with the name "'+n.name+'" already exists! Please, provide a unique name for the method.')]:n.supportsStreaming?[2,Promise.reject("When you create methods with “glue.interop.register()” or “glue.interop.registerAsync()” the property “supportsStreaming” cannot be “true”. If you want “"+n.name+"” to be a stream, please use the “glue.interop.createStream()” method.")]:(o=this.serverRepository.add({definition:n,theFunction:e,protocolState:{}}),[2,this.protocol.server.register(o).catch((function(t){throw r.serverRepository.remove(o.repoId),t}))])}}))}))},t.prototype.containsProps=function(t,e){var n=Object.keys(t).filter((function(e){return"function"!=typeof t[e]&&"object_types"!==e&&"display_name"!==e})),i=Object.keys(e);return Array.from(new Set(At(n,i))).reduce((function(n,i){var o=t[i],r=e[i];if("supportsStreaming"===i&&(r=r||!1,o=o||!1),"objectTypes"===i&&void 0!==o&&void 0!==r)if(o.length!==r.length)n=!1;else{var s=o.sort(),a=r.sort();s.some((function(t,e){return t!==a[e]}))&&(n=!1)}else o!==r&&(n=!1);return n}),!0)},t.prototype.onMethodInvoked=function(t,e,n){var i=this;t&&t.theFunction(n,(function(n,o){if(null!=n)if(n.message&&"string"==typeof n.message)n=n.message;else if("string"!=typeof n)try{n=JSON.stringify(n)}catch(t){n="un-stringifyable error in onMethodInvoked! Top level prop names: "+Object.keys(n)}o&&"object"==typeof o&&o.constructor!==Array||(o={_result:o}),i.protocol.server.methodInvocationResult(t,e,n,o)}))},t}(),Tt=function(){function t(t,e,n,i,o){var r=this;this.protocol=t,this.clientRepository=e,this.serverRepository=n,this.instance=i,this.configuration=o,i.getMethods||(i.getMethods=function(){return r.methodsForInstance(i).filter((function(t){return!t.supportsStreaming}))}),i.getStreams||(i.getStreams=function(){return r.methodsForInstance(i).filter((function(t){return t.supportsStreaming}))}),this.client=new ot(t,e,i,o),this.server=new Ct(t,n,i,o)}return t.prototype.serverRemoved=function(t){return this.client.serverRemoved(t)},t.prototype.serverAdded=function(t){return this.client.serverAdded(t)},t.prototype.serverMethodRemoved=function(t){return this.client.serverMethodRemoved(t)},t.prototype.serverMethodAdded=function(t){return this.client.serverMethodAdded(t)},t.prototype.methodRemoved=function(t){return this.client.methodRemoved(t)},t.prototype.methodAdded=function(t){return this.client.methodAdded(t)},t.prototype.methodsForInstance=function(t){return this.client.methodsForInstance(t)},t.prototype.methods=function(t){return this.client.methods(t)},t.prototype.servers=function(t){return this.client.servers(t)},t.prototype.subscribe=function(t,e,n,i){return this.client.subscribe(t,e,n,i)},t.prototype.createStream=function(t,e,n,i){return this.server.createStream(t,e,n,i)},t.prototype.unregister=function(t){return this.server.unregister(t)},t.prototype.registerAsync=function(t,e){return this.server.registerAsync(t,e)},t.prototype.register=function(t,e){return this.server.register(t,e)},t.prototype.invoke=function(t,e,n,i,o,r){return this.client.invoke(t,e,n,i,o,r)},t.prototype.updateInstance=function(t){void 0===this.instance.machine&&(this.instance.machine=t.MachineName||t.machine),void 0===this.instance.user&&(this.instance.user=t.UserName||t.user),void 0===this.instance.environment&&(this.instance.environment=t.Environment||t.environment),void 0===this.instance.region&&(this.instance.region=t.Region||t.region)},t}(),Mt=function(){function t(){this.servers={},this.methodsCount={},this.callbacks=b()()}return t.prototype.addServer=function(t,e){var n=this,i=this.servers[e];if(i)return i.id;var o={id:e,info:t,methods:{},getInfoForUser:function(){var t=n.createUserServerInfo(o.info);return t.getMethods=function(){return n.getServerMethodsById(o.id).map((function(t){return t.getInfoForUser()}))},t.getStreams=function(){return n.getServerMethodsById(o.id).filter((function(t){return t.info.supportsStreaming})).map((function(t){return t.getInfoForUser()}))},t}};return this.servers[e]=o,this.callbacks.execute("onServerAdded",o),e},t.prototype.removeServerById=function(t,e){var n=this,i=this.servers[t];Object.keys(i.methods).forEach((function(e){n.removeServerMethod(t,e)})),delete this.servers[t],this.callbacks.execute("onServerRemoved",i,e)},t.prototype.addServerMethod=function(t,e,n){n||(n={});var i=this.servers[t];if(!i)throw new Error("server does not exists");var o=this.createMethodId(e);if(!i.methods[o]){var r=this,s={id:o,info:e,getInfoForUser:function(){var t=r.createUserMethodInfo(s.info);return t.getServers=function(){return r.getServersByMethod(o)},t},protocolState:n};i.methods[o]=s,this.methodsCount[o]||(this.methodsCount[o]=0,this.callbacks.execute("onMethodAdded",s)),this.methodsCount[o]=this.methodsCount[o]+1,this.callbacks.execute("onServerMethodAdded",i,s)}},t.prototype.createMethodId=function(t){var e=void 0!==t.accepts?t.accepts:"",n=void 0!==t.returns?t.returns:"";return(t.name+e+n).toLowerCase()},t.prototype.removeServerMethod=function(t,e){var n=this.servers[t];if(!n)throw new Error("server does not exists");var i=n.methods[e];delete n.methods[e],this.methodsCount[e]=this.methodsCount[e]-1,0===this.methodsCount[e]&&this.callbacks.execute("onMethodRemoved",i),this.callbacks.execute("onServerMethodRemoved",n,i)},t.prototype.getMethods=function(){var t=this,e={};return Object.keys(this.servers).forEach((function(n){var i=t.servers[n];Object.keys(i.methods).forEach((function(t){var n=i.methods[t];e[n.id]=n}))})),Object.keys(e).map((function(t){return e[t]}))},t.prototype.getServers=function(){var t=this,e=[];return Object.keys(this.servers).forEach((function(n){var i=t.servers[n];e.push(i)})),e},t.prototype.getServerMethodsById=function(t){var e=this.servers[t];return Object.keys(e.methods).map((function(t){return e.methods[t]}))},t.prototype.onServerAdded=function(t){var e=this.callbacks.add("onServerAdded",t),n=this.getServers();return this.returnUnsubWithDelayedReplay(e,n,t)},t.prototype.onMethodAdded=function(t){var e=this.callbacks.add("onMethodAdded",t),n=this.getMethods();return this.returnUnsubWithDelayedReplay(e,n,t)},t.prototype.onServerMethodAdded=function(t){var e=this.callbacks.add("onServerMethodAdded",t),n=!1,i=this.getServers();return setTimeout((function(){i.forEach((function(e){var i=e.methods;Object.keys(i).forEach((function(o){n||t(e,i[o])}))}))}),0),function(){n=!0,e()}},t.prototype.onMethodRemoved=function(t){return this.callbacks.add("onMethodRemoved",t)},t.prototype.onServerRemoved=function(t){return this.callbacks.add("onServerRemoved",t)},t.prototype.onServerMethodRemoved=function(t){return this.callbacks.add("onServerMethodRemoved",t)},t.prototype.getServerById=function(t){return this.servers[t]},t.prototype.reset=function(){this.servers={},this.methodsCount={}},t.prototype.createUserServerInfo=function(t){return{machine:t.machine,pid:t.pid,user:t.user,application:t.application,applicationName:t.applicationName,environment:t.environment,region:t.region,instance:t.instance,windowId:t.windowId,peerId:t.peerId,isLocal:t.isLocal,api:t.api}},t.prototype.createUserMethodInfo=function(t){var e={name:t.name,accepts:t.accepts,returns:t.returns,description:t.description,displayName:t.displayName,objectTypes:t.objectTypes,supportsStreaming:t.supportsStreaming};return e.object_types=t.objectTypes,e.display_name=t.displayName,e.version=t.version,e},t.prototype.getServersByMethod=function(t){var e=this,n=[];return Object.keys(this.servers).forEach((function(i){var o=e.servers[i];Object.keys(o.methods).forEach((function(e){e===t&&n.push(o.getInfoForUser())}))})),n},t.prototype.returnUnsubWithDelayedReplay=function(t,e,n){var i=!1;return setTimeout((function(){e.forEach((function(t){i||n(t)}))}),0),function(){i=!0,t()}},t}(),xt=function(){function t(){this.nextId=0,this.methods=[]}return t.prototype.add=function(t){if("object"==typeof t&&void 0===t.repoId)return t.repoId=String(this.nextId),this.nextId+=1,this.methods.push(t),t},t.prototype.remove=function(t){if("string"!=typeof t)return new TypeError("Expecting a string");this.methods=this.methods.filter((function(e){return e.repoId!==t}))},t.prototype.getById=function(t){if("string"==typeof t)return this.methods.filter((function(e){return e.repoId===t}))[0]},t.prototype.getList=function(){return this.methods.map((function(t){return t}))},t.prototype.length=function(){return this.methods.length},t.prototype.reset=function(){this.methods=[]},t}(),kt=function(t){if(!t.forceGW&&2===t.gdVersion)return function(t){var e=window.htmlContainer.jsAgmFacade,n=q(t);return new Promise((function(t,i){var o=function(n){var i=new B(n,new H(e),e);i.create_stream=i.createStream,i.methods_for_instance=i.methodsForInstance,i.method_added=i.methodAdded,i.method_removed=i.methodRemoved,i.server_added=i.serverAdded,i.server_removed=i.serverRemoved,i.server_method_added=i.serverMethodAdded,i.server_method_removed=i.serverMethodRemoved,t(i)};e.protocolVersion&&e.protocolVersion>=5&&e.initAsync?e.initAsync(n,o,(function(t){i(t)})):o(e.init(n))}))}(t);if(void 0===t)throw new Error("configuration is required");if(void 0===t.connection)throw new Error("configuration.connections is required");var e=t.connection;"number"!=typeof t.methodResponseTimeout&&(t.methodResponseTimeout=3e3),"number"!=typeof t.waitTimeoutMs&&(t.waitTimeoutMs=3e3);var n,i,o,r,s,a,c=e.resolvedIdentity,u=(n=t.instance,i=c,o=e.peerId,(r={application:D(),pid:Math.floor(1e10*Math.random())}).peerId=o,"object"==typeof n&&(void 0!==n.application&&(r.application=n.application),r.machine=n.machine,r.user=n.user,r.environment=n.environment,r.region=n.region),void 0!==i&&(r.user=i.user,r.instance=i.instance,r.application=i.application,r.applicationName=i.applicationName,r.pid=i.process,r.machine=i.machine,r.environment=i.environment,r.region=i.region,r.windowId=i.windowId,r.isLocal=!0,r.api=i.api),r),d=new Mt,p=new xt;return s=3===e.protocolVersion?yt(u,e,d,p,t,(function(){return a})):function(t,e,n,i,o,r){var s=e.on("agm","Instance",(function(t){r().updateInstance(t),e.off(s)})),a=new Y(e,t,o,i),c=new rt(e,t,o,n);return new Promise((function(t){t({server:a,client:c})}))}(u,e,d,p,t,(function(){return a})),new Promise((function(e,n){s.then((function(n){a=new Tt(n,d,p,u,t),e(a)})).catch((function(t){n(t)}))}))};function Et(t){var e={};return Object.keys(t).forEach((function(n){void 0!==t[n]&&null!==t[n]&&(e[n]=t[n])})),e}var Pt=function(t,e,n){var i=this;this.publish=function(t,e,n){var o=n||{},r=o.routingKey,s=o.target,a=Et({type:"publish",topic:t,data:e,peer_id:i.peerId,routing_key:r,target_identity:s});i.session.send(a)},this.subscribe=function(t,e,n){return new Promise((function(o,r){var s=n||{},a=s.routingKey,c=s.target,u=Et({type:"subscribe",topic:t,peer_id:i.peerId,routing_key:a,source:c});i.session.send(u).then((function(n){var r=n.subscription_id;i.subscriptions.push({subscription_id:r,topic:t,callback:e,source:c}),o({unsubscribe:function(){return i.session.send({type:"unsubscribe",subscription_id:r,peer_id:i.peerId}),i.subscriptions=i.subscriptions.filter((function(t){return t.subscription_id!==r})),Promise.resolve()}})})).catch((function(t){return r(t)}))}))},this.watchOnEvent=function(){i.session.on("event",(function(t){var e,n,o,r,s=t.data,a=t.subscription_id,c=t["publisher-identity"],u=i.subscriptions.find((function(t){return t.subscription_id===a}));u&&(u.source?(e=u.source,n=c,o=Object.keys(e),r=!0,o.forEach((function(t){e[t]!==n[t]&&(r=!1)})),r&&u.callback(s,u.topic,c)):u.callback(s,u.topic,c))}))},this.connection=t,this.logger=e,this.session=n,this.peerId=t.peerId,this.subscriptions=[]},jt=["subscribed","success"],Ot=function(t){var e=t.connection,n=t.logger,i=e.domain("bus",n,jt);return new Promise((function(t,o){i.join().then((function(){var o=function(t,e,n){var i=new Pt(t,e,n);return i.watchOnEvent(),i}(e,n,i);t(o)})).catch(o)}))},Rt="created",Wt="destroyed",Nt="context-created",Ft="context-added",Lt="subscribed-context",Ut="context-destroyed",Dt="context-updated",Gt="joined",Bt={get name(){return"context"},get types(){return["create-context",Rt,Wt,Nt,Ft,"subscribe-context",Lt,"unsubscribe-context","destroy-context",Ut,"update-context",Dt,Gt]}},Ht="4.5.1-alpha.8",qt=function(t,e,n,i,o){var r;"undefined"!=typeof window&&(r=window),"undefined"!=typeof global&&(r=global),r=r||{};var s,a=Object(_.generate)();if(M.isNode()){var c=process.env._GD_STARTING_CONTEXT_;if(c)try{s=JSON.parse(c)}catch(t){}}var u,d,p=r.GLUE_CONFIG||{},f=r.GLUE_DEFAULT_CONFIG||{},h={application:n?n.containerName+"."+n.browserWindowName:i?i.applicationName:M.isNode()?s?s.applicationConfig.name:"NodeJS"+a:"undefined"!=typeof window&&"undefined"!=typeof document?(window.agm_application||document.title)+a:void 0,metrics:function(){var e="undefined"!=typeof document?document.title:"unknown";if(e=e||"none",void 0===n)return{system:"Connect.Browser",service:t.application||e,instance:"~"+a};if(void 0!==n.metricsFacade.getIdentity){var i=n.metricsFacade.getIdentity();return{system:i.system,service:i.service,instance:i.instance}}return{system:"HtmlContainer."+n.containerName,service:"JS."+n.browserWindowName,instance:"~"+n.machineName}}(),agm:{},gateway:(u=3,d="ws://localhost:8385",i&&(u=3,d=i.gwURL),M.isNode()&&s&&(u=3,d=s.gwURL),{ws:d,http:"http://localhost:8385",protocolVersion:u,reconnectInterval:1e3}),logger:{publish:"off",console:"info",metrics:"off"},bus:!1,auth:function(){if(M.isNode()&&s)return{gatewayToken:s.gwToken}}()},l={system:g("metrics","system"),service:g("metrics","service"),instance:g("metrics","instance")},y=g("metrics","disableAutoAppSystem");function v(){return g("application")}function g(e,n){var i=p[e],o=t[e],r=f[e],s=h[e];if(n){if(i&&void 0!==i[n])return i[n];if(o&&void 0!==o[n])return o[n];if(r&&void 0!==r[n])return r[n];if(s&&void 0!==s[n])return s[n]}else{if(void 0!==i)return i;if(void 0!==o)return o;if(void 0!==r)return r;if(void 0!==s)return s}}var m,b,w,S,I=function(){var t=g("gateway","force");if(void 0===n||t){var r=g("gateway"),a=g("gateway","protocolVersion"),c=g("gateway","reconnectInterval"),u=g("gateway","reconnectAttempts"),d=r.ws,p=r.http,f=r.inproc;d||p||f||(M.isNode()||"WebSocket"in window&&2===window.WebSocket.CLOSING?d=g("gateway","ws"):p=g("gateway","http"));var h=void 0,l=void 0,y=void 0,m=void 0,b=void 0,w=v(),_=w;n?(l=n.windowId,m=n.env.env,b=n.env.region):void 0!==i?(l=i.windowId,y=i.pid,i.env&&(m=i.env.env,b=i.env.region),_=i.application,h=i.appInstanceId):M.isNode()&&(y=process.pid,s&&(m=s.env,b=s.region,h=s.instanceId));var S=g("gateway","replaySpecs")||[];return S.push(Bt),{identity:{application:_,applicationName:w,windowId:l,instance:h,process:y,region:b,environment:m,api:e.version||Ht},reconnectInterval:c,ws:d,http:p,gw:f,protocolVersion:a,reconnectAttempts:u,force:!0,replaySpecs:S,gdVersion:o}}return{gdVersion:o}}(),A=function(t){if(t.protocolVersion<3)return!1;var e=g("contexts");return!("boolean"==typeof e&&!e)}(I),C=function(t){if(!t)return!1;var e=g("channels");return!("boolean"==typeof e&&!e)}(A);return{bus:(m=I,!("boolean"!=typeof(b=g("bus"))||!b||m.protocolVersion&&m.protocolVersion<3||2===o)),identity:l,application:v(),auth:g("auth"),logger:g("logger"),connection:I,metrics:{identity:l,disableAutoAppSystem:y},agm:(w=t.agm,S={instance:{application:v()}},"boolean"!=typeof w||w?S:void 0),contexts:A,channels:C,version:e.version||Ht,libs:e.libs}},Vt={protocolVersion:-1,send:function(t,e,n,i,o){return Promise.resolve(void 0)},on:function(t,e,n){return{type:"1",id:1}},off:function(t){},login:function(t){},logout:function(){},loggedIn:function(t){},connected:function(t){},disconnected:function(t){}},Jt=function(){function t(){return(new Date).getTime()}var e,n,i=t();return{get startTime(){return i},get endTime(){return e},get period(){return n},stop:function(){return e=t(),n=t()-i}}},zt=function(){function t(t,e,n,i){this.updateCallbacks={},this.contextId=t,this.name=e,this.isAnnounced=n,this.activityId=i,this.context={}}return t.prototype.hasCallbacks=function(){return Object.keys(this.updateCallbacks).length>0},t.prototype.getState=function(){return this.isAnnounced&&this.hasCallbacks()?3:this.isAnnounced?2:this.hasCallbacks()?1:0},t}(),Kt=function(){return(Kt=Object.assign||function(t){for(var e,n=1,i=arguments.length;n<i;n++)for(var o in e=arguments[n])Object.prototype.hasOwnProperty.call(e,o)&&(t[o]=e[o]);return t}).apply(this,arguments)},Zt=function(){for(var t=0,e=0,n=arguments.length;e<n;e++)t+=arguments[e].length;var i=Array(t),o=0;for(e=0;e<n;e++)for(var r=arguments[e],s=0,a=r.length;s<a;s++,o++)i[o]=r[s];return i};function Yt(t,e){if(e){if(e.reset)return t=Kt({},e.reset);t=Qt(t,null);var n=e.added,i=e.updated,o=e.removed;n&&Object.keys(n).forEach((function(e){t[e]=n[e]})),i&&Object.keys(i).forEach((function(e){Xt(e,t,i)})),o&&o.forEach((function(e){delete t[e]}))}return t}function Qt(t,e){if(e=e||new WeakMap,Object(t)!==t)return t;if(t instanceof Set)return new Set(t);if(e.has(t))return e.get(t);var n=t instanceof Date?new Date(t):t instanceof RegExp?new RegExp(t.source,t.flags):t.constructor?new t.constructor:Object.create(null);return e.set(t,n),t instanceof Map&&Array.from(t,(function(t){var i=t[0],o=t[1];return n.set(i,Qt(o,e))})),Object.assign.apply(Object,Zt([n],Object.keys(t).map((function(n){var i;return(i={})[n]=Qt(t[n],e),i}))))}var Xt=function(t,e,n){var i=n[t];if(void 0===i)return e;var o=e[t];return o&&i?"string"==typeof o||"number"==typeof o||"boolean"==typeof o||"string"==typeof i||"number"==typeof i||"boolean"==typeof i||Array.isArray(o)||Array.isArray(i)?(e[t]=i,e):(e[t]=Object.assign({},o,i),e):(e[t]=i,e)};function $t(t,e){if(t===e)return!0;if(!(t instanceof Object&&e instanceof Object))return!1;if(t.constructor!==e.constructor)return!1;for(var n in t)if(t.hasOwnProperty(n)){if(!e.hasOwnProperty(n))return!1;if(t[n]!==e[n]){if("object"!=typeof t[n])return!1;if(!$t(t[n],e[n]))return!1}}for(var n in e)if(e.hasOwnProperty(n)&&!t.hasOwnProperty(n))return!1;return!0}var te=function(t,e,n,i){return new(n||(n=Promise))((function(o,r){function s(t){try{c(i.next(t))}catch(t){r(t)}}function a(t){try{c(i.throw(t))}catch(t){r(t)}}function c(t){var e;t.done?o(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(s,a)}c((i=i.apply(t,e||[])).next())}))},ee=function(t,e){var n,i,o,r,s={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return r={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(r[Symbol.iterator]=function(){return this}),r;function a(r){return function(a){return function(r){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,i&&(o=2&r[0]?i.return:r[0]?i.throw||((o=i.return)&&o.call(i),0):i.next)&&!(o=o.call(i,r[1])).done)return o;switch(i=0,o&&(r=[2&r[0],o.value]),r[0]){case 0:case 1:o=r;break;case 4:return s.label++,{value:r[1],done:!1};case 5:s.label++,i=r[1],r=[0];continue;case 7:r=s.ops.pop(),s.trys.pop();continue;default:if(!(o=(o=s.trys).length>0&&o[o.length-1])&&(6===r[0]||2===r[0])){s=0;continue}if(3===r[0]&&(!o||r[1]>o[0]&&r[1]<o[3])){s.label=r[1];break}if(6===r[0]&&s.label<o[1]){s.label=o[1],o=r;break}if(o&&s.label<o[2]){s.label=o[2],s.ops.push(r);break}o[2]&&s.ops.pop(),s.trys.pop();continue}r=e.call(t,s)}catch(t){r=[6,t],i=0}finally{n=o=0}if(5&r[0])throw r[1];return{value:r[0]?r[1]:void 0,done:!0}}([r,a])}}},ne=function(){function t(t){var e=this;this._contextNameToData={},this._gw3Subscriptions=[],this._nextCallbackSubscriptionNumber=0,this._contextNameToId={},this._contextIdToName={},this._connection=t.connection,this._logger=t.logger,this._gw3Session=this._connection.domain("global",this._logger,[Nt,Lt,Ut,Dt]),this.subscribeToContextCreatedMessages(),this.subscribeToContextUpdatedMessages(),this.subscribeToContextDestroyedMessages(),this._connection.replayer.drain(Bt.name,(function(t){var n=t.type;n&&(n===Nt||n===Ft||n===Rt?e.handleContextCreatedMessage(t):n===Lt||n===Dt||n===Gt?e.handleContextUpdatedMessage(t):n!==Ut&&n!==Wt||e.handleContextDestroyedMessage(t))}))}return t.prototype.dispose=function(){for(var t=0,e=this._gw3Subscriptions;t<e.length;t++){var n=e[t];this._connection.off(n)}for(var i in this._gw3Subscriptions.length=0,this._contextNameToData)this._contextNameToId.hasOwnProperty(i)&&delete this._contextNameToData[i]},t.prototype.createContext=function(t,e){var n=this;return this._gw3Session.send({type:"create-context",domain:"global",name:t,data:e,lifetime:"retained"}).then((function(i){if(n._contextNameToId[t]=i.context_id,!n._contextIdToName[i.context_id]){n._contextIdToName[i.context_id]=t;var o=n._contextNameToData[t]||new zt(i.context_id,t,!0,null);return o.isAnnounced=!0,o.name=t,o.contextId=i.context_id,n._contextNameToData[t]=o,o.context=i.data,o.sentExplicitSubscription=!0,o.context&&n.invokeUpdateCallbacks(o,o.context,null),n.update(t,e).then((function(){return i.context_id}))}return i.context_id}))},t.prototype.all=function(){var t=this;return Object.keys(this._contextNameToData).filter((function(e){return t._contextNameToData[e].isAnnounced}))},t.prototype.update=function(t,e){return te(this,void 0,void 0,(function(){var n,i,o,r=this;return ee(this,(function(s){switch(s.label){case 0:return(n=this._contextNameToData[t])&&n.isAnnounced?(i=n.context,n.hasCallbacks()?[3,2]:[4,this.get(n.name,!1)]):[2,this.createContext(t,e)];case 1:i=s.sent(),s.label=2;case 2:return o=this.calculateContextDelta(i,e),Object.keys(o.added).length||Object.keys(o.updated).length||o.removed.length?[2,this._gw3Session.send({type:"update-context",domain:"global",context_id:n.contextId,delta:o},{},{skipPeerId:!1}).then((function(t){r.handleUpdated(n,o,{updaterId:t.peer_id})}))]:[2,Promise.resolve()]}}))}))},t.prototype.set=function(t,e){var n=this,i=this._contextNameToData[t];return i&&i.isAnnounced?this._gw3Session.send({type:"update-context",domain:"global",context_id:i.contextId,delta:{reset:e}},{},{skipPeerId:!1}).then((function(t){n.handleUpdated(i,{reset:e,added:{},removed:[],updated:{}},{updaterId:t.peer_id})})):this.createContext(t,e)},t.prototype.get=function(t,e){var n=this;void 0===e&&(e=!0);var i=this._contextNameToData[t];return i&&i.isAnnounced&&i.hasCallbacks()||e?Promise.resolve(i&&i.context):new Promise((function(e,i){return te(n,void 0,void 0,(function(){var n=this;return ee(this,(function(i){return this.subscribe(t,(function(t,i,o,r){n.unsubscribe(r),e(t)})),[2]}))}))}))},t.prototype.subscribe=function(t,e){var n=this._nextCallbackSubscriptionNumber;this._nextCallbackSubscriptionNumber+=1;var i=this._contextNameToData[t];if(!i||!i.isAnnounced)return i=i||new zt(void 0,t,!1,void 0),this._contextNameToData[t]=i,i.updateCallbacks[n]=e,Promise.resolve(n);var o=i.hasCallbacks();return i.updateCallbacks[n]=e,o?(e(i.context,i.context,[],n),Promise.resolve(n)):i.joinedActivity?(e(i.context,i.context,[],n),Promise.resolve(n)):i.context&&i.sentExplicitSubscription?(e(i.context,i.context,[],n),Promise.resolve(n)):this.sendSubscribe(i).then((function(){return n}))},t.prototype.unsubscribe=function(t){for(var e=0,n=Object.keys(this._contextNameToData);e<n.length;e++){var i=n[e],o=(this._contextNameToId[i],this._contextNameToData[i]);if(!o)return;var r=o.hasCallbacks();delete o.updateCallbacks[t],o.isAnnounced&&r&&!o.hasCallbacks()&&o.sentExplicitSubscription&&this.sendUnsubscribe(o),o.isAnnounced||o.hasCallbacks()||delete this._contextNameToData[i]}},t.prototype.handleUpdated=function(t,e,n){var i=t.context;t.context=Yt(t.context,e),this._contextNameToData[t.name]!==t||$t(i,t.context)||this.invokeUpdateCallbacks(t,t.context,e,n)},t.prototype.subscribeToContextCreatedMessages=function(){for(var t=0,e=[Ft,Nt,Rt];t<e.length;t++){var n=e[t],i=this._connection.on("js-contexts",n,this.handleContextCreatedMessage.bind(this));this._gw3Subscriptions.push(i)}},t.prototype.handleContextCreatedMessage=function(t){var e=t.type;e===Rt?(this._contextNameToId[t.activity_id]=t.context_id,this._contextIdToName[t.context_id]=t.activity_id):e===Ft&&(this._contextNameToId[t.name]=t.context_id,this._contextIdToName[t.context_id]=t.name);var n=this._contextIdToName[t.context_id];if(!n)throw new Error("Received created event for context with unknown name: "+t.context_id);if(!this._contextNameToId[n])throw new Error("Received created event for context with unknown id: "+t.context_id);var i=this._contextNameToData[n];if(i){if(i.isAnnounced)return;if(!i.hasCallbacks())throw new Error("Assertion failure: contextData.hasCallbacks()");i.isAnnounced=!0,i.contextId=t.context_id,i.activityId=t.activity_id,i.sentExplicitSubscription||this.sendSubscribe(i)}else this._contextNameToData[n]=i=new zt(t.context_id,n,!0,t.activity_id)},t.prototype.subscribeToContextUpdatedMessages=function(){for(var t=0,e=[Dt,Lt,Gt];t<e.length;t++){var n=e[t],i=this._connection.on("js-contexts",n,this.handleContextUpdatedMessage.bind(this));this._gw3Subscriptions.push(i)}},t.prototype.handleContextUpdatedMessage=function(t){var e=t.type,n=t.context_id,i=this._contextNameToData[this._contextIdToName[n]],o=!i||!i.isAnnounced;if(e===Gt)i?(i.contextId=n,i.isAnnounced=!0,i.activityId=t.activity_id):(i=new zt(n,t.activity_id,!0,t.activity_id),this._contextNameToData[t.activity_id]=i,this._contextIdToName[n]=t.activity_id,this._contextNameToId[t.activity_id]=n),i.joinedActivity=!0;else if(!i||!i.isAnnounced)return void(e===Lt?((i=i||new zt(n,t.name,!0,null)).sentExplicitSubscription=!0,this._contextNameToData[t.name]=i,this._contextIdToName[n]=t.name,this._contextNameToId[t.name]=n):this._logger.error("Received 'update' for unknown context: "+n));var r=i.context;if(e===Lt)i.context=t.data||{};else if(e===Gt)i.context=t.context_snapshot||{};else{if(e!==Dt)throw new Error("Unrecognized context update message "+e);i.context=Yt(i.context,t.delta)}!o&&$t(i.context,r)&&e!==Lt||this.invokeUpdateCallbacks(i,i.context,null,{updaterId:t.updater_id})},t.prototype.invokeUpdateCallbacks=function(t,e,n,i){for(var o in n=n||{added:{},updated:{},reset:{},removed:[]},t.updateCallbacks)if(t.updateCallbacks.hasOwnProperty(o))try{(0,t.updateCallbacks[o])(Qt(e),Object.assign({},n.added||{},n.updated||{},n.reset||{}),n.removed,parseInt(o,10),i)}catch(t){this._logger.debug("Callback error: "+JSON.stringify(t))}},t.prototype.subscribeToContextDestroyedMessages=function(){for(var t=0,e=[Ut,Wt];t<e.length;t++){var n=e[t],i=this._connection.on("js-contexts",n,this.handleContextDestroyedMessage.bind(this));this._gw3Subscriptions.push(i)}},t.prototype.handleContextDestroyedMessage=function(t){var e,n;if(t.type===Wt){if(n=t.activity_id,!(e=this._contextNameToId[n]))return void this._logger.error("Received 'destroyed' for unknown activity: "+t.activity_id)}else if(e=t.context_id,!(n=this._contextIdToName[e]))return void this._logger.error("Received 'destroyed' for unknown context: "+t.context_id);delete this._contextIdToName[e],delete this._contextNameToId[n];var i=this._contextNameToData[n];delete this._contextNameToData[n],i&&i.isAnnounced||this._logger.error("Received 'destroyed' for unknown context: "+e)},t.prototype.sendSubscribe=function(t){return t.sentExplicitSubscription=!0,this._gw3Session.send({type:"subscribe-context",domain:"global",context_id:t.contextId}).then((function(t){}))},t.prototype.sendUnsubscribe=function(t){return t.sentExplicitSubscription=!1,this._gw3Session.send({type:"unsubscribe-context",domain:"global",context_id:t.contextId}).then((function(t){}))},t.prototype.calculateContextDelta=function(t,e){var n={added:{},updated:{},removed:[],reset:null};if(t)for(var i=0,o=Object.keys(t);i<o.length;i++){var r=o[i];-1===Object.keys(e).indexOf(r)||null===e[r]||$t(t[r],e[r])||(n.updated[r]=e[r])}for(var s=0,a=Object.keys(e);s<a.length;s++){r=a[s];t&&-1!==Object.keys(t).indexOf(r)?null===e[r]&&n.removed.push(r):null!==e[r]&&(n.added[r]=e[r])}return n},t}(),ie=function(t,e,n,i){return new(n||(n=Promise))((function(o,r){function s(t){try{c(i.next(t))}catch(t){r(t)}}function a(t){try{c(i.throw(t))}catch(t){r(t)}}function c(t){var e;t.done?o(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(s,a)}c((i=i.apply(t,e||[])).next())}))},oe=function(t,e){var n,i,o,r,s={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return r={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(r[Symbol.iterator]=function(){return this}),r;function a(r){return function(a){return function(r){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,i&&(o=2&r[0]?i.return:r[0]?i.throw||((o=i.return)&&o.call(i),0):i.next)&&!(o=o.call(i,r[1])).done)return o;switch(i=0,o&&(r=[2&r[0],o.value]),r[0]){case 0:case 1:o=r;break;case 4:return s.label++,{value:r[1],done:!1};case 5:s.label++,i=r[1],r=[0];continue;case 7:r=s.ops.pop(),s.trys.pop();continue;default:if(!(o=(o=s.trys).length>0&&o[o.length-1])&&(6===r[0]||2===r[0])){s=0;continue}if(3===r[0]&&(!o||r[1]>o[0]&&r[1]<o[3])){s.label=r[1];break}if(6===r[0]&&s.label<o[1]){s.label=o[1],o=r;break}if(o&&s.label<o[2]){s.label=o[2],s.ops.push(r);break}o[2]&&s.ops.pop(),s.trys.pop();continue}r=e.call(t,s)}catch(t){r=[6,t],i=0}finally{n=o=0}if(5&r[0])throw r[1];return{value:r[0]?r[1]:void 0,done:!0}}([r,a])}}},re=function(){function t(t){this._facade=window.htmlContainer.sharedContextFacade}return t.prototype.all=function(){var t=this._facade.all();return t&&t.keys?t.keys:[]},t.prototype.update=function(t,e){return this._facade.update(t,e),Promise.resolve()},t.prototype.set=function(t,e){return this._facade.set(t,e),Promise.resolve()},t.prototype.subscribe=function(t,e){var n=null,i=this._facade.subscribe(t,(function(t,o,r){i||0===i?e(t,o,r,i):n=t}));return n&&(e(n,n,[],i),n=null),Promise.resolve(i)},t.prototype.get=function(t,e){var n=this;if(e)throw new Error("resolveImmediately not supported in HtmlContainer");return new Promise((function(e,i){return ie(n,void 0,void 0,(function(){var n=this;return oe(this,(function(i){return this.subscribe(t,(function(t,i){n.unsubscribe(i),e(t)})),[2]}))}))}))},t.prototype.unsubscribe=function(t){this._facade.unsubscribe(t)},t}(),se=function(){function t(t){this.config=t;try{if(2===t.gdMajorVersion){if(!window.htmlContainer.sharedContextFacade)throw new Error("Your version of HtmlContainer does not support contexts. Get version 1.46.0.0 or later to have that feature.");this._bridge=new re(t)}else{if(3!==t.connection.protocolVersion)throw new Error("To use the Contexts library you must run in the HTML Container or using a connection to Gateway v3.");this._bridge=new ne(t)}}catch(t){throw t}}return t.prototype.all=function(){return this._bridge.all()},t.prototype.update=function(t,e){return this.checkName(t),this._bridge.update(t,e)},t.prototype.set=function(t,e){return this.checkName(t),this._bridge.set(t,e)},t.prototype.subscribe=function(t,e){var n=this;return this.checkName(t),this._bridge.subscribe(t,(function(t,i,o,r,s){return e(t,i,o,(function(){return n._bridge.unsubscribe(r)}),s)})).then((function(t){return function(){n._bridge.unsubscribe(t)}}))},t.prototype.get=function(t,e){return!1===e&&(e=!0),this._bridge.get(t,e)},t.prototype.ready=function(){return Promise.resolve(this)},t.prototype.checkName=function(t){if("string"!=typeof t||""===t)throw new Error("'name' must be non-empty string, got '"+t+"'")},t}(),ae=function(t,e){var n,i,o=-1,r=Promise.resolve();"undefined"!=typeof window&&(2===(o=M.getGDMajorVersion())?n=window.htmlContainer:o>=3&&(i=window.glue42gd,r=window.gdPreloadPromise||r));var s,a,c,u,d,p,f=Jt(),h=qt(t=t||{},e=e||{},n,i,o),l={};function y(t,e,n){e.initStartTime=n.startTime,e.ready?e.ready().then((function(){e.initTime=n.stop(),e.initEndTime=n.endTime})):(e.initTime=n.stop(),e.initEndTime=n.endTime),Array.isArray(t)||(t=[t]),t.forEach((function(t){l[t]=e,ae[t]=e}))}function v(){if(h.metrics){var t=Jt();u=g({identity:h.metrics.identity,connection:h.metrics?s:Vt,logger:c.subLogger("metrics")});var e,n=(d=h.metrics.disableAutoAppSystem?u:u.subSystem("App")).subSystem("reporting"),i={name:"features",conflation:1};d.featureMetric=function(t,o,r){if(void 0===t||""===t)throw new Error("name is mandatory");if(void 0===o||""===o)throw new Error("action is mandatory");if(void 0===r||""===r)throw new Error("payload is mandatory");e?e.update({name:t,action:o,payload:r}):e=n.objectMetric(i,{name:t,action:o,payload:r})};var o=(d.parent||d).subSystem("LogEvents");c.metricsLevel("warn",o),y("metrics",d,t)}return Promise.resolve(void 0)}function m(){var t=h.activities&&3===s.protocolVersion;if(h.contexts||t){var e=Jt();return y("contexts",p=new se({connection:s,logger:c.subLogger("contexts"),gdMajorVersion:o}),e),p}var n=s.replayer;n&&n.drain(Bt.name,null)}function b(t){try{return t.forEach((function(t){!function(t,e){var n=Jt(),i=e(l);i&&y(t,i,n)}(t.name,t.create)})),Promise.resolve()}catch(t){return Promise.reject(t)}}function w(){if(!h.bus)return Promise.resolve(void 0);var t=Jt(),e={connection:s,logger:c.subLogger("bus")};return new Promise((function(n,i){Ot(e).then((function(e){y("bus",e,t),n()})).catch((function(t){return i(t)}))}))}return r.then((function(){var t=Jt(),e={identity:h.identity,getConnection:function(){return s||Vt},publish:h.logger.publish||"off",console:h.logger.console||"info",metrics:h.metrics&&h.logger.metrics||"off"};return y("logger",c=U(e),t),Promise.resolve(void 0)})).then((function(){var t=Jt();h.connection.logger=c.subLogger("connection"),s=N(h.connection);var e=Promise.resolve(h.auth);if(h.connection&&!h.auth){var n=h.connection.protocolVersion;if(!n||1===n)return y("connection",s,t),Promise.resolve({});if(2===n)return Promise.reject("You need to provide auth information");3===n&&(e=i?i.getGWToken().then((function(t){return{gatewayToken:t}})):Promise.reject("You need to provide auth information"))}return e.then((function(t){var e;if("string"==typeof t||"number"==typeof t)e={token:t};else{if("[object Object]"!==Object.prototype.toString.call(t))throw new Error("Invalid auth object - "+JSON.stringify(t));e=t}return e})).then((function(t){return s.login(t)})).then((function(e){return e&&(e.machine&&(h.agm.instance.machine=e.machine),e.user&&(h.agm.instance.user=e.user)),y("connection",s,t),h})).catch((function(t){throw s&&s.logout(),t}))})).then((function(){return Promise.all([v(),(t=Jt(),e={instance:h.agm.instance,connection:s,logger:c.subLogger("interop"),forceGW:h.connection&&h.connection.force,gdVersion:o},new Promise((function(n,i){kt(e).then((function(e){y(["interop","agm"],a=e,t),n(h)})).catch((function(t){return i(t)}))}))),m(),w()]);var t,e})).then((function(){return b(h.libs||[])})).then((function(){var t=Object.keys(l).map((function(t){var e=l[t];return e.ready?e.ready():Promise.resolve()}));return Promise.all(t)})).then((function(){var o={glueVersion:h.version};f.stop();var r={feedback:function(){a&&a.invoke("T42.ACS.Feedback",{},"best")},info:o,version:h.version,userConfig:t,done:function(){return s.logout(),Promise.resolve()}};if(r.performance={get glueVer(){return h.version},get glueConfig(){return JSON.stringify(t)},get browser(){return window.performance.timing.toJSON()},get memory(){return window.performance.memory},get initTimes(){var t=Object.keys(r).filter((function(t){return"initTimes"!==t&&"agm"!==t&&r[t].initTime})).map((function(t){return{name:t,time:r[t].initTime,startTime:r[t].initStartTime,endTime:r[t].initEndTime}}));return t.push({name:"glue",startTime:f.startTime,endTime:f.endTime,time:f.period}),t}},Object.keys(l).forEach((function(t){var e=l[t];r[t]=e,o[t]=e.version})),n&&n.perfDataNeeded&&n.updatePerfData){var c=n.perfDataDelay||100;setTimeout((function(){n.updatePerfData(r.performance)}),c)}return i&&i.updatePerfData&&i.updatePerfData(r.performance),r.config={},e.enrichGlue&&e.enrichGlue(r),Object.keys(h).forEach((function(t){r.config[t]=h[t]})),e.extOptions&&Object.keys(e.extOptions).forEach((function(t){r.config[t]=e.extOptions[t]})),r})).catch((function(t){return Promise.reject({err:t,libs:l})}))},ce=ae;"undefined"!=typeof window&&(window.GlueCore=ce),ce.default=ce,ce.version=Ht;e.default=ce}])}));
//# sourceMappingURL=desktop.js.map